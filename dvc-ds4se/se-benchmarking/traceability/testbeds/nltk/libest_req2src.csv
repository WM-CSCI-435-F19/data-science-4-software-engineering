src_dtype,trgt_dtype,src_file,trgt_file,src_doc,trgt_doc,src_vec,trgt_vec,wmd,ground_truth
req,src,test_data/LibEST_semeru_format/requirements/RQ58-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir server key generat follow exampl valid serverkeygen exchang exchang est client authent use exist certif issu est server provid servic initi tls handshak ident enrol exampl handshak exampl http post messag post well known est serverkeygen http host accept expect continu content type applic pkcs content transfer encod base content length miicw tccaak caqaw mdw ueax vydm ihjlc sbie sbjb gll qga zgvtbi bzd gvw idey idez njgx nde ntux gtaxbg nvbautefbjrdp wrn zxqg mtawgg gcsq gsib dqebaquaa ibdw awgg ekao ibaqcv suyzbf cqfp aepa bsfluvm hxr wpie rio ruun fll urkq yzmq noo rptu frss niphl sikt rhz cfr aph ipu imh bhi lfhq afhz zjs ousvp umq uog soq djhpj ytj pxrqdch qjxh jhvl pho yix aysutcbb txwfcwsr wdj mmk dio avaz mbaagg itaf bgkqhki bcqcx mqzezz qvht anbgkqhki baqufaaocaqear eqb sjr lcajn hungsz idwx eze omk fgkj red yupb lblo ofx gqjheq jeibc dtajq dihi gqnhosyg izhv kpp qleb gvp rjsn mro pce rin wff namp tgwjv ikhj cll cdg oex fqh hjp zkblo rwv dti zuwt fff gtuxvp wiw dsh bbq erbp jiw aqi gyo decrypt key identifi attribut includ request respons includ addit encrypt beyond tls session est server respons http status content type multipart mix boundari est server exampl boundari content length preambl ignor though handi place est server includ explanatori note includ contact support inform est server exampl boundari content type applic pkcs8 content transfer encod base64 miievg ibadanbgkqhki g9w0baqefaascbkgwgg eaao ibaqdpw ktw j7tj poj64v909ryql0fo p1h u4yq5y8 op5zte6arg uye099ac dfdwpi desiuj s62vck3uwnbnw 4o38fup0en lbbj stud48kp ew6 fzkeu aan pgzma1w kyr yy9 d5t qooju cbvh iti ylznyue4agbpc r0w mtr rr2e58mu8w q80ryk6nk l7cok5z iqd nrxldk7dfvp a85yn1stumo grt vlw51i ts1lt xwhu j6lds3vv j2si y3rx pln jvi r8mf2tbojzu fqva vld2ay qjga gejq2zwhxel qaoz6n3lr choj fgq93i mbaaecgg ebalq5az yjd5x9y3f7nmuffwl rrf mhcmtrx u4aeao kbym0h fvzztxf z7xl d8g0th6gs2h fa6gwc upmi olxht0x lgg ymc nam cdj lbq7x rqcwtlc k9wca5 hbwtc ey6244r xxh wd6nt6b xc165aec x87i jfj7xfne dp656s2dmx scci dte6sa em7 ygu16qev mthc xkvp ikk2px5idad4pb6 qhpqj3d4o m8dj o6w yuvr h8xqlq f8hd5l fwvu57n syy h79 ndtf rtul6axr7km kvfoj0jj zex ucvmzt giqh b6ucg yea639otd wlzczi zfme p7vl rddoz0vatr u2dxn eb4c wd8gerg8u nvp8og84g 6mb pwz4zywkcg dfqyr alw sf02n9sovh93eo j5lat sbfe yuk b8l hvk5 cbges v9mukd mf0 b43ylhi edi 0ue hlfg rrfp p2c xdu eie mcg yea4db sirw g1gjo3o e09kd89vgj vrer srbcqc7dc pxp6lw42sx96h4j vwwq hvo3dfw fbd ub1lh2cn vxqjg duhd ndpl01cf bfycfini2q kmqi jyswkh z1blz qtdb pfl2pg lni kfg2a flr ts3s tge b5qw rpig h3kf yapq cji fmlrvf rrnzd qewi4vn epf4 hjp as1g d8vf zwlkw vyl ud9hcerzg a7rixi q0sx tvtxh l6pxl m2nebfqb v16h pfl6 g4f0u9o hno g8r htq sjn bn4yo yfm70dhe7qtb zelca pch6cuhj2st5b8zhwdt reqkbg hnp xiy4c2ubi canv9csa xul iod xnba cgpf om5d wrm5dd lmf33mo9va sre ku3 q4nbgs glw pp1zqz qznzp mi7w6306yp4gd aj5pb oww st0vq w5ob7d ili k4a9s4 zki nrf rsl8gm dhc9rsu dwqof iaq vhvbhnz jao gbaohqof5l6i ghohcx lazx 4mgv rtpmz px6q3qxqpet egfedzaa l58l67sss3f fbn vaid f6ll c1b ah1ao yhudi45x boroy0h bwrn r6c cvw5st rkz iev tzhhozk m7pyh x4bi bmg q3bh tp4h est server exampl boundari content type applic pkcs7 mime smime type cert content transfer encod base64 miidrqyjko zihvc naqc iidnj ccaz icaqex adalbgkqhki g9w0bbw gggg mymiid fdccafyg ibag ibfj anbgkqhki g9w0baqufadab mrkw ydvqqdex blc3rfe gft gxl q0eg tnd omb4xdtez mduw otiz u1nlo xdte0mduw otiz u1nlow ldeq mcg a1ueax mhc2vydm vyc2lk zsbr zxkg z2vu zxjhd gvk ihjlc3bvbn miibij anbgkq hki kcaqeaz8crc ce04z iapj6i ffd pa8qpd h6d9i vogkucv p2zj wu3ug k4fyvmnt qhpn x3c kcj eoro1bf3uutl xjn1fj w58pu bvkd hpy2240k7n pcq rfuvhc5hrg gpzxm tanc csq2mvaw udji vpwg vyvki c2twfhu g6xed mdla0a9h dlv mepnk8p op5c wjp owsehtuc zxzowxb6qpowj lbpq bkb vs1ud yl3k0t s7v8ibl i3b n77w iidkomd gn68t5zi vch zkf dh9kw to87har2v1sw9msk i4ghh i6tm vh13p uadmejd5awoa rqvd8jo qidaqabo1iw udaobg nvhq8baf8ebamcblaw hqydvr0obbyefk zixu9f app dx2ss5haxm v6jr4 mb8ga1ud qymba aflhea zbow sn2jejizu wqi i8ma0gcsq gsib3dqebbqua a4ibaqbhh rakrn tapqq bob dm9iqdqpuw w1g zkl iwiw hezl1ig xhpjj rf4xqp iki jmmka oeo xa8pfni zm9fqsm j89cuf5d wj8s17xu xu9l xjj xhs l40wu dg6t mpn9vc t8t e3ruor608mkshfx nem6 nvsuptm b33bg yb1wa e7pn3jmn6pj f4p ki8qvo tsvvja cew ue8q fw1yvjo yjti mn4v5kb3rt s8yie1tcf vqrj qutqr34 pzi zwi92kza 1958a6m9o p5oi0up9zxkg2dec 1o9q t0gi yj6sx gtoxk6j mdd qax est server exampl boundari epilogu also ignor,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.00314126 -0.11988081 -0.28746873  0.01172288  0.06187648  0.10759547
  0.23292126  0.08737477 -0.02719483 -0.11510732 -0.04803624 -0.04844419
 -0.012379    0.10769729 -0.08871354 -0.00591579 -0.02452177  0.1129517
  0.0857418   0.00892831 -0.01900305  0.07727785  0.01524534  0.10777587
  0.22458094  0.18147703  0.03898545  0.12245347 -0.05185317  0.04040194
  0.05956536 -0.07907865 -0.05457791 -0.1744715   0.16564552 -0.01130053
  0.01941668  0.09401554 -0.0581401  -0.11260852 -0.041188   -0.11491706
 -0.04600274  0.00391768  0.0498553   0.12522225  0.08951521 -0.03868822
  0.09894913 -0.18486825 -0.01759241 -0.09799492 -0.0365665   0.11935702
 -0.05368097 -0.04078052 -0.05348172 -0.02276937  0.1685632  -0.15495078
 -0.0279893  -0.01774516  0.23565453  0.15086497  0.0155919  -0.03131004
 -0.19996023  0.04308473  0.06074061 -0.03465192 -0.06315255  0.09754014
 -0.1484139   0.06320821 -0.03382818 -0.03923715 -0.04126522 -0.09203753
  0.12731202 -0.01205565  0.0970488  -0.08448064  0.07091998 -0.04249281
  0.06917268 -0.078191   -0.07956326  0.0365563  -0.10901794 -0.01514293
  0.10345594 -0.1191929  -0.07830833 -0.02180294 -0.03442594 -0.05075943
 -0.03158417  0.1431836  -0.17355086  0.06975251]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.3405619296743265,0
req,src,test_data/LibEST_semeru_format/requirements/RQ23-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir certif less tls mutual authent certif less tls cipher suit provid way perform mutual authent situat neither client server certif desir use certif trust anchor necessari verifi certif client server may negoti certif less cipher suit mutual authent use certif less mutual authent tls enrol cipher suit must base protocol resist dictionari attack must base zero knowledg protocol transport layer secur secur remot password tls srp cipher suit srp name list section rfc suitabl purpos section list characterist cipher suit suitabl use certif less mutual authent enrol success authent use certif less cipher suit prove knowledg pre share secret implicit author peer exchang,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.03502419 -0.11070093 -0.26910967  0.00777616  0.02791341  0.10168082
  0.2549339   0.05649045 -0.0143865  -0.12104694 -0.07655802 -0.0343263
 -0.0197481   0.09124649 -0.09171128  0.0503534   0.00999131  0.09990548
  0.09415257  0.07287048  0.0353492   0.0612152   0.00379392  0.08496425
  0.23055631  0.19217035  0.01274706  0.14793596 -0.04581299  0.04930047
  0.01866526 -0.06496868 -0.01570188 -0.14055377  0.13634585 -0.01440789
  0.06431904  0.1236918  -0.0424067  -0.09151722  0.00775591 -0.08086397
 -0.0342573  -0.0591412   0.05797459  0.1055127   0.10518643 -0.05868877
  0.10452148 -0.18195724 -0.051609   -0.08838895 -0.08329114  0.05896837
 -0.03349564  0.00661981 -0.06643137 -0.04309354  0.16077377 -0.1123402
 -0.00621304  0.00910075  0.20758864  0.11458318  0.01921583 -0.05592223
 -0.21312287  0.05017256  0.03245937 -0.08189879 -0.13241974  0.11413654
 -0.14800094  0.06054307 -0.05660127 -0.03889328 -0.04985166 -0.05365571
  0.15377773 -0.0011861   0.14377767 -0.09773597  0.06884117 -0.01214004
  0.06039708 -0.08083048 -0.07974792  0.0349386  -0.14917791 -0.03636461
  0.06550532 -0.12041557 -0.05732323 -0.05503714 -0.02430081 -0.03534544
 -0.06488306  0.12177993 -0.16346969  0.09805314]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.4109769453867617,0
req,src,test_data/LibEST_semeru_format/requirements/RQ28-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.h,requir client use implicit databas est client implicit databas use valid est server certif client must check configur uri http redirect uri accord rule specifi rfc section provis uri recent http redirect uri provid basi author server authent ident confirm author server,prototyp privat est server part public api void est send http error est ctx ctx void http ctx int fail code prototyp privat est server part public api int est enrol auth est ctx ctx void http ctx ssl ssl char path seg int reenrol prototyp privat est server part public api int est handl cacert est ctx ctx unsign char cert int cert len void http ctx char path seg prototyp privat est server part public api int est tls uid auth est ctx ctx ssl ssl req req prototyp privat est server part public api req est server pars csr unsign char pkcs int pkcs len prototyp privat est server part public api int est server check csr req req prototyp privat est server part public api est error est server send http retri est ctx ctx void http ctx int delay,"[ 0.02980203 -0.11710332 -0.26550922  0.00489574  0.02676419  0.09572162
  0.24986003  0.05694745 -0.01432658 -0.10702708 -0.07349299 -0.0454149
 -0.01971533  0.0857412  -0.0916763   0.04715936  0.00419306  0.09055112
  0.09400715  0.06509653  0.03041507  0.06232808  0.00950324  0.09158973
  0.2267382   0.19223216  0.01278502  0.15279706 -0.05178717  0.05148544
  0.01638677 -0.0711347  -0.02233321 -0.13792668  0.13720481 -0.0190333
  0.07492699  0.11952593 -0.03718707 -0.09745617  0.0118284  -0.08132664
 -0.03115921 -0.05673802  0.05955197  0.10505733  0.11087562 -0.06073288
  0.11179315 -0.18532328 -0.04400633 -0.08584488 -0.08164352  0.06556291
 -0.03176954  0.00544172 -0.07225472 -0.04039167  0.15589008 -0.10693979
 -0.00439061  0.01265442  0.21063574  0.10917063  0.01635351 -0.05196821
 -0.21178809  0.04556727  0.04120203 -0.07167455 -0.11883871  0.11778522
 -0.14867255  0.05937248 -0.06633771 -0.04943674 -0.05103191 -0.0551171
  0.15610586 -0.00049677  0.14594123 -0.0978343   0.06999839 -0.01741692
  0.06495398 -0.08941947 -0.07251603  0.04222538 -0.14329088 -0.03212183
  0.07245737 -0.11450756 -0.0526563  -0.05053602 -0.03070516 -0.04316856
 -0.06386606  0.12811702 -0.16160218  0.09532369]","[-0.03448066 -0.14800207 -0.26153752  0.01860353  0.03291209  0.09299336
  0.21855591  0.06188473 -0.0732351  -0.06656175 -0.05412377 -0.04942052
 -0.03035495  0.0804024  -0.08498437 -0.0202797   0.01305559  0.08039699
  0.08743906 -0.02085941  0.00387389  0.04203983  0.01802462  0.09953611
  0.21273911  0.14772174  0.02284225  0.11524689 -0.02219943  0.02153944
  0.06796216 -0.06937531 -0.06721529 -0.11362999  0.11698466 -0.00298368
  0.02319442  0.08784335 -0.05744766 -0.06246546 -0.01083424 -0.08002044
 -0.01642437  0.00855288  0.03213703  0.11672004  0.03887153 -0.01510844
  0.12558614 -0.15382355  0.00908638 -0.09248895 -0.03361282  0.123527
 -0.02250013 -0.05361122 -0.08870934 -0.02207963  0.15079229 -0.12053153
 -0.00388169 -0.01158211  0.23560339  0.11498204 -0.0041721  -0.06923901
 -0.16131113  0.03235906  0.0440696  -0.02854339 -0.08580997  0.08651803
 -0.13393743  0.07229796 -0.02247662 -0.02390396 -0.0316219  -0.07769834
  0.11652736 -0.0180934   0.13809282 -0.05395175  0.07918373 -0.01152649
  0.03642613 -0.07673904 -0.04851412  0.02588795 -0.10273923 -0.03565805
  0.07746129 -0.09363496 -0.08078434 -0.04323328 -0.04522039 -0.01802551
 -0.02205215  0.18893582 -0.14950466  0.063878  ]",0.3864743377880668,0
req,src,test_data/LibEST_semeru_format/requirements/RQ53-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,"requir inform refer idev ieee standard associ ieee secur devic identifi decemb http standard ieee org findstd standard html rfc howard approach use ldap network inform servic rfc march rfc rescorla http tls rfc may rfc nystrom kaliski pkcs https tool ietf org html rfc select object class attribut type version rfc novemb rfc schaad housley advanc encrypt standard key wrap algorithm rfc septemb rfc taylor mavrogiannopoulo perrin use secur remot password srp protocol tls authent rfc novemb rfc turner applic pkcs media type rfc august rfc zieglar turner peck suit profil certif manag cms rfc novemb shs nation institut standard technolog secur hash standard shs feder inform process standard public march http csrc nist gov public fip fips180 fip 180 pdf 800 part nation institut standard technolog recommend key manag part general revis )"", juli 2012 http :// csrc nist gov public nistpub 800 sp800 57_part1_rev3_gener pdf",libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.01319338 -0.11533403 -0.2819848   0.00990328  0.05376234  0.10185458
  0.23951474  0.08045531 -0.01853419 -0.1131255  -0.05485727 -0.04338977
 -0.0102566   0.1099622  -0.08808511  0.01196841 -0.01779054  0.1122872
  0.08624494  0.02919303 -0.00689821  0.07794971  0.0141936   0.10150144
  0.22071712  0.18736595  0.03268617  0.13126399 -0.05178919  0.04590297
  0.04534998 -0.07178124 -0.04453324 -0.17484565  0.16308282 -0.01045712
  0.03377596  0.09652384 -0.05052194 -0.11465301 -0.0268607  -0.10799024
 -0.04462377 -0.01027137  0.05799931  0.11823808  0.09819899 -0.05109863
  0.10031927 -0.18378118 -0.02648262 -0.09882805 -0.04807419  0.10333949
 -0.04671875 -0.02342246 -0.05312942 -0.03053781  0.1639278  -0.14686675
 -0.02447448 -0.01016775  0.22425641  0.14013483  0.02079331 -0.03472797
 -0.20735519  0.04474457  0.06065626 -0.0416242  -0.07342704  0.10396896
 -0.15080395  0.05912101 -0.04484918 -0.04730462 -0.04163873 -0.08358982
  0.13922104 -0.00726333  0.10584519 -0.08943589  0.06419261 -0.04038159
  0.07424197 -0.08175149 -0.07975222  0.03710765 -0.11566629 -0.01916005
  0.09576742 -0.12076638 -0.07158495 -0.02908102 -0.03369354 -0.05639433
 -0.03894927  0.12922879 -0.16803622  0.08045925]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.4478248733612722,0
req,src,test_data/LibEST_semeru_format/requirements/RQ22-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.h,requir tls client authent recommend method identifi est client http base client authent section may use est server authent est client defin cipher suit negoti follow text provid detail assum certif base cipher suit tls rfc mandatori cipher suit tls rsa des ede cbc sha est server must support certif base client authent general client use exist certif renew rekey oper certif renew rekey appropri negoti cipher suit client must use tls handshak otherwis client use altern certif suitabl cipher suit contain subject ident inform request enrol oper client may use client certif issu third parti authent certif valid must perform per rfc est client certif must conform rfc certif profil server valid tls client certif use est server explicit enabl implicit databas server must maintain distinct use explicit implicit databas authent order support proper author est server must perform author check specifi section client support tls client authent must support http base client authent section certif less tls authent section,tcw err tcw connect tcw sock sock tcw opt opt const char host unsign short int port sock type tcw err tcw close tcw sock sock,"[ 0.03560031 -0.11806617 -0.2603899   0.00890871  0.01585975  0.09348304
  0.25568795  0.04921199 -0.01364579 -0.10686032 -0.07941308 -0.03819065
 -0.01938197  0.08820964 -0.09256627  0.05965941  0.01600557  0.09088229
  0.09622283  0.0808967   0.04508314  0.05854633  0.00908588  0.0864503
  0.2236602   0.19485252  0.00715569  0.15756205 -0.04899316  0.05158281
  0.01079367 -0.0625224  -0.01461748 -0.13481785  0.13273986 -0.01295481
  0.0812565   0.12095381 -0.0355486  -0.09259038  0.02310962 -0.0739474
 -0.0297117  -0.06669921  0.06496706  0.0998617   0.11235155 -0.06724715
  0.11444343 -0.17833593 -0.04860706 -0.08750474 -0.09113016  0.0533275
 -0.02372546  0.01697083 -0.07483374 -0.04659152  0.15181443 -0.10130326
 -0.00198923  0.01856928  0.20130399  0.10058656  0.01863825 -0.05983925
 -0.21379791  0.04586987  0.03945242 -0.07876264 -0.13164812  0.12130848
 -0.15071353  0.06014076 -0.0712426  -0.05229118 -0.0510712  -0.04690067
  0.16448826  0.00441768  0.15744776 -0.09881057  0.06442253 -0.01466798
  0.06334844 -0.08961193 -0.07384117  0.03945244 -0.15014768 -0.03686342
  0.06381103 -0.11684715 -0.04838846 -0.05982045 -0.03039164 -0.04102702
 -0.06793607  0.12046503 -0.15554552  0.10614393]","[-0.02559054 -0.11442585 -0.285615    0.00588459  0.08140744  0.10919993
  0.2025552   0.09227076 -0.05288828 -0.10508315 -0.03450128 -0.05000919
 -0.01895749  0.09241728 -0.0825227  -0.04746013 -0.04190391  0.11057997
  0.07707261 -0.05081448 -0.04736394  0.07211433  0.00481617  0.10405831
  0.22073705  0.15570243  0.05207276  0.08818626 -0.03623734  0.03228203
  0.07584656 -0.08614524 -0.0680483  -0.15912452  0.15105945 -0.0176961
 -0.02634157  0.08282487 -0.06824675 -0.09650894 -0.08014593 -0.11928507
 -0.03722025  0.04271827  0.01640472  0.13784954  0.04986245 -0.00652583
  0.0891173  -0.17669564  0.00071935 -0.09104431  0.00715671  0.14993069
 -0.05865422 -0.07927951 -0.04344445  0.00132594  0.17408217 -0.16809788
 -0.02875789 -0.04706879  0.24801992  0.1723621   0.00407052 -0.02492814
 -0.17019147  0.04301095  0.04741421 -0.02034728 -0.03768035  0.06754561
 -0.13278511  0.06559402  0.01077702 -0.00851638 -0.03142531 -0.10705622
  0.08153803 -0.03021447  0.06499343 -0.06556234  0.08207458 -0.03263115
  0.05326113 -0.06163096 -0.07458441  0.02681185 -0.08756457 -0.01315804
  0.11402813 -0.10114845 -0.09870127 -0.01105796 -0.02375322 -0.03328297
 -0.013665    0.17352374 -0.17754659  0.02712149]",0.5327022985764046,0
req,src,test_data/LibEST_semeru_format/requirements/RQ18-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.c,requir http base client authent est server may request http base client authent request addit success tls client authent section est server polici requir addit authent exampl est server may requir est client know password addit exist client certif http base client authent est server polici specifi fallback situat est client success complet tls client authent might aris est client enrol first time certif avail est client cannot use tls client authent http basic digest authent must perform tls rfc later version null anon cipher suit must use provid confidenti support mutual certif base certif less authent respect specifi certif manag cms cmc transport protocol rfc server must assum client support type http authent cooki basic authent digest authent client support basic digest authent mechan server wish use basic digest authent reject http request use http defin www authent respons header rfc section client expect retri request includ appropri author request header rfc section client capabl use basic digest authent client capabl retri request capabl basic digest authent client must termin connect client may set usernam empti string present password associ usernam support http base client authent secur ramif discuss section client must respond server http authent request unless client author est server per section,"author routin int ossl verifi int store ctx ctx int cert error store ctx get error ctx current cert store ctx get current cert ctx est log info enter function cert error cert error current cert name print stdout _get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% serror depth lookup ctx crl path """", cert_error ctx cert_error )); switch cert_error case enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok warn applic est_log_warn crl load tls peer allow .""); break case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error break return return function use load x509_store use raw data buffer data expect pem encod return number cert store static int x509_store store unsign char raw int size stack_of x509_info null x509_info bio int cert_cnt bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return load file stack x509 crl pkey set null null null null est_log_err unabl read pem encod cert bio ""); bio_fre return bio_fre scan pull crl sk_x509_info_num sk_x509_info_shift x509 null est_log_info cert store )"", x509 name x509_store_add_cert store x509 cert_cnt ++; crl null est_log_info crl store ""); x509_store_add_crl store crl x509_info_fre null sk_x509_info_pop_fre x509_info_fre return cert_cnt function use popul x509_store structur use open ssl tls stack verifi tls peer x509_store alreadi alloc paramet store pointer x509_store structur hold cert raw1 char array contain pem encod cert put store size1 length raw1 char array est_error ossl_init_cert_stor x509_store store unsign char raw1 int size1 x509_store_set_flag store int cnt raw1 cnt store raw1 size1 cnt est_log_err cert count zero store ""); return return est_err_non function use output open ssl error buffer use open ssl api call fail like provid detail user regard caus failur void ossl_dump_ssl_error bio null buf_mem bptr null bio_new bio_s_mem ()); est_log_err bio_new fail ""); return err_print_error void bio_flush bio_get_mem_ptr bptr est_log_warn ossl error bptr data bio_free_al /*! brief convert base64 encod pkcs7 respons est server pem format param certs_p7 point buffer contain base64 encod pkcs7 data param certs_len indic size certs_p7 buffer param pem doubl pointer receiv pem encod data sever est messag return data contain base64 encod pkcs7 certif function use convert data pem format function alloc memori point pem argument caller respons releas memori return valu length pem buffer error return int int unsign char certs_p7 int certs_len unsign char pem x509 stack_of x509 cert null bio b64 unsign char cacerts_decod null int cacerts_decoded_len bio p7bio_in null pkcs7 null int nid unsign char pem_data int pem_len base64 decod incom cert buffer decod alway take origin buffer b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); return bio_new_mem_buf certs_p7 certs_len est_log_err bio_new fail ""); return bio_push b64 cacerts_decod malloc certs_len cacerts_decod est_log_err malloc fail ""); return cacerts_decoded_len bio_read cacerts_decod certs_len bio_free_al get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); free cacerts_decod return d2i_pkcs7_bio p7bio_in null est_log_err pem_read_bio_pkcs7 fail ""); ossl_dump_ssl_error (); free cacerts_decod return bio_free_al p7bio_in free cacerts_decod decod cert get refer stack cert nid obj_obj2nid type switch nid case nid_pkcs7_sign cert sign cert break case nid_pkcs7_sign envelop cert signed_and_envelop cert break default est_log_err invalid nid valu pkcs7 structur ""); pkcs7_free return break cert est_log_err fail attain x509 cert stack pkcs7 data ""); pkcs7_free return output cert new bio use pem format bio_new bio_s_mem ()); est_log_err bio_new fail ""); pkcs7_free return sk_x509_num cert ++) sk_x509_valu cert pem_write_bio_x509 bio_put ""); void bio_flush convert bio char pem_len int bio_get_mem_data char **)& pem_data pem_len est_log_err bio_get_mem_data fail ""); pkcs7_free return pem malloc pem_len (!* pem est_log_err malloc fail ""); pkcs7_free return memcpy_ pem pem_len pem_data pem_len pem pem_len make sure null termiant bio_free_al pkcs7_free return pem_len","[ 0.04189074 -0.11007163 -0.2551596   0.00233566  0.01805499  0.09077151
  0.2526413   0.04694885 -0.00965447 -0.10957289 -0.08033112 -0.03941373
 -0.01905064  0.07846716 -0.08960577  0.06454775  0.01125512  0.08553635
  0.09319705  0.08541369  0.04656414  0.05874637  0.00619338  0.08342006
  0.22200316  0.19327737  0.00473623  0.15701966 -0.05048641  0.05173333
  0.00067295 -0.06727549 -0.01061308 -0.12736303  0.12440599 -0.02148066
  0.08769705  0.12558518 -0.02957721 -0.09214164  0.02450513 -0.06753545
 -0.02729463 -0.07379659  0.06167115  0.09554931  0.11722283 -0.06803773
  0.11058782 -0.18054175 -0.05409104 -0.0814022  -0.09369682  0.04354779
 -0.02357797  0.01869402 -0.0721636  -0.04498529  0.15258352 -0.08962433
  0.00059402  0.02084271  0.19618756  0.09544743  0.01718518 -0.05539155
 -0.21096583  0.04690552  0.02912626 -0.08539301 -0.1341283   0.1212899
 -0.14525601  0.05668777 -0.07262701 -0.04757889 -0.05201679 -0.03899992
  0.16102032  0.00607918  0.15748025 -0.10362682  0.06856398 -0.0100242
  0.0654073  -0.09101052 -0.07439058  0.04132548 -0.15535975 -0.03468437
  0.05964667 -0.11453348 -0.0471596  -0.05888367 -0.02621881 -0.03874068
 -0.07306951  0.1179497  -0.15661545  0.10373951]","[-0.02280794 -0.13919947 -0.28047982  0.02055176  0.05719239  0.11580008
  0.21982583  0.08664732 -0.06486179 -0.10728963 -0.04538092 -0.0485174
 -0.02340238  0.0915816  -0.08403641 -0.03389406 -0.00680382  0.10322481
  0.08214781 -0.02023232 -0.01739727  0.05432794  0.02143495  0.10811873
  0.23230235  0.14707267  0.03343172  0.09869646 -0.02522595  0.01939251
  0.08936349 -0.079725   -0.07090753 -0.14112723  0.13800469 -0.0044158
 -0.00118626  0.09041351 -0.07368236 -0.0651512  -0.03746948 -0.0967169
 -0.03527454  0.01767246  0.02962421  0.1314824   0.04278544 -0.00958085
  0.1028138  -0.1680194   0.00360245 -0.09777321 -0.03135832  0.1338649
 -0.05140613 -0.07215084 -0.07555516 -0.02815823  0.17305858 -0.14494699
 -0.01413719 -0.01573827  0.24476083  0.14470093 -0.00722645 -0.05078406
 -0.16619018  0.04294062  0.03615962 -0.03229743 -0.07867274  0.08533599
 -0.1291659   0.07151608 -0.00589654 -0.00445574 -0.02803521 -0.09147019
  0.10225114 -0.02535055  0.10955609 -0.05982644  0.08245157 -0.01598702
  0.03577185 -0.06218307 -0.06432889  0.02448558 -0.102182   -0.02171448
  0.08405258 -0.11564184 -0.09899607 -0.02413773 -0.0364875  -0.01774029
 -0.01183339  0.17720269 -0.17135827  0.06180004]",0.4590752244511882,0
req,src,test_data/LibEST_semeru_format/requirements/RQ38-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,requir simpl enrol enrol respons enrol success server respons must contain http respons code content type applic pkcs mime success respons must cert cmc simpl pki respons defin rfc contain certif issu http content type applic pkcs mime smime type paramet cert use specifi rfc server must answer suitabl http rfc error code problem occur simpl pki respons http content type applic pkcs mime see section may includ respons data convey error respons content type set respons data must plaintext human readabl error messag contain explanatori inform describ request reject exampl indic csr attribut incomplet server respond http rfc indic request accept process respons yet avail server must includ retri header defin http respons server also may includ inform human readabl content client must wait least specifi retri time repeat request client repeat initi enrol request appropri retri interv expir client log inform end user event server respons maintain state necessari recogn handl retri oper client stateless regard simpli send request repeat receiv differ respons code return code handl specifi http rfc client close tls connect wait retri time expir client initi new tls connect perform applic secur check client alreadi generat csr includ link ident pop inform section csr need recreat incorpor tls uniqu new redirect session note key pair need regener process interfac burden client est server administr advis take consider est client may also make certif respons associ privat key avail end entiti softwar use end entiti certif,"function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 2.60162316e-02 -1.15243517e-01 -2.68985897e-01  3.89979943e-03
  3.22336070e-02  9.67861116e-02  2.52314925e-01  5.98994941e-02
 -1.68040451e-02 -1.09637395e-01 -7.19415918e-02 -3.99656780e-02
 -1.98316369e-02  9.33375955e-02 -8.85187462e-02  3.70184593e-02
  1.84732990e-03  9.37291011e-02  9.05560777e-02  5.54151013e-02
  2.42765937e-02  6.69588670e-02  7.24519091e-03  9.32773501e-02
  2.23536626e-01  1.92325026e-01  1.40737845e-02  1.49025112e-01
 -4.85690273e-02  5.07280491e-02  2.05508992e-02 -6.89596534e-02
 -2.92262845e-02 -1.43886313e-01  1.45852000e-01 -1.43732615e-02
  6.18595555e-02  1.11636691e-01 -4.15958799e-02 -1.02186508e-01
  2.72000069e-03 -8.32299739e-02 -3.40227261e-02 -4.85698283e-02
  6.06528558e-02  1.07573964e-01  1.02394573e-01 -5.57830594e-02
  1.08940788e-01 -1.83902442e-01 -4.03380878e-02 -9.12143365e-02
 -7.59458989e-02  7.15928003e-02 -3.06235738e-02 -5.81278982e-06
 -6.81577995e-02 -4.01532352e-02  1.57574117e-01 -1.14927195e-01
 -7.85856601e-03  4.68323845e-03  2.12032318e-01  1.15444124e-01
  1.92030594e-02 -5.10454141e-02 -2.09209427e-01  4.30526435e-02
  4.54858243e-02 -6.52366951e-02 -1.14444010e-01  1.12576976e-01
 -1.50505409e-01  5.87717518e-02 -6.06237501e-02 -4.90748845e-02
 -5.25093116e-02 -6.65929988e-02  1.56021312e-01 -1.47826748e-03
  1.36956453e-01 -9.33287665e-02  6.90785274e-02 -2.56693885e-02
  6.82770461e-02 -8.66072550e-02 -7.27254376e-02  4.00673710e-02
 -1.35501638e-01 -3.15742120e-02  7.41241649e-02 -1.16722263e-01
 -5.37960753e-02 -4.77882028e-02 -3.07618398e-02 -4.59676310e-02
 -6.08017705e-02  1.22683033e-01 -1.65270954e-01  9.61328670e-02]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.33263853577238883,1
req,src,test_data/LibEST_semeru_format/requirements/RQ41-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_http.c,requir full cmc respons enrol success server respons must includ http respons code content type applic pkcs mime specifi rfc respons data includ either simpl pki respons smime type paramet cert full pki respons smime type paramet cmc respons specifi section rfc bodi messag binari valu encod pki respons content transfer encod base rfc reject request server must specifi either http error http error cmc respons content type applic pkcs mime must includ respons data cmc error respons return code handl specifi section http rfc exampl client interpret http respons indic servic implement,"sign long sign int int curlx sltosi long slnum ifdef intel compil pragma warn push pragma warn disabl convers may lose signific bit endif assert slnum sizeof int curl sizeof long assert unsign long slnum unsign long curl mask sint endif return int slnum long curl mask sint ifdef intel compil pragma warn pop endif parsed return parsed fine convers parsed fail fail convert parsed later time overflow far end time parsed sooner time underflow low end time static int parsed const char date time output return day monday sunday static int checkday const char check size len int const char const int found len weekday els curl wkday est client curl raw equal check found break return found return day monday sunday static int checkmonth const char check int const char const int found curl month est client curl raw equal check found break return found return offset real offset return time zone offset gmt input one number second timezon found legal static int checktz const char check unsign int const struct tzinfo int found sizeof sizeof ]); ++) check name found break ++; return found offset return time zone offset gmt input one number second timezon found legal static void skip_over_whit const char date skip everyth letter digit (** date isalnum (** date date )++; struct time sinc epoch gmt time zone similar standard mktime function gmt suffer various bug portabl problem system implement static time_t my_timegm struct my_tm static const int month_days_cumul 120 151 181 212 243 273 304 334 int month year leap_day tm_year support year 1970 caus function return negat valu return year tm_year 1900 month tm_mon month year month month month els month year month month month leap_day year tm_mon leap_day leap_day leap_day 100 leap_day 400 1969 1969 100 1969 400 )); return (((( time_t year 1970 365 leap_day month_days_cumul month tm_mday tm_hour tm_min tm_sec parsed return parsedate_ok fine convers parsedate_fail fail convert parsedate_lat time overflow far end time_t parsedate_soon time underflow low end time_t static int parsed const char date time_t output time_t int wdaynum day week number mon sun int monnum month year number int mdaynum day month int hournum int minnum int secnum int yearnum int tzoff struct my_tm enum assum dignext date_mday const char indat date save origin pointer int part max part date part int found skip_over_whit date isalpha date name come char buf ]=""""; size_t len sscanf date ]"", buf len strnlen_ buf wdaynum wdaynum checkday buf len wdaynum found found monnum monnum checkmonth buf monnum found found tzoff must time zone string tzoff checktz buf tzoff found found return parsedate_fail bad string date len els isdigit date digit int val char end secnum sscanf date 02d 02d 02d hournum minnum secnum ))) time stamp date els secnum sscanf date 02d 02d hournum minnum ))) time stamp without second date secnum els long lval int error int old_errno old_errno errno set_errno lval strtol date end error errno error old_errno set_errno old_errno error return parsedate_fail lval long int_max lval long int_min return parsedate_fail val curlx_sltosi lval tzoff end date val 1400 indat date date date -'))) four digit valu less equal 1400 take account sort funni time zone diff preced plus minus time zone indic 1400 pick sinc 1300 frequent use 1400 mention edg number document iso 200x propos timezon function http :// david tribbl com text c0xtimezon html anyon authorit sourc exact maximum time zone offset pleas speak found tzoff val 100 val 100 prefix indic local time compar gmt need ther revers math get want tzoff date ]=='+'?- tzoff tzoff ((( end date yearnum monnum mdaynum digit year month day yet yyyymmdd found yearnum val 10000 monnum val 10000 100 month mdaynum val 100 found dignext date_mday mdaynum val val mdaynum val found dignext date_year found dignext date_year yearnum yearnum val found yearnum 1900 yearnum yearnum 1900 els yearnum 2000 mdaynum dignext date_mday found return parsedate_fail date end part ++; secnum secnum minnum hournum time make zero ((- mdaynum monnum yearnum lack vital info fail return parsedate_fail sizeof_time_t bit time_t hold date begin 2038 yearnum 2037 output 0x7fffffff return parsedate_lat endif yearnum 1970 output return parsedate_soon mdaynum monnum hournum minnum secnum return parsedate_fail clear illeg date tm_sec secnum tm_min minnum tm_hour hournum tm_mday mdaynum tm_mon monnum tm_year yearnum 1900 my_timegm return time_t time_t often bit even mani architectur featur bit long system bit time_t deal year beyond 2038 howev even system bit time_t mktime return date beyond utc januari 2038 aix 5100 my_timegm time zone adjust cast int compar negat one int add time zone diff local time zone gmt long delta long tzoff !=- tzoff delta delta return time_t overflow delta output return parsedate_ok find next field --------------- find next rfc822 token string entri pstr point string contain word separ white white space "","" "";"" ""="". word option quot use <""> ""<"" "">"" comment surrround filter exit pstr move first delimit past field string mutil termin return pointer first word null error static char htnext field char pstr char char start null pstr pstr return null pstr strip white space delimit isspac int =')) ++; (!* pstr return null field ""') quot field start ""'; ++) ++; skip escap char break kr95 need stop els <') quot field start >'; ++) ++; skip escap char break kr95 need stop els (') comment )'; ++) ++; skip escap char ++; els spool field start isspac int =') ++; break got pstr return start function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static est_error est_ctx ctx char hdr int est_err_non char hdr char token null char valu null int diff errno_t safec_rc header come basic digest field still front skip token htnext field token htnext field ))) est_strcasecmp_ token realm "")) valu htnext field ))) eok strncpy_ ctx realm max_realm valu max_realm els els est_strcasecmp_ token nonc "")) valu htnext field ))) eok strncpy_ ctx s_nonc max_nonc valu max_nonc els els est_strcasecmp_ token qop "")) valu htnext field ))) valu est_log_warn unsupport qop valu valu els safec_rc memcmp_ valu sizeof auth ""), auth sizeof auth ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff safec_rc eok est_log_warn unsupport qop valu valu els els est_strcasecmp_ token algorithm "")) valu htnext field est_strcasecmp_ valu md5 "")) est_log_err unsupport digest algorithm valu support md5 moment els est_strcasecmp_ token error "")) valu htnext field ))) eok strncpy_ ctx token_error max_token_error valu max_token_error els els est_strcasecmp_ token error_descript "")) valu htnext field ))) eok strncpy_ ctx token_error_desc max_token_error_desc valu max_token_error_desc els els est_log_warn unsupport auth token ignor token memzero_ ctx s_nonc max_nonc break return function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static http_header parse_http_head unsign char buf int num_head int http_header hdrs char hdr_end errno_t safec_rc num_head hdrs malloc sizeof http_header max_head hdrs est_log_err malloc failur ""); return null find offset header delimint safec_rc strstr_s char buf strnlen_ char buf rsize_max_str hdr_end safec_rc eok est_log_info strstr_s error safec_rc skip first line skip char **) buf ""); max_head ++) hdrs name skip_quot char **) buf "":"", hdrs valu skip char **) buf ""); fflush stdout est_log_info found http header hdrs name hdrs valu fflush stdout hdrs name break num_head ((* buf unsign char hdr_end break est_log_info found http header num_head return hdrs function pars http status code first header hand code handl est full http stack unrecogn code result error note http expect static int unsign char buf strncmp const char buf est_http_hdr_200 strnlen_ est_http_hdr_200 est_http_hdr_max ))) return 200 els strncmp const char buf est_http_hdr_202 strnlen_ est_http_hdr_202 est_http_hdr_max ))) return 202 els strncmp const char buf est_http_hdr_204 strnlen_ est_http_hdr_204 est_http_hdr_max ))) return 204 els strncmp const char buf est_http_hdr_400 strnlen_ est_http_hdr_400 est_http_hdr_max ))) return 400 els strncmp const char buf est_http_hdr_401 strnlen_ est_http_hdr_401 est_http_hdr_max ))) return 401 els strncmp const char buf est_http_hdr_404 strnlen_ est_http_hdr_404 est_http_hdr_max ))) return 404 els strncmp const char buf est_http_hdr_423 strnlen_ est_http_hdr_423 est_http_hdr_max ))) return 423 els est_log_err unhandl http respons buf return function search process www authent header server result set auth_mod valu context www authent header valu header invalid set auth_mod failur set multipl authent header first one process static void est_ctx ctx http_header hdrs int hdr_cnt int est_error int auth_found walk header look www authent process first one erron second one includ ignor hdr_cnt ++) strncmp hdrs name est_http_hdr_auth auth_found strncmp hdrs valu basic ctx auth_mod auth_bas pars realm ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu digest ctx auth_mod auth_digest pars realm nonc ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu bearer ctx auth_mod auth_token pars realm possibl token error field ctx hdrs valu est_err_non ctx auth_mod auth_fail els est_log_err unsupport www authent method ""); ctx auth_mod auth_fail break auth_found est_log_err www authent header found ""); ctx auth_mod auth_fail return function take list header server respons walk header look retri respons header one found valu pars save away est context valu one two format repres ascii string first format count number second client wait retri request second format time date stamp point time client retri request result function set retry_aft valu context retri header receiv receiv could pars valu zero otherwis set valu receiv note est client current support time date format respons process respons format static est_error est_ctx ctx http_header hdrs int hdr_cnt est_error int int cmp_result diff int long long int temp_ll int found initi assum retri header ctx retry_after_delay ctx retry_after_d hdr_cnt ++) cmp_result strcasecmp_ hdrs name sizeof diff cmp_result eok diff est_log_info retri valu hdrs valu found determin whether valu date time string integ repres number second client must wait isalpha (*( char hdrs valu ifdef int convert date time string time_t parsed hdrs valu ctx retry_after_d parsedate_ok est_log_err retri valu could pars ""); els format current support est_log_err retri valu correct format ""); endif els make sure digit make sure larger four byte integ cach away valu return retri delay strisdigit_ hdrs valu max decim place temp_ll atol hdrs valu temp_ll int_max ctx retry_after_delay int temp_ll els est_log_err retri valu larg ""); els est_log_err retri valu could pars ""); found est_log_err retri header miss ""); return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int http_header hdrs int hdr_cnt est_oper int int int content_type_pres content_length_pres int cmp_result travers http header process one need check hdr_cnt ++) content type memcmp_ hdrs name sizeof est_http_hdr_ct est_http_hdr_ct sizeof est_http_hdr_ct cmp_result cmp_result content_type_pres verifi content pkcs7 data memcmp_ hdrs valu strnlen_ est_op_map content_typ est_op_map length est_op_map content_typ strnlen_ est_op_map content_typ est_op_map length cmp_result cmp_result est_log_err http content type hdrs valu return els content length memcmp_ hdrs name sizeof est_http_hdr_cl est_http_hdr_cl sizeof est_http_hdr_cl cmp_result cmp_result content_length_pres atoi hdrs valu make sure necessari header present content_type_pres est_log_err miss http content type header ""); return els content_length_pres est_log_err miss http content length header ""); return return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int est_ssl_read ssl ssl unsign char buf int buf_max int sock_read_timeout int timeout int read_fd int struct pollfd pfd load timev struct pass select timeout sock_read_timeout 1000 read_fd ssl_get_fd ssl pfd read_fd pfd event pollin pfd revent errno poll pfd timeout est_log_err socket poll timeout data receiv server .""); return els est_log_err socket read failur errno errno return els return ssl_read ssl buf buf_max )); function extract data ssl context put buffer static int est_io_read_raw ssl ssl unsign char buf int buf_max int read_cnt int sock_read_timeout int cur_cnt char peek_read_buf read_cnt cur_cnt est_ssl_read ssl buf buf_max sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt multipl call ssl_read may requir get full http payload cur_cnt read_cnt buf_max cur_cnt est_ssl_read ssl buf read_cnt buf_max read_cnt sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt ((* read_cnt buf_max ssl_peek ssl peek_read_buf est_log_err buffer small receiv messag ""); return return est_err_non function provid primari entri point modul use est client read http respons server data read ssl context http pars invok est_err_non return raw_buf buffer must freed caller otherwis freed est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len int est_err_non http_header hdrs int hdr_cnt int http_status unsign char raw_buf payload_buf payload int raw_len raw_buf malloc est_ca_max raw_buf null est_log_err unabl alloc memori ""); return est_err_malloc memzero_ raw_buf est_ca_max payload raw_buf read raw data ssl connect est_io_read_raw ssl raw_buf est_ca_max raw_len ctx read_timeout est_err_non est_log_info valid respons process ""); free raw_buf return raw_len est_log_warn receiv empti http respons server ""); free raw_buf return est_log_info read byte http data raw_len pars http header get status look status 200 success http_status raw_buf ctx last_http_status http_status hdrs parse_http_head payload hdr_cnt est_log_info http status receiv http_status check status header first see server accept request switch http_status case 200 server report noth break case 204 case 404 est_log_err server respond 204 404 content found ""); est_op_csrattr est_err_non els http_status 404 els est_err_unknown break case 202 server ask retri est_log_info est server respond retri ""); ctx hdrs hdr_cnt break case 400 est_log_err http respons est server bad request ""); est_err_http_bad_req break case 401 server request user auth credenti est_log_info est server request user authent ""); check alreadi tri authent bail first time auth_mod set none ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token ctx auth_mod auth_fail est_err_auth_fail break ctx hdrs hdr_cnt est_err_auth_fail break case 423 est_log_err server respond 423 content attempt access lock ""); est_err_http_lock break case unsupport http respons est_log_err unsupport http respons est server )"", http_status est_err_unknown break default http respons given want handl est_log_err http respons est server http_status break est_err_non get content type content length header verifi http respons contain correct amount data payload_len hdrs hdr_cnt est_log_info http content len payload_len payload_len est_ca_max est_log_err content length larger maximum valu ."", est_ca_max est_err_unknown payload_len buf null els payload_len payload_len buf null els alloc buffer hold payload pass back payload_buf malloc payload_len payload_buf est_log_err unabl alloc memori ""); free raw_buf free hdrs return est_err_malloc memcpy_ payload_buf payload_len payload payload_len buf payload_buf raw_buf free raw_buf hdrs free hdrs return","[ 3.22326161e-02 -1.07418135e-01 -2.68378079e-01 -2.78047519e-03
  3.42566222e-02  9.50381383e-02  2.55895317e-01  5.64534776e-02
 -9.27327946e-03 -1.11403719e-01 -7.36649185e-02 -3.72895487e-02
 -2.00108718e-02  9.38957557e-02 -8.75744671e-02  4.17879038e-02
 -2.89642648e-03  9.19778273e-02  8.79974887e-02  5.81862889e-02
  2.21769735e-02  7.19664395e-02  2.26459559e-03  9.12343115e-02
  2.20090315e-01  1.99602902e-01  1.25402017e-02  1.54298022e-01
 -5.11223562e-02  5.78688495e-02  8.85357801e-03 -6.86337277e-02
 -2.66008377e-02 -1.45404682e-01  1.52274385e-01 -1.89533960e-02
  6.35008216e-02  1.11913659e-01 -3.94432433e-02 -1.13041580e-01
  3.49703885e-04 -8.49999711e-02 -3.41602154e-02 -5.47106713e-02
  6.25731423e-02  1.06606148e-01  1.08671919e-01 -5.81571981e-02
  1.04077227e-01 -1.90032750e-01 -4.62804884e-02 -8.96977559e-02
 -7.66747445e-02  6.48309588e-02 -2.93397382e-02  6.99354429e-03
 -6.26527965e-02 -3.92620116e-02  1.56357676e-01 -1.16065130e-01
 -1.07844276e-02  9.53493727e-05  2.06967309e-01  1.16805032e-01
  2.49400120e-02 -4.69159149e-02 -2.14690417e-01  4.21875045e-02
  4.75085005e-02 -6.77766576e-02 -1.14748895e-01  1.12069711e-01
 -1.53008208e-01  5.47390394e-02 -6.54924065e-02 -5.42785265e-02
 -5.91479614e-02 -7.13804439e-02  1.61059350e-01  1.05338031e-03
  1.30917341e-01 -9.67867672e-02  6.98040649e-02 -3.12194899e-02
  7.45418593e-02 -8.86537284e-02 -7.42369443e-02  4.09330986e-02
 -1.34628117e-01 -3.14696133e-02  7.62645528e-02 -1.16451919e-01
 -4.73038517e-02 -4.78338078e-02 -2.65845899e-02 -5.38013577e-02
 -6.85766190e-02  1.12107038e-01 -1.68441623e-01  9.50502604e-02]","[-0.00987736 -0.11911407 -0.2841379   0.00779026  0.07010551  0.11020532
  0.21956828  0.08649327 -0.0472606  -0.11266565 -0.04507514 -0.04941731
 -0.02074194  0.09147213 -0.08542818 -0.0242101  -0.0258745   0.10481261
  0.08187146 -0.02030602 -0.02759121  0.06745998  0.00749176  0.10427962
  0.227792    0.1629232   0.03945069  0.10436959 -0.03800827  0.03180632
  0.06665646 -0.08501376 -0.06131442 -0.15126903  0.14578922 -0.01711159
 -0.00118449  0.09328528 -0.06543815 -0.09235742 -0.05367571 -0.10725161
 -0.03737934  0.01557842  0.02767696  0.12949339  0.06183678 -0.01494845
  0.09363889 -0.18110369 -0.0098926  -0.09057959 -0.01962026  0.13053118
 -0.05518321 -0.06301711 -0.05672394 -0.01362461  0.17390853 -0.15026285
 -0.02201219 -0.02932046  0.242307    0.15510128  0.00329678 -0.03584385
 -0.17889638  0.04433239  0.03926572 -0.03635661 -0.06652797  0.08144163
 -0.1339039   0.06515578 -0.00812013 -0.01195321 -0.03717465 -0.09508131
  0.10198383 -0.02140859  0.09113996 -0.07103333  0.08522316 -0.02457515
  0.05434166 -0.06651933 -0.07538471  0.02887119 -0.10447777 -0.01726953
  0.09799939 -0.1103819  -0.09234454 -0.01928411 -0.02889781 -0.03046735
 -0.02491977  0.16676706 -0.17673336  0.04843231]",0.3541091821678013,0
req,src,test_data/LibEST_semeru_format/requirements/RQ17-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,"requir http uri control est server must support use path prefix well known defin rfc regist name est thus valid est server uri path begin https www exampl com well known est est oper indic path suffix indic intend oper oper correspond uri oper oper path detail distribut cacert section certif must enrol simpleenrol section client must enrol simplereenrol section client must full cmc option fullcmc section server side key serverkeygen section generat option csr attribut csrattr section option figur oper path figur append path prefix form uri use http get post perform desir est oper exampl valid uri absolut path cacert oper ""/. well known est cacert retriev certif est client would use follow http request line get well known est cacert http likewis request new certif exampl scheme est client would use follow request line post well known est simpleenrol http use distinct oper path simplifi implement server perform client authent distribut cacert respons est server may provid servic multipl cas indic option addit path segment regist applic name oper path avoid conflict label must defin oper path segment est server must provid servic regardless whether addit path segment present follow three exampl valid uri https :// www exampl com well known est cacert https :// www exampl com well known est arbitrari label1 cacert https :// www exampl com well known est arbitrari label2 cacert specif distinct enrol renew rekey explicit indic http uri request fullcmc oper cmc rfc5272 use messag certif renew certif rekey est server provid addit servic use uri",libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 1.86196789e-02 -1.24857284e-01 -2.64275014e-01  8.35250504e-03
  2.66686734e-02  9.35130417e-02  2.42074326e-01  6.10826015e-02
 -1.69051420e-02 -9.58576873e-02 -6.66908398e-02 -5.03677391e-02
 -2.00835839e-02  9.06506553e-02 -9.25894529e-02  3.41986381e-02
  1.68929866e-03  9.10096094e-02  9.32955816e-02  5.04310317e-02
  2.17250567e-02  6.35238662e-02  1.51754906e-02  9.89726186e-02
  2.18594670e-01  1.94706678e-01  1.76267624e-02  1.49484754e-01
 -5.59953004e-02  5.02746515e-02  2.66609304e-02 -7.15241730e-02
 -3.33502702e-02 -1.45633712e-01  1.46077245e-01 -1.29161738e-02
  6.75031319e-02  1.07915521e-01 -4.11471240e-02 -1.01819277e-01
  6.93986705e-03 -9.15415883e-02 -3.23025398e-02 -4.05126475e-02
  6.24578558e-02  1.07125141e-01  1.09051466e-01 -5.59210554e-02
  1.14022613e-01 -1.80809051e-01 -3.29981782e-02 -8.85155797e-02
 -7.19424561e-02  8.13955218e-02 -3.10376380e-02 -1.04272272e-03
 -6.93534389e-02 -3.43988948e-02  1.48990050e-01 -1.16745457e-01
 -9.69202537e-03  7.67837651e-03  2.14941099e-01  1.12903304e-01
  1.61166918e-02 -4.85072657e-02 -2.09255278e-01  3.90478484e-02
  5.90822846e-02 -5.46365082e-02 -9.87736732e-02  1.16406143e-01
 -1.53552845e-01  6.26934245e-02 -6.77136034e-02 -5.77978566e-02
 -5.20138852e-02 -6.62231445e-02  1.54454485e-01 -2.47549993e-04
  1.38816640e-01 -9.06147957e-02  6.62683547e-02 -2.98339091e-02
  6.61024079e-02 -9.07531083e-02 -6.77078664e-02  4.45726924e-02
 -1.27601668e-01 -2.78461166e-02  8.55551362e-02 -1.06707975e-01
 -5.00254147e-02 -4.53098528e-02 -3.65046337e-02 -4.86153662e-02
 -5.59542626e-02  1.30094498e-01 -1.57456264e-01  8.93125460e-02]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.4844593223621954,1
req,src,test_data/LibEST_semeru_format/requirements/RQ47-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir csr attribut polici may allow inclus client provid attribut certif issu attribut may describ inform avail addit may desir certifi certain type public key client may priori knowledg fact therefor client request list expect attribut requir desir enrol request dictat local polici est server requir client authent author repli request request csr attribut option client advis cas may refus enrol request encod accord polici,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.02968495 -0.11686271 -0.26801148  0.00648029  0.02743722  0.0982394
  0.25165728  0.06099455 -0.01752626 -0.11176015 -0.07479029 -0.04174654
 -0.01900009  0.09264915 -0.08656131  0.04428189  0.00860714  0.09498083
  0.0952007   0.06545497  0.03520403  0.06391271  0.00868269  0.0895658
  0.229696    0.18960164  0.00889066  0.15320076 -0.04508354  0.04933071
  0.02189539 -0.07081915 -0.02339262 -0.13762787  0.13588993 -0.01334114
  0.07111301  0.11712073 -0.03847378 -0.093399    0.0120195  -0.0761246
 -0.03448614 -0.05609136  0.06173384  0.10461187  0.10166198 -0.06190827
  0.11348398 -0.18067628 -0.04561681 -0.09214036 -0.08559503  0.06429204
 -0.03057571  0.00690791 -0.07501655 -0.04512166  0.15843633 -0.10455704
 -0.00316266  0.01334982  0.20895116  0.10836024  0.01763768 -0.05398571
 -0.20807934  0.04576829  0.0401619  -0.07334372 -0.12487318  0.11886045
 -0.15014641  0.06088474 -0.06329509 -0.04437476 -0.04713166 -0.05333354
  0.15815681 -0.00291103  0.14977062 -0.09722616  0.06951457 -0.01731742
  0.06697317 -0.08572287 -0.07534491  0.04094745 -0.14867555 -0.03632024
  0.06548738 -0.12147866 -0.05734386 -0.05454785 -0.03282148 -0.04182305
 -0.06138714  0.1250627  -0.16268058  0.1031433 ]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.38554294144939055,0
req,src,test_data/LibEST_semeru_format/requirements/RQ20-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir tls layer tls provid authent turn enabl author decis est server est client respons ensur accept cipher suit negoti mutual authent perform tls authent common enabl use certif rfc altern certif less tls authent neither client server present certif also accept method est mutual authent section est server must authent tls handshak unless client request bootstrap distribut certif section full cmc section https rfc specifi http messag carri tls https must use tls rfc later version must use est communic tls session resumpt rfc support tls channel bind inform insert certif request detail section order provid est server assur authent tls client access privat key certif request est server must implement section,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.03482639 -0.11925778 -0.25635707  0.0111942   0.01414369  0.08873643
  0.2550324   0.04964635 -0.01268515 -0.10304733 -0.07734098 -0.03949381
 -0.01693056  0.08865518 -0.09255532  0.05978993  0.01403247  0.08971747
  0.09296537  0.08232176  0.04417895  0.05891657  0.01247207  0.08897305
  0.21980876  0.19530067  0.00794393  0.15971716 -0.05120674  0.04950899
  0.01265263 -0.06230217 -0.01522912 -0.13589047  0.13435009 -0.0132315
  0.08398876  0.11862933 -0.03378624 -0.09663118  0.02429209 -0.07320178
 -0.02996203 -0.06506277  0.06840348  0.09751589  0.11570702 -0.07151135
  0.11688837 -0.17680904 -0.04574629 -0.0887308  -0.09153944  0.05306793
 -0.02220988  0.01916755 -0.07492248 -0.04804814  0.14921829 -0.09964811
 -0.00248276  0.02058486  0.19894394  0.09718128  0.01878156 -0.05866859
 -0.21306668  0.04317862  0.04427366 -0.07384538 -0.12713926  0.1233433
 -0.15150796  0.05794078 -0.0755888  -0.05729189 -0.0494408  -0.04529589
  0.16541442  0.00586877  0.15767181 -0.09917754  0.06258083 -0.0186538
  0.06708566 -0.09314861 -0.07109559  0.04163617 -0.14940296 -0.03420719
  0.06362146 -0.11670938 -0.04636439 -0.05926928 -0.0327175  -0.04474873
 -0.06690624  0.11809783 -0.15319306  0.10820848]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.4603059486085477,0
req,src,test_data/LibEST_semeru_format/requirements/RQ37-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.h,requir simpl enrol client est client renew rekey certif https post use oper path valu simplereenrol certif request employ format simpleenrol request use http content type request subject field subject alt name extens must ident correspond field certif renew rekey chang subject name attribut defin rfc may includ csr request field chang new certif subject public key info certif request current client certif est server renew client certif public key inform certif request differ current client certif est server rekey client certif,mingw typedef pid int use defin static int pthread mutex lock pthread mutex mingw typedef pid int use defin static int pthread mutex unlock pthread mutex mingw typedef pid int use defin static void unicod const char path wchar wbuf size wbuf len,"[ 0.02295932 -0.12865157 -0.2625398   0.01363922  0.01829726  0.09003629
  0.25150552  0.05542459 -0.01990543 -0.09313633 -0.07183094 -0.0412991
 -0.01735939  0.09687065 -0.0909993   0.04445602  0.01407989  0.09161455
  0.09333055  0.06359763  0.03318593  0.06020574  0.0169421   0.09363894
  0.21687745  0.19183625  0.00954306  0.15490624 -0.04763202  0.04855616
  0.02515566 -0.06079069 -0.02876247 -0.14382209  0.1408722  -0.00644099
  0.07494213  0.10709721 -0.03881552 -0.09667473  0.01849294 -0.0799085
 -0.03088927 -0.05000524  0.06838377  0.10262059  0.10563357 -0.06634908
  0.1211201  -0.17385156 -0.03273186 -0.09386048 -0.08346482  0.07101897
 -0.02114828  0.00621938 -0.07780352 -0.04723461  0.14949845 -0.11155997
 -0.00720455  0.01730639  0.20717327  0.10144386  0.01950153 -0.0586481
 -0.2100551   0.04180185  0.05469429 -0.05930049 -0.11200804  0.11920834
 -0.15185603  0.06116544 -0.07240494 -0.06149346 -0.04770958 -0.05611951
  0.16585332  0.00490728  0.15383731 -0.09296948  0.06011818 -0.02691165
  0.06591925 -0.09343504 -0.06941733  0.03889604 -0.13679385 -0.03456806
  0.0714708  -0.11622873 -0.04947356 -0.0547639  -0.04174098 -0.0487047
 -0.05604007  0.12654388 -0.15204012  0.10639653]","[-0.03037988 -0.11331    -0.27465558 -0.00203319  0.07519955  0.09355958
  0.19650115  0.06960465 -0.06197666 -0.07534166 -0.03835084 -0.04944178
 -0.02543062  0.08664084 -0.08646585 -0.04048822 -0.0412206   0.09362981
  0.08307725 -0.07858405 -0.05480267  0.06726368 -0.00325975  0.09827047
  0.20161283  0.16126537  0.04237292  0.09172165 -0.03171454  0.0403454
  0.0507689  -0.08224706 -0.06746737 -0.13799907  0.14117962 -0.02948107
 -0.02898829  0.06969103 -0.06291301 -0.10410526 -0.07580978 -0.11767408
 -0.01902835  0.04528895  0.00822657  0.1325896   0.04069861  0.00389869
  0.09279744 -0.18381928  0.00359802 -0.08284968  0.02725833  0.15617426
 -0.03961406 -0.0730326  -0.04251455  0.01983031  0.1554352  -0.16565521
 -0.02604633 -0.06621581  0.23679247  0.16015719  0.00463419 -0.03216541
 -0.16877046  0.03641336  0.05460791 -0.01445771 -0.0313769   0.0533159
 -0.13452259  0.0657654   0.01098714 -0.00750631 -0.04080506 -0.11322837
  0.08275991 -0.02547094  0.06750318 -0.05717668  0.08456459 -0.02704674
  0.05315566 -0.06293311 -0.06729733  0.02463711 -0.07433925 -0.01553668
  0.12031873 -0.07553184 -0.08833927 -0.01761947 -0.01969375 -0.0383084
 -0.02034266  0.18647684 -0.16771911  0.00373917]",0.5242322487193827,0
req,src,test_data/LibEST_semeru_format/requirements/RQ57-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir enrol enrol follow exampl valid simpleenrol exchang data messag simplereenrol similar exchang est client use band distribut usernam password authent est server normal http www authent behavior includ inform purpos exist tls client certif use server might skip request http www authent header simplereenrol oper initi tls handshak client ignor option server generat certif request instead proceed http post request respons initi http post attempt server request www authent client might occur even client use client certif detail normat text http unauthor content length www authent digest qop auth realm estrealm nonc subsequ http post usernam password includ along complet applic pkcs content post well known est simpleenrol http author digest usernam estus realm estrealm nonc uri well known est simpleenrol cnonc tyw mzg qop auth respons host accept content type applic pkcs content transfer encod base content length miich tccaw caqaw mbs ueax muzgvtb zxa idez njgx ndez ntiwgg gcsq gsib dqebaquaa ibdw awgg ekao ibaqcl kdz kaum fyjp qkz zixqixc mcatn zrcax gjwbqo xsqff odbyw wdk qoibnt cqri ydc krmjmo slm nkf mlr krmah ycsvw tnv javh teiit ayq ryhk cxo dan skf tyci vxfx wwi skeprel devag bieym rxtlujirwnq srj oquzk d31be961kzcx ygrhxa r4pag aagg itaf bgkqhki g9w0bcqcx mqk3ji q2li lzcr rvl1ntbundanbgkqhki g9w0b aqufaaocaqearbv0aj hpl1mfidz wqoi1d ocf6u ywc bzp ladv pk1qx5pq xm830a1o 7rvr nyd6vf2rl a9lywibj lxo bo8d kxr yl16c vus yydi1m daft ysrgol mlt weiqbc2sdbr2k hxw1tr130h icpwmr29k c2kzur 5thsuj276fgl1v pu0d gqfx4wwa9u ahbgz6t w37cep zsr uke 0pf vhr2o hgbqdqhvtfvj hccd axicrtb u5o1l pv7f4l eapv3sbqm jcaq5o832bz hw7n mfc m15e9gt uvee5c62b vwuk tbn gsbw est server use usernam password perform authent author respond issu certif http 200 status 200 content type applic pkcs7 mime smime type cert content transfer encod base64 content length 1122 miidoayjko zihvc naqc iidktccay ucaqex adalbgkqhki g9w0bbw gggg mlmiid ccae ibag ibftanbgkqhki g9w0baqufadab mrkw ydvqqdex blc3rfe gft gxl q0eg tnd omb4xdtez mduw otiz mtu1m1o xdte0mduw otiz mtu1m1ow mbs a1ueax muzgvtb3n0zxa0idez njgx ndez ntiwgg ma0gcsq gsib3dqebaquaa4ib awgg ekao ibaqcl kdz nj8xp ep9kaum dz3e fyjp qkz9dd d5e5oz cm103 zixqixc0 mcatn rr3dn zrcax gjwbqo b3e kt29 xsqff odbyw0wdk qoibnt qry8ydc 8lj n7m2krmjmo slm u2v4a ycsvw tnv 6mx6pr2p tj82javh teiit ayq1ryhk m1cxo dan n7tz c94skf s3vv f53 j9sk tycy1rw0k3vxfx wwi skeprel7i6k0y devag bieym l1s69rxtluji rwnq srj oquzk d31be961kzcx ygrhxa r4pag mbaagj bqma4ga1ud dad nvhq4efg b6ii6ic q8w gmxvy1jf e4xt ydvr0j bbgw rp5luj bkf yl6olo7 5ar qjww dqyjko zihvc naqefbqadgg ebacmxg1hv ftaroxain bx5gxd z9om sb0l 4pdvg khz mcrc u6m4yp5n0edkm ga6 y8fb et4tt7ju jg6ixb95 760th0vuctwk gr6 d6ettfqi hnrbh x3l ahn 0ja7 o1gv4cwxh1i8a txdp ohorv n0smxdcrl cys2vrt r2a3kaj jo6e q5le odz opha lwen0e2blnji0v c2fa 2lmcnf c38xf gala5a8e7f nhxwzbj xzlbcza3 es9mlh2cj wxm mvd eqnt fpgg f8izsrv ruct ge1lg dmu6afuxc r4por t2xz8ch adea,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[ 0.01086677 -0.11569759 -0.28234908  0.00865691  0.05637074  0.10462321
  0.23565991  0.08105508 -0.02279514 -0.11592611 -0.05374048 -0.04687865
 -0.01230416  0.10313725 -0.08892097  0.00668846 -0.02123964  0.10955703
  0.08608304  0.0214883  -0.01048485  0.0763002   0.01242931  0.10334464
  0.224149    0.18546924  0.03474633  0.12835288 -0.05218068  0.04371798
  0.04764066 -0.07795496 -0.04618291 -0.16880637  0.16087836 -0.01423203
  0.0291514   0.09832232 -0.05347303 -0.11215606 -0.0329565  -0.10921572
 -0.04392487 -0.0091577   0.05223354  0.1207661   0.09599475 -0.04334331
  0.09906842 -0.18660526 -0.02528658 -0.09504613 -0.04417253  0.10603093
 -0.05040376 -0.03031288 -0.05405537 -0.02554804  0.16556297 -0.14586699
 -0.02407699 -0.01302934  0.2279794   0.14382462  0.01681753 -0.03241924
 -0.20396417  0.04428796  0.05654696 -0.04329154 -0.07235874  0.10083704
 -0.14799389  0.06084191 -0.04004302 -0.04092317 -0.04353067 -0.08508565
  0.13239193 -0.00888586  0.10366532 -0.08903971  0.07002182 -0.03829064
  0.07049979 -0.07948064 -0.07984372  0.03788071 -0.11605795 -0.01662358
  0.09837063 -0.11859854 -0.07322418 -0.02647374 -0.03121147 -0.05059266
 -0.03966936  0.13683142 -0.17230171  0.07387189]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.250319518293876,1
req,src,test_data/LibEST_semeru_format/requirements/RQ8-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir http base client authent est server option also request est client submit usernam password use http basic digest authent method see section approach desir est client cannot authent tls handshak see section est server polici requir addit authent inform see section case http base client authent perform tls protect transport see section,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.04073122 -0.11057831 -0.25867715  0.00132969  0.01963301  0.09092411
  0.25570658  0.04843107 -0.00864701 -0.10946109 -0.08062533 -0.04209853
 -0.01921765  0.07926715 -0.09153752  0.06422409  0.00931789  0.08597188
  0.09449763  0.08238224  0.04446275  0.06182453  0.0050822   0.08603556
  0.22466804  0.19702348  0.00657615  0.15999095 -0.05308691  0.05363298
  0.00033013 -0.06947731 -0.01174541 -0.13090938  0.12837368 -0.02287499
  0.08704711  0.12518665 -0.02972106 -0.09752803  0.02159065 -0.07048316
 -0.02797127 -0.07349256  0.06173792  0.09716657  0.11870602 -0.06905124
  0.1119071  -0.18414555 -0.05392797 -0.08264277 -0.09247757  0.04655313
 -0.02552156  0.02035353 -0.07242908 -0.04278795  0.15376344 -0.09289143
  0.00070907  0.01716973  0.19952004  0.09928911  0.01721343 -0.05408397
 -0.21397494  0.04570426  0.03118306 -0.08397996 -0.13190693  0.1214769
 -0.1487791   0.05607114 -0.07355038 -0.05051561 -0.05382313 -0.0439024
  0.162738    0.00538056  0.15501736 -0.10483827  0.07030971 -0.01289234
  0.0687592  -0.09186444 -0.07367888  0.04390734 -0.15494418 -0.03476493
  0.06310401 -0.11503609 -0.04765176 -0.05639751 -0.02592279 -0.04193593
 -0.0740469   0.11996827 -0.15983832  0.1021015 ]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.5691282646902502,1
req,src,test_data/LibEST_semeru_format/requirements/RQ46-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir server side key generat respons request success server respons must http respons code content type multipart mix consist two part one part privat key data part certif data format privat key data part return depend whether privat key return addit encrypt top provid tls addit encrypt employ privat key data must place applic pkcs applic pkcs part consist base encod der encod privat key info content transfer encod base rfc addit encrypt employ privat key place insid cms sign data sign data sign parti generat privat key may may est server est sign data protect place insid cms envelop data describ section rfc follow list show encrypt data use depend type protect key specifi client client specifi symmetr encrypt key protect server generat privat key envelop data content encrypt use secret key identifi request envelop data recipi info field must indic key encrypt kekri key manag techniqu valu follow version set key encrypt key identifi kekid set valu decrypt key identifi section key encrypt algorithm set one key wrap algorithm client includ smimecap accompani request encrypt key encrypt key client specifi asymmetr encrypt key suitabl key transport oper protect server generat privat key envelop data content encrypt use random generat symmetr encrypt key cryptograph strength symmetr encrypt key equival client specifi asymmetr key envelop data recipi info field must indic key tran recipi info ktri key manag techniqu key tran recipi info recipi identifi rid either subject key identifi copi attribut defin section server determin associ issuer serial number attribut version deriv choic rid rfc key encrypt algorithm set one key wrap algorithm client includ smimecap accompani request encrypt key encrypt key client specifi asymmetr encrypt key suitabl key agreement oper protect server generat privat key envelop data content encrypt use random generat symmetr encrypt key cryptograph strength symmetr encrypt key equival client specifi asymmetr key envelop data recipi info field must indic key agre recipi info kari key manag techniqu key agre recipi info type version origin user key materi ukm rfc key encrypt algorithm set one key wrap algorithm client includ smimecap accompani request recipi key identifi either copi attribut defin section subject key identifi server determin issuer serial number correspond valu provid attribut three addit encrypt case envelop data return respons applic pkcs mime part smime type paramet server generat key content transfer encod base certif data part applic pkcs mime exact match certif respons simpleenrol reject request server must specifi either http error http error content type set respons data must plaintext human readabl error messag,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[-0.00180192 -0.14001022 -0.2702808   0.02396031  0.03118713  0.09372749
  0.24121371  0.07212281 -0.03745121 -0.08879794 -0.05672298 -0.03945939
 -0.01522511  0.10968519 -0.0863004   0.00924068  0.0115347   0.10042345
  0.08303375  0.03450964  0.01235944  0.05893371  0.0275687   0.10255965
  0.21120411  0.17184943  0.02146227  0.13666797 -0.03635975  0.03360217
  0.06087466 -0.05658713 -0.05418339 -0.15846092  0.15146388  0.00810363
  0.0476564   0.09083605 -0.04877948 -0.09259018  0.00251288 -0.08810457
 -0.03758815 -0.01510243  0.06934974  0.10964151  0.08180588 -0.05503359
  0.12246166 -0.15861806 -0.00798607 -0.10418037 -0.06848144  0.0980335
 -0.02739654 -0.02310017 -0.07828003 -0.04958087  0.15196921 -0.1316933
 -0.01530242  0.01000813  0.22043301  0.11197917  0.01734846 -0.05906089
 -0.1957379   0.03668795  0.06339801 -0.03330917 -0.08683818  0.11170626
 -0.1458082   0.06473897 -0.05771506 -0.05878053 -0.03343935 -0.07465059
  0.1549689  -0.00256479  0.13718629 -0.07659797  0.05520694 -0.03905776
  0.06345023 -0.08689435 -0.06407102  0.03220663 -0.11376818 -0.02963472
  0.07630265 -0.12382381 -0.06520426 -0.04244742 -0.05180899 -0.0474537
 -0.02886597  0.1372313  -0.14926785  0.10577689]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.26737074140971423,0
req,src,test_data/LibEST_semeru_format/requirements/RQ27-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir client use explicit databas est client explicit databas use valid est server certif client must check either configur uri recent http redirect uri server ident accord rule specifi rfc section est server certif must contain cmc rfc extend key usag extens,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.02390055 -0.12597431 -0.2631655   0.01040151  0.01925609  0.0920774
  0.25199944  0.05535672 -0.01897776 -0.09745026 -0.07395645 -0.04448171
 -0.01967564  0.08998011 -0.09123667  0.04600066  0.01245892  0.08952808
  0.0948455   0.06588144  0.03504631  0.05964885  0.01615124  0.09356245
  0.22093287  0.19145012  0.00997437  0.15609276 -0.04950342  0.0486571
  0.02222176 -0.06530076 -0.02671593 -0.1388655   0.13808008 -0.01112219
  0.07793518  0.1139987  -0.03662445 -0.09551631  0.01903202 -0.07861656
 -0.0306011  -0.05370657  0.06653112  0.10241868  0.10766543 -0.06430312
  0.11941468 -0.17811885 -0.03670623 -0.09031085 -0.08610275  0.06702688
 -0.02481533  0.00803096 -0.07795316 -0.04525677  0.15163578 -0.10662755
 -0.00400082  0.01707375  0.20941612  0.10327631  0.01720794 -0.05782084
 -0.21023452  0.04170449  0.0485475  -0.06408824 -0.1170109   0.12093838
 -0.15194032  0.06114425 -0.07208493 -0.05720827 -0.04917835 -0.05349147
  0.16324273  0.00277698  0.15384234 -0.09474903  0.06435243 -0.02221297
  0.06501196 -0.09243767 -0.06796791  0.04146977 -0.14070383 -0.03437184
  0.07146786 -0.11527655 -0.04992236 -0.05380597 -0.0375825  -0.04526428
 -0.059297    0.12870216 -0.15559691  0.10350665]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.3694305686634389,0
req,src,test_data/LibEST_semeru_format/requirements/RQ18-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir http base client authent est server may request http base client authent request addit success tls client authent section est server polici requir addit authent exampl est server may requir est client know password addit exist client certif http base client authent est server polici specifi fallback situat est client success complet tls client authent might aris est client enrol first time certif avail est client cannot use tls client authent http basic digest authent must perform tls rfc later version null anon cipher suit must use provid confidenti support mutual certif base certif less authent respect specifi certif manag cms cmc transport protocol rfc server must assum client support type http authent cooki basic authent digest authent client support basic digest authent mechan server wish use basic digest authent reject http request use http defin www authent respons header rfc section client expect retri request includ appropri author request header rfc section client capabl use basic digest authent client capabl retri request capabl basic digest authent client must termin connect client may set usernam empti string present password associ usernam support http base client authent secur ramif discuss section client must respond server http authent request unless client author est server per section,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.04189074 -0.11007163 -0.2551596   0.00233566  0.01805499  0.09077151
  0.2526413   0.04694885 -0.00965447 -0.10957289 -0.08033112 -0.03941373
 -0.01905064  0.07846716 -0.08960577  0.06454775  0.01125512  0.08553635
  0.09319705  0.08541369  0.04656414  0.05874637  0.00619338  0.08342006
  0.22200316  0.19327737  0.00473623  0.15701966 -0.05048641  0.05173333
  0.00067295 -0.06727549 -0.01061308 -0.12736303  0.12440599 -0.02148066
  0.08769705  0.12558518 -0.02957721 -0.09214164  0.02450513 -0.06753545
 -0.02729463 -0.07379659  0.06167115  0.09554931  0.11722283 -0.06803773
  0.11058782 -0.18054175 -0.05409104 -0.0814022  -0.09369682  0.04354779
 -0.02357797  0.01869402 -0.0721636  -0.04498529  0.15258352 -0.08962433
  0.00059402  0.02084271  0.19618756  0.09544743  0.01718518 -0.05539155
 -0.21096583  0.04690552  0.02912626 -0.08539301 -0.1341283   0.1212899
 -0.14525601  0.05668777 -0.07262701 -0.04757889 -0.05201679 -0.03899992
  0.16102032  0.00607918  0.15748025 -0.10362682  0.06856398 -0.0100242
  0.0654073  -0.09101052 -0.07439058  0.04132548 -0.15535975 -0.03468437
  0.05964667 -0.11453348 -0.0471596  -0.05888367 -0.02621881 -0.03874068
 -0.07306951  0.1179497  -0.15661545  0.10373951]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4677921172347523,0
req,src,test_data/LibEST_semeru_format/requirements/RQ18-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir http base client authent est server may request http base client authent request addit success tls client authent section est server polici requir addit authent exampl est server may requir est client know password addit exist client certif http base client authent est server polici specifi fallback situat est client success complet tls client authent might aris est client enrol first time certif avail est client cannot use tls client authent http basic digest authent must perform tls rfc later version null anon cipher suit must use provid confidenti support mutual certif base certif less authent respect specifi certif manag cms cmc transport protocol rfc server must assum client support type http authent cooki basic authent digest authent client support basic digest authent mechan server wish use basic digest authent reject http request use http defin www authent respons header rfc section client expect retri request includ appropri author request header rfc section client capabl use basic digest authent client capabl retri request capabl basic digest authent client must termin connect client may set usernam empti string present password associ usernam support http base client authent secur ramif discuss section client must respond server http authent request unless client author est server per section,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.04189074 -0.11007163 -0.2551596   0.00233566  0.01805499  0.09077151
  0.2526413   0.04694885 -0.00965447 -0.10957289 -0.08033112 -0.03941373
 -0.01905064  0.07846716 -0.08960577  0.06454775  0.01125512  0.08553635
  0.09319705  0.08541369  0.04656414  0.05874637  0.00619338  0.08342006
  0.22200316  0.19327737  0.00473623  0.15701966 -0.05048641  0.05173333
  0.00067295 -0.06727549 -0.01061308 -0.12736303  0.12440599 -0.02148066
  0.08769705  0.12558518 -0.02957721 -0.09214164  0.02450513 -0.06753545
 -0.02729463 -0.07379659  0.06167115  0.09554931  0.11722283 -0.06803773
  0.11058782 -0.18054175 -0.05409104 -0.0814022  -0.09369682  0.04354779
 -0.02357797  0.01869402 -0.0721636  -0.04498529  0.15258352 -0.08962433
  0.00059402  0.02084271  0.19618756  0.09544743  0.01718518 -0.05539155
 -0.21096583  0.04690552  0.02912626 -0.08539301 -0.1341283   0.1212899
 -0.14525601  0.05668777 -0.07262701 -0.04757889 -0.05201679 -0.03899992
  0.16102032  0.00607918  0.15748025 -0.10362682  0.06856398 -0.0100242
  0.0654073  -0.09101052 -0.07439058  0.04132548 -0.15535975 -0.03468437
  0.05964667 -0.11453348 -0.0471596  -0.05888367 -0.02621881 -0.03874068
 -0.07306951  0.1179497  -0.15661545  0.10373951]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.4169444313723393,0
req,src,test_data/LibEST_semeru_format/requirements/RQ22-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir tls client authent recommend method identifi est client http base client authent section may use est server authent est client defin cipher suit negoti follow text provid detail assum certif base cipher suit tls rfc mandatori cipher suit tls rsa des ede cbc sha est server must support certif base client authent general client use exist certif renew rekey oper certif renew rekey appropri negoti cipher suit client must use tls handshak otherwis client use altern certif suitabl cipher suit contain subject ident inform request enrol oper client may use client certif issu third parti authent certif valid must perform per rfc est client certif must conform rfc certif profil server valid tls client certif use est server explicit enabl implicit databas server must maintain distinct use explicit implicit databas authent order support proper author est server must perform author check specifi section client support tls client authent must support http base client authent section certif less tls authent section,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.03560031 -0.11806617 -0.2603899   0.00890871  0.01585975  0.09348304
  0.25568795  0.04921199 -0.01364579 -0.10686032 -0.07941308 -0.03819065
 -0.01938197  0.08820964 -0.09256627  0.05965941  0.01600557  0.09088229
  0.09622283  0.0808967   0.04508314  0.05854633  0.00908588  0.0864503
  0.2236602   0.19485252  0.00715569  0.15756205 -0.04899316  0.05158281
  0.01079367 -0.0625224  -0.01461748 -0.13481785  0.13273986 -0.01295481
  0.0812565   0.12095381 -0.0355486  -0.09259038  0.02310962 -0.0739474
 -0.0297117  -0.06669921  0.06496706  0.0998617   0.11235155 -0.06724715
  0.11444343 -0.17833593 -0.04860706 -0.08750474 -0.09113016  0.0533275
 -0.02372546  0.01697083 -0.07483374 -0.04659152  0.15181443 -0.10130326
 -0.00198923  0.01856928  0.20130399  0.10058656  0.01863825 -0.05983925
 -0.21379791  0.04586987  0.03945242 -0.07876264 -0.13164812  0.12130848
 -0.15071353  0.06014076 -0.0712426  -0.05229118 -0.0510712  -0.04690067
  0.16448826  0.00441768  0.15744776 -0.09881057  0.06442253 -0.01466798
  0.06334844 -0.08961193 -0.07384117  0.03945244 -0.15014768 -0.03686342
  0.06381103 -0.11684715 -0.04838846 -0.05982045 -0.03039164 -0.04102702
 -0.06793607  0.12046503 -0.15554552  0.10614393]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.449431043709114,0
req,src,test_data/LibEST_semeru_format/requirements/RQ25-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir link ident pop inform server polici determin whether client requir use mechan specifi section specif provid method link ident proof possess includ inform specif current authent tls session within sign certif request client determin server requir link ident pop examin csr attribut respons see section regardless csr attribut respons client link ident pop embed tls uniqu inform certif request tls uniqu inform includ client server must verifi est server may reject request without tls uniqu inform indic server polici link ident proof possess prove server authent tls client possess privat key associ certif request client abl sign certif request tls session establish altern link ident pop inform method defin section rfc avail full pki messag use client generat csr obtain tls uniqu valu tls subsystem describ channel bind tls rfc est client oper obtain tls uniqu valu generat csr contain current tls uniqu valu subsequ verif valu est server phase applic protocol applic layer authent occur oper protect synchron interoper mechan describ channel bind tls interoper note section rfc perform renegoti tls secur renegoti rfc must use tls uniqu valu base encod specifi section rfc result string place certif request challeng password field rfc section challeng password field limit byte section rfc indic exist cipher suit would result issu limit challeng password attribut absent client includ option channel bind inform presenc challeng password attribut indic inclus tls uniqu inform est server make use back end infrastructur process recommend result verif communic exampl communic might use cmc rfc pop wit control cmc full pki request messag est server might tls authent est client trust infrastructur element forward invalid request detail discuss back end process scope reject request est server respons describ enrol respons section full pki respons includ cmcfail info must set pop fail human readabl reject messag includ includ inform text messag indic link ident pop inform requir,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.02866512 -0.11441547 -0.2701774   0.00442002  0.03214517  0.09592281
  0.25230312  0.06005715 -0.0136436  -0.11038007 -0.07262286 -0.04040393
 -0.01825036  0.09293856 -0.08865151  0.04117584  0.00185751  0.09564464
  0.09132635  0.06186443  0.02607342  0.06754533  0.00713084  0.09191154
  0.22297737  0.19363205  0.01443631  0.15170453 -0.04908246  0.05125998
  0.01845707 -0.06855577 -0.026341   -0.14546049  0.14393145 -0.01583931
  0.06748734  0.11520129 -0.03927449 -0.10437528  0.00403538 -0.08194534
 -0.03539954 -0.05135612  0.0608086   0.10553388  0.1070497  -0.05929298
  0.10855341 -0.18405387 -0.0427472  -0.09051815 -0.07836236  0.06832812
 -0.03100569  0.0026129  -0.06753511 -0.04128408  0.15824023 -0.11383137
 -0.00843634  0.00767578  0.21192789  0.11365141  0.02031517 -0.05055278
 -0.21103525  0.044742    0.04394524 -0.06748792 -0.11455254  0.1143715
 -0.15156509  0.05860876 -0.06367968 -0.05032111 -0.05187921 -0.06050695
  0.15711841  0.00104176  0.14058657 -0.09702465  0.06853221 -0.02545453
  0.07151429 -0.08792089 -0.07546874  0.03977352 -0.13967143 -0.03221549
  0.07394061 -0.11886292 -0.05293486 -0.04884304 -0.03240964 -0.04619752
 -0.06253064  0.12186272 -0.16377579  0.09807327]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.5159066134482135,1
req,src,test_data/LibEST_semeru_format/requirements/RQ2-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir terminolog key word must must requir shall shall recommend recommend may option document interpret describ rfc assum reader familiar term concept describ public key cryptographi standard pkcs rfc https rfc cmp rfc cmc rfc rfc rfc tls rfc addit term defin terminolog section cmc rfc follow term defin clariti est certif issu servic est reach est server could logic behind est server embed within third parti trust anchor trust anchor authorit pki hierarchi est server provid servic explicit trust anchor explicit configur client server use est tls authent exampl manual configur est client bootstrap describ section see detail section implicit trust anchor third parti avail client server use tls authent specif indic use est tls authent exampl tas common use web browser authent web server tas use server authent manufactur instal client credenti certif popul cabl modem router factori author model tas differ author model explicit trust anchor see detail section certif less tls certif less tls cipher suit provid way perform mutual authent situat neither client server certif will use credenti use authent word phrase code key share client server credenti must uniqu share client server order provid authent individu client individu server,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 2.07649991e-02 -1.23978503e-01 -2.67159611e-01  1.30387805e-02
  2.72379238e-02  9.25438255e-02  2.48097673e-01  6.15683980e-02
 -1.89826228e-02 -1.00402072e-01 -6.73580691e-02 -4.38584648e-02
 -1.54374503e-02  9.61187184e-02 -9.23477560e-02  3.81437652e-02
  3.98038188e-03  9.61137637e-02  9.22925770e-02  5.54877557e-02
  2.39771102e-02  6.58327118e-02  1.46603864e-02  9.60533172e-02
  2.19410419e-01  1.91637903e-01  1.71471834e-02  1.48857161e-01
 -5.19462526e-02  4.78976518e-02  2.74605285e-02 -6.68648630e-02
 -3.10950298e-02 -1.49806589e-01  1.44800693e-01 -1.10108415e-02
  6.46093562e-02  1.06654502e-01 -4.08820063e-02 -1.03157014e-01
  5.78791602e-03 -8.80751163e-02 -3.46440189e-02 -4.03746106e-02
  6.40682504e-02  1.06157422e-01  1.07702062e-01 -6.19764514e-02
  1.14483289e-01 -1.79105714e-01 -3.47319804e-02 -9.35924500e-02
 -7.40223303e-02  7.71135464e-02 -3.00947558e-02 -1.19986267e-04
 -6.99129924e-02 -3.98511849e-02  1.52865112e-01 -1.18956573e-01
 -1.12027526e-02  8.59872717e-03  2.12367073e-01  1.13323547e-01
  1.84823927e-02 -5.22320047e-02 -2.10016459e-01  4.18052226e-02
  5.44632412e-02 -5.76656982e-02 -1.00603886e-01  1.15542866e-01
 -1.51536003e-01  6.05084300e-02 -6.55100197e-02 -5.66768460e-02
 -4.56210077e-02 -6.13810308e-02  1.55998811e-01  1.74423866e-03
  1.41226783e-01 -9.38318819e-02  6.19892403e-02 -2.93949302e-02
  6.78196102e-02 -9.01478902e-02 -7.21427798e-02  4.08927873e-02
 -1.33510277e-01 -2.93874368e-02  7.92512447e-02 -1.16184101e-01
 -5.59945144e-02 -4.67266217e-02 -3.56314331e-02 -4.92527708e-02
 -5.34678958e-02  1.30352095e-01 -1.57004431e-01  9.66723338e-02]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.3390143833460501,0
req,src,test_data/LibEST_semeru_format/requirements/RQ4-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir obtain certif est client request copi current est certif est server est client assum perform oper perform oper throughout document assum est certif use client verifi sign object issu certif certif revoc list crls differ certif one use verifi signatur certif crls use est protocol communic requir addit encrypt est client authent verifi author scope est server request current certif detail section avail option includ verifi est server https uri est server certif use implicit tas similar common https exchang allow est server client leverag exist tas might known est client client leverag previous distribut trust anchor specif est server allow est client use exist potenti older certif request current certif bootstrap est client reli upon manual authent perform end user detail section client leverag bind share credenti specif est server certif less tls cipher suit client authent requir exchang trivial support est server,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.02438382 -0.13098782 -0.26134843  0.0141317   0.01635077  0.09086808
  0.25437456  0.05226829 -0.02108167 -0.09430862 -0.07487638 -0.04470679
 -0.01916245  0.08903117 -0.09319656  0.0481416   0.01466362  0.08753572
  0.09618563  0.06717007  0.03886695  0.0574517   0.01630523  0.09496235
  0.22138612  0.19315523  0.00912732  0.15614879 -0.04969338  0.04788723
  0.02022095 -0.06570347 -0.02667379 -0.13700207  0.1358554  -0.00984788
  0.07960428  0.11284473 -0.03676623 -0.09324516  0.02088876 -0.07694186
 -0.02701836 -0.05481062  0.0652549   0.1016745   0.10913593 -0.06553815
  0.12230802 -0.17650937 -0.03599672 -0.08992325 -0.08652338  0.06704387
 -0.02321102  0.00812466 -0.07990809 -0.04363263  0.15058279 -0.10573684
 -0.00420333  0.01912562  0.2100557   0.10065673  0.0155339  -0.05976278
 -0.20887244  0.04145279  0.04830372 -0.06474237 -0.11708082  0.12058631
 -0.15258506  0.06195078 -0.07364008 -0.05825207 -0.04965248 -0.05126161
  0.16317919  0.00364245  0.16031404 -0.09429163  0.06530255 -0.02063966
  0.06301866 -0.09417819 -0.06767496  0.04113423 -0.14174202 -0.03428216
  0.07111481 -0.11451579 -0.04978564 -0.05516825 -0.03919421 -0.04388329
 -0.06074192  0.1321954  -0.15421632  0.1050766 ]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4153283292240219,0
req,src,test_data/LibEST_semeru_format/requirements/RQ21-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir tls base server authent tls server authent certif must support est client authent est server defin cipher suit negoti follow text provid detail assum certif base cipher suit tls rfc mandatori cipher suit tls rsa des ede cbc sha certif valid must perform per rfc est server certif must conform rfc certif profil client valid tls server certif use est client explicit enabl implicit databas client must maintain distinct use explicit implicit databas authent order support proper author est client must perform author check specifi section certif valid fail client may follow procedur outlin section bootstrap distribut certif,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.03138775 -0.11994226 -0.26177543  0.01009134  0.01682908  0.09367315
  0.25434023  0.05125159 -0.01494238 -0.10531525 -0.07769346 -0.03883453
 -0.01932154  0.09069742 -0.09231156  0.05411448  0.01492774  0.0913741
  0.0960763   0.07660591  0.0419167   0.05928199  0.01052361  0.08838896
  0.22210892  0.19456966  0.00931346  0.15594208 -0.0492865   0.05061324
  0.01435906 -0.06201106 -0.01823414 -0.13784477  0.13667072 -0.01078814
  0.07781523  0.11794087 -0.03672037 -0.0946416   0.02050837 -0.07745683
 -0.030766   -0.06127793  0.06628142  0.10129201  0.11000179 -0.06504964
  0.11469381 -0.17779593 -0.04541428 -0.08872579 -0.08837549  0.05811823
 -0.0241732   0.01452403 -0.07426388 -0.04567504  0.1511004  -0.10566079
 -0.00389885  0.01634307  0.20382355  0.10395674  0.01914163 -0.05821224
 -0.21305126  0.04377942  0.04421873 -0.07386363 -0.12642418  0.12058572
 -0.15230733  0.06068396 -0.07067809 -0.0539192  -0.05093762 -0.05201657
  0.16358161  0.00353572  0.15469302 -0.09690873  0.06323567 -0.01821703
  0.06363817 -0.08903045 -0.0724475   0.0400263  -0.14543352 -0.0359267
  0.06705237 -0.1162876  -0.04843105 -0.05791613 -0.03129494 -0.04261147
 -0.06538622  0.12085021 -0.15517925  0.10448755]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4331482327676523,0
req,src,test_data/LibEST_semeru_format/requirements/RQ52-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,"requir refer rfc freed borenstein multipurpos internet mail extens mime part one format internet messag bodi rfc novemb rfc bradner key word use rfcs indic requir level bcp rfc march rfc housley hoffman internet public key infrastructur oper protocol ftp http rfc may rfc field getti mogul frystyk masint leach berner lee hypertext transfer protocol http rfc june rfc frank hallam baker hostetl lawrenc leach luotonen stewart http authent basic digest access authent rfc june rfc ramsdel mime version messag specif rfc june rfc nystrom kaliski pkcs https tool ietf org html rfc certif request syntax specif version rfc novemb rfc berner lee field masint uniform resourc identifi uri generic syntax std rfc 3986 januari 2005 rfc4086 eastlak schiller crocker random requir secur bcp 106 rfc 4086 june 2005 rfc4108 housley use cryptograph messag syntax cms protect firmwar packag rfc 4108 august 2005 rfc4210 adam farrel kaus mononen internet 509 public key infrastructur certif manag protocol cmp )"", rfc 4210 septemb 2005 rfc4346 dierk rescorla transport layer secur tls protocol version rfc 4346 april 2006 rfc4648 josefsson base16 base32 base64 data encod rfc 4648 octob 2006 rfc5077 salowey zhou eronen tschofenig transport layer secur tls session resumpt without server side state rfc 5077 januari 2008 rfc5246 dierk rescorla transport layer secur tls protocol version rfc 5246 august 2008 rfc5272 schaad myer certif manag cms cmc )"", rfc 5272 june 2008 rfc5273 schaad myer certif manag cms cmc transport protocol rfc 5273 june 2008 rfc5274 schaad myer certif manag messag cms cmc complianc requir rfc 5274 june 2008 rfc5280 cooper santesson farrel boeyen housley polk internet 509 public key infrastructur certif certif revoc list crl profil rfc 5280 may 2008 rfc5652 housley cryptograph messag syntax cms )"", std rfc 5652 septemb 2009 rfc5746 rescorla ray dispensa oskov transport layer secur tls renegoti indic extens rfc 5746 februari 2010 rfc5751 ramsdel turner secur multipurpos internet mail extens mime version messag specif rfc 5751 januari 2010 rfc5785 nottingham hammer lahav defin well known uniform resourc identifi uri )"", rfc 5785 april 2010 rfc5929 altman william zhu channel bind tls rfc 5929 juli 2010 rfc5958 turner asymmetr key packag rfc 5958 august 2010 rfc6066 eastlak transport layer secur tls extens extens definit rfc 6066 januari 2011 rfc6125 saint andr hodg represent verif domain base applic servic ident within internet public key infrastructur use 509 pkix certif context transport layer secur tls )"", rfc 6125 march 2011 rfc6402 schaad certif manag cms cmc updat rfc 6402 novemb 2011 rfc6454 barth web origin concept rfc 6454 decemb 2011 rfc6838 freed klensin hansen media type specif registr procedur bcp rfc 6838 januari 2013 680 itu recommend 680 2008 iso iec 8824 2008 abstract syntax notat one asn specif basic notat novemb 2008 http :// www itu int rec rec 680 200811 690 itu recommend 690 2008 iso iec 8825 2008 asn encod rule specif basic encod rule ber canon encod rule cer distinguish encod rule der )"", novemb 2008 http :// www itu int rec rec 690 200811","function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 0.01025765 -0.11777413 -0.28325707  0.01207988  0.05388134  0.10212123
  0.23799163  0.08047444 -0.02325475 -0.11149347 -0.05367354 -0.04429411
 -0.01185895  0.1089884  -0.08942953  0.00727843 -0.01937087  0.11147297
  0.0865723   0.02176114 -0.01077228  0.07656363  0.01465348  0.10345767
  0.22147857  0.18647353  0.03339807  0.13041693 -0.05111844  0.04497825
  0.04986046 -0.07284549 -0.04687074 -0.1727066   0.16408503 -0.01127865
  0.02973878  0.09538329 -0.05305659 -0.11448508 -0.03117074 -0.10800306
 -0.04412735 -0.00730762  0.05457087  0.12088196  0.09519689 -0.0473062
  0.10164963 -0.18514748 -0.02277445 -0.09794035 -0.04509436  0.10810839
 -0.04696552 -0.02879248 -0.05480592 -0.02895504  0.16465215 -0.15007395
 -0.02554926 -0.01202841  0.22675519  0.142252    0.0202333  -0.03588109
 -0.20578422  0.04418229  0.06132133 -0.03959341 -0.0711643   0.10030794
 -0.15053251  0.0618668  -0.04189831 -0.04513828 -0.04274336 -0.0855602
  0.13706793 -0.00757249  0.10553517 -0.08790343  0.06507584 -0.04150384
  0.07143376 -0.08042841 -0.08001163  0.03621494 -0.11474686 -0.01901297
  0.09867138 -0.11920463 -0.0725496  -0.02850738 -0.0344139  -0.05473419
 -0.03739534  0.13531508 -0.17002745  0.07835863]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.30055252077003264,0
req,src,test_data/LibEST_semeru_format/requirements/RQ48-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir csr attribut request est client request list desir csr attribut send https get messag est server oper path csrattr,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.02002758 -0.12629412 -0.26697797  0.0034956   0.02461626  0.10127906
  0.25129998  0.06000828 -0.02672494 -0.1079785  -0.07595601 -0.04931965
 -0.02696041  0.08025389 -0.08667208  0.03605753  0.01440395  0.08650382
  0.09739792  0.05822663  0.04096767  0.05469621  0.00824327  0.09201299
  0.23467979  0.18412314  0.00747143  0.15159453 -0.04240852  0.04653342
  0.02637563 -0.07683077 -0.02884299 -0.12357812  0.12887454 -0.01404486
  0.07451217  0.12343709 -0.0407328  -0.08099362  0.02017124 -0.06972123
 -0.02995891 -0.05795939  0.05504693  0.10681709  0.09271178 -0.04990526
  0.11930827 -0.17942119 -0.03980168 -0.0897399  -0.08688195  0.06949901
 -0.027505   -0.00061127 -0.08535286 -0.04290544  0.15987721 -0.09457348
  0.00626497  0.01546233  0.21935037  0.10524669  0.01012975 -0.06153227
 -0.20000124  0.04297137  0.03431046 -0.07392709 -0.13515612  0.11984724
 -0.1505557   0.06548285 -0.06087423 -0.03773393 -0.04999869 -0.05378553
  0.15527998 -0.00671193  0.15815628 -0.08938377  0.0784928  -0.00864411
  0.06059305 -0.08556458 -0.06554455  0.04344543 -0.14902171 -0.04006366
  0.06310629 -0.11431018 -0.05935525 -0.05731422 -0.03694518 -0.03194145
 -0.06246174  0.13882542 -0.16407111  0.09793685]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4066705986558686,0
req,src,test_data/LibEST_semeru_format/requirements/RQ7-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,requir certif less tls authent est client est server mutual authent use certif less tls cipher suit see section,"function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 0.03959643 -0.11830101 -0.2548828   0.01077982  0.00566081  0.09178946
  0.25971216  0.04032584 -0.01340001 -0.10547499 -0.08484469 -0.03508832
 -0.02130948  0.08159896 -0.09337157  0.07070144  0.02650197  0.08629522
  0.09763462  0.09383267  0.05902656  0.05236711  0.00729992  0.08250453
  0.22394     0.19479032  0.00099752  0.16204035 -0.04796796  0.05053836
  0.00327445 -0.05890686 -0.00805137 -0.12360201  0.12266038 -0.01281946
  0.09161752  0.12744492 -0.03215759 -0.08461346  0.03541954 -0.06501617
 -0.02536058 -0.07928493  0.06529344  0.09452287  0.11429387 -0.07060181
  0.11798905 -0.17435278 -0.05373984 -0.08460791 -0.10178212  0.03956879
 -0.0179163   0.0252831  -0.0794533  -0.05085371  0.14963865 -0.08974943
  0.00263307  0.02504253  0.19634888  0.09015577  0.01737419 -0.06786606
 -0.21300258  0.04589445  0.03202966 -0.08856383 -0.1474802   0.12405513
 -0.15006101  0.06020238 -0.0760394  -0.05127401 -0.05193676 -0.03719536
  0.16823769  0.0072549   0.1711231  -0.09984331  0.06470174 -0.00642119
  0.05870793 -0.09075157 -0.07222641  0.03837254 -0.15819725 -0.04176787
  0.05399001 -0.11535335 -0.0443685  -0.06771926 -0.02842074 -0.03458875
 -0.07419587  0.11946263 -0.15156278  0.11259974]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.4612401718156909,1
req,src,test_data/LibEST_semeru_format/requirements/RQ22-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir tls client authent recommend method identifi est client http base client authent section may use est server authent est client defin cipher suit negoti follow text provid detail assum certif base cipher suit tls rfc mandatori cipher suit tls rsa des ede cbc sha est server must support certif base client authent general client use exist certif renew rekey oper certif renew rekey appropri negoti cipher suit client must use tls handshak otherwis client use altern certif suitabl cipher suit contain subject ident inform request enrol oper client may use client certif issu third parti authent certif valid must perform per rfc est client certif must conform rfc certif profil server valid tls client certif use est server explicit enabl implicit databas server must maintain distinct use explicit implicit databas authent order support proper author est server must perform author check specifi section client support tls client authent must support http base client authent section certif less tls authent section,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.03560031 -0.11806617 -0.2603899   0.00890871  0.01585975  0.09348304
  0.25568795  0.04921199 -0.01364579 -0.10686032 -0.07941308 -0.03819065
 -0.01938197  0.08820964 -0.09256627  0.05965941  0.01600557  0.09088229
  0.09622283  0.0808967   0.04508314  0.05854633  0.00908588  0.0864503
  0.2236602   0.19485252  0.00715569  0.15756205 -0.04899316  0.05158281
  0.01079367 -0.0625224  -0.01461748 -0.13481785  0.13273986 -0.01295481
  0.0812565   0.12095381 -0.0355486  -0.09259038  0.02310962 -0.0739474
 -0.0297117  -0.06669921  0.06496706  0.0998617   0.11235155 -0.06724715
  0.11444343 -0.17833593 -0.04860706 -0.08750474 -0.09113016  0.0533275
 -0.02372546  0.01697083 -0.07483374 -0.04659152  0.15181443 -0.10130326
 -0.00198923  0.01856928  0.20130399  0.10058656  0.01863825 -0.05983925
 -0.21379791  0.04586987  0.03945242 -0.07876264 -0.13164812  0.12130848
 -0.15071353  0.06014076 -0.0712426  -0.05229118 -0.0510712  -0.04690067
  0.16448826  0.00441768  0.15744776 -0.09881057  0.06442253 -0.01466798
  0.06334844 -0.08961193 -0.07384117  0.03945244 -0.15014768 -0.03686342
  0.06381103 -0.11684715 -0.04838846 -0.05982045 -0.03039164 -0.04102702
 -0.06793607  0.12046503 -0.15554552  0.10614393]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4479908054923342,0
req,src,test_data/LibEST_semeru_format/requirements/RQ26-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir server author client must check est server author accept server respons respond http authent request est client author method depend method use authent server explicit databas use authent est server section appli implicit databas use authent est server section appli success authent use certif less cipher suit impli author server client may perform bootstrap specifi section even check fail,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[ 0.03480774 -0.12051839 -0.25787443  0.00640074  0.01230177  0.09126725
  0.2574307   0.04629519 -0.01467834 -0.10499822 -0.08158484 -0.04325932
 -0.02130056  0.08018853 -0.09169014  0.0623023   0.01829556  0.08465093
  0.09761688  0.08360917  0.05196283  0.05559222  0.00973514  0.08694697
  0.22574452  0.1929562   0.00460734  0.16124196 -0.04978705  0.04982254
  0.00672318 -0.06738108 -0.01485482 -0.12545289  0.12542875 -0.01703988
  0.09020518  0.12523633 -0.03148386 -0.08965863  0.02969941 -0.06706581
 -0.02647346 -0.07327627  0.06393037  0.0976954   0.11271487 -0.06751263
  0.11850979 -0.17899852 -0.04881167 -0.08487888 -0.09786985  0.04782249
 -0.02132117  0.02004038 -0.07982083 -0.04670249  0.15280403 -0.08948005
  0.00424325  0.02211522  0.20194371  0.09487215  0.01437735 -0.06061054
 -0.21093339  0.04383912  0.03477304 -0.08099286 -0.1369719   0.12406705
 -0.1500091   0.05975844 -0.07534467 -0.05116968 -0.05136358 -0.04234471
  0.16518141  0.00378528  0.1655588  -0.10038587  0.06927196 -0.01014227
  0.06380244 -0.09224096 -0.06876726  0.04386782 -0.15474753 -0.03883133
  0.05865141 -0.11444595 -0.04686902 -0.06058937 -0.03042979 -0.03886646
 -0.07134651  0.12459505 -0.15633251  0.10607284]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.3919449173472709,1
req,src,test_data/LibEST_semeru_format/requirements/RQ22-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.h,requir tls client authent recommend method identifi est client http base client authent section may use est server authent est client defin cipher suit negoti follow text provid detail assum certif base cipher suit tls rfc mandatori cipher suit tls rsa des ede cbc sha est server must support certif base client authent general client use exist certif renew rekey oper certif renew rekey appropri negoti cipher suit client must use tls handshak otherwis client use altern certif suitabl cipher suit contain subject ident inform request enrol oper client may use client certif issu third parti authent certif valid must perform per rfc est client certif must conform rfc certif profil server valid tls client certif use est server explicit enabl implicit databas server must maintain distinct use explicit implicit databas authent order support proper author est server must perform author check specifi section client support tls client authent must support http base client authent section certif less tls authent section,int ossl verifi int store ctx ctx libest test api void ossl dump ssl error void est error ossl init cert store store store unsign char raw int size,"[ 0.03560031 -0.11806617 -0.2603899   0.00890871  0.01585975  0.09348304
  0.25568795  0.04921199 -0.01364579 -0.10686032 -0.07941308 -0.03819065
 -0.01938197  0.08820964 -0.09256627  0.05965941  0.01600557  0.09088229
  0.09622283  0.0808967   0.04508314  0.05854633  0.00908588  0.0864503
  0.2236602   0.19485252  0.00715569  0.15756205 -0.04899316  0.05158281
  0.01079367 -0.0625224  -0.01461748 -0.13481785  0.13273986 -0.01295481
  0.0812565   0.12095381 -0.0355486  -0.09259038  0.02310962 -0.0739474
 -0.0297117  -0.06669921  0.06496706  0.0998617   0.11235155 -0.06724715
  0.11444343 -0.17833593 -0.04860706 -0.08750474 -0.09113016  0.0533275
 -0.02372546  0.01697083 -0.07483374 -0.04659152  0.15181443 -0.10130326
 -0.00198923  0.01856928  0.20130399  0.10058656  0.01863825 -0.05983925
 -0.21379791  0.04586987  0.03945242 -0.07876264 -0.13164812  0.12130848
 -0.15071353  0.06014076 -0.0712426  -0.05229118 -0.0510712  -0.04690067
  0.16448826  0.00441768  0.15744776 -0.09881057  0.06442253 -0.01466798
  0.06334844 -0.08961193 -0.07384117  0.03945244 -0.15014768 -0.03686342
  0.06381103 -0.11684715 -0.04838846 -0.05982045 -0.03039164 -0.04102702
 -0.06793607  0.12046503 -0.15554552  0.10614393]","[-3.32884416e-02 -1.27662703e-01 -2.79828310e-01  5.80133311e-03
  6.43268228e-02  1.03074744e-01  2.14966252e-01  6.60702139e-02
 -7.85031915e-02 -8.58116224e-02 -4.89064455e-02 -4.54016812e-02
 -3.50504331e-02  7.81022385e-02 -8.51701126e-02 -4.31111641e-02
 -1.43419495e-02  8.63216594e-02  8.00839439e-02 -5.96548319e-02
 -3.35270874e-02  5.42765968e-02 -1.53618690e-03  9.97250006e-02
  2.21757606e-01  1.44508734e-01  2.97749359e-02  9.53684822e-02
 -1.38290357e-02  2.61135083e-02  6.73204586e-02 -7.80463517e-02
 -7.40294531e-02 -1.17273666e-01  1.25188559e-01 -1.86110064e-02
 -1.73459444e-02  8.57384130e-02 -7.10445195e-02 -6.99145049e-02
 -5.70689812e-02 -9.25302655e-02 -1.81697085e-02  2.58753784e-02
  4.22456441e-03  1.32250607e-01  2.52796076e-02  1.20715918e-02
  1.00857124e-01 -1.75514713e-01  7.28853466e-03 -9.01656672e-02
  6.84287661e-05  1.42916068e-01 -3.64756361e-02 -8.28685537e-02
 -6.90998882e-02 -5.78271784e-03  1.69050395e-01 -1.46098763e-01
 -1.19599076e-02 -4.28447016e-02  2.49336705e-01  1.46444991e-01
 -4.27160785e-03 -5.82108498e-02 -1.55882642e-01  4.36593667e-02
  2.77376771e-02 -3.03240996e-02 -7.65059143e-02  6.02095202e-02
 -1.25623688e-01  6.99399114e-02  1.62779465e-02  4.95273247e-03
 -4.01525758e-02 -1.00578167e-01  9.12162662e-02 -2.73536108e-02
  1.01810545e-01 -5.02358116e-02  9.73470807e-02 -9.18499660e-03
  3.33920047e-02 -6.09980337e-02 -6.28004223e-02  1.38998525e-02
 -9.23806950e-02 -2.97233351e-02  8.88039470e-02 -9.21974853e-02
 -9.68739688e-02 -3.19986381e-02 -2.76823603e-02 -1.23113375e-02
 -2.05206685e-02  1.97517261e-01 -1.74902141e-01  3.41759808e-02]",0.5220371953004211,0
req,src,test_data/LibEST_semeru_format/requirements/RQ39-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.c,requir full cmc est client request certif est server https post use oper path valu fullcmc support fullcmc function option client server,"author routin int ossl verifi int store ctx ctx int cert error store ctx get error ctx current cert store ctx get current cert ctx est log info enter function cert error cert error current cert name print stdout _get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% serror depth lookup ctx crl path """", cert_error ctx cert_error )); switch cert_error case enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok warn applic est_log_warn crl load tls peer allow .""); break case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error break return return function use load x509_store use raw data buffer data expect pem encod return number cert store static int x509_store store unsign char raw int size stack_of x509_info null x509_info bio int cert_cnt bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return load file stack x509 crl pkey set null null null null est_log_err unabl read pem encod cert bio ""); bio_fre return bio_fre scan pull crl sk_x509_info_num sk_x509_info_shift x509 null est_log_info cert store )"", x509 name x509_store_add_cert store x509 cert_cnt ++; crl null est_log_info crl store ""); x509_store_add_crl store crl x509_info_fre null sk_x509_info_pop_fre x509_info_fre return cert_cnt function use popul x509_store structur use open ssl tls stack verifi tls peer x509_store alreadi alloc paramet store pointer x509_store structur hold cert raw1 char array contain pem encod cert put store size1 length raw1 char array est_error ossl_init_cert_stor x509_store store unsign char raw1 int size1 x509_store_set_flag store int cnt raw1 cnt store raw1 size1 cnt est_log_err cert count zero store ""); return return est_err_non function use output open ssl error buffer use open ssl api call fail like provid detail user regard caus failur void ossl_dump_ssl_error bio null buf_mem bptr null bio_new bio_s_mem ()); est_log_err bio_new fail ""); return err_print_error void bio_flush bio_get_mem_ptr bptr est_log_warn ossl error bptr data bio_free_al /*! brief convert base64 encod pkcs7 respons est server pem format param certs_p7 point buffer contain base64 encod pkcs7 data param certs_len indic size certs_p7 buffer param pem doubl pointer receiv pem encod data sever est messag return data contain base64 encod pkcs7 certif function use convert data pem format function alloc memori point pem argument caller respons releas memori return valu length pem buffer error return int int unsign char certs_p7 int certs_len unsign char pem x509 stack_of x509 cert null bio b64 unsign char cacerts_decod null int cacerts_decoded_len bio p7bio_in null pkcs7 null int nid unsign char pem_data int pem_len base64 decod incom cert buffer decod alway take origin buffer b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); return bio_new_mem_buf certs_p7 certs_len est_log_err bio_new fail ""); return bio_push b64 cacerts_decod malloc certs_len cacerts_decod est_log_err malloc fail ""); return cacerts_decoded_len bio_read cacerts_decod certs_len bio_free_al get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); free cacerts_decod return d2i_pkcs7_bio p7bio_in null est_log_err pem_read_bio_pkcs7 fail ""); ossl_dump_ssl_error (); free cacerts_decod return bio_free_al p7bio_in free cacerts_decod decod cert get refer stack cert nid obj_obj2nid type switch nid case nid_pkcs7_sign cert sign cert break case nid_pkcs7_sign envelop cert signed_and_envelop cert break default est_log_err invalid nid valu pkcs7 structur ""); pkcs7_free return break cert est_log_err fail attain x509 cert stack pkcs7 data ""); pkcs7_free return output cert new bio use pem format bio_new bio_s_mem ()); est_log_err bio_new fail ""); pkcs7_free return sk_x509_num cert ++) sk_x509_valu cert pem_write_bio_x509 bio_put ""); void bio_flush convert bio char pem_len int bio_get_mem_data char **)& pem_data pem_len est_log_err bio_get_mem_data fail ""); pkcs7_free return pem malloc pem_len (!* pem est_log_err malloc fail ""); pkcs7_free return memcpy_ pem pem_len pem_data pem_len pem pem_len make sure null termiant bio_free_al pkcs7_free return pem_len","[ 0.0286738  -0.12377226 -0.26314363  0.00626567  0.01736777  0.09296239
  0.25464976  0.05189685 -0.0167871  -0.09914148 -0.07647866 -0.04660719
 -0.02258353  0.08461934 -0.09357786  0.05214413  0.01104196  0.08485492
  0.0966189   0.0682694   0.03902406  0.05879138  0.0115375   0.09298906
  0.22558674  0.19726248  0.00797105  0.16008733 -0.05236274  0.05341285
  0.01323281 -0.07040416 -0.02255218 -0.13155293  0.13503185 -0.01690895
  0.0824204   0.118871   -0.03467402 -0.09649996  0.02101236 -0.07635527
 -0.02718265 -0.06239719  0.06192379  0.10297251  0.1112942  -0.06241665
  0.11810257 -0.1838368  -0.04344601 -0.08730295 -0.08754975  0.06260104
 -0.02336557  0.01150582 -0.07861178 -0.04252569  0.15203165 -0.10085892
 -0.00072142  0.01738137  0.20987333  0.10102387  0.01646906 -0.05849835
 -0.21338788  0.04265477  0.04484015 -0.07211962 -0.12576418  0.1217806
 -0.15298802  0.06146162 -0.072516   -0.05523285 -0.05442924 -0.05183978
  0.16435184  0.00227955  0.15819138 -0.09672785  0.06951652 -0.01741732
  0.06482944 -0.09368659 -0.06855002  0.04402376 -0.14555973 -0.0347495
  0.07145251 -0.11022122 -0.04747614 -0.05698948 -0.03449067 -0.04256414
 -0.06748926  0.1299227  -0.15914488  0.10019467]","[-0.02280794 -0.13919947 -0.28047982  0.02055176  0.05719239  0.11580008
  0.21982583  0.08664732 -0.06486179 -0.10728963 -0.04538092 -0.0485174
 -0.02340238  0.0915816  -0.08403641 -0.03389406 -0.00680382  0.10322481
  0.08214781 -0.02023232 -0.01739727  0.05432794  0.02143495  0.10811873
  0.23230235  0.14707267  0.03343172  0.09869646 -0.02522595  0.01939251
  0.08936349 -0.079725   -0.07090753 -0.14112723  0.13800469 -0.0044158
 -0.00118626  0.09041351 -0.07368236 -0.0651512  -0.03746948 -0.0967169
 -0.03527454  0.01767246  0.02962421  0.1314824   0.04278544 -0.00958085
  0.1028138  -0.1680194   0.00360245 -0.09777321 -0.03135832  0.1338649
 -0.05140613 -0.07215084 -0.07555516 -0.02815823  0.17305858 -0.14494699
 -0.01413719 -0.01573827  0.24476083  0.14470093 -0.00722645 -0.05078406
 -0.16619018  0.04294062  0.03615962 -0.03229743 -0.07867274  0.08533599
 -0.1291659   0.07151608 -0.00589654 -0.00445574 -0.02803521 -0.09147019
  0.10225114 -0.02535055  0.10955609 -0.05982644  0.08245157 -0.01598702
  0.03577185 -0.06218307 -0.06432889  0.02448558 -0.102182   -0.02171448
  0.08405258 -0.11564184 -0.09899607 -0.02413773 -0.0364875  -0.01774029
 -0.01183339  0.17720269 -0.17135827  0.06180004]",0.42273632635531855,0
req,src,test_data/LibEST_semeru_format/requirements/RQ33-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.c,requir certif request est client request est databas inform form certif https get messag use oper path cacert est client server must support cacert function client request date respons store inform expir order ensur est databas date est server requir client authent author repli request client must authent est server specifi section certif base authent use section option certif less authent use check server author given section follow procedur outlin section,"author routin int ossl verifi int store ctx ctx int cert error store ctx get error ctx current cert store ctx get current cert ctx est log info enter function cert error cert error current cert name print stdout _get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% serror depth lookup ctx crl path """", cert_error ctx cert_error )); switch cert_error case enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok warn applic est_log_warn crl load tls peer allow .""); break case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error break return return function use load x509_store use raw data buffer data expect pem encod return number cert store static int x509_store store unsign char raw int size stack_of x509_info null x509_info bio int cert_cnt bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return load file stack x509 crl pkey set null null null null est_log_err unabl read pem encod cert bio ""); bio_fre return bio_fre scan pull crl sk_x509_info_num sk_x509_info_shift x509 null est_log_info cert store )"", x509 name x509_store_add_cert store x509 cert_cnt ++; crl null est_log_info crl store ""); x509_store_add_crl store crl x509_info_fre null sk_x509_info_pop_fre x509_info_fre return cert_cnt function use popul x509_store structur use open ssl tls stack verifi tls peer x509_store alreadi alloc paramet store pointer x509_store structur hold cert raw1 char array contain pem encod cert put store size1 length raw1 char array est_error ossl_init_cert_stor x509_store store unsign char raw1 int size1 x509_store_set_flag store int cnt raw1 cnt store raw1 size1 cnt est_log_err cert count zero store ""); return return est_err_non function use output open ssl error buffer use open ssl api call fail like provid detail user regard caus failur void ossl_dump_ssl_error bio null buf_mem bptr null bio_new bio_s_mem ()); est_log_err bio_new fail ""); return err_print_error void bio_flush bio_get_mem_ptr bptr est_log_warn ossl error bptr data bio_free_al /*! brief convert base64 encod pkcs7 respons est server pem format param certs_p7 point buffer contain base64 encod pkcs7 data param certs_len indic size certs_p7 buffer param pem doubl pointer receiv pem encod data sever est messag return data contain base64 encod pkcs7 certif function use convert data pem format function alloc memori point pem argument caller respons releas memori return valu length pem buffer error return int int unsign char certs_p7 int certs_len unsign char pem x509 stack_of x509 cert null bio b64 unsign char cacerts_decod null int cacerts_decoded_len bio p7bio_in null pkcs7 null int nid unsign char pem_data int pem_len base64 decod incom cert buffer decod alway take origin buffer b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); return bio_new_mem_buf certs_p7 certs_len est_log_err bio_new fail ""); return bio_push b64 cacerts_decod malloc certs_len cacerts_decod est_log_err malloc fail ""); return cacerts_decoded_len bio_read cacerts_decod certs_len bio_free_al get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); free cacerts_decod return d2i_pkcs7_bio p7bio_in null est_log_err pem_read_bio_pkcs7 fail ""); ossl_dump_ssl_error (); free cacerts_decod return bio_free_al p7bio_in free cacerts_decod decod cert get refer stack cert nid obj_obj2nid type switch nid case nid_pkcs7_sign cert sign cert break case nid_pkcs7_sign envelop cert signed_and_envelop cert break default est_log_err invalid nid valu pkcs7 structur ""); pkcs7_free return break cert est_log_err fail attain x509 cert stack pkcs7 data ""); pkcs7_free return output cert new bio use pem format bio_new bio_s_mem ()); est_log_err bio_new fail ""); pkcs7_free return sk_x509_num cert ++) sk_x509_valu cert pem_write_bio_x509 bio_put ""); void bio_flush convert bio char pem_len int bio_get_mem_data char **)& pem_data pem_len est_log_err bio_get_mem_data fail ""); pkcs7_free return pem malloc pem_len (!* pem est_log_err malloc fail ""); pkcs7_free return memcpy_ pem pem_len pem_data pem_len pem pem_len make sure null termiant bio_free_al pkcs7_free return pem_len","[ 0.02632169 -0.13015677 -0.2576756   0.01241919  0.01260467  0.09004859
  0.2522737   0.0503244  -0.02057564 -0.09379324 -0.07570851 -0.04538738
 -0.02038482  0.08483381 -0.0916789   0.05207106  0.01732369  0.08419213
  0.09666848  0.07116482  0.04296283  0.05562077  0.01688949  0.09372921
  0.22051851  0.1913325   0.00567104  0.15829857 -0.04957277  0.04840507
  0.01775323 -0.0656731  -0.02494764 -0.13087797  0.12939404 -0.01119166
  0.08547689  0.11410074 -0.03459496 -0.08953839  0.02660134 -0.07269314
 -0.02627142 -0.06148451  0.0649793   0.0992192   0.10960004 -0.06579403
  0.12387184 -0.17508304 -0.03775979 -0.0879233  -0.09097252  0.06230897
 -0.02053265  0.01097035 -0.0834973  -0.04603983  0.14861546 -0.09757554
 -0.00125907  0.02326394  0.20627224  0.09426762  0.01389263 -0.06107499
 -0.20708948  0.04099749  0.04427666 -0.06992828 -0.12265079  0.12332729
 -0.15010153  0.06142894 -0.07495775 -0.05751375 -0.04960462 -0.04639466
  0.16415969  0.0054016   0.16442753 -0.09568474  0.06602313 -0.0174561
  0.06275233 -0.09495432 -0.06722612  0.04163887 -0.14510216 -0.03485824
  0.06642866 -0.11390972 -0.04807076 -0.05707845 -0.03834479 -0.04216758
 -0.06322502  0.1319232  -0.15268102  0.10635325]","[-0.02280794 -0.13919947 -0.28047982  0.02055176  0.05719239  0.11580008
  0.21982583  0.08664732 -0.06486179 -0.10728963 -0.04538092 -0.0485174
 -0.02340238  0.0915816  -0.08403641 -0.03389406 -0.00680382  0.10322481
  0.08214781 -0.02023232 -0.01739727  0.05432794  0.02143495  0.10811873
  0.23230235  0.14707267  0.03343172  0.09869646 -0.02522595  0.01939251
  0.08936349 -0.079725   -0.07090753 -0.14112723  0.13800469 -0.0044158
 -0.00118626  0.09041351 -0.07368236 -0.0651512  -0.03746948 -0.0967169
 -0.03527454  0.01767246  0.02962421  0.1314824   0.04278544 -0.00958085
  0.1028138  -0.1680194   0.00360245 -0.09777321 -0.03135832  0.1338649
 -0.05140613 -0.07215084 -0.07555516 -0.02815823  0.17305858 -0.14494699
 -0.01413719 -0.01573827  0.24476083  0.14470093 -0.00722645 -0.05078406
 -0.16619018  0.04294062  0.03615962 -0.03229743 -0.07867274  0.08533599
 -0.1291659   0.07151608 -0.00589654 -0.00445574 -0.02803521 -0.09147019
  0.10225114 -0.02535055  0.10955609 -0.05982644  0.08245157 -0.01598702
  0.03577185 -0.06218307 -0.06432889  0.02448558 -0.102182   -0.02171448
  0.08405258 -0.11564184 -0.09899607 -0.02413773 -0.0364875  -0.01774029
 -0.01183339  0.17720269 -0.17135827  0.06180004]",0.42930696386904577,0
req,src,test_data/LibEST_semeru_format/requirements/RQ4-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir obtain certif est client request copi current est certif est server est client assum perform oper perform oper throughout document assum est certif use client verifi sign object issu certif certif revoc list crls differ certif one use verifi signatur certif crls use est protocol communic requir addit encrypt est client authent verifi author scope est server request current certif detail section avail option includ verifi est server https uri est server certif use implicit tas similar common https exchang allow est server client leverag exist tas might known est client client leverag previous distribut trust anchor specif est server allow est client use exist potenti older certif request current certif bootstrap est client reli upon manual authent perform end user detail section client leverag bind share credenti specif est server certif less tls cipher suit client authent requir exchang trivial support est server,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[ 0.02438382 -0.13098782 -0.26134843  0.0141317   0.01635077  0.09086808
  0.25437456  0.05226829 -0.02108167 -0.09430862 -0.07487638 -0.04470679
 -0.01916245  0.08903117 -0.09319656  0.0481416   0.01466362  0.08753572
  0.09618563  0.06717007  0.03886695  0.0574517   0.01630523  0.09496235
  0.22138612  0.19315523  0.00912732  0.15614879 -0.04969338  0.04788723
  0.02022095 -0.06570347 -0.02667379 -0.13700207  0.1358554  -0.00984788
  0.07960428  0.11284473 -0.03676623 -0.09324516  0.02088876 -0.07694186
 -0.02701836 -0.05481062  0.0652549   0.1016745   0.10913593 -0.06553815
  0.12230802 -0.17650937 -0.03599672 -0.08992325 -0.08652338  0.06704387
 -0.02321102  0.00812466 -0.07990809 -0.04363263  0.15058279 -0.10573684
 -0.00420333  0.01912562  0.2100557   0.10065673  0.0155339  -0.05976278
 -0.20887244  0.04145279  0.04830372 -0.06474237 -0.11708082  0.12058631
 -0.15258506  0.06195078 -0.07364008 -0.05825207 -0.04965248 -0.05126161
  0.16317919  0.00364245  0.16031404 -0.09429163  0.06530255 -0.02063966
  0.06301866 -0.09417819 -0.06767496  0.04113423 -0.14174202 -0.03428216
  0.07111481 -0.11451579 -0.04978564 -0.05516825 -0.03919421 -0.04388329
 -0.06074192  0.1321954  -0.15421632  0.1050766 ]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.34450372760436226,1
req,src,test_data/LibEST_semeru_format/requirements/RQ55-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,requir obtain certif follow exampl valid cacert exchang initi tls handshak client ignor option server generat certif request instead proceed http get request get well known est cacert http user agent curl linux gnu libcurl open zlib libidn librtmp host accept respons server provid current certif http status content type applic pkcs mime content transfer encod base content length miimoqyjko zihvc naqc iimkj ccdcycaqex adalbgkqhki bbw ggggw mmiic ccae ibag ijajp uzo gcsq gsib dqebbquambsx gtaxbg nvbamt egvzd gvdqsbpd hhc nmtmw nta mdm whc nmtqw nta mdm mrkw ydvqqdex blc rfe gftc gxl pmiibij anbgkqhki baqef aaocaq amiibcg kcaqeaw dqpi hopa icubp rqbp tiq welfia ddhe hikuy zap ksse buxdmox knyvtyjeh iof zwhgi lcegwr pba xza lvqc ceqj fms rluhfti rkw ukk pcf vfl yfqm uoqsa rti zbj qre zcz uhw mlowqk qtgo cpf ymju amk vcxlc wnkhf wbr orzril isl oumc dfasmdfbp osnfqidaqabo qdapbg nvhrmb ebtadaqh qwbbqittkx atxrfc ffp cibt gsz aobg nvhq ebamcaqyw dqyjko zihvc naqefbqadgg ebacpn qpu wre ugu cms boga pam ssi ydc dwh kmo xfqhdp ioy kadcx xkh mui bklwygdi hbe tmo nnw eli onsk hivo pmm imi fse xxld glk oqsh swz xlvcb umg andgj apip veeoc ulm vlqwa v84o ioji gm0c4xwc kkegc mos n3s4lvm8ptpq0glo ijy8ntd20wgg miib66adag ecag ebma0gcsq gsib3dqebbquambsx gtaxbg nvbamtegvzd ev4yw1w gvdqsbpd08w hhc nmtmw nta5mdm1mz whc nmtqw nta5mdm1mz mrkw vqqdex blc3rfe gftc gxl q0eg tnd pmiibij anbgkqhki kcaqeann3r z3r mjhwf7md9k4mubx havtdnr qf5ofgt ril4a pnh adg pyj8c lox d3utv q1vi pn7aciko onk rpjp opki kkv hmqxgn qtbs mav1q q6pvj n51iew ykks g7cglw 5jbwh yr2d gltri rvix pwrvt itp5rcjh 8rs3le8t qy3k tnh jf3i r2s png ito catysba inepr4memq ml4t g9i 8qe7s1li mfv dletp2mm byk oat b0s n524d1xagz8zkv wrkh or3hw idaqabo1iw udaobg nvhq8baf8ebamcblaw hqydvr0obbyeflhea zbow sn2jejizu wqi i8mb8ga1ud qymba afah nmr bnet9zh9 ihu3oaz psma0gcsq l7a lnv6h sok v9ylo56 tj00v v5skg dhk5d0b ogort kvu ga57 v0av trl jns3b nw8ntv dehmd00ak02a psi4w rhlfgtt uf9hd ehau aesptu43diptjkf hht bmfs ckd domhyf uekh rvv 1zi gex6ov1ap2iu2p3 asih amx teqasbwj uti r52zo l6n mpzpb zi2m0 ebvf8 due a9hjo6wo ljg yc5v c2hax uohx0c wti rbg qlki y5tkbh951oj q4vh f2hmco o7dkc nlyjoge16ssx4og bhul20vg xjjj miidaz ccaeug ibag ibaj anbgkqhki g9w0baqufadab mrkw ydvqqdex c3rfe gftc gxl q0eg tnd omb4xdtez mduw otaz ntmz mlo xdte0mduw otaz ntmz mlow ezmbc ga1ueax mqzxn0rxhhb xbs zunbie93tj ccasiw dqyjko zihvc naqebbqad epadccaqo cgg ebama6q yh6kwi arm6uam6rdey6ki klh sapagw4xhi crsjh1v 2qd 0ze wvoo gi1v5llhg vmxzq mdyjcr7co3o skh07tv ymuvywh blkdzyvn 4dw qnjd cxi tlpm4m b9l6f0zbo x7cme zm0mh9rbr ezmnf6l e2f dwhf frzwh6pl kkr u8m w4i cocfm ov4x bvqe0k3lvc3m ld3v n3p 7oc dczlk jgb elykoqq x2di7g oeno6ektr3mzxplj sh3 g6w29d wa4pf spe klpn ec97g wio8 n4xq32r x26f idkj rucaw eaaa nsmfaw ydvr0paqh baqdag mb0ga1ud qwbbqittkx atxrfc4ffp cibt6gsz0j nvhsmegdaw bsxx gnm w6mep9i xo4s7v7lqsj jcpdanbgkqhki g9w0baqufaaocaqealh e6mp binb jozdb xlijr l1csv8f4gwp ufk3cg zjibt w9uoa nr4e58i ropu ehjw fzk 2w8yt rqx8izo fhco lkp bdfg llwhoztzb ovkqmidj blk bevnr5mwdrs7f wuy 8an r8gwq eib cd0a7x ighm wemh bvi9c7glqd6px taju epfd ykm l3xdb swr30j2eqya 3w0tn2ufuxdw dq4zjs9g mw50s7ag6cp isi oifm jxgli lwf j9c aum9nyl gcj68bu cs9567kgf xexi0md ffcl7ta vr43kjsg3 c43k z7369me ezz ccavswgg hjo amcaqiccqdprp3dmj etanbgkqhki g9w0baquf adab mrkw ydvqqdex blc3rfe gftc gxl q0eg tnd omb4xdtez mduw otaz ntmz mlo dte0mduw otaz ntmz mlow ezmbc ga1ueax mqzxn0rxhhb xbs zunbie53tj ccasiw dqyjko zihvc naqebbqadgg epadccaqo cgg ebaj5962d6z cr8h jrm8rw l7x z67eh tn4ltiusc gnjz yqhyd8o apa mto a91e1fn unvyjs1c tze2n kdp5chua y6tq zmj kpip lxz efxp0e27dal9alrf utdgz nbjg nxu bnt7ne wdzk0f6uj74z sbmgcp lbuwo afu sw8iwk9g 9lm7rpba4k vys t1q77fs e6ea3i4f eutyx plumt5ez ysrd2p3r edr dojz ycla e8r g2i drd6 dhpqj lq6uf2hvcvv ehu7 ns8j bbw5xradppgcp aav 5zmrf6c fjqd ldedu a9vw gsr1q5ifm wjq94c caw ncmeaw ydvr0taqh bauw nvhq4efg qusc rp5luj bkf yl6olo7 qjww ydvr0paqh baqdag egma0gcsq cwd yvn eiom5a1vxa w8n cwg aiia hqu tuae9lona2mb fhw8u5e8 cp0r a9uyxxh fqzd5zwpms4w uyt1j3gqqd36kor jiau pig vng13i kytx m7c vmx qnh0aux3a rgah gal hp0ra kdg prz gtip jtnbk sv5s4k d4i dcphmnb ocluerw epbz6gv e7cp xl2jr tbzsq felq0iz4kk9 9cnw zwr vgdzklh j1z4j lruwb o4nv bzs nfn3k2o3sk8aua dwkq18 5rjcfpr ro8x4ytw xpq m0magndew qax,"function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 0.00447892 -0.11617817 -0.28854927  0.01061949  0.06629576  0.10656037
  0.2311487   0.08998039 -0.02469804 -0.11714841 -0.04550915 -0.04779466
 -0.01120913  0.10914169 -0.08880638 -0.00734462 -0.03025339  0.1154425
  0.08412931  0.00548849 -0.02587972  0.08153018  0.01370875  0.10828437
  0.22300564  0.18368562  0.0410941   0.12025899 -0.05337133  0.04198923
  0.05854587 -0.07985628 -0.05391787 -0.18009898  0.16956742 -0.0128517
  0.01394041  0.09088042 -0.05858231 -0.1188051  -0.04814189 -0.11949833
 -0.04836361  0.00766622  0.04903623  0.1262076   0.09155334 -0.03825193
  0.09521507 -0.18748453 -0.01821277 -0.09794547 -0.03042909  0.12252503
 -0.05615925 -0.04228884 -0.0485429  -0.02074126  0.16879569 -0.16072597
 -0.03114848 -0.02174028  0.23549508  0.15507524  0.01822429 -0.0264469
 -0.2021854   0.04367545  0.0632642  -0.03260459 -0.05556032  0.09493287
 -0.1488383   0.06237729 -0.03213459 -0.03922716 -0.04101633 -0.09592195
  0.12518898 -0.01246657  0.08944256 -0.08594869  0.06995909 -0.04600859
  0.07221036 -0.07687785 -0.08226904  0.03661688 -0.10535643 -0.01188542
  0.10836085 -0.11915584 -0.07904644 -0.01813637 -0.03271008 -0.05426972
 -0.02998712  0.14062606 -0.17540434  0.0656574 ]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.3473998068490129,1
req,src,test_data/LibEST_semeru_format/requirements/RQ1-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir document profil certif enrol client use certif manag cms cmc rfc messag secur transport enrol secur transport est describ use transport layer secur tls rfc rfc futur version hypertext transfer protocol http rfc provid authent author channel simpl public key infrastructur pki request respons rfc architectur est servic locat certif author client perform sever function tradit alloc registr author role pki natur communic est server describ document est adopt certif manag protocol cmp rfc model certif rollov use cmp messag syntax protocol est server extens new function may defin provid addit capabl specifi cmc rfc document defin two extens one request certif sign request attribut anoth request server generat key est specifi transfer messag secur via http tls https rfc http header media type use conjunct tls https oper tcp document specifi est http datagram transport layer secur user datagram protocol http dtls udp suitabl specif combin http dtls udp est requir would prevent work stack figur show layer build upon est layer protocol est request respons messag http messag transfer signal tls transport secur tcp transport figur,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.02284028 -0.12077426 -0.26966238  0.00974358  0.0310018   0.095249
  0.24923563  0.0638282  -0.01765209 -0.10512701 -0.06701693 -0.0433536
 -0.01471999  0.09761204 -0.09092212  0.03648291  0.00036775  0.09900626
  0.09235761  0.05497847  0.02151929  0.06737054  0.01430776  0.09609676
  0.22207929  0.19286954  0.01787076  0.14816473 -0.05192499  0.04967792
  0.02831225 -0.06750308 -0.03138851 -0.15244515  0.14888155 -0.0123314
  0.06254578  0.10739353 -0.04158305 -0.10440334  0.0026153  -0.08868862
 -0.03611577 -0.04065555  0.06363716  0.10882507  0.10696664 -0.06085839
  0.11297515 -0.18137185 -0.0357108  -0.09375731 -0.07262033  0.07879873
 -0.0328069  -0.00056451 -0.06799909 -0.03973329  0.15565492 -0.12098384
 -0.01178951  0.00629229  0.21225332  0.11609561  0.01980201 -0.04898002
 -0.2113368   0.04263633  0.05346652 -0.05715531 -0.10148075  0.1149331
 -0.1530971   0.06037368 -0.06317425 -0.05398037 -0.04689009 -0.06444343
  0.1560771   0.0002928   0.13693348 -0.09499977  0.06419823 -0.02981238
  0.07016631 -0.08957378 -0.07319229  0.04192101 -0.13329715 -0.02868743
  0.08018683 -0.11771093 -0.05716359 -0.04584751 -0.03490083 -0.05162573
 -0.05376758  0.12657598 -0.16078262  0.09604326]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.34621327451092604,0
req,src,test_data/LibEST_semeru_format/requirements/RQ49-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir csr attribut respons local configur polici authent est client indic csr attribut respons provid server respons must includ http respons code http respons code indic csr attribut respons avail regardless respons code est server may reject subsequ enrol request reason incomplet csr attribut request respons attribut request messag must encod content type applic csrattr content transfer encod base rfc syntax applic csrattr bodi follow csr attr sequenc size max attr oid attr oid choic oid object identifi attribut attribut attribut attribut ioset sequenc type attribut ioset valu set size max attribut type ioset type est server includ zero oid attribut rfc request client use certif request client must ignor oid attribut recogn server encod csr attribut empti sequenc mean server specif addit inform desir client certif request function equival http respons code requir particular crypto system use particular signatur scheme certif public key base certain ellipt curv sign use certain hash algorithm must provid inform csr attribut respons est server requir link ident pop inform see section must includ challeng password oid csr attribut respons structur csr attribut respons greatest extent possibl reflect structur csr request request use particular signatur scheme use particular hash function repres oid reflect signatur algorithm csr request use particular crypto system certif public key base certain ellipt curv repres attribut reflect algorithm identifi subject public key info type indic algorithm valu indic particular paramet specif algorithm request descript inform client made attribut repres attribut csr type indic rfc extens request valu indic particular attribut desir includ result certif extens sequenc distinguish encod rule der encod base encod section rfc result text form applic csrattr bodi without header exampl request client submit certif request contain challeng password indic link ident pop inform request see section extens request media access control mac address rfc client use secp ellipt curv sign sha hash function take follow oid challeng password attribut type extens request valu mac address attribut type public key 840 10045 valu secp384r1 132 oid ecdsa sha384 840 10045 encod asn sequenc produc base64 encod result asn sequenc produc meegcsq gsib3dqejbz asbgcqhkj opqibmqc gbsu bbaai mbygcsq gsib3dqejdj bgcr ebaqewbggqhkj opqqdaw,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.02143563 -0.11755752 -0.27468386  0.00466786  0.04018066  0.10122033
  0.24755359  0.06902635 -0.02063513 -0.11381162 -0.06687876 -0.04369671
 -0.01805617  0.09634093 -0.08602762  0.02641561 -0.00204484  0.09868195
  0.0896062   0.04765042  0.01748905  0.06798459  0.00850443  0.09525166
  0.22741055  0.18583071  0.01774214  0.14298098 -0.04517163  0.04734974
  0.03304495 -0.07350547 -0.03479632 -0.14851081  0.1460247  -0.01322859
  0.05535612  0.11085464 -0.04415503 -0.098883   -0.00378311 -0.08499429
 -0.03791551 -0.03890606  0.05780213  0.1107566   0.09650908 -0.05266955
  0.10772912 -0.18235703 -0.03588135 -0.09420495 -0.07086648  0.08135846
 -0.03635812 -0.00968211 -0.06941737 -0.03942946  0.162586   -0.11828196
 -0.00903836  0.00343819  0.21899763  0.12090989  0.01789206 -0.04736782
 -0.20423816  0.04461528  0.04390687 -0.06099513 -0.10749847  0.11185439
 -0.14870533  0.06058955 -0.05386962 -0.04206748 -0.04671936 -0.06632178
  0.14972821 -0.00463358  0.13290621 -0.09220652  0.0717117  -0.02640405
  0.06952386 -0.08332644 -0.0747985   0.03860429 -0.13528588 -0.0301439
  0.07576589 -0.12135252 -0.06361742 -0.04387866 -0.03515015 -0.0446384
 -0.05381896  0.12861839 -0.16765195  0.09312891]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.3290017387808869,0
req,src,test_data/LibEST_semeru_format/requirements/RQ13-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir protocol design layer figur provid expans figur describ layer use aspect describ detail section follow est layer protocol use messag type simpl pki messag incorpor proof possess certif retriev full pki messag option incorpor proof possess csr attribut request option server generat key request option http http header uri control content type header specifi messag type header control error messag uri select function basic digest authent option tls transport secur authent est server authent est client option provid communic integr confidenti suppli channel bind rfc5929 inform link proof ident messag base proof possess option figur specifi https secur transport enrol messag introduc two layer communic authent control messag tls http tls layer provid integr confidenti transport proof ident suppli tls handshak authent option also http layer header messag type control error messag includ http header cmc rfc5272 section note simpl pki request must use proof ident need includ sinc tls http layer provid proof ident est client server simpl pki messag type use tls layer certif exchang provid method author client enrol request use exist certif certif may issu client request certif may issu distinct pki ieee 802 1ar initi devic identifi idev idev credenti proof possess pop distinct issu proof ident includ simpl pki messag type describ section method link proof ident proof possess describ section document also defin transport cmc rfc5272 compli cmc transport protocol rfc5273 cmc pop proof ident mechan defin cmc mechan also use conjunct mechan full pki messag protocol exchang differ certif use follow tabl provid inform overview end entiti one certif type list figur use one trust anchor databas type list figur certif correspond use certif issuer use section refer est server serv present est server certif est server tls handshak section est server present est server certif authenticat tls handshak third parti web server section secur consider third parti present est client est client authenticat est server client certif third parti yet enrol devic manufactur section est client serv present est server certif est server futur est oper section end entiti serv client obtain cert certif est server intend non est use includ cert cannot use est oper section figur trust anchor databas correspond use databas use section refer est server est server use databas authent explicit certif issu est includ est databas client certif enrol enrol oper section est server est server use databas authent implicit certif issu third parti tas databas est client certif issu devic manufactur implicit databas disabl section est client est client use databas authent explicit certif issu est includ est databas server certif section est client est client use databas implicit authent est server use extern databas issu certif implicit databas disabl section secur consider figur,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.02657052 -0.12036944 -0.26600012  0.00769731  0.02519619  0.09288459
  0.25211862  0.05701216 -0.01458956 -0.10315142 -0.07204935 -0.04307814
 -0.01753975  0.0918503  -0.09113381  0.04400409  0.00530834  0.09245326
  0.09301442  0.06330608  0.029698    0.06563444  0.01179966  0.09417477
  0.22073424  0.19526982  0.01328366  0.15423985 -0.05215363  0.05093993
  0.01829844 -0.06766375 -0.02699149 -0.14411442  0.14303838 -0.01353413
  0.07248268  0.11295755 -0.03767674 -0.10352062  0.01059605 -0.08310931
 -0.03325747 -0.05130202  0.06405777  0.10393772  0.11089683 -0.06294422
  0.11399092 -0.18142961 -0.04011103 -0.09035882 -0.08026907  0.06851946
 -0.02783009  0.00620223 -0.07116716 -0.04109729  0.15358302 -0.11183792
 -0.0082901   0.01096577  0.21020721  0.10914733  0.0199991  -0.05213115
 -0.21127588  0.04138465  0.05004081 -0.06428101 -0.11133707  0.11746637
 -0.15366139  0.05925317 -0.0694292  -0.05662212 -0.05164877 -0.05942052
  0.16088142  0.00261978  0.14584544 -0.09660456  0.06596328 -0.0266951
  0.0698906  -0.09136602 -0.07157568  0.04181428 -0.13868223 -0.03170133
  0.07565615 -0.11579034 -0.05002736 -0.05038233 -0.03448498 -0.04919431
 -0.0617221   0.12435626 -0.15915889  0.09953406]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.509545775243049,1
req,src,test_data/LibEST_semeru_format/requirements/RQ2-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_http.c,requir terminolog key word must must requir shall shall recommend recommend may option document interpret describ rfc assum reader familiar term concept describ public key cryptographi standard pkcs rfc https rfc cmp rfc cmc rfc rfc rfc tls rfc addit term defin terminolog section cmc rfc follow term defin clariti est certif issu servic est reach est server could logic behind est server embed within third parti trust anchor trust anchor authorit pki hierarchi est server provid servic explicit trust anchor explicit configur client server use est tls authent exampl manual configur est client bootstrap describ section see detail section implicit trust anchor third parti avail client server use tls authent specif indic use est tls authent exampl tas common use web browser authent web server tas use server authent manufactur instal client credenti certif popul cabl modem router factori author model tas differ author model explicit trust anchor see detail section certif less tls certif less tls cipher suit provid way perform mutual authent situat neither client server certif will use credenti use authent word phrase code key share client server credenti must uniqu share client server order provid authent individu client individu server,"sign long sign int int curlx sltosi long slnum ifdef intel compil pragma warn push pragma warn disabl convers may lose signific bit endif assert slnum sizeof int curl sizeof long assert unsign long slnum unsign long curl mask sint endif return int slnum long curl mask sint ifdef intel compil pragma warn pop endif parsed return parsed fine convers parsed fail fail convert parsed later time overflow far end time parsed sooner time underflow low end time static int parsed const char date time output return day monday sunday static int checkday const char check size len int const char const int found len weekday els curl wkday est client curl raw equal check found break return found return day monday sunday static int checkmonth const char check int const char const int found curl month est client curl raw equal check found break return found return offset real offset return time zone offset gmt input one number second timezon found legal static int checktz const char check unsign int const struct tzinfo int found sizeof sizeof ]); ++) check name found break ++; return found offset return time zone offset gmt input one number second timezon found legal static void skip_over_whit const char date skip everyth letter digit (** date isalnum (** date date )++; struct time sinc epoch gmt time zone similar standard mktime function gmt suffer various bug portabl problem system implement static time_t my_timegm struct my_tm static const int month_days_cumul 120 151 181 212 243 273 304 334 int month year leap_day tm_year support year 1970 caus function return negat valu return year tm_year 1900 month tm_mon month year month month month els month year month month month leap_day year tm_mon leap_day leap_day leap_day 100 leap_day 400 1969 1969 100 1969 400 )); return (((( time_t year 1970 365 leap_day month_days_cumul month tm_mday tm_hour tm_min tm_sec parsed return parsedate_ok fine convers parsedate_fail fail convert parsedate_lat time overflow far end time_t parsedate_soon time underflow low end time_t static int parsed const char date time_t output time_t int wdaynum day week number mon sun int monnum month year number int mdaynum day month int hournum int minnum int secnum int yearnum int tzoff struct my_tm enum assum dignext date_mday const char indat date save origin pointer int part max part date part int found skip_over_whit date isalpha date name come char buf ]=""""; size_t len sscanf date ]"", buf len strnlen_ buf wdaynum wdaynum checkday buf len wdaynum found found monnum monnum checkmonth buf monnum found found tzoff must time zone string tzoff checktz buf tzoff found found return parsedate_fail bad string date len els isdigit date digit int val char end secnum sscanf date 02d 02d 02d hournum minnum secnum ))) time stamp date els secnum sscanf date 02d 02d hournum minnum ))) time stamp without second date secnum els long lval int error int old_errno old_errno errno set_errno lval strtol date end error errno error old_errno set_errno old_errno error return parsedate_fail lval long int_max lval long int_min return parsedate_fail val curlx_sltosi lval tzoff end date val 1400 indat date date date -'))) four digit valu less equal 1400 take account sort funni time zone diff preced plus minus time zone indic 1400 pick sinc 1300 frequent use 1400 mention edg number document iso 200x propos timezon function http :// david tribbl com text c0xtimezon html anyon authorit sourc exact maximum time zone offset pleas speak found tzoff val 100 val 100 prefix indic local time compar gmt need ther revers math get want tzoff date ]=='+'?- tzoff tzoff ((( end date yearnum monnum mdaynum digit year month day yet yyyymmdd found yearnum val 10000 monnum val 10000 100 month mdaynum val 100 found dignext date_mday mdaynum val val mdaynum val found dignext date_year found dignext date_year yearnum yearnum val found yearnum 1900 yearnum yearnum 1900 els yearnum 2000 mdaynum dignext date_mday found return parsedate_fail date end part ++; secnum secnum minnum hournum time make zero ((- mdaynum monnum yearnum lack vital info fail return parsedate_fail sizeof_time_t bit time_t hold date begin 2038 yearnum 2037 output 0x7fffffff return parsedate_lat endif yearnum 1970 output return parsedate_soon mdaynum monnum hournum minnum secnum return parsedate_fail clear illeg date tm_sec secnum tm_min minnum tm_hour hournum tm_mday mdaynum tm_mon monnum tm_year yearnum 1900 my_timegm return time_t time_t often bit even mani architectur featur bit long system bit time_t deal year beyond 2038 howev even system bit time_t mktime return date beyond utc januari 2038 aix 5100 my_timegm time zone adjust cast int compar negat one int add time zone diff local time zone gmt long delta long tzoff !=- tzoff delta delta return time_t overflow delta output return parsedate_ok find next field --------------- find next rfc822 token string entri pstr point string contain word separ white white space "","" "";"" ""="". word option quot use <""> ""<"" "">"" comment surrround filter exit pstr move first delimit past field string mutil termin return pointer first word null error static char htnext field char pstr char char start null pstr pstr return null pstr strip white space delimit isspac int =')) ++; (!* pstr return null field ""') quot field start ""'; ++) ++; skip escap char break kr95 need stop els <') quot field start >'; ++) ++; skip escap char break kr95 need stop els (') comment )'; ++) ++; skip escap char ++; els spool field start isspac int =') ++; break got pstr return start function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static est_error est_ctx ctx char hdr int est_err_non char hdr char token null char valu null int diff errno_t safec_rc header come basic digest field still front skip token htnext field token htnext field ))) est_strcasecmp_ token realm "")) valu htnext field ))) eok strncpy_ ctx realm max_realm valu max_realm els els est_strcasecmp_ token nonc "")) valu htnext field ))) eok strncpy_ ctx s_nonc max_nonc valu max_nonc els els est_strcasecmp_ token qop "")) valu htnext field ))) valu est_log_warn unsupport qop valu valu els safec_rc memcmp_ valu sizeof auth ""), auth sizeof auth ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff safec_rc eok est_log_warn unsupport qop valu valu els els est_strcasecmp_ token algorithm "")) valu htnext field est_strcasecmp_ valu md5 "")) est_log_err unsupport digest algorithm valu support md5 moment els est_strcasecmp_ token error "")) valu htnext field ))) eok strncpy_ ctx token_error max_token_error valu max_token_error els els est_strcasecmp_ token error_descript "")) valu htnext field ))) eok strncpy_ ctx token_error_desc max_token_error_desc valu max_token_error_desc els els est_log_warn unsupport auth token ignor token memzero_ ctx s_nonc max_nonc break return function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static http_header parse_http_head unsign char buf int num_head int http_header hdrs char hdr_end errno_t safec_rc num_head hdrs malloc sizeof http_header max_head hdrs est_log_err malloc failur ""); return null find offset header delimint safec_rc strstr_s char buf strnlen_ char buf rsize_max_str hdr_end safec_rc eok est_log_info strstr_s error safec_rc skip first line skip char **) buf ""); max_head ++) hdrs name skip_quot char **) buf "":"", hdrs valu skip char **) buf ""); fflush stdout est_log_info found http header hdrs name hdrs valu fflush stdout hdrs name break num_head ((* buf unsign char hdr_end break est_log_info found http header num_head return hdrs function pars http status code first header hand code handl est full http stack unrecogn code result error note http expect static int unsign char buf strncmp const char buf est_http_hdr_200 strnlen_ est_http_hdr_200 est_http_hdr_max ))) return 200 els strncmp const char buf est_http_hdr_202 strnlen_ est_http_hdr_202 est_http_hdr_max ))) return 202 els strncmp const char buf est_http_hdr_204 strnlen_ est_http_hdr_204 est_http_hdr_max ))) return 204 els strncmp const char buf est_http_hdr_400 strnlen_ est_http_hdr_400 est_http_hdr_max ))) return 400 els strncmp const char buf est_http_hdr_401 strnlen_ est_http_hdr_401 est_http_hdr_max ))) return 401 els strncmp const char buf est_http_hdr_404 strnlen_ est_http_hdr_404 est_http_hdr_max ))) return 404 els strncmp const char buf est_http_hdr_423 strnlen_ est_http_hdr_423 est_http_hdr_max ))) return 423 els est_log_err unhandl http respons buf return function search process www authent header server result set auth_mod valu context www authent header valu header invalid set auth_mod failur set multipl authent header first one process static void est_ctx ctx http_header hdrs int hdr_cnt int est_error int auth_found walk header look www authent process first one erron second one includ ignor hdr_cnt ++) strncmp hdrs name est_http_hdr_auth auth_found strncmp hdrs valu basic ctx auth_mod auth_bas pars realm ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu digest ctx auth_mod auth_digest pars realm nonc ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu bearer ctx auth_mod auth_token pars realm possibl token error field ctx hdrs valu est_err_non ctx auth_mod auth_fail els est_log_err unsupport www authent method ""); ctx auth_mod auth_fail break auth_found est_log_err www authent header found ""); ctx auth_mod auth_fail return function take list header server respons walk header look retri respons header one found valu pars save away est context valu one two format repres ascii string first format count number second client wait retri request second format time date stamp point time client retri request result function set retry_aft valu context retri header receiv receiv could pars valu zero otherwis set valu receiv note est client current support time date format respons process respons format static est_error est_ctx ctx http_header hdrs int hdr_cnt est_error int int cmp_result diff int long long int temp_ll int found initi assum retri header ctx retry_after_delay ctx retry_after_d hdr_cnt ++) cmp_result strcasecmp_ hdrs name sizeof diff cmp_result eok diff est_log_info retri valu hdrs valu found determin whether valu date time string integ repres number second client must wait isalpha (*( char hdrs valu ifdef int convert date time string time_t parsed hdrs valu ctx retry_after_d parsedate_ok est_log_err retri valu could pars ""); els format current support est_log_err retri valu correct format ""); endif els make sure digit make sure larger four byte integ cach away valu return retri delay strisdigit_ hdrs valu max decim place temp_ll atol hdrs valu temp_ll int_max ctx retry_after_delay int temp_ll els est_log_err retri valu larg ""); els est_log_err retri valu could pars ""); found est_log_err retri header miss ""); return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int http_header hdrs int hdr_cnt est_oper int int int content_type_pres content_length_pres int cmp_result travers http header process one need check hdr_cnt ++) content type memcmp_ hdrs name sizeof est_http_hdr_ct est_http_hdr_ct sizeof est_http_hdr_ct cmp_result cmp_result content_type_pres verifi content pkcs7 data memcmp_ hdrs valu strnlen_ est_op_map content_typ est_op_map length est_op_map content_typ strnlen_ est_op_map content_typ est_op_map length cmp_result cmp_result est_log_err http content type hdrs valu return els content length memcmp_ hdrs name sizeof est_http_hdr_cl est_http_hdr_cl sizeof est_http_hdr_cl cmp_result cmp_result content_length_pres atoi hdrs valu make sure necessari header present content_type_pres est_log_err miss http content type header ""); return els content_length_pres est_log_err miss http content length header ""); return return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int est_ssl_read ssl ssl unsign char buf int buf_max int sock_read_timeout int timeout int read_fd int struct pollfd pfd load timev struct pass select timeout sock_read_timeout 1000 read_fd ssl_get_fd ssl pfd read_fd pfd event pollin pfd revent errno poll pfd timeout est_log_err socket poll timeout data receiv server .""); return els est_log_err socket read failur errno errno return els return ssl_read ssl buf buf_max )); function extract data ssl context put buffer static int est_io_read_raw ssl ssl unsign char buf int buf_max int read_cnt int sock_read_timeout int cur_cnt char peek_read_buf read_cnt cur_cnt est_ssl_read ssl buf buf_max sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt multipl call ssl_read may requir get full http payload cur_cnt read_cnt buf_max cur_cnt est_ssl_read ssl buf read_cnt buf_max read_cnt sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt ((* read_cnt buf_max ssl_peek ssl peek_read_buf est_log_err buffer small receiv messag ""); return return est_err_non function provid primari entri point modul use est client read http respons server data read ssl context http pars invok est_err_non return raw_buf buffer must freed caller otherwis freed est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len int est_err_non http_header hdrs int hdr_cnt int http_status unsign char raw_buf payload_buf payload int raw_len raw_buf malloc est_ca_max raw_buf null est_log_err unabl alloc memori ""); return est_err_malloc memzero_ raw_buf est_ca_max payload raw_buf read raw data ssl connect est_io_read_raw ssl raw_buf est_ca_max raw_len ctx read_timeout est_err_non est_log_info valid respons process ""); free raw_buf return raw_len est_log_warn receiv empti http respons server ""); free raw_buf return est_log_info read byte http data raw_len pars http header get status look status 200 success http_status raw_buf ctx last_http_status http_status hdrs parse_http_head payload hdr_cnt est_log_info http status receiv http_status check status header first see server accept request switch http_status case 200 server report noth break case 204 case 404 est_log_err server respond 204 404 content found ""); est_op_csrattr est_err_non els http_status 404 els est_err_unknown break case 202 server ask retri est_log_info est server respond retri ""); ctx hdrs hdr_cnt break case 400 est_log_err http respons est server bad request ""); est_err_http_bad_req break case 401 server request user auth credenti est_log_info est server request user authent ""); check alreadi tri authent bail first time auth_mod set none ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token ctx auth_mod auth_fail est_err_auth_fail break ctx hdrs hdr_cnt est_err_auth_fail break case 423 est_log_err server respond 423 content attempt access lock ""); est_err_http_lock break case unsupport http respons est_log_err unsupport http respons est server )"", http_status est_err_unknown break default http respons given want handl est_log_err http respons est server http_status break est_err_non get content type content length header verifi http respons contain correct amount data payload_len hdrs hdr_cnt est_log_info http content len payload_len payload_len est_ca_max est_log_err content length larger maximum valu ."", est_ca_max est_err_unknown payload_len buf null els payload_len payload_len buf null els alloc buffer hold payload pass back payload_buf malloc payload_len payload_buf est_log_err unabl alloc memori ""); free raw_buf free hdrs return est_err_malloc memcpy_ payload_buf payload_len payload payload_len buf payload_buf raw_buf free raw_buf hdrs free hdrs return","[ 2.07649991e-02 -1.23978503e-01 -2.67159611e-01  1.30387805e-02
  2.72379238e-02  9.25438255e-02  2.48097673e-01  6.15683980e-02
 -1.89826228e-02 -1.00402072e-01 -6.73580691e-02 -4.38584648e-02
 -1.54374503e-02  9.61187184e-02 -9.23477560e-02  3.81437652e-02
  3.98038188e-03  9.61137637e-02  9.22925770e-02  5.54877557e-02
  2.39771102e-02  6.58327118e-02  1.46603864e-02  9.60533172e-02
  2.19410419e-01  1.91637903e-01  1.71471834e-02  1.48857161e-01
 -5.19462526e-02  4.78976518e-02  2.74605285e-02 -6.68648630e-02
 -3.10950298e-02 -1.49806589e-01  1.44800693e-01 -1.10108415e-02
  6.46093562e-02  1.06654502e-01 -4.08820063e-02 -1.03157014e-01
  5.78791602e-03 -8.80751163e-02 -3.46440189e-02 -4.03746106e-02
  6.40682504e-02  1.06157422e-01  1.07702062e-01 -6.19764514e-02
  1.14483289e-01 -1.79105714e-01 -3.47319804e-02 -9.35924500e-02
 -7.40223303e-02  7.71135464e-02 -3.00947558e-02 -1.19986267e-04
 -6.99129924e-02 -3.98511849e-02  1.52865112e-01 -1.18956573e-01
 -1.12027526e-02  8.59872717e-03  2.12367073e-01  1.13323547e-01
  1.84823927e-02 -5.22320047e-02 -2.10016459e-01  4.18052226e-02
  5.44632412e-02 -5.76656982e-02 -1.00603886e-01  1.15542866e-01
 -1.51536003e-01  6.05084300e-02 -6.55100197e-02 -5.66768460e-02
 -4.56210077e-02 -6.13810308e-02  1.55998811e-01  1.74423866e-03
  1.41226783e-01 -9.38318819e-02  6.19892403e-02 -2.93949302e-02
  6.78196102e-02 -9.01478902e-02 -7.21427798e-02  4.08927873e-02
 -1.33510277e-01 -2.93874368e-02  7.92512447e-02 -1.16184101e-01
 -5.59945144e-02 -4.67266217e-02 -3.56314331e-02 -4.92527708e-02
 -5.34678958e-02  1.30352095e-01 -1.57004431e-01  9.66723338e-02]","[-0.00987736 -0.11911407 -0.2841379   0.00779026  0.07010551  0.11020532
  0.21956828  0.08649327 -0.0472606  -0.11266565 -0.04507514 -0.04941731
 -0.02074194  0.09147213 -0.08542818 -0.0242101  -0.0258745   0.10481261
  0.08187146 -0.02030602 -0.02759121  0.06745998  0.00749176  0.10427962
  0.227792    0.1629232   0.03945069  0.10436959 -0.03800827  0.03180632
  0.06665646 -0.08501376 -0.06131442 -0.15126903  0.14578922 -0.01711159
 -0.00118449  0.09328528 -0.06543815 -0.09235742 -0.05367571 -0.10725161
 -0.03737934  0.01557842  0.02767696  0.12949339  0.06183678 -0.01494845
  0.09363889 -0.18110369 -0.0098926  -0.09057959 -0.01962026  0.13053118
 -0.05518321 -0.06301711 -0.05672394 -0.01362461  0.17390853 -0.15026285
 -0.02201219 -0.02932046  0.242307    0.15510128  0.00329678 -0.03584385
 -0.17889638  0.04433239  0.03926572 -0.03635661 -0.06652797  0.08144163
 -0.1339039   0.06515578 -0.00812013 -0.01195321 -0.03717465 -0.09508131
  0.10198383 -0.02140859  0.09113996 -0.07103333  0.08522316 -0.02457515
  0.05434166 -0.06651933 -0.07538471  0.02887119 -0.10447777 -0.01726953
  0.09799939 -0.1103819  -0.09234454 -0.01928411 -0.02889781 -0.03046735
 -0.02491977  0.16676706 -0.17673336  0.04843231]",0.3382881061171823,0
req,src,test_data/LibEST_semeru_format/requirements/RQ19-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir messag type document use exist media type messag specifi ftp http rfc applic pkcs rfc cmc rfc consist rfc distinct est messag type use http content type header specif media type est messag correspond media type oper messag type request media type request section respons media type respons section per oper sourc type distribut section certif applic pkcs mime section rfc cacert client certif applic pkcs10 section request function applic pkcs7 mime section rfc5967 rfc5751 simpleenrol simplereenrol full cmc applic pkcs7 mime section applic pkcs7 mime section fullcmc rfc5751 server side key applic pkcs10 section generat multipart mix section applic pkcs7 mime applic pkcs8 rfc5967 rfc5751 serverkeygen rfc5958 csr attribut section applic csrattr section document csrattr figur,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.02480437 -0.11728615 -0.26795545  0.00619919  0.03287434  0.09476029
  0.24743827  0.06529675 -0.01310141 -0.10482081 -0.06616237 -0.0425465
 -0.01393973  0.10133674 -0.08952554  0.03560685 -0.00479299  0.09998573
  0.09146743  0.0510737   0.01796927  0.07160509  0.01316675  0.09596094
  0.21853924  0.19536503  0.01916811  0.15075968 -0.05518525  0.05459089
  0.0264561  -0.06906594 -0.0308692  -0.15646254  0.15443161 -0.01437793
  0.06161686  0.10248507 -0.03997527 -0.11073412  0.00060297 -0.09123478
 -0.03746448 -0.03951796  0.06551383  0.10881574  0.1088464  -0.06363022
  0.11230122 -0.18387358 -0.03757964 -0.0949434  -0.06991491  0.07850139
 -0.03288061  0.00164794 -0.06452169 -0.0378795   0.15352608 -0.12292963
 -0.01440485  0.00423601  0.20927717  0.11765676  0.02267848 -0.04384664
 -0.21248193  0.04186571  0.05879945 -0.05452083 -0.09591392  0.1154337
 -0.15399636  0.05752812 -0.06454521 -0.05712061 -0.05031272 -0.06844957
  0.15793686  0.00096536  0.13013817 -0.09436408  0.06269205 -0.03508111
  0.07452258 -0.09076336 -0.07440425  0.04393045 -0.13078514 -0.02674996
  0.0838663  -0.1173908  -0.05627068 -0.04261345 -0.03413154 -0.05983952
 -0.05523409  0.12090265 -0.16179574  0.09461352]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.3692604088819851,0
req,src,test_data/LibEST_semeru_format/requirements/RQ28-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_http.c,requir client use implicit databas est client implicit databas use valid est server certif client must check configur uri http redirect uri accord rule specifi rfc section provis uri recent http redirect uri provid basi author server authent ident confirm author server,"sign long sign int int curlx sltosi long slnum ifdef intel compil pragma warn push pragma warn disabl convers may lose signific bit endif assert slnum sizeof int curl sizeof long assert unsign long slnum unsign long curl mask sint endif return int slnum long curl mask sint ifdef intel compil pragma warn pop endif parsed return parsed fine convers parsed fail fail convert parsed later time overflow far end time parsed sooner time underflow low end time static int parsed const char date time output return day monday sunday static int checkday const char check size len int const char const int found len weekday els curl wkday est client curl raw equal check found break return found return day monday sunday static int checkmonth const char check int const char const int found curl month est client curl raw equal check found break return found return offset real offset return time zone offset gmt input one number second timezon found legal static int checktz const char check unsign int const struct tzinfo int found sizeof sizeof ]); ++) check name found break ++; return found offset return time zone offset gmt input one number second timezon found legal static void skip_over_whit const char date skip everyth letter digit (** date isalnum (** date date )++; struct time sinc epoch gmt time zone similar standard mktime function gmt suffer various bug portabl problem system implement static time_t my_timegm struct my_tm static const int month_days_cumul 120 151 181 212 243 273 304 334 int month year leap_day tm_year support year 1970 caus function return negat valu return year tm_year 1900 month tm_mon month year month month month els month year month month month leap_day year tm_mon leap_day leap_day leap_day 100 leap_day 400 1969 1969 100 1969 400 )); return (((( time_t year 1970 365 leap_day month_days_cumul month tm_mday tm_hour tm_min tm_sec parsed return parsedate_ok fine convers parsedate_fail fail convert parsedate_lat time overflow far end time_t parsedate_soon time underflow low end time_t static int parsed const char date time_t output time_t int wdaynum day week number mon sun int monnum month year number int mdaynum day month int hournum int minnum int secnum int yearnum int tzoff struct my_tm enum assum dignext date_mday const char indat date save origin pointer int part max part date part int found skip_over_whit date isalpha date name come char buf ]=""""; size_t len sscanf date ]"", buf len strnlen_ buf wdaynum wdaynum checkday buf len wdaynum found found monnum monnum checkmonth buf monnum found found tzoff must time zone string tzoff checktz buf tzoff found found return parsedate_fail bad string date len els isdigit date digit int val char end secnum sscanf date 02d 02d 02d hournum minnum secnum ))) time stamp date els secnum sscanf date 02d 02d hournum minnum ))) time stamp without second date secnum els long lval int error int old_errno old_errno errno set_errno lval strtol date end error errno error old_errno set_errno old_errno error return parsedate_fail lval long int_max lval long int_min return parsedate_fail val curlx_sltosi lval tzoff end date val 1400 indat date date date -'))) four digit valu less equal 1400 take account sort funni time zone diff preced plus minus time zone indic 1400 pick sinc 1300 frequent use 1400 mention edg number document iso 200x propos timezon function http :// david tribbl com text c0xtimezon html anyon authorit sourc exact maximum time zone offset pleas speak found tzoff val 100 val 100 prefix indic local time compar gmt need ther revers math get want tzoff date ]=='+'?- tzoff tzoff ((( end date yearnum monnum mdaynum digit year month day yet yyyymmdd found yearnum val 10000 monnum val 10000 100 month mdaynum val 100 found dignext date_mday mdaynum val val mdaynum val found dignext date_year found dignext date_year yearnum yearnum val found yearnum 1900 yearnum yearnum 1900 els yearnum 2000 mdaynum dignext date_mday found return parsedate_fail date end part ++; secnum secnum minnum hournum time make zero ((- mdaynum monnum yearnum lack vital info fail return parsedate_fail sizeof_time_t bit time_t hold date begin 2038 yearnum 2037 output 0x7fffffff return parsedate_lat endif yearnum 1970 output return parsedate_soon mdaynum monnum hournum minnum secnum return parsedate_fail clear illeg date tm_sec secnum tm_min minnum tm_hour hournum tm_mday mdaynum tm_mon monnum tm_year yearnum 1900 my_timegm return time_t time_t often bit even mani architectur featur bit long system bit time_t deal year beyond 2038 howev even system bit time_t mktime return date beyond utc januari 2038 aix 5100 my_timegm time zone adjust cast int compar negat one int add time zone diff local time zone gmt long delta long tzoff !=- tzoff delta delta return time_t overflow delta output return parsedate_ok find next field --------------- find next rfc822 token string entri pstr point string contain word separ white white space "","" "";"" ""="". word option quot use <""> ""<"" "">"" comment surrround filter exit pstr move first delimit past field string mutil termin return pointer first word null error static char htnext field char pstr char char start null pstr pstr return null pstr strip white space delimit isspac int =')) ++; (!* pstr return null field ""') quot field start ""'; ++) ++; skip escap char break kr95 need stop els <') quot field start >'; ++) ++; skip escap char break kr95 need stop els (') comment )'; ++) ++; skip escap char ++; els spool field start isspac int =') ++; break got pstr return start function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static est_error est_ctx ctx char hdr int est_err_non char hdr char token null char valu null int diff errno_t safec_rc header come basic digest field still front skip token htnext field token htnext field ))) est_strcasecmp_ token realm "")) valu htnext field ))) eok strncpy_ ctx realm max_realm valu max_realm els els est_strcasecmp_ token nonc "")) valu htnext field ))) eok strncpy_ ctx s_nonc max_nonc valu max_nonc els els est_strcasecmp_ token qop "")) valu htnext field ))) valu est_log_warn unsupport qop valu valu els safec_rc memcmp_ valu sizeof auth ""), auth sizeof auth ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff safec_rc eok est_log_warn unsupport qop valu valu els els est_strcasecmp_ token algorithm "")) valu htnext field est_strcasecmp_ valu md5 "")) est_log_err unsupport digest algorithm valu support md5 moment els est_strcasecmp_ token error "")) valu htnext field ))) eok strncpy_ ctx token_error max_token_error valu max_token_error els els est_strcasecmp_ token error_descript "")) valu htnext field ))) eok strncpy_ ctx token_error_desc max_token_error_desc valu max_token_error_desc els els est_log_warn unsupport auth token ignor token memzero_ ctx s_nonc max_nonc break return function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static http_header parse_http_head unsign char buf int num_head int http_header hdrs char hdr_end errno_t safec_rc num_head hdrs malloc sizeof http_header max_head hdrs est_log_err malloc failur ""); return null find offset header delimint safec_rc strstr_s char buf strnlen_ char buf rsize_max_str hdr_end safec_rc eok est_log_info strstr_s error safec_rc skip first line skip char **) buf ""); max_head ++) hdrs name skip_quot char **) buf "":"", hdrs valu skip char **) buf ""); fflush stdout est_log_info found http header hdrs name hdrs valu fflush stdout hdrs name break num_head ((* buf unsign char hdr_end break est_log_info found http header num_head return hdrs function pars http status code first header hand code handl est full http stack unrecogn code result error note http expect static int unsign char buf strncmp const char buf est_http_hdr_200 strnlen_ est_http_hdr_200 est_http_hdr_max ))) return 200 els strncmp const char buf est_http_hdr_202 strnlen_ est_http_hdr_202 est_http_hdr_max ))) return 202 els strncmp const char buf est_http_hdr_204 strnlen_ est_http_hdr_204 est_http_hdr_max ))) return 204 els strncmp const char buf est_http_hdr_400 strnlen_ est_http_hdr_400 est_http_hdr_max ))) return 400 els strncmp const char buf est_http_hdr_401 strnlen_ est_http_hdr_401 est_http_hdr_max ))) return 401 els strncmp const char buf est_http_hdr_404 strnlen_ est_http_hdr_404 est_http_hdr_max ))) return 404 els strncmp const char buf est_http_hdr_423 strnlen_ est_http_hdr_423 est_http_hdr_max ))) return 423 els est_log_err unhandl http respons buf return function search process www authent header server result set auth_mod valu context www authent header valu header invalid set auth_mod failur set multipl authent header first one process static void est_ctx ctx http_header hdrs int hdr_cnt int est_error int auth_found walk header look www authent process first one erron second one includ ignor hdr_cnt ++) strncmp hdrs name est_http_hdr_auth auth_found strncmp hdrs valu basic ctx auth_mod auth_bas pars realm ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu digest ctx auth_mod auth_digest pars realm nonc ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu bearer ctx auth_mod auth_token pars realm possibl token error field ctx hdrs valu est_err_non ctx auth_mod auth_fail els est_log_err unsupport www authent method ""); ctx auth_mod auth_fail break auth_found est_log_err www authent header found ""); ctx auth_mod auth_fail return function take list header server respons walk header look retri respons header one found valu pars save away est context valu one two format repres ascii string first format count number second client wait retri request second format time date stamp point time client retri request result function set retry_aft valu context retri header receiv receiv could pars valu zero otherwis set valu receiv note est client current support time date format respons process respons format static est_error est_ctx ctx http_header hdrs int hdr_cnt est_error int int cmp_result diff int long long int temp_ll int found initi assum retri header ctx retry_after_delay ctx retry_after_d hdr_cnt ++) cmp_result strcasecmp_ hdrs name sizeof diff cmp_result eok diff est_log_info retri valu hdrs valu found determin whether valu date time string integ repres number second client must wait isalpha (*( char hdrs valu ifdef int convert date time string time_t parsed hdrs valu ctx retry_after_d parsedate_ok est_log_err retri valu could pars ""); els format current support est_log_err retri valu correct format ""); endif els make sure digit make sure larger four byte integ cach away valu return retri delay strisdigit_ hdrs valu max decim place temp_ll atol hdrs valu temp_ll int_max ctx retry_after_delay int temp_ll els est_log_err retri valu larg ""); els est_log_err retri valu could pars ""); found est_log_err retri header miss ""); return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int http_header hdrs int hdr_cnt est_oper int int int content_type_pres content_length_pres int cmp_result travers http header process one need check hdr_cnt ++) content type memcmp_ hdrs name sizeof est_http_hdr_ct est_http_hdr_ct sizeof est_http_hdr_ct cmp_result cmp_result content_type_pres verifi content pkcs7 data memcmp_ hdrs valu strnlen_ est_op_map content_typ est_op_map length est_op_map content_typ strnlen_ est_op_map content_typ est_op_map length cmp_result cmp_result est_log_err http content type hdrs valu return els content length memcmp_ hdrs name sizeof est_http_hdr_cl est_http_hdr_cl sizeof est_http_hdr_cl cmp_result cmp_result content_length_pres atoi hdrs valu make sure necessari header present content_type_pres est_log_err miss http content type header ""); return els content_length_pres est_log_err miss http content length header ""); return return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int est_ssl_read ssl ssl unsign char buf int buf_max int sock_read_timeout int timeout int read_fd int struct pollfd pfd load timev struct pass select timeout sock_read_timeout 1000 read_fd ssl_get_fd ssl pfd read_fd pfd event pollin pfd revent errno poll pfd timeout est_log_err socket poll timeout data receiv server .""); return els est_log_err socket read failur errno errno return els return ssl_read ssl buf buf_max )); function extract data ssl context put buffer static int est_io_read_raw ssl ssl unsign char buf int buf_max int read_cnt int sock_read_timeout int cur_cnt char peek_read_buf read_cnt cur_cnt est_ssl_read ssl buf buf_max sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt multipl call ssl_read may requir get full http payload cur_cnt read_cnt buf_max cur_cnt est_ssl_read ssl buf read_cnt buf_max read_cnt sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt ((* read_cnt buf_max ssl_peek ssl peek_read_buf est_log_err buffer small receiv messag ""); return return est_err_non function provid primari entri point modul use est client read http respons server data read ssl context http pars invok est_err_non return raw_buf buffer must freed caller otherwis freed est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len int est_err_non http_header hdrs int hdr_cnt int http_status unsign char raw_buf payload_buf payload int raw_len raw_buf malloc est_ca_max raw_buf null est_log_err unabl alloc memori ""); return est_err_malloc memzero_ raw_buf est_ca_max payload raw_buf read raw data ssl connect est_io_read_raw ssl raw_buf est_ca_max raw_len ctx read_timeout est_err_non est_log_info valid respons process ""); free raw_buf return raw_len est_log_warn receiv empti http respons server ""); free raw_buf return est_log_info read byte http data raw_len pars http header get status look status 200 success http_status raw_buf ctx last_http_status http_status hdrs parse_http_head payload hdr_cnt est_log_info http status receiv http_status check status header first see server accept request switch http_status case 200 server report noth break case 204 case 404 est_log_err server respond 204 404 content found ""); est_op_csrattr est_err_non els http_status 404 els est_err_unknown break case 202 server ask retri est_log_info est server respond retri ""); ctx hdrs hdr_cnt break case 400 est_log_err http respons est server bad request ""); est_err_http_bad_req break case 401 server request user auth credenti est_log_info est server request user authent ""); check alreadi tri authent bail first time auth_mod set none ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token ctx auth_mod auth_fail est_err_auth_fail break ctx hdrs hdr_cnt est_err_auth_fail break case 423 est_log_err server respond 423 content attempt access lock ""); est_err_http_lock break case unsupport http respons est_log_err unsupport http respons est server )"", http_status est_err_unknown break default http respons given want handl est_log_err http respons est server http_status break est_err_non get content type content length header verifi http respons contain correct amount data payload_len hdrs hdr_cnt est_log_info http content len payload_len payload_len est_ca_max est_log_err content length larger maximum valu ."", est_ca_max est_err_unknown payload_len buf null els payload_len payload_len buf null els alloc buffer hold payload pass back payload_buf malloc payload_len payload_buf est_log_err unabl alloc memori ""); free raw_buf free hdrs return est_err_malloc memcpy_ payload_buf payload_len payload payload_len buf payload_buf raw_buf free raw_buf hdrs free hdrs return","[ 0.02980203 -0.11710332 -0.26550922  0.00489574  0.02676419  0.09572162
  0.24986003  0.05694745 -0.01432658 -0.10702708 -0.07349299 -0.0454149
 -0.01971533  0.0857412  -0.0916763   0.04715936  0.00419306  0.09055112
  0.09400715  0.06509653  0.03041507  0.06232808  0.00950324  0.09158973
  0.2267382   0.19223216  0.01278502  0.15279706 -0.05178717  0.05148544
  0.01638677 -0.0711347  -0.02233321 -0.13792668  0.13720481 -0.0190333
  0.07492699  0.11952593 -0.03718707 -0.09745617  0.0118284  -0.08132664
 -0.03115921 -0.05673802  0.05955197  0.10505733  0.11087562 -0.06073288
  0.11179315 -0.18532328 -0.04400633 -0.08584488 -0.08164352  0.06556291
 -0.03176954  0.00544172 -0.07225472 -0.04039167  0.15589008 -0.10693979
 -0.00439061  0.01265442  0.21063574  0.10917063  0.01635351 -0.05196821
 -0.21178809  0.04556727  0.04120203 -0.07167455 -0.11883871  0.11778522
 -0.14867255  0.05937248 -0.06633771 -0.04943674 -0.05103191 -0.0551171
  0.15610586 -0.00049677  0.14594123 -0.0978343   0.06999839 -0.01741692
  0.06495398 -0.08941947 -0.07251603  0.04222538 -0.14329088 -0.03212183
  0.07245737 -0.11450756 -0.0526563  -0.05053602 -0.03070516 -0.04316856
 -0.06386606  0.12811702 -0.16160218  0.09532369]","[-0.00987736 -0.11911407 -0.2841379   0.00779026  0.07010551  0.11020532
  0.21956828  0.08649327 -0.0472606  -0.11266565 -0.04507514 -0.04941731
 -0.02074194  0.09147213 -0.08542818 -0.0242101  -0.0258745   0.10481261
  0.08187146 -0.02030602 -0.02759121  0.06745998  0.00749176  0.10427962
  0.227792    0.1629232   0.03945069  0.10436959 -0.03800827  0.03180632
  0.06665646 -0.08501376 -0.06131442 -0.15126903  0.14578922 -0.01711159
 -0.00118449  0.09328528 -0.06543815 -0.09235742 -0.05367571 -0.10725161
 -0.03737934  0.01557842  0.02767696  0.12949339  0.06183678 -0.01494845
  0.09363889 -0.18110369 -0.0098926  -0.09057959 -0.01962026  0.13053118
 -0.05518321 -0.06301711 -0.05672394 -0.01362461  0.17390853 -0.15026285
 -0.02201219 -0.02932046  0.242307    0.15510128  0.00329678 -0.03584385
 -0.17889638  0.04433239  0.03926572 -0.03635661 -0.06652797  0.08144163
 -0.1339039   0.06515578 -0.00812013 -0.01195321 -0.03717465 -0.09508131
  0.10198383 -0.02140859  0.09113996 -0.07103333  0.08522316 -0.02457515
  0.05434166 -0.06651933 -0.07538471  0.02887119 -0.10447777 -0.01726953
  0.09799939 -0.1103819  -0.09234454 -0.01928411 -0.02889781 -0.03046735
 -0.02491977  0.16676706 -0.17673336  0.04843231]",0.3706437217104746,0
req,src,test_data/LibEST_semeru_format/requirements/RQ51-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir secur consider support basic authent specifi http rfc allow server access client cleartext password provid support legaci usernam password databas requir expos plaintext password est server use pin one time password help mitig exposur recommend est client use credenti obtain client certif use futur interact est server client use implicit databas certif valid see section author proceed specifi section situat client valid server respond certifi third parti uri configur cannot verifi respond author act pki client tri enrol client use implicit trust anchor databas recommend use tls base client authent prevent expos http base client authent inform recommend client includ link ident pop inform section request prevent request forward real est server man middl recommend implicit trust anchor databas use est server authent care manag reduc chanc third parti poor certif practic trust disabl implicit trust anchor databas success receiv distribut certif respons section limit vulner first tls exchang certif less tls cipher suit maintain secur perform mutual authent necessari enrol follow properti inform leak activ attack whether singl guess secret correct advantag adversari gain interact comput possibl perform countermeasur exponenti backoff certain number fail attempt frustrat repeat activ attack use certif less cipher suit properti list would render result enrol void potenti result certif issu unauthent unauthor entiti use certif less tls cipher suit share secret use authent author cannot share entiti parti exchang someon client server addit share secret void secur afford certif less cipher suit exposur share secret use certif less cipher suit third parti enabl client imperson result corrupt client trust anchor databas tls cipher suit includ export des name must use cipher offer suffici level protect bit crypto offer accept protect use des deprec describ cmc section rfc key use signatur key sign certif request privat key serv pop key pair inclus tls uniqu within certif request link proof possess tls proof ident enforc pop oper occur tls session activ impli server authent client current access privat key authent client known specif capabl hardwar protect authent credenti key storag implic strengthen proven server side key generat method allow key transport tls connect client without applic layer protect distribut privat key materi inher riski privat key distribut use encrypt mode negoti tls cipher suit key protect prefer key wrap method key wrap rfc specifi rfc encrypt privat key beyond provid tls option recommend est server support oper default recommend client request servic unless compel oper benefit use implicit trust anchor databas recommend server side key generat employ use encrypt cms server side key generat respons recommend regard csr attribut may list inclus enrol request real inher secur issu content convey adversari abl interpos convers could exclud attribut server may want includ attribut server may want render meaningless attribut server may want asn encod rule der ber type length valu structur easi construct malici content invalid length field caus buffer overrun condit asn encod rule allow arbitrari level nest may make possibl construct malici content caus stack overflow interpret asn structur awar issu take appropri measur guard buffer overflow stack overrun particular malici content general,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.0189344  -0.12086762 -0.27243558  0.01124373  0.0368322   0.09904639
  0.24570268  0.06664453 -0.02290943 -0.10877211 -0.06552196 -0.04178625
 -0.01695314  0.09657768 -0.08949996  0.02774441  0.00127898  0.10010207
  0.08983328  0.04830928  0.01734949  0.06528727  0.01335612  0.09518918
  0.2228079   0.18503615  0.0203068   0.14092821 -0.04587187  0.04432371
  0.03544043 -0.06770312 -0.03433644 -0.15114896  0.14524175 -0.01042842
  0.05346381  0.10856967 -0.04492432 -0.09854058 -0.00346637 -0.08806235
 -0.03638779 -0.03482285  0.05887227  0.11063449  0.09703409 -0.05485849
  0.10917465 -0.17768449 -0.03212404 -0.09335963 -0.06889676  0.08228234
 -0.03486841 -0.01089434 -0.06850056 -0.03938957  0.15965264 -0.12361487
 -0.01187668  0.00436597  0.21695496  0.11946355  0.0173128  -0.05032689
 -0.20565802  0.04454385  0.04663602 -0.05815081 -0.10334317  0.11066569
 -0.14804283  0.0624555  -0.05406999 -0.04576638 -0.0440175  -0.06608483
  0.14855218 -0.00354439  0.1332854  -0.09077922  0.06694544 -0.02622521
  0.06570163 -0.08479669 -0.07486844  0.0359394  -0.13179006 -0.02893699
  0.07756511 -0.11924619 -0.06247345 -0.04438787 -0.03446443 -0.04317556
 -0.04945877  0.13138828 -0.1619641   0.09331657]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.2967090105571869,1
req,src,test_data/LibEST_semeru_format/requirements/RQ50-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_http.c,requir iana consider section defin oid regist arc deleg iana pkix work group iana regist follow iana updat well known uri registri follow fill templat rfc uri suffix est chang control ietf iana updat applic media type registri follow fill templat rfc media subtyp csr attribut csr attribut respons applic csrattr type name applic subtyp name csrattr requir paramet none option paramet none encod consider binari secur consider client request list attribut server wish certif request request respons normal done tls protect tunnel interoper consider none publish specif memo applic use media type enrol secur transport est addit inform magic number none file extens csrattr person email address contact inform dan harkin dharkin arubanetwork com restrict usag none author dan harkin dharkin arubanetwork com intend usag common chang control iesg iesg ietf org applic pkcs mime content type defin option smime type paramet rfc set specif valu document add anoth valu server generat key paramet valu server side key generat respons,"sign long sign int int curlx sltosi long slnum ifdef intel compil pragma warn push pragma warn disabl convers may lose signific bit endif assert slnum sizeof int curl sizeof long assert unsign long slnum unsign long curl mask sint endif return int slnum long curl mask sint ifdef intel compil pragma warn pop endif parsed return parsed fine convers parsed fail fail convert parsed later time overflow far end time parsed sooner time underflow low end time static int parsed const char date time output return day monday sunday static int checkday const char check size len int const char const int found len weekday els curl wkday est client curl raw equal check found break return found return day monday sunday static int checkmonth const char check int const char const int found curl month est client curl raw equal check found break return found return offset real offset return time zone offset gmt input one number second timezon found legal static int checktz const char check unsign int const struct tzinfo int found sizeof sizeof ]); ++) check name found break ++; return found offset return time zone offset gmt input one number second timezon found legal static void skip_over_whit const char date skip everyth letter digit (** date isalnum (** date date )++; struct time sinc epoch gmt time zone similar standard mktime function gmt suffer various bug portabl problem system implement static time_t my_timegm struct my_tm static const int month_days_cumul 120 151 181 212 243 273 304 334 int month year leap_day tm_year support year 1970 caus function return negat valu return year tm_year 1900 month tm_mon month year month month month els month year month month month leap_day year tm_mon leap_day leap_day leap_day 100 leap_day 400 1969 1969 100 1969 400 )); return (((( time_t year 1970 365 leap_day month_days_cumul month tm_mday tm_hour tm_min tm_sec parsed return parsedate_ok fine convers parsedate_fail fail convert parsedate_lat time overflow far end time_t parsedate_soon time underflow low end time_t static int parsed const char date time_t output time_t int wdaynum day week number mon sun int monnum month year number int mdaynum day month int hournum int minnum int secnum int yearnum int tzoff struct my_tm enum assum dignext date_mday const char indat date save origin pointer int part max part date part int found skip_over_whit date isalpha date name come char buf ]=""""; size_t len sscanf date ]"", buf len strnlen_ buf wdaynum wdaynum checkday buf len wdaynum found found monnum monnum checkmonth buf monnum found found tzoff must time zone string tzoff checktz buf tzoff found found return parsedate_fail bad string date len els isdigit date digit int val char end secnum sscanf date 02d 02d 02d hournum minnum secnum ))) time stamp date els secnum sscanf date 02d 02d hournum minnum ))) time stamp without second date secnum els long lval int error int old_errno old_errno errno set_errno lval strtol date end error errno error old_errno set_errno old_errno error return parsedate_fail lval long int_max lval long int_min return parsedate_fail val curlx_sltosi lval tzoff end date val 1400 indat date date date -'))) four digit valu less equal 1400 take account sort funni time zone diff preced plus minus time zone indic 1400 pick sinc 1300 frequent use 1400 mention edg number document iso 200x propos timezon function http :// david tribbl com text c0xtimezon html anyon authorit sourc exact maximum time zone offset pleas speak found tzoff val 100 val 100 prefix indic local time compar gmt need ther revers math get want tzoff date ]=='+'?- tzoff tzoff ((( end date yearnum monnum mdaynum digit year month day yet yyyymmdd found yearnum val 10000 monnum val 10000 100 month mdaynum val 100 found dignext date_mday mdaynum val val mdaynum val found dignext date_year found dignext date_year yearnum yearnum val found yearnum 1900 yearnum yearnum 1900 els yearnum 2000 mdaynum dignext date_mday found return parsedate_fail date end part ++; secnum secnum minnum hournum time make zero ((- mdaynum monnum yearnum lack vital info fail return parsedate_fail sizeof_time_t bit time_t hold date begin 2038 yearnum 2037 output 0x7fffffff return parsedate_lat endif yearnum 1970 output return parsedate_soon mdaynum monnum hournum minnum secnum return parsedate_fail clear illeg date tm_sec secnum tm_min minnum tm_hour hournum tm_mday mdaynum tm_mon monnum tm_year yearnum 1900 my_timegm return time_t time_t often bit even mani architectur featur bit long system bit time_t deal year beyond 2038 howev even system bit time_t mktime return date beyond utc januari 2038 aix 5100 my_timegm time zone adjust cast int compar negat one int add time zone diff local time zone gmt long delta long tzoff !=- tzoff delta delta return time_t overflow delta output return parsedate_ok find next field --------------- find next rfc822 token string entri pstr point string contain word separ white white space "","" "";"" ""="". word option quot use <""> ""<"" "">"" comment surrround filter exit pstr move first delimit past field string mutil termin return pointer first word null error static char htnext field char pstr char char start null pstr pstr return null pstr strip white space delimit isspac int =')) ++; (!* pstr return null field ""') quot field start ""'; ++) ++; skip escap char break kr95 need stop els <') quot field start >'; ++) ++; skip escap char break kr95 need stop els (') comment )'; ++) ++; skip escap char ++; els spool field start isspac int =') ++; break got pstr return start function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static est_error est_ctx ctx char hdr int est_err_non char hdr char token null char valu null int diff errno_t safec_rc header come basic digest field still front skip token htnext field token htnext field ))) est_strcasecmp_ token realm "")) valu htnext field ))) eok strncpy_ ctx realm max_realm valu max_realm els els est_strcasecmp_ token nonc "")) valu htnext field ))) eok strncpy_ ctx s_nonc max_nonc valu max_nonc els els est_strcasecmp_ token qop "")) valu htnext field ))) valu est_log_warn unsupport qop valu valu els safec_rc memcmp_ valu sizeof auth ""), auth sizeof auth ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff safec_rc eok est_log_warn unsupport qop valu valu els els est_strcasecmp_ token algorithm "")) valu htnext field est_strcasecmp_ valu md5 "")) est_log_err unsupport digest algorithm valu support md5 moment els est_strcasecmp_ token error "")) valu htnext field ))) eok strncpy_ ctx token_error max_token_error valu max_token_error els els est_strcasecmp_ token error_descript "")) valu htnext field ))) eok strncpy_ ctx token_error_desc max_token_error_desc valu max_token_error_desc els els est_log_warn unsupport auth token ignor token memzero_ ctx s_nonc max_nonc break return function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static http_header parse_http_head unsign char buf int num_head int http_header hdrs char hdr_end errno_t safec_rc num_head hdrs malloc sizeof http_header max_head hdrs est_log_err malloc failur ""); return null find offset header delimint safec_rc strstr_s char buf strnlen_ char buf rsize_max_str hdr_end safec_rc eok est_log_info strstr_s error safec_rc skip first line skip char **) buf ""); max_head ++) hdrs name skip_quot char **) buf "":"", hdrs valu skip char **) buf ""); fflush stdout est_log_info found http header hdrs name hdrs valu fflush stdout hdrs name break num_head ((* buf unsign char hdr_end break est_log_info found http header num_head return hdrs function pars http status code first header hand code handl est full http stack unrecogn code result error note http expect static int unsign char buf strncmp const char buf est_http_hdr_200 strnlen_ est_http_hdr_200 est_http_hdr_max ))) return 200 els strncmp const char buf est_http_hdr_202 strnlen_ est_http_hdr_202 est_http_hdr_max ))) return 202 els strncmp const char buf est_http_hdr_204 strnlen_ est_http_hdr_204 est_http_hdr_max ))) return 204 els strncmp const char buf est_http_hdr_400 strnlen_ est_http_hdr_400 est_http_hdr_max ))) return 400 els strncmp const char buf est_http_hdr_401 strnlen_ est_http_hdr_401 est_http_hdr_max ))) return 401 els strncmp const char buf est_http_hdr_404 strnlen_ est_http_hdr_404 est_http_hdr_max ))) return 404 els strncmp const char buf est_http_hdr_423 strnlen_ est_http_hdr_423 est_http_hdr_max ))) return 423 els est_log_err unhandl http respons buf return function search process www authent header server result set auth_mod valu context www authent header valu header invalid set auth_mod failur set multipl authent header first one process static void est_ctx ctx http_header hdrs int hdr_cnt int est_error int auth_found walk header look www authent process first one erron second one includ ignor hdr_cnt ++) strncmp hdrs name est_http_hdr_auth auth_found strncmp hdrs valu basic ctx auth_mod auth_bas pars realm ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu digest ctx auth_mod auth_digest pars realm nonc ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu bearer ctx auth_mod auth_token pars realm possibl token error field ctx hdrs valu est_err_non ctx auth_mod auth_fail els est_log_err unsupport www authent method ""); ctx auth_mod auth_fail break auth_found est_log_err www authent header found ""); ctx auth_mod auth_fail return function take list header server respons walk header look retri respons header one found valu pars save away est context valu one two format repres ascii string first format count number second client wait retri request second format time date stamp point time client retri request result function set retry_aft valu context retri header receiv receiv could pars valu zero otherwis set valu receiv note est client current support time date format respons process respons format static est_error est_ctx ctx http_header hdrs int hdr_cnt est_error int int cmp_result diff int long long int temp_ll int found initi assum retri header ctx retry_after_delay ctx retry_after_d hdr_cnt ++) cmp_result strcasecmp_ hdrs name sizeof diff cmp_result eok diff est_log_info retri valu hdrs valu found determin whether valu date time string integ repres number second client must wait isalpha (*( char hdrs valu ifdef int convert date time string time_t parsed hdrs valu ctx retry_after_d parsedate_ok est_log_err retri valu could pars ""); els format current support est_log_err retri valu correct format ""); endif els make sure digit make sure larger four byte integ cach away valu return retri delay strisdigit_ hdrs valu max decim place temp_ll atol hdrs valu temp_ll int_max ctx retry_after_delay int temp_ll els est_log_err retri valu larg ""); els est_log_err retri valu could pars ""); found est_log_err retri header miss ""); return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int http_header hdrs int hdr_cnt est_oper int int int content_type_pres content_length_pres int cmp_result travers http header process one need check hdr_cnt ++) content type memcmp_ hdrs name sizeof est_http_hdr_ct est_http_hdr_ct sizeof est_http_hdr_ct cmp_result cmp_result content_type_pres verifi content pkcs7 data memcmp_ hdrs valu strnlen_ est_op_map content_typ est_op_map length est_op_map content_typ strnlen_ est_op_map content_typ est_op_map length cmp_result cmp_result est_log_err http content type hdrs valu return els content length memcmp_ hdrs name sizeof est_http_hdr_cl est_http_hdr_cl sizeof est_http_hdr_cl cmp_result cmp_result content_length_pres atoi hdrs valu make sure necessari header present content_type_pres est_log_err miss http content type header ""); return els content_length_pres est_log_err miss http content length header ""); return return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int est_ssl_read ssl ssl unsign char buf int buf_max int sock_read_timeout int timeout int read_fd int struct pollfd pfd load timev struct pass select timeout sock_read_timeout 1000 read_fd ssl_get_fd ssl pfd read_fd pfd event pollin pfd revent errno poll pfd timeout est_log_err socket poll timeout data receiv server .""); return els est_log_err socket read failur errno errno return els return ssl_read ssl buf buf_max )); function extract data ssl context put buffer static int est_io_read_raw ssl ssl unsign char buf int buf_max int read_cnt int sock_read_timeout int cur_cnt char peek_read_buf read_cnt cur_cnt est_ssl_read ssl buf buf_max sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt multipl call ssl_read may requir get full http payload cur_cnt read_cnt buf_max cur_cnt est_ssl_read ssl buf read_cnt buf_max read_cnt sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt ((* read_cnt buf_max ssl_peek ssl peek_read_buf est_log_err buffer small receiv messag ""); return return est_err_non function provid primari entri point modul use est client read http respons server data read ssl context http pars invok est_err_non return raw_buf buffer must freed caller otherwis freed est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len int est_err_non http_header hdrs int hdr_cnt int http_status unsign char raw_buf payload_buf payload int raw_len raw_buf malloc est_ca_max raw_buf null est_log_err unabl alloc memori ""); return est_err_malloc memzero_ raw_buf est_ca_max payload raw_buf read raw data ssl connect est_io_read_raw ssl raw_buf est_ca_max raw_len ctx read_timeout est_err_non est_log_info valid respons process ""); free raw_buf return raw_len est_log_warn receiv empti http respons server ""); free raw_buf return est_log_info read byte http data raw_len pars http header get status look status 200 success http_status raw_buf ctx last_http_status http_status hdrs parse_http_head payload hdr_cnt est_log_info http status receiv http_status check status header first see server accept request switch http_status case 200 server report noth break case 204 case 404 est_log_err server respond 204 404 content found ""); est_op_csrattr est_err_non els http_status 404 els est_err_unknown break case 202 server ask retri est_log_info est server respond retri ""); ctx hdrs hdr_cnt break case 400 est_log_err http respons est server bad request ""); est_err_http_bad_req break case 401 server request user auth credenti est_log_info est server request user authent ""); check alreadi tri authent bail first time auth_mod set none ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token ctx auth_mod auth_fail est_err_auth_fail break ctx hdrs hdr_cnt est_err_auth_fail break case 423 est_log_err server respond 423 content attempt access lock ""); est_err_http_lock break case unsupport http respons est_log_err unsupport http respons est server )"", http_status est_err_unknown break default http respons given want handl est_log_err http respons est server http_status break est_err_non get content type content length header verifi http respons contain correct amount data payload_len hdrs hdr_cnt est_log_info http content len payload_len payload_len est_ca_max est_log_err content length larger maximum valu ."", est_ca_max est_err_unknown payload_len buf null els payload_len payload_len buf null els alloc buffer hold payload pass back payload_buf malloc payload_len payload_buf est_log_err unabl alloc memori ""); free raw_buf free hdrs return est_err_malloc memcpy_ payload_buf payload_len payload payload_len buf payload_buf raw_buf free raw_buf hdrs free hdrs return","[ 0.01455077 -0.11760523 -0.27798823  0.00936417  0.04466067  0.1018698
  0.24203427  0.0747766  -0.01998218 -0.11229543 -0.06082178 -0.04515509
 -0.0159307   0.10148558 -0.08723974  0.01666962 -0.01009987  0.1048014
  0.08883064  0.03836401  0.00720306  0.0709268   0.01295671  0.10015388
  0.22338237  0.18712837  0.02536644  0.13806102 -0.05075964  0.04574479
  0.04110394 -0.07429202 -0.0405269  -0.16016544  0.15530358 -0.01033524
  0.04418178  0.10371401 -0.04912624 -0.10613897 -0.01434211 -0.0978439
 -0.04228833 -0.02410277  0.05754616  0.11626682  0.09696139 -0.048896
  0.1063061  -0.18287207 -0.03004228 -0.09590009 -0.05996358  0.09247024
 -0.04182244 -0.01752593 -0.06211773 -0.03446762  0.1607612  -0.13303913
 -0.01703096 -0.00283197  0.22197972  0.13017042  0.01862626 -0.04145245
 -0.20404302  0.04355728  0.0550122  -0.05101917 -0.09057447  0.10815263
 -0.1506866   0.06213933 -0.05071264 -0.04555655 -0.04612851 -0.0772885
  0.14445266 -0.00623067  0.12081959 -0.08837395  0.06804623 -0.03497378
  0.07120293 -0.08166824 -0.07523229  0.0404107  -0.1249653  -0.02483736
  0.08752623 -0.11858247 -0.06537509 -0.03630754 -0.03352167 -0.04951058
 -0.04714146  0.12940632 -0.16626534  0.085875  ]","[-0.00987736 -0.11911407 -0.2841379   0.00779026  0.07010551  0.11020532
  0.21956828  0.08649327 -0.0472606  -0.11266565 -0.04507514 -0.04941731
 -0.02074194  0.09147213 -0.08542818 -0.0242101  -0.0258745   0.10481261
  0.08187146 -0.02030602 -0.02759121  0.06745998  0.00749176  0.10427962
  0.227792    0.1629232   0.03945069  0.10436959 -0.03800827  0.03180632
  0.06665646 -0.08501376 -0.06131442 -0.15126903  0.14578922 -0.01711159
 -0.00118449  0.09328528 -0.06543815 -0.09235742 -0.05367571 -0.10725161
 -0.03737934  0.01557842  0.02767696  0.12949339  0.06183678 -0.01494845
  0.09363889 -0.18110369 -0.0098926  -0.09057959 -0.01962026  0.13053118
 -0.05518321 -0.06301711 -0.05672394 -0.01362461  0.17390853 -0.15026285
 -0.02201219 -0.02932046  0.242307    0.15510128  0.00329678 -0.03584385
 -0.17889638  0.04433239  0.03926572 -0.03635661 -0.06652797  0.08144163
 -0.1339039   0.06515578 -0.00812013 -0.01195321 -0.03717465 -0.09508131
  0.10198383 -0.02140859  0.09113996 -0.07103333  0.08522316 -0.02457515
  0.05434166 -0.06651933 -0.07538471  0.02887119 -0.10447777 -0.01726953
  0.09799939 -0.1103819  -0.09234454 -0.01928411 -0.02889781 -0.03046735
 -0.02491977  0.16676706 -0.17673336  0.04843231]",0.2575770933944822,0
req,src,test_data/LibEST_semeru_format/requirements/RQ29-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir client author decis issu certif client alway control local polici est server configur reflect polici document specifi constraint polici est provid est server access client authent ident tls client certif addit http user authent credenti help implement polici client certif issu est includ cmc rfc extend key usag extens client registr author describ rfc rfc case est server appli author polici consist client exampl handl simpleenrol request est server could configur accept pop link inform match current tls session authent est client verifi inform act est server specifi section specif mechan avail est client use fullcmc method,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.02829203 -0.12302754 -0.26229742  0.00880806  0.02002794  0.09051092
  0.25270495  0.05446298 -0.01571509 -0.09972385 -0.07377151 -0.04399642
 -0.01788861  0.08840609 -0.09109861  0.04871471  0.00914043  0.08954263
  0.09437549  0.06899469  0.0366182   0.06181451  0.01434302  0.09435619
  0.22057936  0.19458833  0.0112726   0.15630749 -0.05232048  0.04996011
  0.01733976 -0.06790815 -0.02509712 -0.1393817   0.13728    -0.01343643
  0.08020362  0.11493257 -0.03532334 -0.09900467  0.01777131 -0.07821506
 -0.03149048 -0.05596867  0.06513039  0.10057502  0.11343491 -0.06573108
  0.11800817 -0.17973056 -0.03928315 -0.08946294 -0.08520797  0.06376544
 -0.02493978  0.0095234  -0.07520843 -0.0428663   0.15157445 -0.10560311
 -0.00431229  0.01709236  0.20855834  0.10295875  0.01721841 -0.05470847
 -0.21069679  0.04191446  0.04686016 -0.06694676 -0.11594611  0.1205094
 -0.15234648  0.06024561 -0.0731443  -0.05764334 -0.05095166 -0.05290856
  0.16270734  0.00474755  0.15396082 -0.09820273  0.06537385 -0.02404833
  0.06720523 -0.09346303 -0.06992313  0.04271678 -0.14311957 -0.03287098
  0.07132775 -0.11474663 -0.04793837 -0.05362155 -0.0352576  -0.04658654
 -0.06290676  0.12567624 -0.15676533  0.10325272]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.5260975216304061,1
req,src,test_data/LibEST_semeru_format/requirements/RQ41-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.h,requir full cmc respons enrol success server respons must includ http respons code content type applic pkcs mime specifi rfc respons data includ either simpl pki respons smime type paramet cert full pki respons smime type paramet cmc respons specifi section rfc bodi messag binari valu encod pki respons content transfer encod base rfc reject request server must specifi either http error http error cmc respons content type applic pkcs mime must includ respons data cmc error respons return code handl specifi section http rfc exampl client interpret http respons indic servic implement,int ossl verifi int store ctx ctx libest test api void ossl dump ssl error void est error ossl init cert store store store unsign char raw int size,"[ 3.22326161e-02 -1.07418135e-01 -2.68378079e-01 -2.78047519e-03
  3.42566222e-02  9.50381383e-02  2.55895317e-01  5.64534776e-02
 -9.27327946e-03 -1.11403719e-01 -7.36649185e-02 -3.72895487e-02
 -2.00108718e-02  9.38957557e-02 -8.75744671e-02  4.17879038e-02
 -2.89642648e-03  9.19778273e-02  8.79974887e-02  5.81862889e-02
  2.21769735e-02  7.19664395e-02  2.26459559e-03  9.12343115e-02
  2.20090315e-01  1.99602902e-01  1.25402017e-02  1.54298022e-01
 -5.11223562e-02  5.78688495e-02  8.85357801e-03 -6.86337277e-02
 -2.66008377e-02 -1.45404682e-01  1.52274385e-01 -1.89533960e-02
  6.35008216e-02  1.11913659e-01 -3.94432433e-02 -1.13041580e-01
  3.49703885e-04 -8.49999711e-02 -3.41602154e-02 -5.47106713e-02
  6.25731423e-02  1.06606148e-01  1.08671919e-01 -5.81571981e-02
  1.04077227e-01 -1.90032750e-01 -4.62804884e-02 -8.96977559e-02
 -7.66747445e-02  6.48309588e-02 -2.93397382e-02  6.99354429e-03
 -6.26527965e-02 -3.92620116e-02  1.56357676e-01 -1.16065130e-01
 -1.07844276e-02  9.53493727e-05  2.06967309e-01  1.16805032e-01
  2.49400120e-02 -4.69159149e-02 -2.14690417e-01  4.21875045e-02
  4.75085005e-02 -6.77766576e-02 -1.14748895e-01  1.12069711e-01
 -1.53008208e-01  5.47390394e-02 -6.54924065e-02 -5.42785265e-02
 -5.91479614e-02 -7.13804439e-02  1.61059350e-01  1.05338031e-03
  1.30917341e-01 -9.67867672e-02  6.98040649e-02 -3.12194899e-02
  7.45418593e-02 -8.86537284e-02 -7.42369443e-02  4.09330986e-02
 -1.34628117e-01 -3.14696133e-02  7.62645528e-02 -1.16451919e-01
 -4.73038517e-02 -4.78338078e-02 -2.65845899e-02 -5.38013577e-02
 -6.85766190e-02  1.12107038e-01 -1.68441623e-01  9.50502604e-02]","[-3.32884416e-02 -1.27662703e-01 -2.79828310e-01  5.80133311e-03
  6.43268228e-02  1.03074744e-01  2.14966252e-01  6.60702139e-02
 -7.85031915e-02 -8.58116224e-02 -4.89064455e-02 -4.54016812e-02
 -3.50504331e-02  7.81022385e-02 -8.51701126e-02 -4.31111641e-02
 -1.43419495e-02  8.63216594e-02  8.00839439e-02 -5.96548319e-02
 -3.35270874e-02  5.42765968e-02 -1.53618690e-03  9.97250006e-02
  2.21757606e-01  1.44508734e-01  2.97749359e-02  9.53684822e-02
 -1.38290357e-02  2.61135083e-02  6.73204586e-02 -7.80463517e-02
 -7.40294531e-02 -1.17273666e-01  1.25188559e-01 -1.86110064e-02
 -1.73459444e-02  8.57384130e-02 -7.10445195e-02 -6.99145049e-02
 -5.70689812e-02 -9.25302655e-02 -1.81697085e-02  2.58753784e-02
  4.22456441e-03  1.32250607e-01  2.52796076e-02  1.20715918e-02
  1.00857124e-01 -1.75514713e-01  7.28853466e-03 -9.01656672e-02
  6.84287661e-05  1.42916068e-01 -3.64756361e-02 -8.28685537e-02
 -6.90998882e-02 -5.78271784e-03  1.69050395e-01 -1.46098763e-01
 -1.19599076e-02 -4.28447016e-02  2.49336705e-01  1.46444991e-01
 -4.27160785e-03 -5.82108498e-02 -1.55882642e-01  4.36593667e-02
  2.77376771e-02 -3.03240996e-02 -7.65059143e-02  6.02095202e-02
 -1.25623688e-01  6.99399114e-02  1.62779465e-02  4.95273247e-03
 -4.01525758e-02 -1.00578167e-01  9.12162662e-02 -2.73536108e-02
  1.01810545e-01 -5.02358116e-02  9.73470807e-02 -9.18499660e-03
  3.33920047e-02 -6.09980337e-02 -6.28004223e-02  1.38998525e-02
 -9.23806950e-02 -2.97233351e-02  8.88039470e-02 -9.21974853e-02
 -9.68739688e-02 -3.19986381e-02 -2.76823603e-02 -1.23113375e-02
 -2.05206685e-02  1.97517261e-01 -1.74902141e-01  3.41759808e-02]",0.4754043652507267,0
req,src,test_data/LibEST_semeru_format/requirements/RQ9-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir client certif reissuanc est client renew rekey exist client certif submit enrol request est server current est client certif use tls client authent section client present certif est server client authent reissu est client certif cannot use tls client authent authent method use initi enrol use exampl client altern certif issu est use tls client authent use certif request messag includ subject subject alt name current certif name chang request specifi section,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.03855427 -0.12504819 -0.2510919   0.01149607  0.0076158   0.08488826
  0.2566574   0.041898   -0.01368416 -0.09432435 -0.08369258 -0.04079591
 -0.01946473  0.08366457 -0.09057654  0.06961349  0.02362834  0.08212152
  0.0974941   0.08827223  0.05380687  0.05302203  0.01362798  0.08697211
  0.21853083  0.19203764 -0.00266988  0.16265064 -0.04830605  0.05039161
  0.00691337 -0.06188225 -0.01308225 -0.12560394  0.12174503 -0.0113884
  0.09587349  0.11893199 -0.0296308  -0.08670709  0.03561904 -0.0636338
 -0.024173   -0.07395966  0.0657983   0.09188224  0.11764099 -0.07374547
  0.12383506 -0.17309202 -0.04423895 -0.08757625 -0.09842665  0.04801712
 -0.01542364  0.02070923 -0.08416303 -0.05040414  0.1475078  -0.09013534
  0.00167859  0.02768153  0.19512877  0.08436232  0.01481133 -0.06555238
 -0.20995972  0.04324034  0.03715029 -0.08059732 -0.13407245  0.12586959
 -0.14669149  0.05806143 -0.08023839 -0.06041915 -0.05022393 -0.03406627
  0.1698249   0.01045215  0.17348748 -0.10187751  0.0622394  -0.01184198
  0.06312705 -0.09554031 -0.07106808  0.04059054 -0.15562667 -0.03961741
  0.05655479 -0.11454917 -0.04301624 -0.06507436 -0.03648514 -0.04148217
 -0.07063986  0.12546714 -0.14945333  0.11585773]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.5005564142259711,0
req,src,test_data/LibEST_semeru_format/requirements/RQ24-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,requir proof possess defin section cmc rfc proof possess pop refer valu use prove privat key correspond public key possess use end entiti sign enrol request provid signatur base proof possess mechan describ section strengthen option includ direct base proof possess rfc includ tls session specif inform within data cover enrol request signatur thus link enrol request authent end point tls connect,"function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 2.31978204e-02 -1.14786230e-01 -2.69795746e-01  6.51546987e-03
  3.40447575e-02  9.36617553e-02  2.47893289e-01  6.26544207e-02
 -1.38401343e-02 -1.06274642e-01 -6.78405762e-02 -3.86850648e-02
 -1.73026603e-02  9.95008126e-02 -8.72873738e-02  3.19836549e-02
  2.19697738e-03  9.79658589e-02  8.79186168e-02  5.35206161e-02
  1.89503487e-02  6.99304864e-02  7.96700548e-03  9.41005722e-02
  2.16429964e-01  1.91979468e-01  1.75699107e-02  1.47812083e-01
 -4.82626930e-02  5.02374470e-02  2.46946644e-02 -6.53545856e-02
 -3.27396281e-02 -1.52497068e-01  1.51304647e-01 -9.39227175e-03
  5.93021438e-02  1.08051166e-01 -4.13811654e-02 -1.08989790e-01
  2.00418101e-04 -8.91248956e-02 -3.89357321e-02 -4.07590866e-02
  6.49973676e-02  1.07444011e-01  1.03559271e-01 -5.79529740e-02
  1.07417293e-01 -1.79897457e-01 -3.62904184e-02 -9.30461213e-02
 -7.27795511e-02  7.61521831e-02 -2.93873623e-02 -1.52336853e-03
 -6.54952675e-02 -4.03385572e-02  1.56087562e-01 -1.22641668e-01
 -1.36664165e-02  1.27543730e-03  2.11658210e-01  1.17112227e-01
  2.41319016e-02 -4.91394103e-02 -2.10546434e-01  4.06668074e-02
  5.55888452e-02 -5.73357232e-02 -1.03868738e-01  1.11337982e-01
 -1.54522642e-01  5.82905561e-02 -6.25813231e-02 -5.49915321e-02
 -5.23708239e-02 -7.03058168e-02  1.57516688e-01  1.08537287e-03
  1.31793246e-01 -9.15601701e-02  6.33344725e-02 -3.50347236e-02
  7.28789717e-02 -8.61717835e-02 -7.26431310e-02  3.84189412e-02
 -1.28702864e-01 -3.10225636e-02  7.86217153e-02 -1.17940873e-01
 -5.02822138e-02 -4.63090576e-02 -3.47401276e-02 -5.11340722e-02
 -5.62962182e-02  1.17372453e-01 -1.59793988e-01  9.73655283e-02]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.35534081890834457,1
req,src,test_data/LibEST_semeru_format/requirements/RQ36-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.h,requir simpl enrol client https post simpleenrol client must includ simpl pki request specifi cmc rfc section pkcs https tool ietf org html rfc certif request rfc certif sign request csr signatur provid proof possess client possess privat key est server csr key usag extens indic privat key use generat digit signatur client must generat csr signatur use privat key key use generat digit signatur request csr key usag extens prohibit generat digit signatur csr signatur may still generat use privat key key must use signatur oper consist recommend concern submiss proof possess describ part use fullcmc oper provid access advanc proof possess method use key pair cannot use digit signatur generat see section http content type applic pkcs use format messag specifi rfc content transfer encod base rfc est client authent use previous instal certif issu third parti see section client may includ chang subject name attribut defin rfc csr request subject name subject alt name chang new certif est client may request addit certif even use exist certif tls client authent exampl client use exist certif tls client authent request certif cannot use tls client authent,int ossl verifi int store ctx ctx libest test api void ossl dump ssl error void est error ossl init cert store store store unsign char raw int size,"[ 0.01958846 -0.1267131  -0.26361227  0.0145874   0.02303552  0.09173826
  0.24910069  0.05986529 -0.02182845 -0.09705956 -0.06950548 -0.03952636
 -0.01552563  0.09911339 -0.08838802  0.0376846   0.0128602   0.09496702
  0.09000012  0.06150854  0.03013017  0.06121313  0.0184723   0.09331339
  0.21549359  0.18582104  0.0122945   0.15009536 -0.04508191  0.04494869
  0.03135175 -0.06036976 -0.03284583 -0.14728865  0.14294499 -0.00290708
  0.0696394   0.10552076 -0.03977104 -0.09579479  0.014654   -0.07943401
 -0.0337011  -0.04474365  0.06860975  0.10271879  0.10087627 -0.06369101
  0.11845712 -0.16925041 -0.03052308 -0.09587932 -0.08245415  0.07262788
 -0.02431618  0.0016664  -0.0762477  -0.04948009  0.1508442  -0.11278421
 -0.00828508  0.01549758  0.20810996  0.10301318  0.01991542 -0.0580514
 -0.20639268  0.04115503  0.05356612 -0.05582773 -0.10964313  0.11765481
 -0.14923628  0.06093213 -0.06822452 -0.05772437 -0.04425952 -0.05823787
  0.16291292  0.00344182  0.1482024  -0.08956388  0.05866493 -0.02918248
  0.06739423 -0.0895301  -0.06890389  0.03722397 -0.13393629 -0.03364358
  0.06911814 -0.12094902 -0.05361405 -0.05153795 -0.04276393 -0.04734282
 -0.05141906  0.12375692 -0.15178855  0.10772501]","[-3.32884416e-02 -1.27662703e-01 -2.79828310e-01  5.80133311e-03
  6.43268228e-02  1.03074744e-01  2.14966252e-01  6.60702139e-02
 -7.85031915e-02 -8.58116224e-02 -4.89064455e-02 -4.54016812e-02
 -3.50504331e-02  7.81022385e-02 -8.51701126e-02 -4.31111641e-02
 -1.43419495e-02  8.63216594e-02  8.00839439e-02 -5.96548319e-02
 -3.35270874e-02  5.42765968e-02 -1.53618690e-03  9.97250006e-02
  2.21757606e-01  1.44508734e-01  2.97749359e-02  9.53684822e-02
 -1.38290357e-02  2.61135083e-02  6.73204586e-02 -7.80463517e-02
 -7.40294531e-02 -1.17273666e-01  1.25188559e-01 -1.86110064e-02
 -1.73459444e-02  8.57384130e-02 -7.10445195e-02 -6.99145049e-02
 -5.70689812e-02 -9.25302655e-02 -1.81697085e-02  2.58753784e-02
  4.22456441e-03  1.32250607e-01  2.52796076e-02  1.20715918e-02
  1.00857124e-01 -1.75514713e-01  7.28853466e-03 -9.01656672e-02
  6.84287661e-05  1.42916068e-01 -3.64756361e-02 -8.28685537e-02
 -6.90998882e-02 -5.78271784e-03  1.69050395e-01 -1.46098763e-01
 -1.19599076e-02 -4.28447016e-02  2.49336705e-01  1.46444991e-01
 -4.27160785e-03 -5.82108498e-02 -1.55882642e-01  4.36593667e-02
  2.77376771e-02 -3.03240996e-02 -7.65059143e-02  6.02095202e-02
 -1.25623688e-01  6.99399114e-02  1.62779465e-02  4.95273247e-03
 -4.01525758e-02 -1.00578167e-01  9.12162662e-02 -2.73536108e-02
  1.01810545e-01 -5.02358116e-02  9.73470807e-02 -9.18499660e-03
  3.33920047e-02 -6.09980337e-02 -6.28004223e-02  1.38998525e-02
 -9.23806950e-02 -2.97233351e-02  8.88039470e-02 -9.21974853e-02
 -9.68739688e-02 -3.19986381e-02 -2.76823603e-02 -1.23113375e-02
 -2.05206685e-02  1.97517261e-01 -1.74902141e-01  3.41759808e-02]",0.4808569839653497,0
req,src,test_data/LibEST_semeru_format/requirements/RQ34-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir certif respons success server respons must http respons code respons code indic error client must abort protocol success respons must cert cmc simpl pki respons defin rfc contain certif describ follow paragraph http content type applic pkcs mime use simpl pki respons sent content transfer encod base rfc est server must includ current root certif respons est server must includ addit certif client would need build chain est issu certif current est exampl est subordin appropri subordin certif necessari build chain root est includ respons est server includ three root key updat certif old old old new new old respons chain defin section cmp rfc est client must abl handl certif respons est recent self sign certif new new certif self sign latest date est server includ respons current est certif expir est client need reiniti pki use bootstrap distribut certif section method involv user interact band valid occur certif must valid use normal rfc certif path valid use recent certif use build certif path certif valid est client must store extract est certif explicit databas entri subsequ est server authent est client disabl use implicit databas entri est server explicit databas entri avail client disabl implicit databas est server certif verifi use implicit databas entri client must includ trust indic extens futur tls session rfc indic server est server certif authenticat explicit databas entri accept otherwis est server might continu use server certif verifi disabl implicit est client also make certif respons inform avail end entiti softwar use valid peer certif,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.02339767 -0.1270185  -0.26099136  0.01024865  0.01757123  0.08873273
  0.25414467  0.05126838 -0.01798994 -0.09407413 -0.07343505 -0.04350891
 -0.01998024  0.09083649 -0.09002466  0.04520605  0.01334724  0.08695947
  0.09256002  0.06462749  0.03504866  0.06073774  0.01412612  0.09494216
  0.21737574  0.1940941   0.00804922  0.1569892  -0.04963905  0.0496419
  0.01927823 -0.0638549  -0.02939481 -0.13758956  0.13944243 -0.00925746
  0.07873417  0.11077236 -0.03786821 -0.09753454  0.01953155 -0.07857829
 -0.0288356  -0.054874    0.06710736  0.10155272  0.10793929 -0.06229698
  0.11910134 -0.17733859 -0.03469973 -0.0893081  -0.0868752   0.06640238
 -0.02099572  0.00774699 -0.07795773 -0.04483058  0.14948858 -0.10687409
 -0.0059256   0.01612505  0.20881389  0.10195189  0.01822071 -0.05839076
 -0.20903791  0.03863799  0.05137467 -0.06286048 -0.1157866   0.11953192
 -0.1531012   0.06027981 -0.07472005 -0.06048715 -0.05265439 -0.05671989
  0.16568767  0.00358783  0.1556013  -0.09333678  0.06434973 -0.02548366
  0.06557094 -0.09371358 -0.06654649  0.04019627 -0.13649844 -0.03412395
  0.07137875 -0.11399649 -0.04554118 -0.05400779 -0.03886272 -0.0473214
 -0.06157602  0.12615602 -0.15542127  0.10463546]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.3700326489654619,1
req,src,test_data/LibEST_semeru_format/requirements/RQ33-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.h,requir certif request est client request est databas inform form certif https get messag use oper path cacert est client server must support cacert function client request date respons store inform expir order ensur est databas date est server requir client authent author repli request client must authent est server specifi section certif base authent use section option certif less authent use check server author given section follow procedur outlin section,prototyp privat est server part public api void est send http error est ctx ctx void http ctx int fail code prototyp privat est server part public api int est enrol auth est ctx ctx void http ctx ssl ssl char path seg int reenrol prototyp privat est server part public api int est handl cacert est ctx ctx unsign char cert int cert len void http ctx char path seg prototyp privat est server part public api int est tls uid auth est ctx ctx ssl ssl req req prototyp privat est server part public api req est server pars csr unsign char pkcs int pkcs len prototyp privat est server part public api int est server check csr req req prototyp privat est server part public api est error est server send http retri est ctx ctx void http ctx int delay,"[ 0.02632169 -0.13015677 -0.2576756   0.01241919  0.01260467  0.09004859
  0.2522737   0.0503244  -0.02057564 -0.09379324 -0.07570851 -0.04538738
 -0.02038482  0.08483381 -0.0916789   0.05207106  0.01732369  0.08419213
  0.09666848  0.07116482  0.04296283  0.05562077  0.01688949  0.09372921
  0.22051851  0.1913325   0.00567104  0.15829857 -0.04957277  0.04840507
  0.01775323 -0.0656731  -0.02494764 -0.13087797  0.12939404 -0.01119166
  0.08547689  0.11410074 -0.03459496 -0.08953839  0.02660134 -0.07269314
 -0.02627142 -0.06148451  0.0649793   0.0992192   0.10960004 -0.06579403
  0.12387184 -0.17508304 -0.03775979 -0.0879233  -0.09097252  0.06230897
 -0.02053265  0.01097035 -0.0834973  -0.04603983  0.14861546 -0.09757554
 -0.00125907  0.02326394  0.20627224  0.09426762  0.01389263 -0.06107499
 -0.20708948  0.04099749  0.04427666 -0.06992828 -0.12265079  0.12332729
 -0.15010153  0.06142894 -0.07495775 -0.05751375 -0.04960462 -0.04639466
  0.16415969  0.0054016   0.16442753 -0.09568474  0.06602313 -0.0174561
  0.06275233 -0.09495432 -0.06722612  0.04163887 -0.14510216 -0.03485824
  0.06642866 -0.11390972 -0.04807076 -0.05707845 -0.03834479 -0.04216758
 -0.06322502  0.1319232  -0.15268102  0.10635325]","[-0.03448066 -0.14800207 -0.26153752  0.01860353  0.03291209  0.09299336
  0.21855591  0.06188473 -0.0732351  -0.06656175 -0.05412377 -0.04942052
 -0.03035495  0.0804024  -0.08498437 -0.0202797   0.01305559  0.08039699
  0.08743906 -0.02085941  0.00387389  0.04203983  0.01802462  0.09953611
  0.21273911  0.14772174  0.02284225  0.11524689 -0.02219943  0.02153944
  0.06796216 -0.06937531 -0.06721529 -0.11362999  0.11698466 -0.00298368
  0.02319442  0.08784335 -0.05744766 -0.06246546 -0.01083424 -0.08002044
 -0.01642437  0.00855288  0.03213703  0.11672004  0.03887153 -0.01510844
  0.12558614 -0.15382355  0.00908638 -0.09248895 -0.03361282  0.123527
 -0.02250013 -0.05361122 -0.08870934 -0.02207963  0.15079229 -0.12053153
 -0.00388169 -0.01158211  0.23560339  0.11498204 -0.0041721  -0.06923901
 -0.16131113  0.03235906  0.0440696  -0.02854339 -0.08580997  0.08651803
 -0.13393743  0.07229796 -0.02247662 -0.02390396 -0.0316219  -0.07769834
  0.11652736 -0.0180934   0.13809282 -0.05395175  0.07918373 -0.01152649
  0.03642613 -0.07673904 -0.04851412  0.02588795 -0.10273923 -0.03565805
  0.07746129 -0.09363496 -0.08078434 -0.04323328 -0.04522039 -0.01802551
 -0.02205215  0.18893582 -0.14950466  0.063878  ]",0.39559472363472936,1
req,src,test_data/LibEST_semeru_format/requirements/RQ39-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir full cmc est client request certif est server https post use oper path valu fullcmc support fullcmc function option client server,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.0286738  -0.12377226 -0.26314363  0.00626567  0.01736777  0.09296239
  0.25464976  0.05189685 -0.0167871  -0.09914148 -0.07647866 -0.04660719
 -0.02258353  0.08461934 -0.09357786  0.05214413  0.01104196  0.08485492
  0.0966189   0.0682694   0.03902406  0.05879138  0.0115375   0.09298906
  0.22558674  0.19726248  0.00797105  0.16008733 -0.05236274  0.05341285
  0.01323281 -0.07040416 -0.02255218 -0.13155293  0.13503185 -0.01690895
  0.0824204   0.118871   -0.03467402 -0.09649996  0.02101236 -0.07635527
 -0.02718265 -0.06239719  0.06192379  0.10297251  0.1112942  -0.06241665
  0.11810257 -0.1838368  -0.04344601 -0.08730295 -0.08754975  0.06260104
 -0.02336557  0.01150582 -0.07861178 -0.04252569  0.15203165 -0.10085892
 -0.00072142  0.01738137  0.20987333  0.10102387  0.01646906 -0.05849835
 -0.21338788  0.04265477  0.04484015 -0.07211962 -0.12576418  0.1217806
 -0.15298802  0.06146162 -0.072516   -0.05523285 -0.05442924 -0.05183978
  0.16435184  0.00227955  0.15819138 -0.09672785  0.06951652 -0.01741732
  0.06482944 -0.09368659 -0.06855002  0.04402376 -0.14555973 -0.0347495
  0.07145251 -0.11022122 -0.04747614 -0.05698948 -0.03449067 -0.04256414
 -0.06748926  0.1299227  -0.15914488  0.10019467]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.4379296390342681,1
req,src,test_data/LibEST_semeru_format/requirements/RQ23-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir certif less tls mutual authent certif less tls cipher suit provid way perform mutual authent situat neither client server certif desir use certif trust anchor necessari verifi certif client server may negoti certif less cipher suit mutual authent use certif less mutual authent tls enrol cipher suit must base protocol resist dictionari attack must base zero knowledg protocol transport layer secur secur remot password tls srp cipher suit srp name list section rfc suitabl purpos section list characterist cipher suit suitabl use certif less mutual authent enrol success authent use certif less cipher suit prove knowledg pre share secret implicit author peer exchang,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[ 0.03502419 -0.11070093 -0.26910967  0.00777616  0.02791341  0.10168082
  0.2549339   0.05649045 -0.0143865  -0.12104694 -0.07655802 -0.0343263
 -0.0197481   0.09124649 -0.09171128  0.0503534   0.00999131  0.09990548
  0.09415257  0.07287048  0.0353492   0.0612152   0.00379392  0.08496425
  0.23055631  0.19217035  0.01274706  0.14793596 -0.04581299  0.04930047
  0.01866526 -0.06496868 -0.01570188 -0.14055377  0.13634585 -0.01440789
  0.06431904  0.1236918  -0.0424067  -0.09151722  0.00775591 -0.08086397
 -0.0342573  -0.0591412   0.05797459  0.1055127   0.10518643 -0.05868877
  0.10452148 -0.18195724 -0.051609   -0.08838895 -0.08329114  0.05896837
 -0.03349564  0.00661981 -0.06643137 -0.04309354  0.16077377 -0.1123402
 -0.00621304  0.00910075  0.20758864  0.11458318  0.01921583 -0.05592223
 -0.21312287  0.05017256  0.03245937 -0.08189879 -0.13241974  0.11413654
 -0.14800094  0.06054307 -0.05660127 -0.03889328 -0.04985166 -0.05365571
  0.15377773 -0.0011861   0.14377767 -0.09773597  0.06884117 -0.01214004
  0.06039708 -0.08083048 -0.07974792  0.0349386  -0.14917791 -0.03636461
  0.06550532 -0.12041557 -0.05732323 -0.05503714 -0.02430081 -0.03534544
 -0.06488306  0.12177993 -0.16346969  0.09805314]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.3365365149574266,1
req,src,test_data/LibEST_semeru_format/requirements/RQ11-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.h,requir full pki request messag full pki request rfc messag transport via est use full cmc request function afford access function provid simpl enrol function full pki request messag defin section rfc see section discuss est provid transport messag,mingw typedef pid int use defin static int pthread mutex lock pthread mutex mingw typedef pid int use defin static int pthread mutex unlock pthread mutex mingw typedef pid int use defin static void unicod const char path wchar wbuf size wbuf len,"[ 0.03035533 -0.11383446 -0.26580575  0.00432627  0.02761981  0.09399769
  0.25304827  0.0585673  -0.01167726 -0.10678162 -0.07353128 -0.0416877
 -0.01743504  0.0939384  -0.09069099  0.04607029  0.00137209  0.09475562
  0.09469792  0.06103455  0.02877524  0.06895774  0.00851756  0.09243834
  0.22240849  0.19871967  0.01279013  0.15411621 -0.05440762  0.05680403
  0.01392296 -0.06882903 -0.0241872  -0.14597565  0.1472446  -0.01552509
  0.06938189  0.11110464 -0.03822511 -0.10802761  0.00768994 -0.08492652
 -0.03423871 -0.05296767  0.06456269  0.10608641  0.10997982 -0.06282111
  0.1113403  -0.18659192 -0.04517302 -0.09046815 -0.07760712  0.06825775
 -0.02904774  0.010488   -0.06754573 -0.03778215  0.1523315  -0.11436163
 -0.00847246  0.00577043  0.2057648   0.11153105  0.02295171 -0.04931873
 -0.21511501  0.04179766  0.05078291 -0.0664045  -0.11246302  0.11593832
 -0.15496098  0.05869327 -0.06714286 -0.05493055 -0.05402278 -0.06265676
  0.16176315  0.0004058   0.13889988 -0.09779175  0.06496396 -0.0277472
  0.07281877 -0.08981834 -0.07433216  0.04431475 -0.13806516 -0.03113637
  0.07690786 -0.11427344 -0.04971594 -0.04923675 -0.03018457 -0.05416696
 -0.0632909   0.11871101 -0.16276231  0.09612863]","[-0.03037988 -0.11331    -0.27465558 -0.00203319  0.07519955  0.09355958
  0.19650115  0.06960465 -0.06197666 -0.07534166 -0.03835084 -0.04944178
 -0.02543062  0.08664084 -0.08646585 -0.04048822 -0.0412206   0.09362981
  0.08307725 -0.07858405 -0.05480267  0.06726368 -0.00325975  0.09827047
  0.20161283  0.16126537  0.04237292  0.09172165 -0.03171454  0.0403454
  0.0507689  -0.08224706 -0.06746737 -0.13799907  0.14117962 -0.02948107
 -0.02898829  0.06969103 -0.06291301 -0.10410526 -0.07580978 -0.11767408
 -0.01902835  0.04528895  0.00822657  0.1325896   0.04069861  0.00389869
  0.09279744 -0.18381928  0.00359802 -0.08284968  0.02725833  0.15617426
 -0.03961406 -0.0730326  -0.04251455  0.01983031  0.1554352  -0.16565521
 -0.02604633 -0.06621581  0.23679247  0.16015719  0.00463419 -0.03216541
 -0.16877046  0.03641336  0.05460791 -0.01445771 -0.0313769   0.0533159
 -0.13452259  0.0657654   0.01098714 -0.00750631 -0.04080506 -0.11322837
  0.08275991 -0.02547094  0.06750318 -0.05717668  0.08456459 -0.02704674
  0.05315566 -0.06293311 -0.06729733  0.02463711 -0.07433925 -0.01553668
  0.12031873 -0.07553184 -0.08833927 -0.01761947 -0.01969375 -0.0383084
 -0.02034266  0.18647684 -0.16771911  0.00373917]",0.5000559613766117,0
req,src,test_data/LibEST_semeru_format/requirements/RQ13-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir protocol design layer figur provid expans figur describ layer use aspect describ detail section follow est layer protocol use messag type simpl pki messag incorpor proof possess certif retriev full pki messag option incorpor proof possess csr attribut request option server generat key request option http http header uri control content type header specifi messag type header control error messag uri select function basic digest authent option tls transport secur authent est server authent est client option provid communic integr confidenti suppli channel bind rfc5929 inform link proof ident messag base proof possess option figur specifi https secur transport enrol messag introduc two layer communic authent control messag tls http tls layer provid integr confidenti transport proof ident suppli tls handshak authent option also http layer header messag type control error messag includ http header cmc rfc5272 section note simpl pki request must use proof ident need includ sinc tls http layer provid proof ident est client server simpl pki messag type use tls layer certif exchang provid method author client enrol request use exist certif certif may issu client request certif may issu distinct pki ieee 802 1ar initi devic identifi idev idev credenti proof possess pop distinct issu proof ident includ simpl pki messag type describ section method link proof ident proof possess describ section document also defin transport cmc rfc5272 compli cmc transport protocol rfc5273 cmc pop proof ident mechan defin cmc mechan also use conjunct mechan full pki messag protocol exchang differ certif use follow tabl provid inform overview end entiti one certif type list figur use one trust anchor databas type list figur certif correspond use certif issuer use section refer est server serv present est server certif est server tls handshak section est server present est server certif authenticat tls handshak third parti web server section secur consider third parti present est client est client authenticat est server client certif third parti yet enrol devic manufactur section est client serv present est server certif est server futur est oper section end entiti serv client obtain cert certif est server intend non est use includ cert cannot use est oper section figur trust anchor databas correspond use databas use section refer est server est server use databas authent explicit certif issu est includ est databas client certif enrol enrol oper section est server est server use databas authent implicit certif issu third parti tas databas est client certif issu devic manufactur implicit databas disabl section est client est client use databas authent explicit certif issu est includ est databas server certif section est client est client use databas implicit authent est server use extern databas issu certif implicit databas disabl section secur consider figur,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.02657052 -0.12036944 -0.26600012  0.00769731  0.02519619  0.09288459
  0.25211862  0.05701216 -0.01458956 -0.10315142 -0.07204935 -0.04307814
 -0.01753975  0.0918503  -0.09113381  0.04400409  0.00530834  0.09245326
  0.09301442  0.06330608  0.029698    0.06563444  0.01179966  0.09417477
  0.22073424  0.19526982  0.01328366  0.15423985 -0.05215363  0.05093993
  0.01829844 -0.06766375 -0.02699149 -0.14411442  0.14303838 -0.01353413
  0.07248268  0.11295755 -0.03767674 -0.10352062  0.01059605 -0.08310931
 -0.03325747 -0.05130202  0.06405777  0.10393772  0.11089683 -0.06294422
  0.11399092 -0.18142961 -0.04011103 -0.09035882 -0.08026907  0.06851946
 -0.02783009  0.00620223 -0.07116716 -0.04109729  0.15358302 -0.11183792
 -0.0082901   0.01096577  0.21020721  0.10914733  0.0199991  -0.05213115
 -0.21127588  0.04138465  0.05004081 -0.06428101 -0.11133707  0.11746637
 -0.15366139  0.05925317 -0.0694292  -0.05662212 -0.05164877 -0.05942052
  0.16088142  0.00261978  0.14584544 -0.09660456  0.06596328 -0.0266951
  0.0698906  -0.09136602 -0.07157568  0.04181428 -0.13868223 -0.03170133
  0.07565615 -0.11579034 -0.05002736 -0.05038233 -0.03448498 -0.04919431
 -0.0617221   0.12435626 -0.15915889  0.09953406]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.3954711515416769,0
req,src,test_data/LibEST_semeru_format/requirements/RQ35-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir client certif request function est client request certif est server https post use oper path valu simpleenrol est client request renew rekey exist certif http post use oper path valu simplereenrol est server must support simpleenrol simplereenrol function recommend client obtain current certif describ section perform certif request function ensur client abl valid est server certif client must authent est server specifi section certif base authent use section option certif less authent use client must verifi author est server specifi section server must authent client specifi section certif base authent use section option certif less authent use server must verifi client author specifi section est server must check tls uniqu valu describ section one submit client server may accept certif request manual author check administr section describ use http respons est client occur,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.03689534 -0.1224552  -0.2568433   0.00792768  0.01106641  0.08807577
  0.25695542  0.04656845 -0.0127191  -0.09853647 -0.08033545 -0.04252779
 -0.01942581  0.08458116 -0.09271383  0.06479581  0.0166279   0.08412797
  0.09623074  0.08328172  0.04783554  0.05795944  0.01206963  0.0890021
  0.22144334  0.1973424   0.00333641  0.1645551  -0.05161984  0.05344819
  0.00673593 -0.0641315  -0.01540605 -0.13119297  0.12998529 -0.01592202
  0.0922823   0.11883807 -0.0300463  -0.09425151  0.03032228 -0.06955707
 -0.02640462 -0.07272374  0.06725335  0.09677907  0.11729274 -0.07283836
  0.12072316 -0.17987792 -0.04727729 -0.08643714 -0.09648091  0.05093245
 -0.01917445  0.02142201 -0.08029334 -0.04823495  0.1490937  -0.09342832
  0.00071497  0.02508539  0.1992632   0.09175977  0.01805615 -0.06051861
 -0.21439505  0.0438037   0.04135104 -0.07798237 -0.13040361  0.12575293
 -0.150844    0.05832598 -0.0796911  -0.05936405 -0.05246435 -0.04153801
  0.1698879   0.00824522  0.16596366 -0.10138979  0.06497496 -0.01554407
  0.06635085 -0.09616321 -0.07020454  0.04289234 -0.15226892 -0.03601051
  0.0630153  -0.11515877 -0.04412894 -0.06039564 -0.0345933  -0.04476745
 -0.07034493  0.12267117 -0.15355836  0.10991908]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.44266442090636654,0
req,src,test_data/LibEST_semeru_format/requirements/RQ29-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir client author decis issu certif client alway control local polici est server configur reflect polici document specifi constraint polici est provid est server access client authent ident tls client certif addit http user authent credenti help implement polici client certif issu est includ cmc rfc extend key usag extens client registr author describ rfc rfc case est server appli author polici consist client exampl handl simpleenrol request est server could configur accept pop link inform match current tls session authent est client verifi inform act est server specifi section specif mechan avail est client use fullcmc method,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.02829203 -0.12302754 -0.26229742  0.00880806  0.02002794  0.09051092
  0.25270495  0.05446298 -0.01571509 -0.09972385 -0.07377151 -0.04399642
 -0.01788861  0.08840609 -0.09109861  0.04871471  0.00914043  0.08954263
  0.09437549  0.06899469  0.0366182   0.06181451  0.01434302  0.09435619
  0.22057936  0.19458833  0.0112726   0.15630749 -0.05232048  0.04996011
  0.01733976 -0.06790815 -0.02509712 -0.1393817   0.13728    -0.01343643
  0.08020362  0.11493257 -0.03532334 -0.09900467  0.01777131 -0.07821506
 -0.03149048 -0.05596867  0.06513039  0.10057502  0.11343491 -0.06573108
  0.11800817 -0.17973056 -0.03928315 -0.08946294 -0.08520797  0.06376544
 -0.02493978  0.0095234  -0.07520843 -0.0428663   0.15157445 -0.10560311
 -0.00431229  0.01709236  0.20855834  0.10295875  0.01721841 -0.05470847
 -0.21069679  0.04191446  0.04686016 -0.06694676 -0.11594611  0.1205094
 -0.15234648  0.06024561 -0.0731443  -0.05764334 -0.05095166 -0.05290856
  0.16270734  0.00474755  0.15396082 -0.09820273  0.06537385 -0.02404833
  0.06720523 -0.09346303 -0.06992313  0.04271678 -0.14311957 -0.03287098
  0.07132775 -0.11474663 -0.04793837 -0.05362155 -0.0352576  -0.04658654
 -0.06290676  0.12567624 -0.15676533  0.10325272]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.41688060767823215,1
req,src,test_data/LibEST_semeru_format/requirements/RQ9-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir client certif reissuanc est client renew rekey exist client certif submit enrol request est server current est client certif use tls client authent section client present certif est server client authent reissu est client certif cannot use tls client authent authent method use initi enrol use exampl client altern certif issu est use tls client authent use certif request messag includ subject subject alt name current certif name chang request specifi section,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.03855427 -0.12504819 -0.2510919   0.01149607  0.0076158   0.08488826
  0.2566574   0.041898   -0.01368416 -0.09432435 -0.08369258 -0.04079591
 -0.01946473  0.08366457 -0.09057654  0.06961349  0.02362834  0.08212152
  0.0974941   0.08827223  0.05380687  0.05302203  0.01362798  0.08697211
  0.21853083  0.19203764 -0.00266988  0.16265064 -0.04830605  0.05039161
  0.00691337 -0.06188225 -0.01308225 -0.12560394  0.12174503 -0.0113884
  0.09587349  0.11893199 -0.0296308  -0.08670709  0.03561904 -0.0636338
 -0.024173   -0.07395966  0.0657983   0.09188224  0.11764099 -0.07374547
  0.12383506 -0.17309202 -0.04423895 -0.08757625 -0.09842665  0.04801712
 -0.01542364  0.02070923 -0.08416303 -0.05040414  0.1475078  -0.09013534
  0.00167859  0.02768153  0.19512877  0.08436232  0.01481133 -0.06555238
 -0.20995972  0.04324034  0.03715029 -0.08059732 -0.13407245  0.12586959
 -0.14669149  0.05806143 -0.08023839 -0.06041915 -0.05022393 -0.03406627
  0.1698249   0.01045215  0.17348748 -0.10187751  0.0622394  -0.01184198
  0.06312705 -0.09554031 -0.07106808  0.04059054 -0.15562667 -0.03961741
  0.05655479 -0.11454917 -0.04301624 -0.06507436 -0.03648514 -0.04148217
 -0.07063986  0.12546714 -0.14945333  0.11585773]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.4657170331986571,0
req,src,test_data/LibEST_semeru_format/requirements/RQ51-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,requir secur consider support basic authent specifi http rfc allow server access client cleartext password provid support legaci usernam password databas requir expos plaintext password est server use pin one time password help mitig exposur recommend est client use credenti obtain client certif use futur interact est server client use implicit databas certif valid see section author proceed specifi section situat client valid server respond certifi third parti uri configur cannot verifi respond author act pki client tri enrol client use implicit trust anchor databas recommend use tls base client authent prevent expos http base client authent inform recommend client includ link ident pop inform section request prevent request forward real est server man middl recommend implicit trust anchor databas use est server authent care manag reduc chanc third parti poor certif practic trust disabl implicit trust anchor databas success receiv distribut certif respons section limit vulner first tls exchang certif less tls cipher suit maintain secur perform mutual authent necessari enrol follow properti inform leak activ attack whether singl guess secret correct advantag adversari gain interact comput possibl perform countermeasur exponenti backoff certain number fail attempt frustrat repeat activ attack use certif less cipher suit properti list would render result enrol void potenti result certif issu unauthent unauthor entiti use certif less tls cipher suit share secret use authent author cannot share entiti parti exchang someon client server addit share secret void secur afford certif less cipher suit exposur share secret use certif less cipher suit third parti enabl client imperson result corrupt client trust anchor databas tls cipher suit includ export des name must use cipher offer suffici level protect bit crypto offer accept protect use des deprec describ cmc section rfc key use signatur key sign certif request privat key serv pop key pair inclus tls uniqu within certif request link proof possess tls proof ident enforc pop oper occur tls session activ impli server authent client current access privat key authent client known specif capabl hardwar protect authent credenti key storag implic strengthen proven server side key generat method allow key transport tls connect client without applic layer protect distribut privat key materi inher riski privat key distribut use encrypt mode negoti tls cipher suit key protect prefer key wrap method key wrap rfc specifi rfc encrypt privat key beyond provid tls option recommend est server support oper default recommend client request servic unless compel oper benefit use implicit trust anchor databas recommend server side key generat employ use encrypt cms server side key generat respons recommend regard csr attribut may list inclus enrol request real inher secur issu content convey adversari abl interpos convers could exclud attribut server may want includ attribut server may want render meaningless attribut server may want asn encod rule der ber type length valu structur easi construct malici content invalid length field caus buffer overrun condit asn encod rule allow arbitrari level nest may make possibl construct malici content caus stack overflow interpret asn structur awar issu take appropri measur guard buffer overflow stack overrun particular malici content general,"function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 0.0189344  -0.12086762 -0.27243558  0.01124373  0.0368322   0.09904639
  0.24570268  0.06664453 -0.02290943 -0.10877211 -0.06552196 -0.04178625
 -0.01695314  0.09657768 -0.08949996  0.02774441  0.00127898  0.10010207
  0.08983328  0.04830928  0.01734949  0.06528727  0.01335612  0.09518918
  0.2228079   0.18503615  0.0203068   0.14092821 -0.04587187  0.04432371
  0.03544043 -0.06770312 -0.03433644 -0.15114896  0.14524175 -0.01042842
  0.05346381  0.10856967 -0.04492432 -0.09854058 -0.00346637 -0.08806235
 -0.03638779 -0.03482285  0.05887227  0.11063449  0.09703409 -0.05485849
  0.10917465 -0.17768449 -0.03212404 -0.09335963 -0.06889676  0.08228234
 -0.03486841 -0.01089434 -0.06850056 -0.03938957  0.15965264 -0.12361487
 -0.01187668  0.00436597  0.21695496  0.11946355  0.0173128  -0.05032689
 -0.20565802  0.04454385  0.04663602 -0.05815081 -0.10334317  0.11066569
 -0.14804283  0.0624555  -0.05406999 -0.04576638 -0.0440175  -0.06608483
  0.14855218 -0.00354439  0.1332854  -0.09077922  0.06694544 -0.02622521
  0.06570163 -0.08479669 -0.07486844  0.0359394  -0.13179006 -0.02893699
  0.07756511 -0.11924619 -0.06247345 -0.04438787 -0.03446443 -0.04317556
 -0.04945877  0.13138828 -0.1619641   0.09331657]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.2993582904052633,1
req,src,test_data/LibEST_semeru_format/requirements/RQ34-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_http.c,requir certif respons success server respons must http respons code respons code indic error client must abort protocol success respons must cert cmc simpl pki respons defin rfc contain certif describ follow paragraph http content type applic pkcs mime use simpl pki respons sent content transfer encod base rfc est server must includ current root certif respons est server must includ addit certif client would need build chain est issu certif current est exampl est subordin appropri subordin certif necessari build chain root est includ respons est server includ three root key updat certif old old old new new old respons chain defin section cmp rfc est client must abl handl certif respons est recent self sign certif new new certif self sign latest date est server includ respons current est certif expir est client need reiniti pki use bootstrap distribut certif section method involv user interact band valid occur certif must valid use normal rfc certif path valid use recent certif use build certif path certif valid est client must store extract est certif explicit databas entri subsequ est server authent est client disabl use implicit databas entri est server explicit databas entri avail client disabl implicit databas est server certif verifi use implicit databas entri client must includ trust indic extens futur tls session rfc indic server est server certif authenticat explicit databas entri accept otherwis est server might continu use server certif verifi disabl implicit est client also make certif respons inform avail end entiti softwar use valid peer certif,"sign long sign int int curlx sltosi long slnum ifdef intel compil pragma warn push pragma warn disabl convers may lose signific bit endif assert slnum sizeof int curl sizeof long assert unsign long slnum unsign long curl mask sint endif return int slnum long curl mask sint ifdef intel compil pragma warn pop endif parsed return parsed fine convers parsed fail fail convert parsed later time overflow far end time parsed sooner time underflow low end time static int parsed const char date time output return day monday sunday static int checkday const char check size len int const char const int found len weekday els curl wkday est client curl raw equal check found break return found return day monday sunday static int checkmonth const char check int const char const int found curl month est client curl raw equal check found break return found return offset real offset return time zone offset gmt input one number second timezon found legal static int checktz const char check unsign int const struct tzinfo int found sizeof sizeof ]); ++) check name found break ++; return found offset return time zone offset gmt input one number second timezon found legal static void skip_over_whit const char date skip everyth letter digit (** date isalnum (** date date )++; struct time sinc epoch gmt time zone similar standard mktime function gmt suffer various bug portabl problem system implement static time_t my_timegm struct my_tm static const int month_days_cumul 120 151 181 212 243 273 304 334 int month year leap_day tm_year support year 1970 caus function return negat valu return year tm_year 1900 month tm_mon month year month month month els month year month month month leap_day year tm_mon leap_day leap_day leap_day 100 leap_day 400 1969 1969 100 1969 400 )); return (((( time_t year 1970 365 leap_day month_days_cumul month tm_mday tm_hour tm_min tm_sec parsed return parsedate_ok fine convers parsedate_fail fail convert parsedate_lat time overflow far end time_t parsedate_soon time underflow low end time_t static int parsed const char date time_t output time_t int wdaynum day week number mon sun int monnum month year number int mdaynum day month int hournum int minnum int secnum int yearnum int tzoff struct my_tm enum assum dignext date_mday const char indat date save origin pointer int part max part date part int found skip_over_whit date isalpha date name come char buf ]=""""; size_t len sscanf date ]"", buf len strnlen_ buf wdaynum wdaynum checkday buf len wdaynum found found monnum monnum checkmonth buf monnum found found tzoff must time zone string tzoff checktz buf tzoff found found return parsedate_fail bad string date len els isdigit date digit int val char end secnum sscanf date 02d 02d 02d hournum minnum secnum ))) time stamp date els secnum sscanf date 02d 02d hournum minnum ))) time stamp without second date secnum els long lval int error int old_errno old_errno errno set_errno lval strtol date end error errno error old_errno set_errno old_errno error return parsedate_fail lval long int_max lval long int_min return parsedate_fail val curlx_sltosi lval tzoff end date val 1400 indat date date date -'))) four digit valu less equal 1400 take account sort funni time zone diff preced plus minus time zone indic 1400 pick sinc 1300 frequent use 1400 mention edg number document iso 200x propos timezon function http :// david tribbl com text c0xtimezon html anyon authorit sourc exact maximum time zone offset pleas speak found tzoff val 100 val 100 prefix indic local time compar gmt need ther revers math get want tzoff date ]=='+'?- tzoff tzoff ((( end date yearnum monnum mdaynum digit year month day yet yyyymmdd found yearnum val 10000 monnum val 10000 100 month mdaynum val 100 found dignext date_mday mdaynum val val mdaynum val found dignext date_year found dignext date_year yearnum yearnum val found yearnum 1900 yearnum yearnum 1900 els yearnum 2000 mdaynum dignext date_mday found return parsedate_fail date end part ++; secnum secnum minnum hournum time make zero ((- mdaynum monnum yearnum lack vital info fail return parsedate_fail sizeof_time_t bit time_t hold date begin 2038 yearnum 2037 output 0x7fffffff return parsedate_lat endif yearnum 1970 output return parsedate_soon mdaynum monnum hournum minnum secnum return parsedate_fail clear illeg date tm_sec secnum tm_min minnum tm_hour hournum tm_mday mdaynum tm_mon monnum tm_year yearnum 1900 my_timegm return time_t time_t often bit even mani architectur featur bit long system bit time_t deal year beyond 2038 howev even system bit time_t mktime return date beyond utc januari 2038 aix 5100 my_timegm time zone adjust cast int compar negat one int add time zone diff local time zone gmt long delta long tzoff !=- tzoff delta delta return time_t overflow delta output return parsedate_ok find next field --------------- find next rfc822 token string entri pstr point string contain word separ white white space "","" "";"" ""="". word option quot use <""> ""<"" "">"" comment surrround filter exit pstr move first delimit past field string mutil termin return pointer first word null error static char htnext field char pstr char char start null pstr pstr return null pstr strip white space delimit isspac int =')) ++; (!* pstr return null field ""') quot field start ""'; ++) ++; skip escap char break kr95 need stop els <') quot field start >'; ++) ++; skip escap char break kr95 need stop els (') comment )'; ++) ++; skip escap char ++; els spool field start isspac int =') ++; break got pstr return start function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static est_error est_ctx ctx char hdr int est_err_non char hdr char token null char valu null int diff errno_t safec_rc header come basic digest field still front skip token htnext field token htnext field ))) est_strcasecmp_ token realm "")) valu htnext field ))) eok strncpy_ ctx realm max_realm valu max_realm els els est_strcasecmp_ token nonc "")) valu htnext field ))) eok strncpy_ ctx s_nonc max_nonc valu max_nonc els els est_strcasecmp_ token qop "")) valu htnext field ))) valu est_log_warn unsupport qop valu valu els safec_rc memcmp_ valu sizeof auth ""), auth sizeof auth ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff safec_rc eok est_log_warn unsupport qop valu valu els els est_strcasecmp_ token algorithm "")) valu htnext field est_strcasecmp_ valu md5 "")) est_log_err unsupport digest algorithm valu support md5 moment els est_strcasecmp_ token error "")) valu htnext field ))) eok strncpy_ ctx token_error max_token_error valu max_token_error els els est_strcasecmp_ token error_descript "")) valu htnext field ))) eok strncpy_ ctx token_error_desc max_token_error_desc valu max_token_error_desc els els est_log_warn unsupport auth token ignor token memzero_ ctx s_nonc max_nonc break return function pars authent token server server request http digest authent token requir generat valid authent respons futur http request static http_header parse_http_head unsign char buf int num_head int http_header hdrs char hdr_end errno_t safec_rc num_head hdrs malloc sizeof http_header max_head hdrs est_log_err malloc failur ""); return null find offset header delimint safec_rc strstr_s char buf strnlen_ char buf rsize_max_str hdr_end safec_rc eok est_log_info strstr_s error safec_rc skip first line skip char **) buf ""); max_head ++) hdrs name skip_quot char **) buf "":"", hdrs valu skip char **) buf ""); fflush stdout est_log_info found http header hdrs name hdrs valu fflush stdout hdrs name break num_head ((* buf unsign char hdr_end break est_log_info found http header num_head return hdrs function pars http status code first header hand code handl est full http stack unrecogn code result error note http expect static int unsign char buf strncmp const char buf est_http_hdr_200 strnlen_ est_http_hdr_200 est_http_hdr_max ))) return 200 els strncmp const char buf est_http_hdr_202 strnlen_ est_http_hdr_202 est_http_hdr_max ))) return 202 els strncmp const char buf est_http_hdr_204 strnlen_ est_http_hdr_204 est_http_hdr_max ))) return 204 els strncmp const char buf est_http_hdr_400 strnlen_ est_http_hdr_400 est_http_hdr_max ))) return 400 els strncmp const char buf est_http_hdr_401 strnlen_ est_http_hdr_401 est_http_hdr_max ))) return 401 els strncmp const char buf est_http_hdr_404 strnlen_ est_http_hdr_404 est_http_hdr_max ))) return 404 els strncmp const char buf est_http_hdr_423 strnlen_ est_http_hdr_423 est_http_hdr_max ))) return 423 els est_log_err unhandl http respons buf return function search process www authent header server result set auth_mod valu context www authent header valu header invalid set auth_mod failur set multipl authent header first one process static void est_ctx ctx http_header hdrs int hdr_cnt int est_error int auth_found walk header look www authent process first one erron second one includ ignor hdr_cnt ++) strncmp hdrs name est_http_hdr_auth auth_found strncmp hdrs valu basic ctx auth_mod auth_bas pars realm ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu digest ctx auth_mod auth_digest pars realm nonc ctx hdrs valu est_err_non ctx auth_mod auth_fail els strncmp hdrs valu bearer ctx auth_mod auth_token pars realm possibl token error field ctx hdrs valu est_err_non ctx auth_mod auth_fail els est_log_err unsupport www authent method ""); ctx auth_mod auth_fail break auth_found est_log_err www authent header found ""); ctx auth_mod auth_fail return function take list header server respons walk header look retri respons header one found valu pars save away est context valu one two format repres ascii string first format count number second client wait retri request second format time date stamp point time client retri request result function set retry_aft valu context retri header receiv receiv could pars valu zero otherwis set valu receiv note est client current support time date format respons process respons format static est_error est_ctx ctx http_header hdrs int hdr_cnt est_error int int cmp_result diff int long long int temp_ll int found initi assum retri header ctx retry_after_delay ctx retry_after_d hdr_cnt ++) cmp_result strcasecmp_ hdrs name sizeof diff cmp_result eok diff est_log_info retri valu hdrs valu found determin whether valu date time string integ repres number second client must wait isalpha (*( char hdrs valu ifdef int convert date time string time_t parsed hdrs valu ctx retry_after_d parsedate_ok est_log_err retri valu could pars ""); els format current support est_log_err retri valu correct format ""); endif els make sure digit make sure larger four byte integ cach away valu return retri delay strisdigit_ hdrs valu max decim place temp_ll atol hdrs valu temp_ll int_max ctx retry_after_delay int temp_ll els est_log_err retri valu larg ""); els est_log_err retri valu could pars ""); found est_log_err retri header miss ""); return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int http_header hdrs int hdr_cnt est_oper int int int content_type_pres content_length_pres int cmp_result travers http header process one need check hdr_cnt ++) content type memcmp_ hdrs name sizeof est_http_hdr_ct est_http_hdr_ct sizeof est_http_hdr_ct cmp_result cmp_result content_type_pres verifi content pkcs7 data memcmp_ hdrs valu strnlen_ est_op_map content_typ est_op_map length est_op_map content_typ strnlen_ est_op_map content_typ est_op_map length cmp_result cmp_result est_log_err http content type hdrs valu return els content length memcmp_ hdrs name sizeof est_http_hdr_cl est_http_hdr_cl sizeof est_http_hdr_cl cmp_result cmp_result content_length_pres atoi hdrs valu make sure necessari header present content_type_pres est_log_err miss http content type header ""); return els content_length_pres est_log_err miss http content length header ""); return return function verifi content type header also return length content header content type import exampl content type expect pkcs7 simpl enrol static int est_ssl_read ssl ssl unsign char buf int buf_max int sock_read_timeout int timeout int read_fd int struct pollfd pfd load timev struct pass select timeout sock_read_timeout 1000 read_fd ssl_get_fd ssl pfd read_fd pfd event pollin pfd revent errno poll pfd timeout est_log_err socket poll timeout data receiv server .""); return els est_log_err socket read failur errno errno return els return ssl_read ssl buf buf_max )); function extract data ssl context put buffer static int est_io_read_raw ssl ssl unsign char buf int buf_max int read_cnt int sock_read_timeout int cur_cnt char peek_read_buf read_cnt cur_cnt est_ssl_read ssl buf buf_max sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt multipl call ssl_read may requir get full http payload cur_cnt read_cnt buf_max cur_cnt est_ssl_read ssl buf read_cnt buf_max read_cnt sock_read_timeout cur_cnt est_log_err tls read error ""); ossl_dump_ssl_error (); return est_err_ssl_read read_cnt cur_cnt ((* read_cnt buf_max ssl_peek ssl peek_read_buf est_log_err buffer small receiv messag ""); return return est_err_non function provid primari entri point modul use est client read http respons server data read ssl context http pars invok est_err_non return raw_buf buffer must freed caller otherwis freed est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len int est_err_non http_header hdrs int hdr_cnt int http_status unsign char raw_buf payload_buf payload int raw_len raw_buf malloc est_ca_max raw_buf null est_log_err unabl alloc memori ""); return est_err_malloc memzero_ raw_buf est_ca_max payload raw_buf read raw data ssl connect est_io_read_raw ssl raw_buf est_ca_max raw_len ctx read_timeout est_err_non est_log_info valid respons process ""); free raw_buf return raw_len est_log_warn receiv empti http respons server ""); free raw_buf return est_log_info read byte http data raw_len pars http header get status look status 200 success http_status raw_buf ctx last_http_status http_status hdrs parse_http_head payload hdr_cnt est_log_info http status receiv http_status check status header first see server accept request switch http_status case 200 server report noth break case 204 case 404 est_log_err server respond 204 404 content found ""); est_op_csrattr est_err_non els http_status 404 els est_err_unknown break case 202 server ask retri est_log_info est server respond retri ""); ctx hdrs hdr_cnt break case 400 est_log_err http respons est server bad request ""); est_err_http_bad_req break case 401 server request user auth credenti est_log_info est server request user authent ""); check alreadi tri authent bail first time auth_mod set none ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token ctx auth_mod auth_fail est_err_auth_fail break ctx hdrs hdr_cnt est_err_auth_fail break case 423 est_log_err server respond 423 content attempt access lock ""); est_err_http_lock break case unsupport http respons est_log_err unsupport http respons est server )"", http_status est_err_unknown break default http respons given want handl est_log_err http respons est server http_status break est_err_non get content type content length header verifi http respons contain correct amount data payload_len hdrs hdr_cnt est_log_info http content len payload_len payload_len est_ca_max est_log_err content length larger maximum valu ."", est_ca_max est_err_unknown payload_len buf null els payload_len payload_len buf null els alloc buffer hold payload pass back payload_buf malloc payload_len payload_buf est_log_err unabl alloc memori ""); free raw_buf free hdrs return est_err_malloc memcpy_ payload_buf payload_len payload payload_len buf payload_buf raw_buf free raw_buf hdrs free hdrs return","[ 0.02339767 -0.1270185  -0.26099136  0.01024865  0.01757123  0.08873273
  0.25414467  0.05126838 -0.01798994 -0.09407413 -0.07343505 -0.04350891
 -0.01998024  0.09083649 -0.09002466  0.04520605  0.01334724  0.08695947
  0.09256002  0.06462749  0.03504866  0.06073774  0.01412612  0.09494216
  0.21737574  0.1940941   0.00804922  0.1569892  -0.04963905  0.0496419
  0.01927823 -0.0638549  -0.02939481 -0.13758956  0.13944243 -0.00925746
  0.07873417  0.11077236 -0.03786821 -0.09753454  0.01953155 -0.07857829
 -0.0288356  -0.054874    0.06710736  0.10155272  0.10793929 -0.06229698
  0.11910134 -0.17733859 -0.03469973 -0.0893081  -0.0868752   0.06640238
 -0.02099572  0.00774699 -0.07795773 -0.04483058  0.14948858 -0.10687409
 -0.0059256   0.01612505  0.20881389  0.10195189  0.01822071 -0.05839076
 -0.20903791  0.03863799  0.05137467 -0.06286048 -0.1157866   0.11953192
 -0.1531012   0.06027981 -0.07472005 -0.06048715 -0.05265439 -0.05671989
  0.16568767  0.00358783  0.1556013  -0.09333678  0.06434973 -0.02548366
  0.06557094 -0.09371358 -0.06654649  0.04019627 -0.13649844 -0.03412395
  0.07137875 -0.11399649 -0.04554118 -0.05400779 -0.03886272 -0.0473214
 -0.06157602  0.12615602 -0.15542127  0.10463546]","[-0.00987736 -0.11911407 -0.2841379   0.00779026  0.07010551  0.11020532
  0.21956828  0.08649327 -0.0472606  -0.11266565 -0.04507514 -0.04941731
 -0.02074194  0.09147213 -0.08542818 -0.0242101  -0.0258745   0.10481261
  0.08187146 -0.02030602 -0.02759121  0.06745998  0.00749176  0.10427962
  0.227792    0.1629232   0.03945069  0.10436959 -0.03800827  0.03180632
  0.06665646 -0.08501376 -0.06131442 -0.15126903  0.14578922 -0.01711159
 -0.00118449  0.09328528 -0.06543815 -0.09235742 -0.05367571 -0.10725161
 -0.03737934  0.01557842  0.02767696  0.12949339  0.06183678 -0.01494845
  0.09363889 -0.18110369 -0.0098926  -0.09057959 -0.01962026  0.13053118
 -0.05518321 -0.06301711 -0.05672394 -0.01362461  0.17390853 -0.15026285
 -0.02201219 -0.02932046  0.242307    0.15510128  0.00329678 -0.03584385
 -0.17889638  0.04433239  0.03926572 -0.03635661 -0.06652797  0.08144163
 -0.1339039   0.06515578 -0.00812013 -0.01195321 -0.03717465 -0.09508131
  0.10198383 -0.02140859  0.09113996 -0.07103333  0.08522316 -0.02457515
  0.05434166 -0.06651933 -0.07538471  0.02887119 -0.10447777 -0.01726953
  0.09799939 -0.1103819  -0.09234454 -0.01928411 -0.02889781 -0.03046735
 -0.02491977  0.16676706 -0.17673336  0.04843231]",0.3897527973402313,0
req,src,test_data/LibEST_semeru_format/requirements/RQ37-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.h,requir simpl enrol client est client renew rekey certif https post use oper path valu simplereenrol certif request employ format simpleenrol request use http content type request subject field subject alt name extens must ident correspond field certif renew rekey chang subject name attribut defin rfc may includ csr request field chang new certif subject public key info certif request current client certif est server renew client certif public key inform certif request differ current client certif est server rekey client certif,int ossl verifi int store ctx ctx libest test api void ossl dump ssl error void est error ossl init cert store store store unsign char raw int size,"[ 0.02295932 -0.12865157 -0.2625398   0.01363922  0.01829726  0.09003629
  0.25150552  0.05542459 -0.01990543 -0.09313633 -0.07183094 -0.0412991
 -0.01735939  0.09687065 -0.0909993   0.04445602  0.01407989  0.09161455
  0.09333055  0.06359763  0.03318593  0.06020574  0.0169421   0.09363894
  0.21687745  0.19183625  0.00954306  0.15490624 -0.04763202  0.04855616
  0.02515566 -0.06079069 -0.02876247 -0.14382209  0.1408722  -0.00644099
  0.07494213  0.10709721 -0.03881552 -0.09667473  0.01849294 -0.0799085
 -0.03088927 -0.05000524  0.06838377  0.10262059  0.10563357 -0.06634908
  0.1211201  -0.17385156 -0.03273186 -0.09386048 -0.08346482  0.07101897
 -0.02114828  0.00621938 -0.07780352 -0.04723461  0.14949845 -0.11155997
 -0.00720455  0.01730639  0.20717327  0.10144386  0.01950153 -0.0586481
 -0.2100551   0.04180185  0.05469429 -0.05930049 -0.11200804  0.11920834
 -0.15185603  0.06116544 -0.07240494 -0.06149346 -0.04770958 -0.05611951
  0.16585332  0.00490728  0.15383731 -0.09296948  0.06011818 -0.02691165
  0.06591925 -0.09343504 -0.06941733  0.03889604 -0.13679385 -0.03456806
  0.0714708  -0.11622873 -0.04947356 -0.0547639  -0.04174098 -0.0487047
 -0.05604007  0.12654388 -0.15204012  0.10639653]","[-3.32884416e-02 -1.27662703e-01 -2.79828310e-01  5.80133311e-03
  6.43268228e-02  1.03074744e-01  2.14966252e-01  6.60702139e-02
 -7.85031915e-02 -8.58116224e-02 -4.89064455e-02 -4.54016812e-02
 -3.50504331e-02  7.81022385e-02 -8.51701126e-02 -4.31111641e-02
 -1.43419495e-02  8.63216594e-02  8.00839439e-02 -5.96548319e-02
 -3.35270874e-02  5.42765968e-02 -1.53618690e-03  9.97250006e-02
  2.21757606e-01  1.44508734e-01  2.97749359e-02  9.53684822e-02
 -1.38290357e-02  2.61135083e-02  6.73204586e-02 -7.80463517e-02
 -7.40294531e-02 -1.17273666e-01  1.25188559e-01 -1.86110064e-02
 -1.73459444e-02  8.57384130e-02 -7.10445195e-02 -6.99145049e-02
 -5.70689812e-02 -9.25302655e-02 -1.81697085e-02  2.58753784e-02
  4.22456441e-03  1.32250607e-01  2.52796076e-02  1.20715918e-02
  1.00857124e-01 -1.75514713e-01  7.28853466e-03 -9.01656672e-02
  6.84287661e-05  1.42916068e-01 -3.64756361e-02 -8.28685537e-02
 -6.90998882e-02 -5.78271784e-03  1.69050395e-01 -1.46098763e-01
 -1.19599076e-02 -4.28447016e-02  2.49336705e-01  1.46444991e-01
 -4.27160785e-03 -5.82108498e-02 -1.55882642e-01  4.36593667e-02
  2.77376771e-02 -3.03240996e-02 -7.65059143e-02  6.02095202e-02
 -1.25623688e-01  6.99399114e-02  1.62779465e-02  4.95273247e-03
 -4.01525758e-02 -1.00578167e-01  9.12162662e-02 -2.73536108e-02
  1.01810545e-01 -5.02358116e-02  9.73470807e-02 -9.18499660e-03
  3.33920047e-02 -6.09980337e-02 -6.28004223e-02  1.38998525e-02
 -9.23806950e-02 -2.97233351e-02  8.88039470e-02 -9.21974853e-02
 -9.68739688e-02 -3.19986381e-02 -2.76823603e-02 -1.23113375e-02
 -2.05206685e-02  1.97517261e-01 -1.74902141e-01  3.41759808e-02]",0.4861522568165183,0
req,src,test_data/LibEST_semeru_format/requirements/RQ36-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir simpl enrol client https post simpleenrol client must includ simpl pki request specifi cmc rfc section pkcs https tool ietf org html rfc certif request rfc certif sign request csr signatur provid proof possess client possess privat key est server csr key usag extens indic privat key use generat digit signatur client must generat csr signatur use privat key key use generat digit signatur request csr key usag extens prohibit generat digit signatur csr signatur may still generat use privat key key must use signatur oper consist recommend concern submiss proof possess describ part use fullcmc oper provid access advanc proof possess method use key pair cannot use digit signatur generat see section http content type applic pkcs use format messag specifi rfc content transfer encod base rfc est client authent use previous instal certif issu third parti see section client may includ chang subject name attribut defin rfc csr request subject name subject alt name chang new certif est client may request addit certif even use exist certif tls client authent exampl client use exist certif tls client authent request certif cannot use tls client authent,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[ 0.01958846 -0.1267131  -0.26361227  0.0145874   0.02303552  0.09173826
  0.24910069  0.05986529 -0.02182845 -0.09705956 -0.06950548 -0.03952636
 -0.01552563  0.09911339 -0.08838802  0.0376846   0.0128602   0.09496702
  0.09000012  0.06150854  0.03013017  0.06121313  0.0184723   0.09331339
  0.21549359  0.18582104  0.0122945   0.15009536 -0.04508191  0.04494869
  0.03135175 -0.06036976 -0.03284583 -0.14728865  0.14294499 -0.00290708
  0.0696394   0.10552076 -0.03977104 -0.09579479  0.014654   -0.07943401
 -0.0337011  -0.04474365  0.06860975  0.10271879  0.10087627 -0.06369101
  0.11845712 -0.16925041 -0.03052308 -0.09587932 -0.08245415  0.07262788
 -0.02431618  0.0016664  -0.0762477  -0.04948009  0.1508442  -0.11278421
 -0.00828508  0.01549758  0.20810996  0.10301318  0.01991542 -0.0580514
 -0.20639268  0.04115503  0.05356612 -0.05582773 -0.10964313  0.11765481
 -0.14923628  0.06093213 -0.06822452 -0.05772437 -0.04425952 -0.05823787
  0.16291292  0.00344182  0.1482024  -0.08956388  0.05866493 -0.02918248
  0.06739423 -0.0895301  -0.06890389  0.03722397 -0.13393629 -0.03364358
  0.06911814 -0.12094902 -0.05361405 -0.05153795 -0.04276393 -0.04734282
 -0.05141906  0.12375692 -0.15178855  0.10772501]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.3215210470766453,1
req,src,test_data/LibEST_semeru_format/requirements/RQ56-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.h,requir csr attribut follow exampl valid csrattr exchang exchang est client authent use exist certif issu est server provid servic initi tls handshak ident enrol exampl handshak http get request get well known est csrattr http user agent curl linux gnu libcurl open zlib libidn librtmp host accept respons server provid suggest attribut appropri authent client exampl est server also includ two exampl attribut client would ignor unless attribut type known client http status content type applic csrattr content transfer encod base content length mhw gbys gaqebaryw ydi bmrs tgvbhcn ifnfvcbhci ljk igrhd geg csq gsib dqejbz oinw jqydi dbg oinw qtgvbhcn ifnfvcbhci ljk igrhd gegcssk mccaebcw yjyiziawudba,prototyp privat est server part public api void est send http error est ctx ctx void http ctx int fail code prototyp privat est server part public api int est enrol auth est ctx ctx void http ctx ssl ssl char path seg int reenrol prototyp privat est server part public api int est handl cacert est ctx ctx unsign char cert int cert len void http ctx char path seg prototyp privat est server part public api int est tls uid auth est ctx ctx ssl ssl req req prototyp privat est server part public api req est server pars csr unsign char pkcs int pkcs len prototyp privat est server part public api int est server check csr req req prototyp privat est server part public api est error est server send http retri est ctx ctx void http ctx int delay,"[ 0.02395854 -0.11083509 -0.2696939   0.00515233  0.04010803  0.09671755
  0.24046211  0.06863278 -0.01207215 -0.1117431  -0.06320527 -0.04308947
 -0.01416053  0.09575117 -0.08713961  0.0288417  -0.00998502  0.09967745
  0.08809737  0.04669232  0.01060457  0.07284181  0.00952477  0.09429001
  0.22104488  0.18953803  0.0214175   0.14017102 -0.05411264  0.05012326
  0.0253354  -0.07133163 -0.03016269 -0.15383331  0.15113176 -0.01756203
  0.05233524  0.10688986 -0.04261354 -0.10935302 -0.01193745 -0.09400719
 -0.03930497 -0.03585842  0.05647051  0.10987123  0.10731338 -0.05385493
  0.10140332 -0.18513335 -0.03681063 -0.08934456 -0.0631026   0.08197857
 -0.04023861 -0.00683201 -0.05887919 -0.03182765  0.15806551 -0.12478047
 -0.01661825 -0.00180007  0.21305229  0.12544496  0.02079645 -0.03837957
 -0.20633687  0.04470221  0.05019088 -0.05663951 -0.09237517  0.10703102
 -0.14943752  0.05738793 -0.05464655 -0.04639229 -0.04928357 -0.07054825
  0.14588083 -0.00191426  0.12022975 -0.09506229  0.06673502 -0.03118519
  0.07284617 -0.08285208 -0.07806559  0.04052639 -0.12932838 -0.0242494
  0.08375161 -0.11621556 -0.05853105 -0.03820031 -0.02922564 -0.05089702
 -0.05512664  0.12103469 -0.16541101  0.08473887]","[-0.03448066 -0.14800207 -0.26153752  0.01860353  0.03291209  0.09299336
  0.21855591  0.06188473 -0.0732351  -0.06656175 -0.05412377 -0.04942052
 -0.03035495  0.0804024  -0.08498437 -0.0202797   0.01305559  0.08039699
  0.08743906 -0.02085941  0.00387389  0.04203983  0.01802462  0.09953611
  0.21273911  0.14772174  0.02284225  0.11524689 -0.02219943  0.02153944
  0.06796216 -0.06937531 -0.06721529 -0.11362999  0.11698466 -0.00298368
  0.02319442  0.08784335 -0.05744766 -0.06246546 -0.01083424 -0.08002044
 -0.01642437  0.00855288  0.03213703  0.11672004  0.03887153 -0.01510844
  0.12558614 -0.15382355  0.00908638 -0.09248895 -0.03361282  0.123527
 -0.02250013 -0.05361122 -0.08870934 -0.02207963  0.15079229 -0.12053153
 -0.00388169 -0.01158211  0.23560339  0.11498204 -0.0041721  -0.06923901
 -0.16131113  0.03235906  0.0440696  -0.02854339 -0.08580997  0.08651803
 -0.13393743  0.07229796 -0.02247662 -0.02390396 -0.0316219  -0.07769834
  0.11652736 -0.0180934   0.13809282 -0.05395175  0.07918373 -0.01152649
  0.03642613 -0.07673904 -0.04851412  0.02588795 -0.10273923 -0.03565805
  0.07746129 -0.09363496 -0.08078434 -0.04323328 -0.04522039 -0.01802551
 -0.02205215  0.18893582 -0.14950466  0.063878  ]",0.3722190532784162,0
req,src,test_data/LibEST_semeru_format/requirements/RQ27-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.h,requir client use explicit databas est client explicit databas use valid est server certif client must check either configur uri recent http redirect uri server ident accord rule specifi rfc section est server certif must contain cmc rfc extend key usag extens,mingw typedef pid int use defin static int pthread mutex lock pthread mutex mingw typedef pid int use defin static int pthread mutex unlock pthread mutex mingw typedef pid int use defin static void unicod const char path wchar wbuf size wbuf len,"[ 0.02390055 -0.12597431 -0.2631655   0.01040151  0.01925609  0.0920774
  0.25199944  0.05535672 -0.01897776 -0.09745026 -0.07395645 -0.04448171
 -0.01967564  0.08998011 -0.09123667  0.04600066  0.01245892  0.08952808
  0.0948455   0.06588144  0.03504631  0.05964885  0.01615124  0.09356245
  0.22093287  0.19145012  0.00997437  0.15609276 -0.04950342  0.0486571
  0.02222176 -0.06530076 -0.02671593 -0.1388655   0.13808008 -0.01112219
  0.07793518  0.1139987  -0.03662445 -0.09551631  0.01903202 -0.07861656
 -0.0306011  -0.05370657  0.06653112  0.10241868  0.10766543 -0.06430312
  0.11941468 -0.17811885 -0.03670623 -0.09031085 -0.08610275  0.06702688
 -0.02481533  0.00803096 -0.07795316 -0.04525677  0.15163578 -0.10662755
 -0.00400082  0.01707375  0.20941612  0.10327631  0.01720794 -0.05782084
 -0.21023452  0.04170449  0.0485475  -0.06408824 -0.1170109   0.12093838
 -0.15194032  0.06114425 -0.07208493 -0.05720827 -0.04917835 -0.05349147
  0.16324273  0.00277698  0.15384234 -0.09474903  0.06435243 -0.02221297
  0.06501196 -0.09243767 -0.06796791  0.04146977 -0.14070383 -0.03437184
  0.07146786 -0.11527655 -0.04992236 -0.05380597 -0.0375825  -0.04526428
 -0.059297    0.12870216 -0.15559691  0.10350665]","[-0.03037988 -0.11331    -0.27465558 -0.00203319  0.07519955  0.09355958
  0.19650115  0.06960465 -0.06197666 -0.07534166 -0.03835084 -0.04944178
 -0.02543062  0.08664084 -0.08646585 -0.04048822 -0.0412206   0.09362981
  0.08307725 -0.07858405 -0.05480267  0.06726368 -0.00325975  0.09827047
  0.20161283  0.16126537  0.04237292  0.09172165 -0.03171454  0.0403454
  0.0507689  -0.08224706 -0.06746737 -0.13799907  0.14117962 -0.02948107
 -0.02898829  0.06969103 -0.06291301 -0.10410526 -0.07580978 -0.11767408
 -0.01902835  0.04528895  0.00822657  0.1325896   0.04069861  0.00389869
  0.09279744 -0.18381928  0.00359802 -0.08284968  0.02725833  0.15617426
 -0.03961406 -0.0730326  -0.04251455  0.01983031  0.1554352  -0.16565521
 -0.02604633 -0.06621581  0.23679247  0.16015719  0.00463419 -0.03216541
 -0.16877046  0.03641336  0.05460791 -0.01445771 -0.0313769   0.0533159
 -0.13452259  0.0657654   0.01098714 -0.00750631 -0.04080506 -0.11322837
  0.08275991 -0.02547094  0.06750318 -0.05717668  0.08456459 -0.02704674
  0.05315566 -0.06293311 -0.06729733  0.02463711 -0.07433925 -0.01553668
  0.12031873 -0.07553184 -0.08833927 -0.01761947 -0.01969375 -0.0383084
 -0.02034266  0.18647684 -0.16771911  0.00373917]",0.5300284707873304,0
req,src,test_data/LibEST_semeru_format/requirements/RQ57-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir enrol enrol follow exampl valid simpleenrol exchang data messag simplereenrol similar exchang est client use band distribut usernam password authent est server normal http www authent behavior includ inform purpos exist tls client certif use server might skip request http www authent header simplereenrol oper initi tls handshak client ignor option server generat certif request instead proceed http post request respons initi http post attempt server request www authent client might occur even client use client certif detail normat text http unauthor content length www authent digest qop auth realm estrealm nonc subsequ http post usernam password includ along complet applic pkcs content post well known est simpleenrol http author digest usernam estus realm estrealm nonc uri well known est simpleenrol cnonc tyw mzg qop auth respons host accept content type applic pkcs content transfer encod base content length miich tccaw caqaw mbs ueax muzgvtb zxa idez njgx ndez ntiwgg gcsq gsib dqebaquaa ibdw awgg ekao ibaqcl kdz kaum fyjp qkz zixqixc mcatn zrcax gjwbqo xsqff odbyw wdk qoibnt cqri ydc krmjmo slm nkf mlr krmah ycsvw tnv javh teiit ayq ryhk cxo dan skf tyci vxfx wwi skeprel devag bieym rxtlujirwnq srj oquzk d31be961kzcx ygrhxa r4pag aagg itaf bgkqhki g9w0bcqcx mqk3ji q2li lzcr rvl1ntbundanbgkqhki g9w0b aqufaaocaqearbv0aj hpl1mfidz wqoi1d ocf6u ywc bzp ladv pk1qx5pq xm830a1o 7rvr nyd6vf2rl a9lywibj lxo bo8d kxr yl16c vus yydi1m daft ysrgol mlt weiqbc2sdbr2k hxw1tr130h icpwmr29k c2kzur 5thsuj276fgl1v pu0d gqfx4wwa9u ahbgz6t w37cep zsr uke 0pf vhr2o hgbqdqhvtfvj hccd axicrtb u5o1l pv7f4l eapv3sbqm jcaq5o832bz hw7n mfc m15e9gt uvee5c62b vwuk tbn gsbw est server use usernam password perform authent author respond issu certif http 200 status 200 content type applic pkcs7 mime smime type cert content transfer encod base64 content length 1122 miidoayjko zihvc naqc iidktccay ucaqex adalbgkqhki g9w0bbw gggg mlmiid ccae ibag ibftanbgkqhki g9w0baqufadab mrkw ydvqqdex blc3rfe gft gxl q0eg tnd omb4xdtez mduw otiz mtu1m1o xdte0mduw otiz mtu1m1ow mbs a1ueax muzgvtb3n0zxa0idez njgx ndez ntiwgg ma0gcsq gsib3dqebaquaa4ib awgg ekao ibaqcl kdz nj8xp ep9kaum dz3e fyjp qkz9dd d5e5oz cm103 zixqixc0 mcatn rr3dn zrcax gjwbqo b3e kt29 xsqff odbyw0wdk qoibnt qry8ydc 8lj n7m2krmjmo slm u2v4a ycsvw tnv 6mx6pr2p tj82javh teiit ayq1ryhk m1cxo dan n7tz c94skf s3vv f53 j9sk tycy1rw0k3vxfx wwi skeprel7i6k0y devag bieym l1s69rxtluji rwnq srj oquzk d31be961kzcx ygrhxa r4pag mbaagj bqma4ga1ud dad nvhq4efg b6ii6ic q8w gmxvy1jf e4xt ydvr0j bbgw rp5luj bkf yl6olo7 5ar qjww dqyjko zihvc naqefbqadgg ebacmxg1hv ftaroxain bx5gxd z9om sb0l 4pdvg khz mcrc u6m4yp5n0edkm ga6 y8fb et4tt7ju jg6ixb95 760th0vuctwk gr6 d6ettfqi hnrbh x3l ahn 0ja7 o1gv4cwxh1i8a txdp ohorv n0smxdcrl cys2vrt r2a3kaj jo6e q5le odz opha lwen0e2blnji0v c2fa 2lmcnf c38xf gala5a8e7f nhxwzbj xzlbcza3 es9mlh2cj wxm mvd eqnt fpgg f8izsrv ruct ge1lg dmu6afuxc r4por t2xz8ch adea,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.01086677 -0.11569759 -0.28234908  0.00865691  0.05637074  0.10462321
  0.23565991  0.08105508 -0.02279514 -0.11592611 -0.05374048 -0.04687865
 -0.01230416  0.10313725 -0.08892097  0.00668846 -0.02123964  0.10955703
  0.08608304  0.0214883  -0.01048485  0.0763002   0.01242931  0.10334464
  0.224149    0.18546924  0.03474633  0.12835288 -0.05218068  0.04371798
  0.04764066 -0.07795496 -0.04618291 -0.16880637  0.16087836 -0.01423203
  0.0291514   0.09832232 -0.05347303 -0.11215606 -0.0329565  -0.10921572
 -0.04392487 -0.0091577   0.05223354  0.1207661   0.09599475 -0.04334331
  0.09906842 -0.18660526 -0.02528658 -0.09504613 -0.04417253  0.10603093
 -0.05040376 -0.03031288 -0.05405537 -0.02554804  0.16556297 -0.14586699
 -0.02407699 -0.01302934  0.2279794   0.14382462  0.01681753 -0.03241924
 -0.20396417  0.04428796  0.05654696 -0.04329154 -0.07235874  0.10083704
 -0.14799389  0.06084191 -0.04004302 -0.04092317 -0.04353067 -0.08508565
  0.13239193 -0.00888586  0.10366532 -0.08903971  0.07002182 -0.03829064
  0.07049979 -0.07948064 -0.07984372  0.03788071 -0.11605795 -0.01662358
  0.09837063 -0.11859854 -0.07322418 -0.02647374 -0.03121147 -0.05059266
 -0.03966936  0.13683142 -0.17230171  0.07387189]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.2810755680285971,1
req,src,test_data/LibEST_semeru_format/requirements/RQ45-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir request asymmetr encrypt privat key specifi asymmetr encrypt key use encrypt server generat privat key client must includ asymmetr decrypt key identifi attribut asymmetr decrypt key identifi attribut defin asymm decrypt key object identifi asymmetr decrypt key identifi attribut valu asn type asymmetr decrypt key identifi asn defin asymmetr decrypt key identifi octet string server public key match identifi specifi client request must termin error return client distribut key specifi asymmetr decrypt key identifi key generat client outsid scope document key identifi bound certif key must either explicit support key transport key agreement use must unrestrict,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[-0.01903737 -0.15851521 -0.2653666   0.03420503  0.02131716  0.09314218
  0.23720728  0.07227997 -0.05305812 -0.07365578 -0.05325852 -0.04244871
 -0.01582221  0.11108595 -0.08458643 -0.00175141  0.02718496  0.09703909
  0.08508353  0.02950925  0.01984661  0.04977895  0.03923777  0.1069194
  0.20719326  0.158462    0.02001022  0.13253199 -0.03080961  0.0223055
  0.07900513 -0.05211078 -0.06441168 -0.15466492  0.14247584  0.01987765
  0.05165501  0.08726027 -0.05061065 -0.07576956  0.01427613 -0.08255435
 -0.03630516 -0.0072949   0.07321486  0.10791153  0.0679185  -0.05327526
  0.13751121 -0.14157149  0.00948063 -0.1081468  -0.0727725   0.10930569
 -0.02034199 -0.0320744  -0.09329873 -0.05649677  0.14927727 -0.1274813
 -0.01164808  0.01980522  0.22579765  0.10159064  0.0121653  -0.07030316
 -0.18499786  0.03173618  0.06695539 -0.02378062 -0.08543126  0.11468208
 -0.1438714   0.06976923 -0.06048561 -0.05996561 -0.02265866 -0.06996401
  0.15597215 -0.00330241  0.15204081 -0.06555766  0.05197034 -0.03531701
  0.0552163  -0.08915283 -0.05440256  0.02912815 -0.11034888 -0.03304452
  0.07162654 -0.12292724 -0.07012123 -0.04660139 -0.06514648 -0.03973281
 -0.01753863  0.15259886 -0.13708946  0.11415056]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.368227800545114,0
req,src,test_data/LibEST_semeru_format/requirements/RQ56-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.c,requir csr attribut follow exampl valid csrattr exchang exchang est client authent use exist certif issu est server provid servic initi tls handshak ident enrol exampl handshak http get request get well known est csrattr http user agent curl linux gnu libcurl open zlib libidn librtmp host accept respons server provid suggest attribut appropri authent client exampl est server also includ two exampl attribut client would ignor unless attribut type known client http status content type applic csrattr content transfer encod base content length mhw gbys gaqebaryw ydi bmrs tgvbhcn ifnfvcbhci ljk igrhd geg csq gsib dqejbz oinw jqydi dbg oinw qtgvbhcn ifnfvcbhci ljk igrhd gegcssk mccaebcw yjyiziawudba,"author routin int ossl verifi int store ctx ctx int cert error store ctx get error ctx current cert store ctx get current cert ctx est log info enter function cert error cert error current cert name print stdout _get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% serror depth lookup ctx crl path """", cert_error ctx cert_error )); switch cert_error case enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok warn applic est_log_warn crl load tls peer allow .""); break case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error break return return function use load x509_store use raw data buffer data expect pem encod return number cert store static int x509_store store unsign char raw int size stack_of x509_info null x509_info bio int cert_cnt bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return load file stack x509 crl pkey set null null null null est_log_err unabl read pem encod cert bio ""); bio_fre return bio_fre scan pull crl sk_x509_info_num sk_x509_info_shift x509 null est_log_info cert store )"", x509 name x509_store_add_cert store x509 cert_cnt ++; crl null est_log_info crl store ""); x509_store_add_crl store crl x509_info_fre null sk_x509_info_pop_fre x509_info_fre return cert_cnt function use popul x509_store structur use open ssl tls stack verifi tls peer x509_store alreadi alloc paramet store pointer x509_store structur hold cert raw1 char array contain pem encod cert put store size1 length raw1 char array est_error ossl_init_cert_stor x509_store store unsign char raw1 int size1 x509_store_set_flag store int cnt raw1 cnt store raw1 size1 cnt est_log_err cert count zero store ""); return return est_err_non function use output open ssl error buffer use open ssl api call fail like provid detail user regard caus failur void ossl_dump_ssl_error bio null buf_mem bptr null bio_new bio_s_mem ()); est_log_err bio_new fail ""); return err_print_error void bio_flush bio_get_mem_ptr bptr est_log_warn ossl error bptr data bio_free_al /*! brief convert base64 encod pkcs7 respons est server pem format param certs_p7 point buffer contain base64 encod pkcs7 data param certs_len indic size certs_p7 buffer param pem doubl pointer receiv pem encod data sever est messag return data contain base64 encod pkcs7 certif function use convert data pem format function alloc memori point pem argument caller respons releas memori return valu length pem buffer error return int int unsign char certs_p7 int certs_len unsign char pem x509 stack_of x509 cert null bio b64 unsign char cacerts_decod null int cacerts_decoded_len bio p7bio_in null pkcs7 null int nid unsign char pem_data int pem_len base64 decod incom cert buffer decod alway take origin buffer b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); return bio_new_mem_buf certs_p7 certs_len est_log_err bio_new fail ""); return bio_push b64 cacerts_decod malloc certs_len cacerts_decod est_log_err malloc fail ""); return cacerts_decoded_len bio_read cacerts_decod certs_len bio_free_al get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); free cacerts_decod return d2i_pkcs7_bio p7bio_in null est_log_err pem_read_bio_pkcs7 fail ""); ossl_dump_ssl_error (); free cacerts_decod return bio_free_al p7bio_in free cacerts_decod decod cert get refer stack cert nid obj_obj2nid type switch nid case nid_pkcs7_sign cert sign cert break case nid_pkcs7_sign envelop cert signed_and_envelop cert break default est_log_err invalid nid valu pkcs7 structur ""); pkcs7_free return break cert est_log_err fail attain x509 cert stack pkcs7 data ""); pkcs7_free return output cert new bio use pem format bio_new bio_s_mem ()); est_log_err bio_new fail ""); pkcs7_free return sk_x509_num cert ++) sk_x509_valu cert pem_write_bio_x509 bio_put ""); void bio_flush convert bio char pem_len int bio_get_mem_data char **)& pem_data pem_len est_log_err bio_get_mem_data fail ""); pkcs7_free return pem malloc pem_len (!* pem est_log_err malloc fail ""); pkcs7_free return memcpy_ pem pem_len pem_data pem_len pem pem_len make sure null termiant bio_free_al pkcs7_free return pem_len","[ 0.02395854 -0.11083509 -0.2696939   0.00515233  0.04010803  0.09671755
  0.24046211  0.06863278 -0.01207215 -0.1117431  -0.06320527 -0.04308947
 -0.01416053  0.09575117 -0.08713961  0.0288417  -0.00998502  0.09967745
  0.08809737  0.04669232  0.01060457  0.07284181  0.00952477  0.09429001
  0.22104488  0.18953803  0.0214175   0.14017102 -0.05411264  0.05012326
  0.0253354  -0.07133163 -0.03016269 -0.15383331  0.15113176 -0.01756203
  0.05233524  0.10688986 -0.04261354 -0.10935302 -0.01193745 -0.09400719
 -0.03930497 -0.03585842  0.05647051  0.10987123  0.10731338 -0.05385493
  0.10140332 -0.18513335 -0.03681063 -0.08934456 -0.0631026   0.08197857
 -0.04023861 -0.00683201 -0.05887919 -0.03182765  0.15806551 -0.12478047
 -0.01661825 -0.00180007  0.21305229  0.12544496  0.02079645 -0.03837957
 -0.20633687  0.04470221  0.05019088 -0.05663951 -0.09237517  0.10703102
 -0.14943752  0.05738793 -0.05464655 -0.04639229 -0.04928357 -0.07054825
  0.14588083 -0.00191426  0.12022975 -0.09506229  0.06673502 -0.03118519
  0.07284617 -0.08285208 -0.07806559  0.04052639 -0.12932838 -0.0242494
  0.08375161 -0.11621556 -0.05853105 -0.03820031 -0.02922564 -0.05089702
 -0.05512664  0.12103469 -0.16541101  0.08473887]","[-0.02280794 -0.13919947 -0.28047982  0.02055176  0.05719239  0.11580008
  0.21982583  0.08664732 -0.06486179 -0.10728963 -0.04538092 -0.0485174
 -0.02340238  0.0915816  -0.08403641 -0.03389406 -0.00680382  0.10322481
  0.08214781 -0.02023232 -0.01739727  0.05432794  0.02143495  0.10811873
  0.23230235  0.14707267  0.03343172  0.09869646 -0.02522595  0.01939251
  0.08936349 -0.079725   -0.07090753 -0.14112723  0.13800469 -0.0044158
 -0.00118626  0.09041351 -0.07368236 -0.0651512  -0.03746948 -0.0967169
 -0.03527454  0.01767246  0.02962421  0.1314824   0.04278544 -0.00958085
  0.1028138  -0.1680194   0.00360245 -0.09777321 -0.03135832  0.1338649
 -0.05140613 -0.07215084 -0.07555516 -0.02815823  0.17305858 -0.14494699
 -0.01413719 -0.01573827  0.24476083  0.14470093 -0.00722645 -0.05078406
 -0.16619018  0.04294062  0.03615962 -0.03229743 -0.07867274  0.08533599
 -0.1291659   0.07151608 -0.00589654 -0.00445574 -0.02803521 -0.09147019
  0.10225114 -0.02535055  0.10955609 -0.05982644  0.08245157 -0.01598702
  0.03577185 -0.06218307 -0.06432889  0.02448558 -0.102182   -0.02171448
  0.08405258 -0.11564184 -0.09899607 -0.02413773 -0.0364875  -0.01774029
 -0.01183339  0.17720269 -0.17135827  0.06180004]",0.3462540208308148,0
req,src,test_data/LibEST_semeru_format/requirements/RQ53-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.h,"requir inform refer idev ieee standard associ ieee secur devic identifi decemb http standard ieee org findstd standard html rfc howard approach use ldap network inform servic rfc march rfc rescorla http tls rfc may rfc nystrom kaliski pkcs https tool ietf org html rfc select object class attribut type version rfc novemb rfc schaad housley advanc encrypt standard key wrap algorithm rfc septemb rfc taylor mavrogiannopoulo perrin use secur remot password srp protocol tls authent rfc novemb rfc turner applic pkcs media type rfc august rfc zieglar turner peck suit profil certif manag cms rfc novemb shs nation institut standard technolog secur hash standard shs feder inform process standard public march http csrc nist gov public fip fips180 fip 180 pdf 800 part nation institut standard technolog recommend key manag part general revis )"", juli 2012 http :// csrc nist gov public nistpub 800 sp800 57_part1_rev3_gener pdf",tcw err tcw connect tcw sock sock tcw opt opt const char host unsign short int port sock type tcw err tcw close tcw sock sock,"[ 0.01319338 -0.11533403 -0.2819848   0.00990328  0.05376234  0.10185458
  0.23951474  0.08045531 -0.01853419 -0.1131255  -0.05485727 -0.04338977
 -0.0102566   0.1099622  -0.08808511  0.01196841 -0.01779054  0.1122872
  0.08624494  0.02919303 -0.00689821  0.07794971  0.0141936   0.10150144
  0.22071712  0.18736595  0.03268617  0.13126399 -0.05178919  0.04590297
  0.04534998 -0.07178124 -0.04453324 -0.17484565  0.16308282 -0.01045712
  0.03377596  0.09652384 -0.05052194 -0.11465301 -0.0268607  -0.10799024
 -0.04462377 -0.01027137  0.05799931  0.11823808  0.09819899 -0.05109863
  0.10031927 -0.18378118 -0.02648262 -0.09882805 -0.04807419  0.10333949
 -0.04671875 -0.02342246 -0.05312942 -0.03053781  0.1639278  -0.14686675
 -0.02447448 -0.01016775  0.22425641  0.14013483  0.02079331 -0.03472797
 -0.20735519  0.04474457  0.06065626 -0.0416242  -0.07342704  0.10396896
 -0.15080395  0.05912101 -0.04484918 -0.04730462 -0.04163873 -0.08358982
  0.13922104 -0.00726333  0.10584519 -0.08943589  0.06419261 -0.04038159
  0.07424197 -0.08175149 -0.07975222  0.03710765 -0.11566629 -0.01916005
  0.09576742 -0.12076638 -0.07158495 -0.02908102 -0.03369354 -0.05639433
 -0.03894927  0.12922879 -0.16803622  0.08045925]","[-0.02559054 -0.11442585 -0.285615    0.00588459  0.08140744  0.10919993
  0.2025552   0.09227076 -0.05288828 -0.10508315 -0.03450128 -0.05000919
 -0.01895749  0.09241728 -0.0825227  -0.04746013 -0.04190391  0.11057997
  0.07707261 -0.05081448 -0.04736394  0.07211433  0.00481617  0.10405831
  0.22073705  0.15570243  0.05207276  0.08818626 -0.03623734  0.03228203
  0.07584656 -0.08614524 -0.0680483  -0.15912452  0.15105945 -0.0176961
 -0.02634157  0.08282487 -0.06824675 -0.09650894 -0.08014593 -0.11928507
 -0.03722025  0.04271827  0.01640472  0.13784954  0.04986245 -0.00652583
  0.0891173  -0.17669564  0.00071935 -0.09104431  0.00715671  0.14993069
 -0.05865422 -0.07927951 -0.04344445  0.00132594  0.17408217 -0.16809788
 -0.02875789 -0.04706879  0.24801992  0.1723621   0.00407052 -0.02492814
 -0.17019147  0.04301095  0.04741421 -0.02034728 -0.03768035  0.06754561
 -0.13278511  0.06559402  0.01077702 -0.00851638 -0.03142531 -0.10705622
  0.08153803 -0.03021447  0.06499343 -0.06556234  0.08207458 -0.03263115
  0.05326113 -0.06163096 -0.07458441  0.02681185 -0.08756457 -0.01315804
  0.11402813 -0.10114845 -0.09870127 -0.01105796 -0.02375322 -0.03328297
 -0.013665    0.17352374 -0.17754659  0.02712149]",0.32481857056246577,0
req,src,test_data/LibEST_semeru_format/requirements/RQ51-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir secur consider support basic authent specifi http rfc allow server access client cleartext password provid support legaci usernam password databas requir expos plaintext password est server use pin one time password help mitig exposur recommend est client use credenti obtain client certif use futur interact est server client use implicit databas certif valid see section author proceed specifi section situat client valid server respond certifi third parti uri configur cannot verifi respond author act pki client tri enrol client use implicit trust anchor databas recommend use tls base client authent prevent expos http base client authent inform recommend client includ link ident pop inform section request prevent request forward real est server man middl recommend implicit trust anchor databas use est server authent care manag reduc chanc third parti poor certif practic trust disabl implicit trust anchor databas success receiv distribut certif respons section limit vulner first tls exchang certif less tls cipher suit maintain secur perform mutual authent necessari enrol follow properti inform leak activ attack whether singl guess secret correct advantag adversari gain interact comput possibl perform countermeasur exponenti backoff certain number fail attempt frustrat repeat activ attack use certif less cipher suit properti list would render result enrol void potenti result certif issu unauthent unauthor entiti use certif less tls cipher suit share secret use authent author cannot share entiti parti exchang someon client server addit share secret void secur afford certif less cipher suit exposur share secret use certif less cipher suit third parti enabl client imperson result corrupt client trust anchor databas tls cipher suit includ export des name must use cipher offer suffici level protect bit crypto offer accept protect use des deprec describ cmc section rfc key use signatur key sign certif request privat key serv pop key pair inclus tls uniqu within certif request link proof possess tls proof ident enforc pop oper occur tls session activ impli server authent client current access privat key authent client known specif capabl hardwar protect authent credenti key storag implic strengthen proven server side key generat method allow key transport tls connect client without applic layer protect distribut privat key materi inher riski privat key distribut use encrypt mode negoti tls cipher suit key protect prefer key wrap method key wrap rfc specifi rfc encrypt privat key beyond provid tls option recommend est server support oper default recommend client request servic unless compel oper benefit use implicit trust anchor databas recommend server side key generat employ use encrypt cms server side key generat respons recommend regard csr attribut may list inclus enrol request real inher secur issu content convey adversari abl interpos convers could exclud attribut server may want includ attribut server may want render meaningless attribut server may want asn encod rule der ber type length valu structur easi construct malici content invalid length field caus buffer overrun condit asn encod rule allow arbitrari level nest may make possibl construct malici content caus stack overflow interpret asn structur awar issu take appropri measur guard buffer overflow stack overrun particular malici content general,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.0189344  -0.12086762 -0.27243558  0.01124373  0.0368322   0.09904639
  0.24570268  0.06664453 -0.02290943 -0.10877211 -0.06552196 -0.04178625
 -0.01695314  0.09657768 -0.08949996  0.02774441  0.00127898  0.10010207
  0.08983328  0.04830928  0.01734949  0.06528727  0.01335612  0.09518918
  0.2228079   0.18503615  0.0203068   0.14092821 -0.04587187  0.04432371
  0.03544043 -0.06770312 -0.03433644 -0.15114896  0.14524175 -0.01042842
  0.05346381  0.10856967 -0.04492432 -0.09854058 -0.00346637 -0.08806235
 -0.03638779 -0.03482285  0.05887227  0.11063449  0.09703409 -0.05485849
  0.10917465 -0.17768449 -0.03212404 -0.09335963 -0.06889676  0.08228234
 -0.03486841 -0.01089434 -0.06850056 -0.03938957  0.15965264 -0.12361487
 -0.01187668  0.00436597  0.21695496  0.11946355  0.0173128  -0.05032689
 -0.20565802  0.04454385  0.04663602 -0.05815081 -0.10334317  0.11066569
 -0.14804283  0.0624555  -0.05406999 -0.04576638 -0.0440175  -0.06608483
  0.14855218 -0.00354439  0.1332854  -0.09077922  0.06694544 -0.02622521
  0.06570163 -0.08479669 -0.07486844  0.0359394  -0.13179006 -0.02893699
  0.07756511 -0.11924619 -0.06247345 -0.04438787 -0.03446443 -0.04317556
 -0.04945877  0.13138828 -0.1619641   0.09331657]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.3293627220527511,1
req,src,test_data/LibEST_semeru_format/requirements/RQ14-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.h,requir applic layer est client must capabl generat pars simpl pki messag see section generat pars full pki messag option see section client must also abl request certif est server pars return bag certif see section request csr attribut pars return list attribut option see section detail est client applic configur scope protocol discuss necessari understand prerequisit initi protocol oper est client recommend configur databas section secret key section implement conform standard must provid abil design explicit tas human usabl reason fingerprint explicit databas entri configur bootstrap discuss section configur implicit databas perhap inclus within est client distribut avail oper system provid flexibl along caveat detail section implement conform standard must provid abil disabl use implicit databas est client configur suffici inform form est server uri full oper path segment https www exampl com well known est https www exampl com well known est arbitrari label est client configur tupl compos author portion uri along option label www exampl com arbitrari label author portion uri,tcw err tcw connect tcw sock sock tcw opt opt const char host unsign short int port sock type tcw err tcw close tcw sock sock,"[ 0.02053281 -0.12123726 -0.2706113   0.00754503  0.03284876  0.09603371
  0.24748842  0.06332658 -0.0178313  -0.10373963 -0.06661796 -0.04611782
 -0.017879    0.09510401 -0.09124913  0.03192593 -0.00181591  0.09610971
  0.09318314  0.04931641  0.01777521  0.06753694  0.01254363  0.09842784
  0.22242452  0.19408877  0.01981346  0.14768097 -0.05404649  0.05095172
  0.02783701 -0.07216049 -0.0337243  -0.15125288  0.14937769 -0.01294686
  0.05996245  0.10778116 -0.04154735 -0.10614729 -0.00054563 -0.09174965
 -0.03506671 -0.0371269   0.06184037  0.11052653  0.1066608  -0.05658229
  0.1109309  -0.1835738  -0.03579294 -0.09118894 -0.0693889   0.08247844
 -0.03505006 -0.00339302 -0.06698567 -0.03456534  0.15591423 -0.12226508
 -0.01224476  0.00362387  0.21750155  0.11970648  0.01848424 -0.0472704
 -0.20962897  0.04057097  0.05561881 -0.05640746 -0.09884669  0.11436097
 -0.15415578  0.06100602 -0.06214064 -0.05334384 -0.05021876 -0.06913305
  0.15330288 -0.00111938  0.13372998 -0.09263568  0.06799096 -0.03020653
  0.06966456 -0.08870257 -0.07117629  0.04295572 -0.13088755 -0.02718384
  0.08503725 -0.1136632  -0.0551651  -0.04388693 -0.03517667 -0.04950952
 -0.05492873  0.12959647 -0.1622044   0.08964612]","[-0.02559054 -0.11442585 -0.285615    0.00588459  0.08140744  0.10919993
  0.2025552   0.09227076 -0.05288828 -0.10508315 -0.03450128 -0.05000919
 -0.01895749  0.09241728 -0.0825227  -0.04746013 -0.04190391  0.11057997
  0.07707261 -0.05081448 -0.04736394  0.07211433  0.00481617  0.10405831
  0.22073705  0.15570243  0.05207276  0.08818626 -0.03623734  0.03228203
  0.07584656 -0.08614524 -0.0680483  -0.15912452  0.15105945 -0.0176961
 -0.02634157  0.08282487 -0.06824675 -0.09650894 -0.08014593 -0.11928507
 -0.03722025  0.04271827  0.01640472  0.13784954  0.04986245 -0.00652583
  0.0891173  -0.17669564  0.00071935 -0.09104431  0.00715671  0.14993069
 -0.05865422 -0.07927951 -0.04344445  0.00132594  0.17408217 -0.16809788
 -0.02875789 -0.04706879  0.24801992  0.1723621   0.00407052 -0.02492814
 -0.17019147  0.04301095  0.04741421 -0.02034728 -0.03768035  0.06754561
 -0.13278511  0.06559402  0.01077702 -0.00851638 -0.03142531 -0.10705622
  0.08153803 -0.03021447  0.06499343 -0.06556234  0.08207458 -0.03263115
  0.05326113 -0.06163096 -0.07458441  0.02681185 -0.08756457 -0.01315804
  0.11402813 -0.10114845 -0.09870127 -0.01105796 -0.02375322 -0.03328297
 -0.013665    0.17352374 -0.17754659  0.02712149]",0.4176998808742741,0
req,src,test_data/LibEST_semeru_format/requirements/RQ46-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir server side key generat respons request success server respons must http respons code content type multipart mix consist two part one part privat key data part certif data format privat key data part return depend whether privat key return addit encrypt top provid tls addit encrypt employ privat key data must place applic pkcs applic pkcs part consist base encod der encod privat key info content transfer encod base rfc addit encrypt employ privat key place insid cms sign data sign data sign parti generat privat key may may est server est sign data protect place insid cms envelop data describ section rfc follow list show encrypt data use depend type protect key specifi client client specifi symmetr encrypt key protect server generat privat key envelop data content encrypt use secret key identifi request envelop data recipi info field must indic key encrypt kekri key manag techniqu valu follow version set key encrypt key identifi kekid set valu decrypt key identifi section key encrypt algorithm set one key wrap algorithm client includ smimecap accompani request encrypt key encrypt key client specifi asymmetr encrypt key suitabl key transport oper protect server generat privat key envelop data content encrypt use random generat symmetr encrypt key cryptograph strength symmetr encrypt key equival client specifi asymmetr key envelop data recipi info field must indic key tran recipi info ktri key manag techniqu key tran recipi info recipi identifi rid either subject key identifi copi attribut defin section server determin associ issuer serial number attribut version deriv choic rid rfc key encrypt algorithm set one key wrap algorithm client includ smimecap accompani request encrypt key encrypt key client specifi asymmetr encrypt key suitabl key agreement oper protect server generat privat key envelop data content encrypt use random generat symmetr encrypt key cryptograph strength symmetr encrypt key equival client specifi asymmetr key envelop data recipi info field must indic key agre recipi info kari key manag techniqu key agre recipi info type version origin user key materi ukm rfc key encrypt algorithm set one key wrap algorithm client includ smimecap accompani request recipi key identifi either copi attribut defin section subject key identifi server determin issuer serial number correspond valu provid attribut three addit encrypt case envelop data return respons applic pkcs mime part smime type paramet server generat key content transfer encod base certif data part applic pkcs mime exact match certif respons simpleenrol reject request server must specifi either http error http error content type set respons data must plaintext human readabl error messag,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[-0.00180192 -0.14001022 -0.2702808   0.02396031  0.03118713  0.09372749
  0.24121371  0.07212281 -0.03745121 -0.08879794 -0.05672298 -0.03945939
 -0.01522511  0.10968519 -0.0863004   0.00924068  0.0115347   0.10042345
  0.08303375  0.03450964  0.01235944  0.05893371  0.0275687   0.10255965
  0.21120411  0.17184943  0.02146227  0.13666797 -0.03635975  0.03360217
  0.06087466 -0.05658713 -0.05418339 -0.15846092  0.15146388  0.00810363
  0.0476564   0.09083605 -0.04877948 -0.09259018  0.00251288 -0.08810457
 -0.03758815 -0.01510243  0.06934974  0.10964151  0.08180588 -0.05503359
  0.12246166 -0.15861806 -0.00798607 -0.10418037 -0.06848144  0.0980335
 -0.02739654 -0.02310017 -0.07828003 -0.04958087  0.15196921 -0.1316933
 -0.01530242  0.01000813  0.22043301  0.11197917  0.01734846 -0.05906089
 -0.1957379   0.03668795  0.06339801 -0.03330917 -0.08683818  0.11170626
 -0.1458082   0.06473897 -0.05771506 -0.05878053 -0.03343935 -0.07465059
  0.1549689  -0.00256479  0.13718629 -0.07659797  0.05520694 -0.03905776
  0.06345023 -0.08689435 -0.06407102  0.03220663 -0.11376818 -0.02963472
  0.07630265 -0.12382381 -0.06520426 -0.04244742 -0.05180899 -0.0474537
 -0.02886597  0.1372313  -0.14926785  0.10577689]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.3185132224977849,0
req,src,test_data/LibEST_semeru_format/requirements/RQ56-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir csr attribut follow exampl valid csrattr exchang exchang est client authent use exist certif issu est server provid servic initi tls handshak ident enrol exampl handshak http get request get well known est csrattr http user agent curl linux gnu libcurl open zlib libidn librtmp host accept respons server provid suggest attribut appropri authent client exampl est server also includ two exampl attribut client would ignor unless attribut type known client http status content type applic csrattr content transfer encod base content length mhw gbys gaqebaryw ydi bmrs tgvbhcn ifnfvcbhci ljk igrhd geg csq gsib dqejbz oinw jqydi dbg oinw qtgvbhcn ifnfvcbhci ljk igrhd gegcssk mccaebcw yjyiziawudba,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.02395854 -0.11083509 -0.2696939   0.00515233  0.04010803  0.09671755
  0.24046211  0.06863278 -0.01207215 -0.1117431  -0.06320527 -0.04308947
 -0.01416053  0.09575117 -0.08713961  0.0288417  -0.00998502  0.09967745
  0.08809737  0.04669232  0.01060457  0.07284181  0.00952477  0.09429001
  0.22104488  0.18953803  0.0214175   0.14017102 -0.05411264  0.05012326
  0.0253354  -0.07133163 -0.03016269 -0.15383331  0.15113176 -0.01756203
  0.05233524  0.10688986 -0.04261354 -0.10935302 -0.01193745 -0.09400719
 -0.03930497 -0.03585842  0.05647051  0.10987123  0.10731338 -0.05385493
  0.10140332 -0.18513335 -0.03681063 -0.08934456 -0.0631026   0.08197857
 -0.04023861 -0.00683201 -0.05887919 -0.03182765  0.15806551 -0.12478047
 -0.01661825 -0.00180007  0.21305229  0.12544496  0.02079645 -0.03837957
 -0.20633687  0.04470221  0.05019088 -0.05663951 -0.09237517  0.10703102
 -0.14943752  0.05738793 -0.05464655 -0.04639229 -0.04928357 -0.07054825
  0.14588083 -0.00191426  0.12022975 -0.09506229  0.06673502 -0.03118519
  0.07284617 -0.08285208 -0.07806559  0.04052639 -0.12932838 -0.0242494
  0.08375161 -0.11621556 -0.05853105 -0.03820031 -0.02922564 -0.05089702
 -0.05512664  0.12103469 -0.16541101  0.08473887]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.34320856667861954,1
req,src,test_data/LibEST_semeru_format/requirements/RQ7-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir certif less tls authent est client est server mutual authent use certif less tls cipher suit see section,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.03959643 -0.11830101 -0.2548828   0.01077982  0.00566081  0.09178946
  0.25971216  0.04032584 -0.01340001 -0.10547499 -0.08484469 -0.03508832
 -0.02130948  0.08159896 -0.09337157  0.07070144  0.02650197  0.08629522
  0.09763462  0.09383267  0.05902656  0.05236711  0.00729992  0.08250453
  0.22394     0.19479032  0.00099752  0.16204035 -0.04796796  0.05053836
  0.00327445 -0.05890686 -0.00805137 -0.12360201  0.12266038 -0.01281946
  0.09161752  0.12744492 -0.03215759 -0.08461346  0.03541954 -0.06501617
 -0.02536058 -0.07928493  0.06529344  0.09452287  0.11429387 -0.07060181
  0.11798905 -0.17435278 -0.05373984 -0.08460791 -0.10178212  0.03956879
 -0.0179163   0.0252831  -0.0794533  -0.05085371  0.14963865 -0.08974943
  0.00263307  0.02504253  0.19634888  0.09015577  0.01737419 -0.06786606
 -0.21300258  0.04589445  0.03202966 -0.08856383 -0.1474802   0.12405513
 -0.15006101  0.06020238 -0.0760394  -0.05127401 -0.05193676 -0.03719536
  0.16823769  0.0072549   0.1711231  -0.09984331  0.06470174 -0.00642119
  0.05870793 -0.09075157 -0.07222641  0.03837254 -0.15819725 -0.04176787
  0.05399001 -0.11535335 -0.0443685  -0.06771926 -0.02842074 -0.03458875
 -0.07419587  0.11946263 -0.15156278  0.11259974]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.5099275767211647,0
req,src,test_data/LibEST_semeru_format/requirements/RQ29-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir client author decis issu certif client alway control local polici est server configur reflect polici document specifi constraint polici est provid est server access client authent ident tls client certif addit http user authent credenti help implement polici client certif issu est includ cmc rfc extend key usag extens client registr author describ rfc rfc case est server appli author polici consist client exampl handl simpleenrol request est server could configur accept pop link inform match current tls session authent est client verifi inform act est server specifi section specif mechan avail est client use fullcmc method,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.02829203 -0.12302754 -0.26229742  0.00880806  0.02002794  0.09051092
  0.25270495  0.05446298 -0.01571509 -0.09972385 -0.07377151 -0.04399642
 -0.01788861  0.08840609 -0.09109861  0.04871471  0.00914043  0.08954263
  0.09437549  0.06899469  0.0366182   0.06181451  0.01434302  0.09435619
  0.22057936  0.19458833  0.0112726   0.15630749 -0.05232048  0.04996011
  0.01733976 -0.06790815 -0.02509712 -0.1393817   0.13728    -0.01343643
  0.08020362  0.11493257 -0.03532334 -0.09900467  0.01777131 -0.07821506
 -0.03149048 -0.05596867  0.06513039  0.10057502  0.11343491 -0.06573108
  0.11800817 -0.17973056 -0.03928315 -0.08946294 -0.08520797  0.06376544
 -0.02493978  0.0095234  -0.07520843 -0.0428663   0.15157445 -0.10560311
 -0.00431229  0.01709236  0.20855834  0.10295875  0.01721841 -0.05470847
 -0.21069679  0.04191446  0.04686016 -0.06694676 -0.11594611  0.1205094
 -0.15234648  0.06024561 -0.0731443  -0.05764334 -0.05095166 -0.05290856
  0.16270734  0.00474755  0.15396082 -0.09820273  0.06537385 -0.02404833
  0.06720523 -0.09346303 -0.06992313  0.04271678 -0.14311957 -0.03287098
  0.07132775 -0.11474663 -0.04793837 -0.05362155 -0.0352576  -0.04658654
 -0.06290676  0.12567624 -0.15676533  0.10325272]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.3927455187672007,0
req,src,test_data/LibEST_semeru_format/requirements/RQ50-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir iana consider section defin oid regist arc deleg iana pkix work group iana regist follow iana updat well known uri registri follow fill templat rfc uri suffix est chang control ietf iana updat applic media type registri follow fill templat rfc media subtyp csr attribut csr attribut respons applic csrattr type name applic subtyp name csrattr requir paramet none option paramet none encod consider binari secur consider client request list attribut server wish certif request request respons normal done tls protect tunnel interoper consider none publish specif memo applic use media type enrol secur transport est addit inform magic number none file extens csrattr person email address contact inform dan harkin dharkin arubanetwork com restrict usag none author dan harkin dharkin arubanetwork com intend usag common chang control iesg iesg ietf org applic pkcs mime content type defin option smime type paramet rfc set specif valu document add anoth valu server generat key paramet valu server side key generat respons,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.01455077 -0.11760523 -0.27798823  0.00936417  0.04466067  0.1018698
  0.24203427  0.0747766  -0.01998218 -0.11229543 -0.06082178 -0.04515509
 -0.0159307   0.10148558 -0.08723974  0.01666962 -0.01009987  0.1048014
  0.08883064  0.03836401  0.00720306  0.0709268   0.01295671  0.10015388
  0.22338237  0.18712837  0.02536644  0.13806102 -0.05075964  0.04574479
  0.04110394 -0.07429202 -0.0405269  -0.16016544  0.15530358 -0.01033524
  0.04418178  0.10371401 -0.04912624 -0.10613897 -0.01434211 -0.0978439
 -0.04228833 -0.02410277  0.05754616  0.11626682  0.09696139 -0.048896
  0.1063061  -0.18287207 -0.03004228 -0.09590009 -0.05996358  0.09247024
 -0.04182244 -0.01752593 -0.06211773 -0.03446762  0.1607612  -0.13303913
 -0.01703096 -0.00283197  0.22197972  0.13017042  0.01862626 -0.04145245
 -0.20404302  0.04355728  0.0550122  -0.05101917 -0.09057447  0.10815263
 -0.1506866   0.06213933 -0.05071264 -0.04555655 -0.04612851 -0.0772885
  0.14445266 -0.00623067  0.12081959 -0.08837395  0.06804623 -0.03497378
  0.07120293 -0.08166824 -0.07523229  0.0404107  -0.1249653  -0.02483736
  0.08752623 -0.11858247 -0.06537509 -0.03630754 -0.03352167 -0.04951058
 -0.04714146  0.12940632 -0.16626534  0.085875  ]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.2724622980920145,0
req,src,test_data/LibEST_semeru_format/requirements/RQ1-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir document profil certif enrol client use certif manag cms cmc rfc messag secur transport enrol secur transport est describ use transport layer secur tls rfc rfc futur version hypertext transfer protocol http rfc provid authent author channel simpl public key infrastructur pki request respons rfc architectur est servic locat certif author client perform sever function tradit alloc registr author role pki natur communic est server describ document est adopt certif manag protocol cmp rfc model certif rollov use cmp messag syntax protocol est server extens new function may defin provid addit capabl specifi cmc rfc document defin two extens one request certif sign request attribut anoth request server generat key est specifi transfer messag secur via http tls https rfc http header media type use conjunct tls https oper tcp document specifi est http datagram transport layer secur user datagram protocol http dtls udp suitabl specif combin http dtls udp est requir would prevent work stack figur show layer build upon est layer protocol est request respons messag http messag transfer signal tls transport secur tcp transport figur,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.02284028 -0.12077426 -0.26966238  0.00974358  0.0310018   0.095249
  0.24923563  0.0638282  -0.01765209 -0.10512701 -0.06701693 -0.0433536
 -0.01471999  0.09761204 -0.09092212  0.03648291  0.00036775  0.09900626
  0.09235761  0.05497847  0.02151929  0.06737054  0.01430776  0.09609676
  0.22207929  0.19286954  0.01787076  0.14816473 -0.05192499  0.04967792
  0.02831225 -0.06750308 -0.03138851 -0.15244515  0.14888155 -0.0123314
  0.06254578  0.10739353 -0.04158305 -0.10440334  0.0026153  -0.08868862
 -0.03611577 -0.04065555  0.06363716  0.10882507  0.10696664 -0.06085839
  0.11297515 -0.18137185 -0.0357108  -0.09375731 -0.07262033  0.07879873
 -0.0328069  -0.00056451 -0.06799909 -0.03973329  0.15565492 -0.12098384
 -0.01178951  0.00629229  0.21225332  0.11609561  0.01980201 -0.04898002
 -0.2113368   0.04263633  0.05346652 -0.05715531 -0.10148075  0.1149331
 -0.1530971   0.06037368 -0.06317425 -0.05398037 -0.04689009 -0.06444343
  0.1560771   0.0002928   0.13693348 -0.09499977  0.06419823 -0.02981238
  0.07016631 -0.08957378 -0.07319229  0.04192101 -0.13329715 -0.02868743
  0.08018683 -0.11771093 -0.05716359 -0.04584751 -0.03490083 -0.05162573
 -0.05376758  0.12657598 -0.16078262  0.09604326]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.3319749612064173,0
req,src,test_data/LibEST_semeru_format/requirements/RQ15-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.c,requir http layer http use transfer est messag uri defin handl media type messag type describ section http also use client authent servic tls client authent avail due lack client certif suitabl use tls see section http authent also use addit tls client authent est server wish addit authent inform note section regist media type use convey est messag specifi figur http rfc support persist connect describ section rfc persist connect may use reduc network process load associ multipl http request est requir preclud persist http connect,"function send est specif http error respons void est send http error est ctx ctx void http ctx int fail code struct connect conn struct connect http ctx switch fail code case est err bad pkcs send http error conn est http stat est http stat txt est bodi bad pkcs break case est err auth fail send http error conn est http stat est http stat txt est bodi unauthor break case est err wrong method send http error conn est http stat est http stat txt est bodi bad meth break case est err ssl ctx send http error conn est http stat est http stat txt est bodi bad ssl break case est err http found send http error conn est http stat est http stat txt est bodi found break case est err http content send http error conn est http stat est http stat txt break default send http error conn est http stat est http stat txt est bodi unknown err break function send http accept respons client retri valu notifi client check back later see csr approv est_error est_ctx ctx void http_ctx int delay char http_hdr est_http_hdr_max struct mg_connect conn struct mg_connect http_ctx snprintf http_hdr est_http_hdr_max est_http_hdr_202 est_http_hdr_eol est_http_hdr_eol delay est_http_hdr_eol est_http_hdr_eol conn status_cod est_http_stat_202 mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) est_log_err http write error propag retri ""); return est_err_http_writ return est_err_non function handl incom cacert request client int est_handle_cacert est_ctx ctx unsign char ca_cert int ca_certs_len void http_ctx char path_seg char http_hdr est_http_hdr_max int hdrlen ca_cert null return send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl ca_certs_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send cert bodi mg_write http_ctx ca_cert ca_certs_len return est_err_http_writ est_log_info cert success sent est client ""); return est_err_non handl cert request applic layer regist callback call els applic layer provid local configur buffer send els return error indic cert avail static int est_ctx ctx void http_ctx char path_seg est_error int ca_certs_len unsign char ca_cert call back set call otherwis local configur cacert buffer return otherwis return error indic cacert ctx est_get_cacerts_cb est_log_info server retriev cert applic layer ""); ca_cert ctx est_get_cacerts_cb ca_certs_len path_seg ctx ex_data ca_cert est_log_info server success retriev cert applic layer ""); est_handle_cacert ctx ca_cert ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non els ctx ca_cert est_log_info server cert set local respond local set cert respons ""); est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg els est_send_http_error ctx http_ctx est_err_http_no_cont est_err_non return /*! brief use applic calcul http digest valu base header valu provid est client param authent header valu client provid lib est param ha1 precalcul ha1 valu user ha1 defin rfc 2617 md5 calcul user http realm user password helper function applic use calcul http digest valu perform http digest authent est client lib est maintain user databas left applic intent integr extern user databas radius aaa ha1 valu calcul applic defin rfc 2617 ha1 md5 hash user http realm user password md5 valu convert hex string ha1 expect byte long return char contain digest null error occur char est_http_auth_hdr char ha1 evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str unsign char digest evp_max_md_s unsign int d_len char est_log_err null auth header ""); return null ha1 est_log_err null ha1 ""); return null calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null evp_digest updat mdctx ha1 evp_digest updat mdctx "":"", evp_digest updat mdctx nonc strnlen_ nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx strnlen_ max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx cnonc strnlen_ cnonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc est_hex_to_str digest d_len return function alloc http authent header structur use pass auth credenti applic layer allow app authent est client static est_http_auth_hdr est_create_ah est_http_auth_hdr malloc sizeof est_http_auth_hdr )); memzero_ sizeof est_http_auth_hdr )); return function free element http authent header structur static void est_destroy_ah est_http_auth_hdr int len return user free user pwd get length password zeroiz len strnlen_ pwd max_uidpwd len memzero_ pwd len free pwd uri free uri cnonc free cnonc qop free qop free nonc free nonc respons free respons auth_token len strnlen_ auth_token max_auth_token_len len memzero_ auth_token len free auth_token free function verifi peer either provid certif verif tls stack http authent credenti provid return est_auth_st author result est_auth_st est_enroll_auth est_ctx ctx void http_ctx ssl ssl char path_seg int reenrol est_auth_st est_unauthor x509 peer null struct mg_connect conn struct mg_connect http_ctx est_http_auth_hdr int v_result get client certif tls stack peer ssl_get_peer_certif ssl null check tls base client author client cert author v_result int ssl x509_v_ok v_result est_log_info tls client certif valid ""); est_cert_auth els v_result est_log_warn peer cert valid crl load unabl determin peer cert revok .""); est_cert_auth els est_log_info tls client certif verifi v_result )"", v_result need bail sinc client use bogus cert need contiu http authent x509_free peer return est_unauthor els est_log_info tls peer certif ""); est_unauthor see srp use certif est_cert_auth ssl_get_srp_usernam ssl null est_log_info tls certif client srp login ssl_get_srp_usernam ssl )); est_srp_auth applic layer enabl http authent attempt http authent tls client auth fail require_http_auth flag set applic assum applic layer provid http auth callback facil ctx est_http_auth_cb est_unauthor http_auth_requir ctx require_http_auth tri http authent est_create_ah (); mg_parse_auth_head conn switch case est_auth_hdr_good invok applic specif auth check user credenti ctx est_http_auth_cb ctx peer path_seg ctx ex_data est_http_auth els est_log_warn http authent fail auth type mode est_unauthor break case est_auth_hdr_miss ask client send author header conn est_log_info http auth header miss send http auth request client .""); est_http_auth_pend break case est_auth_hdr_bad default est_log_warn client sent incomplet http author header ""); reenrol est_cert_auth est_log_info client cert authent http auth requir reenrol ""); els est_unauthor break est_destroy_ah peer x509_free peer return function use determin est client could use certif contain cmc usag extens usag bit present check disabl allow use case logic taken x509v3_cache_extens v3_purp open ssl return cert contain cmc extend key usag extens otherwis return static int est_check_cmc x509 cert int cmc ra_found extended_key_usag extusag int asn1_object obj get extend key usag extens found loop valu look cmc valu extens extusag x509_get_ext_d2i cert nid_ext_key_usag null null ))) iter extend key usag valu sk_asn1_object_num extusag ++) obj sk_asn1_object_valu extusag compar current iter global cmc valu creat earlier obj_cmp obj o_cmc cmc ra_found break extusag asn1_object_fre return cmc ra_found util function convert base64 der encod csr open ssl x509_req pointer return null problem x509_req est_server_parse_csr unsign char pkcs10 int pkcs10_len bio b64 x509_req req get origin pkcs10 request client b64 bio_new bio_f_base64 ()); b64 null est_log_err unabl open pkcs10 b64 buffer ""); return null bio_new_mem_buf pkcs10 pkcs10_len null est_log_err unabl open pkcs10 raw buffer ""); bio_fre b64 return null bio_push b64 read pem encod pkcs10 cert request req d2i_x509_req_bio null null est_log_err problem read der encod certif request ""); ossl_dump_ssl_error (); bio_free_al return null bio_free_al return req function implement proof posess check tls uid alreadi save tls session earlier tls uid match valu challeng password attribut pkcs10 client certif client provid valu sign pkcs10 cert request privat key prove client possess privat key check enforc follow csr contain must valid csr contain server configur requir authent fail otherwis csr contain server configur requir authent pass paramet ctx pointer est context ssl pointer ssl context pkcs10 pointer raw pkcs10 data pkcs10_len length raw pkcs10 data return valu est_err_non check pass int est_tls_uid_auth est_ctx ctx ssl ssl x509_req req x509_attribut attr int asn1_typ asn1_bit_str null asn1_typ int est_err_non char tls_uid int diff get index challeng password attribut request req nid_pkcs9_challeng password est_log_info cert request contain challeng password attribut ""); enabl must fail point sinc client send channel bind info csr ctx server_enable_pop est_log_warn enabl csr authent ""); return els return est_err_non els get refer attribut know locat rfc 7030 requir check present attr x509_req_get_attr req found attribut get actual valu challeng password attr attr singl attr valu singl valu bit_str els sk_asn1_type_valu attr valu set valu asn1_str els est_log_warn challeng password attribut found client cert request ""); return challeng password client cert request compar tls uid calcul server side implement check verifi client hold privat key use sign cert request tls_uid est_get_tls_uid ssl tls_uid memcmp_ tls_uid est_tls_uid_len data est_tls_uid_len diff eok diff est_log_info valid ""); est_err_non els est_log_warn valid ""); free tls_uid els est_log_warn local tls channel bind info avail ""); return function perform simpl saniti check pkcs10 csr check signatur csr return success non zero saniti check fail int est_server_check_csr x509_req req evp_pkey pub_key null int extract public key csr pub_key x509_req_get_pubkey req null est_log_err unabl extract public key csr ""); return verifi signatur csr x509_req_verifi req pub_key evp_pkey_fre pub_key check result est_log_err csr signatur check fail ""); return els est_log_err csr signatur mismatch ""); return els return free link list contain attribut client csr static void est_oid_list head est_oid_list next_entri head return next_entri head next next_entri free head head next_entri next_entri head next free head add new entri tail list attribut client csr static void est_oid_list list est_oid_list new_entri est_oid_list head list list head yet new entri simpli becom head head null list new_entri els walk list find tail add new entri end head next head head next head next new_entri recurs routin walk asn blob look asn object definit found oid object est_oid_list first argument end result routin list contain oid valu everi asn object blob code shameless taken open ssl ans1_parse2 (), explain poor chosen variabl name static int est_oid_list list const unsign char blob long length int offset est_oid_list new_entri const unsign char ptr tot opp long len int tag xclass int asn1_object a_object null errno_t safec_rc ptr blob tot ptr length ptr ptr tot ptr ptr asn1_get_object ptr len tag xclass length 0x80 est_log_err error encod ""); blob ptr return ptr length v_asn1_construct ptr len len length est_log_err length greater length blob ptr return 0x21 len list ptr long tot ptr offset ptr blob )); blob ptr return ptr tot break els ptr list ptr long len offset ptr blob )); blob ptr return els xclass ptr len els tag v_asn1_object opp d2i_asn1_object a_object opp len null new_entri malloc sizeof est_oid_list )); new_entri est_log_err malloc failur ""); list a_object null asn1_object_fre a_object blob ptr return safec_rc memset_ new_entri sizeof est_oid_list 0x0 sizeof est_oid_list )); safec_rc eok est_log_info memset_ error safec_rc i2t_asn1_object new_entri oid est_max_attr_len a_object est_log_info build csr oid list new_entri oid list new_entri a_object null asn1_object_fre a_object a_object null els est_log_err bad asn object ""); a_object null asn1_object_fre a_object blob ptr return ptr len tag v_asn1_eoc xclass blob ptr return length len blob ptr return util function popul link list contain oid name attribut present client csr static est_error est_oid_list list char bodi int body_len unsign char der_data der_ptr int der_len int grab space hold decod csr data der_ptr der_data malloc body_len der_data est_log_err malloc fail ""); return est_err_malloc decod csr data der_len est_base64_decod char bodi char der_data body_len der_len est_log_err invalid base64 encod data ""); free der_data return est_err_bad_base64 list const unsign char **)& der_data der_len est_log_err fail build oid list client provid csr ""); list free der_ptr return est_err_unknown free der_ptr return est_err_non function check local configur csr attribut attribut csr attribut miss csr error return static est_error est_ctx ctx char bodi int body_len int tag xclass found_match nid long len unsign char der_ptr save_ptr asn1_object a_object int max_len max_csrattr char csr_data int csr_len long out_len_sav unsign char der_data int der_len out_len int a_len char tbuf est_max_attr_len est_oid_list csr_attr_oid null est_oid_list oid_entri int compar est_error est_log_info csr attribut enforc enabl ""); ctx server_csrattr ctx est_get_csr_cb est_log_warn csr attribut enforc enabl attribut configur ""); return est_err_non build list attribut present csr list use later confirm requir attribut present csr_attr_oid bodi body_len est_err_non return get csr attribut configur server need look csr make sure csr provid use callback configur otherwis use local copi ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len null ctx ex_data csr_data est_log_err applic layer fail return csr attribut ""); csr_attr_oid return est_err_cb_fail els csr_data malloc ctx server_csrattrs_len csr_data est_log_err malloc failur ""); csr_attr_oid return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len est_log_info check csr attr present csr csr_data csr configur server need base64 decod check smallest possibl base64 case saniti test check min max valu asn data csr_len min_csrattr csr_attr_oid free csr_data return grab space hold decod csr data der_data malloc csr_len der_data est_log_err malloc fail ""); csr_attr_oid free csr_data return est_err_malloc decod csr data der_len est_base64_decod csr_data char der_data csr_len free csr_data der_len est_log_err invalid base64 encod data ""); csr_attr_oid free der_data return est_err_bad_base64 pointer fun start joy open ssl out_len_sav out_len der_len der_ptr save_ptr der_data out_len_sav max_len est_log_err der length exceed max ""); csr_attr_oid free der_data return make sure long enough asn der_len min_asn1_csrattr est_log_err der short ""); csr_attr_oid free der_data return iter csr attribut configur server out_len get next attribut asn1_get_object const unsign char **)& der_ptr len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 est_log_err bad asn1 hex ""); csr_attr_oid free der_data return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null const unsign char **)& der_ptr len a_object est_log_err a_object null ""); csr_attr_oid free der_data return est_err_unknown challeng password need check alreadi cover authent client nid obj_obj2nid a_object nid nid_pkcs9_challeng password asn1_object_fre a_object break a_len i2t_asn1_object tbuf est_max_attr_len a_object est_log_info look attr csr tbuf asn1_object_fre a_object attrubut csr bail csr_attr_oid null est_log_warn csr contain attribut csr reject tbuf free der_data return found_match oid_entri csr_attr_oid iter attribut csr oid_entri est_log_info compar tbuf oid_entri oid strcmp_s oid_entri oid a_len est_max_attr_len a_len est_max_attr_len tbuf compar compar found_match break oid_entri oid_entri next found_match est_log_warn csr contain attribut csr reject tbuf csr_attr_oid free der_data return break default adjust string pointer move next item der_ptr len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav der_ptr save_ptr one file check ensur miss someth pars local configur csr attribut out_len est_log_err der length zero )"", out_len csr_attr_oid free der_data return est_err_bad_asn1_hex lucki enough make far mean local configur csr attribut found client csr csr_attr_oid free der_data return est_err_non function use server process incom simpl enrol request client static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol int cert_len struct mg_connect conn struct mg_connect http_ctx unsign char cert char http_hdr est_http_hdr_max int hdrlen x509 peer_cert x509_req csr null int client_is_ra reenrol ctx est_enroll_pkcs10_cb est_log_err null enrol callback ""); return reenrol ctx est_log_err null reenrol callback ""); return make sure client sent pkcs10 csr request strncmp applic pkcs10 return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth mean user author either http authorizt certif author break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 get peer certif avail identifi client may desir inform peer_cert ssl_get_peer_certif ssl peer_cert client_is_ra est_check_cmc peer_cert est_log_info cmc present client_is_ra check proof possess challeng password pkcs10 request match tls uniqu check performend client client_is_ra est_tls_uid_auth ctx ssl csr est_err_non x509_req_fre csr x509_free peer_cert return check need ensur client includ csr attribut requir ctx enforce_csrattr est_err_non ctx bodi body_len x509_req_fre csr x509_free peer_cert return bodi point pkcs10 data pass enrol routin reenrol ctx unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data els ctx est_enroll_pkcs10_cb unsign char bodi body_len cert int *)& cert_len conn user_id peer_cert path_seg ctx ex_data peer cert longer need delet one peer_cert x509_free peer_cert est_err_non cert_len send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl cert_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free cert x509_req_fre csr return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx cert cert_len free cert x509_req_fre csr return est_err_http_writ free cert els sign request ask client retri futur may occur configur automat enrol send http retri respons client est_log_info server request retri possibl setup auto enrol ""); est_err_non ctx http_ctx ctx retry_period x509_req_fre csr return est_err_http_writ els x509_req_fre csr return x509_req_fre csr return est_err_non function use server process incom csr attribut request client static int est_handle_csr_attr est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len ctx server_csrattr ctx est_get_csr_cb ctx server_enable_pop est_log_err null csr callback ""); send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non els csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); invok server callback retriev csr callback take prioriti save valu context note need authent client see sec ctx est_get_csr_cb csr_data char ctx est_get_csr_cb csr_len path_seg ctx ex_data csr_data csr_len pop_pres csr_len est_err_non csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); csr_data free csr_data est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non free csr_data csr_data csr_data_pop csr_len csr_pop_len els csr_data malloc ctx server_csrattrs_len csr_data return est_err_malloc strncpy_ csr_data ctx server_csrattrs_len char ctx server_csrattr ctx server_csrattrs_len csr_data ctx server_csrattrs_len csr_len ctx server_csrattrs_len return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est server determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header int est_http_request est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl int est_oper oper char path_seg est_error est_err_non ctx est_log_err null context ""); return est_err_no_ctx verifi context server client ctx est_mod est_serv return est_err_bad_mod est_parse_uri uri oper char **)& path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow strncmp method get est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg ctx http_ctx path_seg ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return see enrol request els oper post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow strncmp method post est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return est_handle_keygen ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow strncmp method get est_log_warn incom http request use wrong method ""); est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_handle_csr_attr ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_server_start use applic start est server est_server_init call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_server_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_server_stop use applic stop est server call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_server_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_server_init use applic creat context est librari oper est server front context use invok function api param ca_chain char array contain pem encod cert crl entri param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain server certif tls layer param tls_id_key pointer evp_pkey contain privat key associ server certif function allow applic initi est server context use applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls stack identifi server warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null cert_format est_cert_format_pem est_log_err pem encod certif chang support .""); return null check length valu match len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err actual length cacerts_resp_chain match pass length valu ""); return null tls_id_cert null est_log_err tls ident cert empti ""); return null tls_id_key null est_log_err privat key associ tls ident cert empti ""); return null http_realm null est_log_err est http realm null ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_serv ctx retry_period est_retry_period_def ctx require_http_auth http_auth_requir ctx server_read_timeout load certif local memori retain futur use use cacert request option paramet altern app layer provid callback return fli cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null ctx ca_chain ca_chain_len est_log_err fail load trust certfic store ""); free ctx return null strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx server_enable_pop ctx creat new asn object cmc oid open ssl defin need creat http :// www openssl org doc crypto obj_nid2obj html o_cmc o_cmc obj_txt2obj o_cmc est_log_warn fail creat oid cmc key usag check ""); return ctx /*! brief use applic configur http authent method use valid ident est client param ctx pointer est context param amod must one follow auth_bas auth_digest auth_token function option invok applic chang default http authent mode default mode http basic authent applic may desir use digest token authent instead case function use set mode function must invok prior start est server return est_error est_error est_ctx ctx est_http_auth_mod amod ctx est_log_err null context ""); return est_err_no_ctx switch amod case auth_digest sinc http digest auth use md5 make sure fip mode fips_mod ()) est_log_err http digest auth allow fip mode ""); return est_err_bad_mod fallthrough case auth_bas case auth_token ctx auth_mod amod return est_err_non break default est_log_err unsupport http authent mode basic digest token allow ""); return est_err_bad_mod break /*! brief est_set_ca_enroll_cb use applic instal handler sign incom pkcs10 request param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 char void *); function call lib est certif request need sign server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_enroll_pkcs10_cb return est_err_non /*! brief use applic instal handler enrol certif param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int func unsign char int unsign char **, int char x509 function call lib est certif need renew server applic need forward request sign author return respons respons pkcs7 sign certif return est_error est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx return est_err_non /*! brief est_set_http_auth_cb use applic instal handler authent est client param ctx pointer est context param function address handler function must call prior start est server callback function must match follow prototyp int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data function call lib est perform http authent lib est pass est_http_auth_hdr struct applic allow applic hook radius aaa user authent databas x509 certif tls peer est client also provid callback facil allow applic layer check specif attribut x509 certif 802 1ar devic addit path segment string pass one request uri return est_error est_error est_set_http_auth_cb est_ctx ctx int est_ctx ctx est_http_auth_hdr x509 peer_cert char path_seg void ex_data ctx est_log_err null context ""); return est_err_no_ctx ctx est_http_auth_cb return est_err_non /*! brief use applic defin whether http authent requir addit use client certif param ctx pointer est context param requir flag indic http authent requir set http_auth_requir valu requir http auth set http_auth_not_requir http auth occur tls client authent fail return est_error default mode http_auth_requir mean http authent attempt even tls client authent succeed http authent need tls client auth fail set http_auth_not_requir est_error est_ctx ctx est_http_auth_requir requir ctx est_log_err null context ""); return est_err_no_ctx ctx require_http_auth requir return est_err_non /*! brief use applic enabl tls srp authent allow est client provid srp credenti tls layer authent est server function must invok enabl server side srp support param ctx pointer est context param function address applic specif srp verifi handler function invok prior start est server use specifi handler srp authent tls layer tls srp cipher suit negoti tls layer handler invok lib est retriev srp paramet user authent applic must provid srp paramet user handler use follow logic invok ssl_get_srp_usernam get srp user name tls layer lookup user srp paramet applic specif user databas paramet includ paramet invok forward srp paramet tls layer allow tls handshak proceed lib est includ exampl server applic use handler srp support exampl use open ssl srp verifi file capabl manag srp paramet individu user applic could use approach may util anoth facil manag user specif srp paramet pleas refer rfc 2945 rfc 5054 full understand srp return est_error est_error est_ctx ctx int ssl int void arg ctx est_log_err null context ""); return est_err_no_ctx est_log_err null callback ""); return ctx est_srp_username_cb ctx enable_srp return est_err_non /*! brief use applic enabl proof possess check est server prove est client sent csr server posses privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario note check possibl est proxi use est client est server sinc proxi possess privat key est server woul fail check howev est proxi enabl featur ensur est client sign key param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic disabl proof possess check est server pleas see documen inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx server_enable_pop return est_err_non /*! brief use applic chang default retri period sent est client server configur auto enrol retri valu notifi client long wait attempt enrol oper see approv origin csr param ctx pointer est context param second number second server use retri respons function may call time context creat return est_error est_error est_ctx ctx int second ctx est_log_err null context ""); return est_err_no_ctx second est_retry_period_max est_log_err maximum retri period second est_retry_period_max return second est_retry_period_min est_log_err minimum retri period second est_retry_period_min return ctx retry_period second return est_err_non /*! brief use applic specifi ecc curv use ephemer diffi hellman key tls handshak ephemer diffi hellman enabl lib est provid better forward secreci curv specifi applic use function prime256v1 curv use default curv param ctx pointer est context param nid open ssl nid valu desir curv function must call prior start est server nid valu defin openssl obj_mac typic nid valu provid function would includ nid_x9_62_prime192v1 nid_x9_62_prime256v1 nid_secp384r1 nid_secp521r1 return est_error est_error est_ctx ctx int nid ctx est_log_err null context ""); return est_err_no_ctx nid est_log_err invalid nid valu ""); return ctx ecdhe_nid nid return est_err_non /*! brief use applic specifi diffi hellman paramet use singl use key generat tls handshak paramet use singl use key generat enabl enabl improv forward secreci tls handshak oper paramet provid api hard code applic paramet generat time product instal reus paramet across multipl instal product result vulner product param ctx pointer est context param parm pointer open ssl paramet function must call prior start est server return est_error est_error est_ctx ctx parm ctx est_log_err null context ""); return est_err_no_ctx parm est_log_err null paramet ""); return ctx dh_tmp dhparams_dup parm return est_err_non /*! brief use applic initi fix set csr attribut attribut use lib est respons client csr attribut request attribut must asn base64 encod charact string param ctx pointer est context param csrattr pointer csr attribut asn base64 encod format null pointer clear attribut length param csrattrs_len length csr attribut charact string est_get_csr_cb callback function maintain precend method csr attribut est_get_csr_cb initi applic use lib est use attribut initi function call prior start est server configur call prior function return est_error est_error est_ctx ctx char csrattr int csrattrs_len int csrattrs_pop_len pop_pres char csrattrs_data_pop null ctx null return est_err_no_ctx verifi context server client proxi ctx est_mod est_serv return est_err_bad_mod est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len free old version previous initi ctx server_csrattr null free ctx server_csrattr ctx server_csrattr null ctx server_csrattrs_len caller want clear return csrattr null return est_err_non order run client negat unit test paramet pars check need disabl via defin coupl place check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return assum csr attribut ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csrattr csrattrs_len pop_pres est_err_non est_log_err error saniti check ""); return ctx csr_pop_pres pop_pres ctx csr_pop_pres est_add_challeng password csrattr csrattrs_len csrattrs_data_pop csrattrs_pop_len est_err_non est_log_err error add ""); return csrattr csrattrs_data_pop csrattrs_len csrattrs_pop_len els csrattr csrattrs_len pop_pres est_err_non est_log_err corrupt csr attribut ""); return ctx server_csrattr malloc csrattrs_len ctx server_csrattr csrattrs_data_pop free csrattrs_data_pop return est_err_malloc ctx server_csrattrs_len csrattrs_len strncpy_ char ctx server_csrattr csrattrs_len csrattr csrattrs_len ctx server_csrattr csrattrs_len csrattrs_data_pop free csrattrs_data_pop est_log_info attribut pointer len ctx server_csrattr ctx server_csrattrs_len return est_err_non /*! brief deprec function tls violat rfc7030 longer support est librari function log error messag return est_err_bad_mod param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx est_log_err tls violat rfc7030 therefor support ""); return est_err_bad_mod /*! brief use applic enabl check csr attribut est server enabl est client must provid csr attribut csrattr respons sent server enrol fail client fail provid csr attribut set appli simpl enrol reenrol oper set appli server mode bear proxi mode oper param ctx pointer est context function must call prior start est server return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enforce_csrattr return est_err_non /*! brief use applic set timeout valu server read oper socket open est server begin attempt read socket timeout valu limit amount time client wait respons default valu set param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx server_read_timeout timeout return est_err_non","[ 0.03864323 -0.10897409 -0.26056692  0.00260508  0.02246282  0.09064396
  0.25421777  0.05252626 -0.00565872 -0.1102251  -0.07690315 -0.04012714
 -0.01519439  0.08781698 -0.09155332  0.05991425  0.00350434  0.09168342
  0.09322197  0.07663775  0.03536521  0.06725655  0.00606831  0.08763507
  0.2213795   0.20004387  0.01140251  0.15865704 -0.05477182  0.05570792
  0.00409183 -0.06735761 -0.01471062 -0.14163505  0.13918307 -0.02087712
  0.08033842  0.11698662 -0.03087768 -0.10637076  0.01515063 -0.078952
 -0.03179729 -0.06329699  0.06562978  0.10039134  0.12094686 -0.07017708
  0.10916142 -0.18480454 -0.05109124 -0.0873822  -0.08569652  0.0533169
 -0.0269042   0.0179052  -0.06595332 -0.04037933  0.15166867 -0.10448129
 -0.00556533  0.01126752  0.19880052  0.10525785  0.0230553  -0.04904344
 -0.21748674  0.04531444  0.04483563 -0.07402666 -0.11850883  0.11942875
 -0.15152311  0.05633594 -0.07287087 -0.0565585  -0.05402806 -0.05214145
  0.16181251  0.00504341  0.14513701 -0.10343631  0.06489266 -0.02316799
  0.07387105 -0.09119418 -0.07497969  0.04425578 -0.14768574 -0.03120163
  0.07187551 -0.11473658 -0.04698696 -0.05290601 -0.02689118 -0.05214773
 -0.07098998  0.11339513 -0.15873036  0.10083969]","[-0.01627092 -0.13162005 -0.2732596   0.01455643  0.05795148  0.11397269
  0.21677604  0.08563121 -0.06016198 -0.11256866 -0.04860396 -0.05386287
 -0.02597274  0.07709649 -0.08083944 -0.02538622 -0.00762543  0.0969975
  0.08194636 -0.00970311 -0.00858239  0.05040537  0.01399724  0.10359457
  0.23463632  0.14375594  0.03279136  0.10150719 -0.02904148  0.01931112
  0.07885498 -0.08712501 -0.06424148 -0.12921382  0.12342141 -0.01066918
  0.00967955  0.10024368 -0.06672719 -0.06195878 -0.03284315 -0.08941217
 -0.03394737  0.00490315  0.02428684  0.12408841  0.04947647 -0.01014176
  0.10124724 -0.16569836 -0.00552198 -0.08851386 -0.03676705  0.12192149
 -0.05350054 -0.06674827 -0.07588187 -0.02407282  0.17350607 -0.12735
 -0.01035207 -0.01084846  0.2423459   0.13822702 -0.00924376 -0.04874464
 -0.16206087  0.04376368  0.02168859 -0.04519144 -0.08751407  0.08699037
 -0.12402721  0.06903939 -0.0068375  -0.00042534 -0.02931479 -0.07734133
  0.09957907 -0.02489885  0.11355342 -0.06387284  0.09134662 -0.0069392
  0.03853912 -0.06272422 -0.06688908  0.02737132 -0.11455854 -0.02223404
  0.07842047 -0.11342198 -0.09910918 -0.02608446 -0.0348848  -0.01100571
 -0.02053721  0.17833014 -0.1717283   0.05985392]",0.4059385493490781,1
req,src,test_data/LibEST_semeru_format/requirements/RQ7-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.c,requir certif less tls authent est client est server mutual authent use certif less tls cipher suit see section,"author routin int ossl verifi int store ctx ctx int cert error store ctx get error ctx current cert store ctx get current cert ctx est log info enter function cert error cert error current cert name print stdout _get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% serror depth lookup ctx crl path """", cert_error ctx cert_error )); switch cert_error case enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok warn applic est_log_warn crl load tls peer allow .""); break case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error break return return function use load x509_store use raw data buffer data expect pem encod return number cert store static int x509_store store unsign char raw int size stack_of x509_info null x509_info bio int cert_cnt bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return load file stack x509 crl pkey set null null null null est_log_err unabl read pem encod cert bio ""); bio_fre return bio_fre scan pull crl sk_x509_info_num sk_x509_info_shift x509 null est_log_info cert store )"", x509 name x509_store_add_cert store x509 cert_cnt ++; crl null est_log_info crl store ""); x509_store_add_crl store crl x509_info_fre null sk_x509_info_pop_fre x509_info_fre return cert_cnt function use popul x509_store structur use open ssl tls stack verifi tls peer x509_store alreadi alloc paramet store pointer x509_store structur hold cert raw1 char array contain pem encod cert put store size1 length raw1 char array est_error ossl_init_cert_stor x509_store store unsign char raw1 int size1 x509_store_set_flag store int cnt raw1 cnt store raw1 size1 cnt est_log_err cert count zero store ""); return return est_err_non function use output open ssl error buffer use open ssl api call fail like provid detail user regard caus failur void ossl_dump_ssl_error bio null buf_mem bptr null bio_new bio_s_mem ()); est_log_err bio_new fail ""); return err_print_error void bio_flush bio_get_mem_ptr bptr est_log_warn ossl error bptr data bio_free_al /*! brief convert base64 encod pkcs7 respons est server pem format param certs_p7 point buffer contain base64 encod pkcs7 data param certs_len indic size certs_p7 buffer param pem doubl pointer receiv pem encod data sever est messag return data contain base64 encod pkcs7 certif function use convert data pem format function alloc memori point pem argument caller respons releas memori return valu length pem buffer error return int int unsign char certs_p7 int certs_len unsign char pem x509 stack_of x509 cert null bio b64 unsign char cacerts_decod null int cacerts_decoded_len bio p7bio_in null pkcs7 null int nid unsign char pem_data int pem_len base64 decod incom cert buffer decod alway take origin buffer b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); return bio_new_mem_buf certs_p7 certs_len est_log_err bio_new fail ""); return bio_push b64 cacerts_decod malloc certs_len cacerts_decod est_log_err malloc fail ""); return cacerts_decoded_len bio_read cacerts_decod certs_len bio_free_al get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); free cacerts_decod return d2i_pkcs7_bio p7bio_in null est_log_err pem_read_bio_pkcs7 fail ""); ossl_dump_ssl_error (); free cacerts_decod return bio_free_al p7bio_in free cacerts_decod decod cert get refer stack cert nid obj_obj2nid type switch nid case nid_pkcs7_sign cert sign cert break case nid_pkcs7_sign envelop cert signed_and_envelop cert break default est_log_err invalid nid valu pkcs7 structur ""); pkcs7_free return break cert est_log_err fail attain x509 cert stack pkcs7 data ""); pkcs7_free return output cert new bio use pem format bio_new bio_s_mem ()); est_log_err bio_new fail ""); pkcs7_free return sk_x509_num cert ++) sk_x509_valu cert pem_write_bio_x509 bio_put ""); void bio_flush convert bio char pem_len int bio_get_mem_data char **)& pem_data pem_len est_log_err bio_get_mem_data fail ""); pkcs7_free return pem malloc pem_len (!* pem est_log_err malloc fail ""); pkcs7_free return memcpy_ pem pem_len pem_data pem_len pem pem_len make sure null termiant bio_free_al pkcs7_free return pem_len","[ 0.03959643 -0.11830101 -0.2548828   0.01077982  0.00566081  0.09178946
  0.25971216  0.04032584 -0.01340001 -0.10547499 -0.08484469 -0.03508832
 -0.02130948  0.08159896 -0.09337157  0.07070144  0.02650197  0.08629522
  0.09763462  0.09383267  0.05902656  0.05236711  0.00729992  0.08250453
  0.22394     0.19479032  0.00099752  0.16204035 -0.04796796  0.05053836
  0.00327445 -0.05890686 -0.00805137 -0.12360201  0.12266038 -0.01281946
  0.09161752  0.12744492 -0.03215759 -0.08461346  0.03541954 -0.06501617
 -0.02536058 -0.07928493  0.06529344  0.09452287  0.11429387 -0.07060181
  0.11798905 -0.17435278 -0.05373984 -0.08460791 -0.10178212  0.03956879
 -0.0179163   0.0252831  -0.0794533  -0.05085371  0.14963865 -0.08974943
  0.00263307  0.02504253  0.19634888  0.09015577  0.01737419 -0.06786606
 -0.21300258  0.04589445  0.03202966 -0.08856383 -0.1474802   0.12405513
 -0.15006101  0.06020238 -0.0760394  -0.05127401 -0.05193676 -0.03719536
  0.16823769  0.0072549   0.1711231  -0.09984331  0.06470174 -0.00642119
  0.05870793 -0.09075157 -0.07222641  0.03837254 -0.15819725 -0.04176787
  0.05399001 -0.11535335 -0.0443685  -0.06771926 -0.02842074 -0.03458875
 -0.07419587  0.11946263 -0.15156278  0.11259974]","[-0.02280794 -0.13919947 -0.28047982  0.02055176  0.05719239  0.11580008
  0.21982583  0.08664732 -0.06486179 -0.10728963 -0.04538092 -0.0485174
 -0.02340238  0.0915816  -0.08403641 -0.03389406 -0.00680382  0.10322481
  0.08214781 -0.02023232 -0.01739727  0.05432794  0.02143495  0.10811873
  0.23230235  0.14707267  0.03343172  0.09869646 -0.02522595  0.01939251
  0.08936349 -0.079725   -0.07090753 -0.14112723  0.13800469 -0.0044158
 -0.00118626  0.09041351 -0.07368236 -0.0651512  -0.03746948 -0.0967169
 -0.03527454  0.01767246  0.02962421  0.1314824   0.04278544 -0.00958085
  0.1028138  -0.1680194   0.00360245 -0.09777321 -0.03135832  0.1338649
 -0.05140613 -0.07215084 -0.07555516 -0.02815823  0.17305858 -0.14494699
 -0.01413719 -0.01573827  0.24476083  0.14470093 -0.00722645 -0.05078406
 -0.16619018  0.04294062  0.03615962 -0.03229743 -0.07867274  0.08533599
 -0.1291659   0.07151608 -0.00589654 -0.00445574 -0.02803521 -0.09147019
  0.10225114 -0.02535055  0.10955609 -0.05982644  0.08245157 -0.01598702
  0.03577185 -0.06218307 -0.06432889  0.02448558 -0.102182   -0.02171448
  0.08405258 -0.11564184 -0.09899607 -0.02413773 -0.0364875  -0.01774029
 -0.01183339  0.17720269 -0.17135827  0.06180004]",0.4948176255519888,0
req,src,test_data/LibEST_semeru_format/requirements/RQ18-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir http base client authent est server may request http base client authent request addit success tls client authent section est server polici requir addit authent exampl est server may requir est client know password addit exist client certif http base client authent est server polici specifi fallback situat est client success complet tls client authent might aris est client enrol first time certif avail est client cannot use tls client authent http basic digest authent must perform tls rfc later version null anon cipher suit must use provid confidenti support mutual certif base certif less authent respect specifi certif manag cms cmc transport protocol rfc server must assum client support type http authent cooki basic authent digest authent client support basic digest authent mechan server wish use basic digest authent reject http request use http defin www authent respons header rfc section client expect retri request includ appropri author request header rfc section client capabl use basic digest authent client capabl retri request capabl basic digest authent client must termin connect client may set usernam empti string present password associ usernam support http base client authent secur ramif discuss section client must respond server http authent request unless client author est server per section,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.04189074 -0.11007163 -0.2551596   0.00233566  0.01805499  0.09077151
  0.2526413   0.04694885 -0.00965447 -0.10957289 -0.08033112 -0.03941373
 -0.01905064  0.07846716 -0.08960577  0.06454775  0.01125512  0.08553635
  0.09319705  0.08541369  0.04656414  0.05874637  0.00619338  0.08342006
  0.22200316  0.19327737  0.00473623  0.15701966 -0.05048641  0.05173333
  0.00067295 -0.06727549 -0.01061308 -0.12736303  0.12440599 -0.02148066
  0.08769705  0.12558518 -0.02957721 -0.09214164  0.02450513 -0.06753545
 -0.02729463 -0.07379659  0.06167115  0.09554931  0.11722283 -0.06803773
  0.11058782 -0.18054175 -0.05409104 -0.0814022  -0.09369682  0.04354779
 -0.02357797  0.01869402 -0.0721636  -0.04498529  0.15258352 -0.08962433
  0.00059402  0.02084271  0.19618756  0.09544743  0.01718518 -0.05539155
 -0.21096583  0.04690552  0.02912626 -0.08539301 -0.1341283   0.1212899
 -0.14525601  0.05668777 -0.07262701 -0.04757889 -0.05201679 -0.03899992
  0.16102032  0.00607918  0.15748025 -0.10362682  0.06856398 -0.0100242
  0.0654073  -0.09101052 -0.07439058  0.04132548 -0.15535975 -0.03468437
  0.05964667 -0.11453348 -0.0471596  -0.05888367 -0.02621881 -0.03874068
 -0.07306951  0.1179497  -0.15661545  0.10373951]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.4714560792585344,1
req,src,test_data/LibEST_semeru_format/requirements/RQ40-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,requir full cmc request http post fullcmc valid full pki request server must reject messag http content type use applic pkcs mime smime type paramet cmc request specifi rfc bodi messag binari valu encod pki request content transfer encod base rfc,"sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 3.31680961e-02 -1.09561153e-01 -2.68568397e-01  2.37767425e-04
  3.33783962e-02  9.65451896e-02  2.52346873e-01  6.12566657e-02
 -6.83800830e-03 -1.12069331e-01 -7.14952350e-02 -4.07509990e-02
 -1.47267375e-02  9.90439281e-02 -8.92788023e-02  4.46578301e-02
 -5.72738284e-03  9.85863283e-02  9.12647992e-02  6.06227145e-02
  2.19066795e-02  7.30349645e-02  7.30477972e-03  9.10852402e-02
  2.21028283e-01  2.00857237e-01  1.56332124e-02  1.54753238e-01
 -5.49394339e-02  5.89441024e-02  1.39411455e-02 -6.94569945e-02
 -2.41238903e-02 -1.53245836e-01  1.53422415e-01 -1.88801717e-02
  6.56609833e-02  1.09690443e-01 -3.77843194e-02 -1.13284960e-01
  2.35931342e-03 -8.86012316e-02 -3.72381434e-02 -5.00572771e-02
  6.61972910e-02  1.07987843e-01  1.13125801e-01 -6.54744655e-02
  1.06814340e-01 -1.89130858e-01 -4.63803560e-02 -9.17774439e-02
 -7.48868138e-02  6.78933039e-02 -3.24718319e-02  9.36878566e-03
 -6.18498549e-02 -3.91116180e-02  1.55523777e-01 -1.18827656e-01
 -1.18092746e-02  3.32569703e-03  2.04179272e-01  1.17506154e-01
  2.49034110e-02 -4.30628993e-02 -2.18112126e-01  4.51110452e-02
  5.19152917e-02 -6.40306473e-02 -1.06978685e-01  1.15810812e-01
 -1.54294774e-01  5.59741445e-02 -6.68439493e-02 -5.56377918e-02
 -5.39109372e-02 -6.56110197e-02  1.60431534e-01  1.11163722e-03
  1.29392907e-01 -1.00717850e-01  6.43804967e-02 -3.09858229e-02
  7.69515261e-02 -8.96500126e-02 -7.70879537e-02  4.44716923e-02
 -1.38319999e-01 -2.86600087e-02  8.06313604e-02 -1.18195809e-01
 -5.23767993e-02 -4.55874465e-02 -2.78428383e-02 -5.93711808e-02
 -6.40961230e-02  1.13241263e-01 -1.65623546e-01  9.51777995e-02]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.3781514848918458,0
req,src,test_data/LibEST_semeru_format/requirements/RQ38-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir simpl enrol enrol respons enrol success server respons must contain http respons code content type applic pkcs mime success respons must cert cmc simpl pki respons defin rfc contain certif issu http content type applic pkcs mime smime type paramet cert use specifi rfc server must answer suitabl http rfc error code problem occur simpl pki respons http content type applic pkcs mime see section may includ respons data convey error respons content type set respons data must plaintext human readabl error messag contain explanatori inform describ request reject exampl indic csr attribut incomplet server respond http rfc indic request accept process respons yet avail server must includ retri header defin http respons server also may includ inform human readabl content client must wait least specifi retri time repeat request client repeat initi enrol request appropri retri interv expir client log inform end user event server respons maintain state necessari recogn handl retri oper client stateless regard simpli send request repeat receiv differ respons code return code handl specifi http rfc client close tls connect wait retri time expir client initi new tls connect perform applic secur check client alreadi generat csr includ link ident pop inform section csr need recreat incorpor tls uniqu new redirect session note key pair need regener process interfac burden client est server administr advis take consider est client may also make certif respons associ privat key avail end entiti softwar use end entiti certif,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 2.60162316e-02 -1.15243517e-01 -2.68985897e-01  3.89979943e-03
  3.22336070e-02  9.67861116e-02  2.52314925e-01  5.98994941e-02
 -1.68040451e-02 -1.09637395e-01 -7.19415918e-02 -3.99656780e-02
 -1.98316369e-02  9.33375955e-02 -8.85187462e-02  3.70184593e-02
  1.84732990e-03  9.37291011e-02  9.05560777e-02  5.54151013e-02
  2.42765937e-02  6.69588670e-02  7.24519091e-03  9.32773501e-02
  2.23536626e-01  1.92325026e-01  1.40737845e-02  1.49025112e-01
 -4.85690273e-02  5.07280491e-02  2.05508992e-02 -6.89596534e-02
 -2.92262845e-02 -1.43886313e-01  1.45852000e-01 -1.43732615e-02
  6.18595555e-02  1.11636691e-01 -4.15958799e-02 -1.02186508e-01
  2.72000069e-03 -8.32299739e-02 -3.40227261e-02 -4.85698283e-02
  6.06528558e-02  1.07573964e-01  1.02394573e-01 -5.57830594e-02
  1.08940788e-01 -1.83902442e-01 -4.03380878e-02 -9.12143365e-02
 -7.59458989e-02  7.15928003e-02 -3.06235738e-02 -5.81278982e-06
 -6.81577995e-02 -4.01532352e-02  1.57574117e-01 -1.14927195e-01
 -7.85856601e-03  4.68323845e-03  2.12032318e-01  1.15444124e-01
  1.92030594e-02 -5.10454141e-02 -2.09209427e-01  4.30526435e-02
  4.54858243e-02 -6.52366951e-02 -1.14444010e-01  1.12576976e-01
 -1.50505409e-01  5.87717518e-02 -6.06237501e-02 -4.90748845e-02
 -5.25093116e-02 -6.65929988e-02  1.56021312e-01 -1.47826748e-03
  1.36956453e-01 -9.33287665e-02  6.90785274e-02 -2.56693885e-02
  6.82770461e-02 -8.66072550e-02 -7.27254376e-02  4.00673710e-02
 -1.35501638e-01 -3.15742120e-02  7.41241649e-02 -1.16722263e-01
 -5.37960753e-02 -4.77882028e-02 -3.07618398e-02 -4.59676310e-02
 -6.08017705e-02  1.22683033e-01 -1.65270954e-01  9.61328670e-02]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.367218003793659,0
req,src,test_data/LibEST_semeru_format/requirements/RQ22-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir tls client authent recommend method identifi est client http base client authent section may use est server authent est client defin cipher suit negoti follow text provid detail assum certif base cipher suit tls rfc mandatori cipher suit tls rsa des ede cbc sha est server must support certif base client authent general client use exist certif renew rekey oper certif renew rekey appropri negoti cipher suit client must use tls handshak otherwis client use altern certif suitabl cipher suit contain subject ident inform request enrol oper client may use client certif issu third parti authent certif valid must perform per rfc est client certif must conform rfc certif profil server valid tls client certif use est server explicit enabl implicit databas server must maintain distinct use explicit implicit databas authent order support proper author est server must perform author check specifi section client support tls client authent must support http base client authent section certif less tls authent section,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 0.03560031 -0.11806617 -0.2603899   0.00890871  0.01585975  0.09348304
  0.25568795  0.04921199 -0.01364579 -0.10686032 -0.07941308 -0.03819065
 -0.01938197  0.08820964 -0.09256627  0.05965941  0.01600557  0.09088229
  0.09622283  0.0808967   0.04508314  0.05854633  0.00908588  0.0864503
  0.2236602   0.19485252  0.00715569  0.15756205 -0.04899316  0.05158281
  0.01079367 -0.0625224  -0.01461748 -0.13481785  0.13273986 -0.01295481
  0.0812565   0.12095381 -0.0355486  -0.09259038  0.02310962 -0.0739474
 -0.0297117  -0.06669921  0.06496706  0.0998617   0.11235155 -0.06724715
  0.11444343 -0.17833593 -0.04860706 -0.08750474 -0.09113016  0.0533275
 -0.02372546  0.01697083 -0.07483374 -0.04659152  0.15181443 -0.10130326
 -0.00198923  0.01856928  0.20130399  0.10058656  0.01863825 -0.05983925
 -0.21379791  0.04586987  0.03945242 -0.07876264 -0.13164812  0.12130848
 -0.15071353  0.06014076 -0.0712426  -0.05229118 -0.0510712  -0.04690067
  0.16448826  0.00441768  0.15744776 -0.09881057  0.06442253 -0.01466798
  0.06334844 -0.08961193 -0.07384117  0.03945244 -0.15014768 -0.03686342
  0.06381103 -0.11684715 -0.04838846 -0.05982045 -0.03039164 -0.04102702
 -0.06793607  0.12046503 -0.15554552  0.10614393]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.4558411956186352,0
req,src,test_data/LibEST_semeru_format/requirements/RQ35-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir client certif request function est client request certif est server https post use oper path valu simpleenrol est client request renew rekey exist certif http post use oper path valu simplereenrol est server must support simpleenrol simplereenrol function recommend client obtain current certif describ section perform certif request function ensur client abl valid est server certif client must authent est server specifi section certif base authent use section option certif less authent use client must verifi author est server specifi section server must authent client specifi section certif base authent use section option certif less authent use server must verifi client author specifi section est server must check tls uniqu valu describ section one submit client server may accept certif request manual author check administr section describ use http respons est client occur,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.03689534 -0.1224552  -0.2568433   0.00792768  0.01106641  0.08807577
  0.25695542  0.04656845 -0.0127191  -0.09853647 -0.08033545 -0.04252779
 -0.01942581  0.08458116 -0.09271383  0.06479581  0.0166279   0.08412797
  0.09623074  0.08328172  0.04783554  0.05795944  0.01206963  0.0890021
  0.22144334  0.1973424   0.00333641  0.1645551  -0.05161984  0.05344819
  0.00673593 -0.0641315  -0.01540605 -0.13119297  0.12998529 -0.01592202
  0.0922823   0.11883807 -0.0300463  -0.09425151  0.03032228 -0.06955707
 -0.02640462 -0.07272374  0.06725335  0.09677907  0.11729274 -0.07283836
  0.12072316 -0.17987792 -0.04727729 -0.08643714 -0.09648091  0.05093245
 -0.01917445  0.02142201 -0.08029334 -0.04823495  0.1490937  -0.09342832
  0.00071497  0.02508539  0.1992632   0.09175977  0.01805615 -0.06051861
 -0.21439505  0.0438037   0.04135104 -0.07798237 -0.13040361  0.12575293
 -0.150844    0.05832598 -0.0796911  -0.05936405 -0.05246435 -0.04153801
  0.1698879   0.00824522  0.16596366 -0.10138979  0.06497496 -0.01554407
  0.06635085 -0.09616321 -0.07020454  0.04289234 -0.15226892 -0.03601051
  0.0630153  -0.11515877 -0.04412894 -0.06039564 -0.0345933  -0.04476745
 -0.07034493  0.12267117 -0.15355836  0.10991908]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4723751233427983,0
req,src,test_data/LibEST_semeru_format/requirements/RQ56-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir csr attribut follow exampl valid csrattr exchang exchang est client authent use exist certif issu est server provid servic initi tls handshak ident enrol exampl handshak http get request get well known est csrattr http user agent curl linux gnu libcurl open zlib libidn librtmp host accept respons server provid suggest attribut appropri authent client exampl est server also includ two exampl attribut client would ignor unless attribut type known client http status content type applic csrattr content transfer encod base content length mhw gbys gaqebaryw ydi bmrs tgvbhcn ifnfvcbhci ljk igrhd geg csq gsib dqejbz oinw jqydi dbg oinw qtgvbhcn ifnfvcbhci ljk igrhd gegcssk mccaebcw yjyiziawudba,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.02395854 -0.11083509 -0.2696939   0.00515233  0.04010803  0.09671755
  0.24046211  0.06863278 -0.01207215 -0.1117431  -0.06320527 -0.04308947
 -0.01416053  0.09575117 -0.08713961  0.0288417  -0.00998502  0.09967745
  0.08809737  0.04669232  0.01060457  0.07284181  0.00952477  0.09429001
  0.22104488  0.18953803  0.0214175   0.14017102 -0.05411264  0.05012326
  0.0253354  -0.07133163 -0.03016269 -0.15383331  0.15113176 -0.01756203
  0.05233524  0.10688986 -0.04261354 -0.10935302 -0.01193745 -0.09400719
 -0.03930497 -0.03585842  0.05647051  0.10987123  0.10731338 -0.05385493
  0.10140332 -0.18513335 -0.03681063 -0.08934456 -0.0631026   0.08197857
 -0.04023861 -0.00683201 -0.05887919 -0.03182765  0.15806551 -0.12478047
 -0.01661825 -0.00180007  0.21305229  0.12544496  0.02079645 -0.03837957
 -0.20633687  0.04470221  0.05019088 -0.05663951 -0.09237517  0.10703102
 -0.14943752  0.05738793 -0.05464655 -0.04639229 -0.04928357 -0.07054825
  0.14588083 -0.00191426  0.12022975 -0.09506229  0.06673502 -0.03118519
  0.07284617 -0.08285208 -0.07806559  0.04052639 -0.12932838 -0.0242494
  0.08375161 -0.11621556 -0.05853105 -0.03820031 -0.02922564 -0.05089702
 -0.05512664  0.12103469 -0.16541101  0.08473887]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.4660855063798619,1
req,src,test_data/LibEST_semeru_format/requirements/RQ39-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir full cmc est client request certif est server https post use oper path valu fullcmc support fullcmc function option client server,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.0286738  -0.12377226 -0.26314363  0.00626567  0.01736777  0.09296239
  0.25464976  0.05189685 -0.0167871  -0.09914148 -0.07647866 -0.04660719
 -0.02258353  0.08461934 -0.09357786  0.05214413  0.01104196  0.08485492
  0.0966189   0.0682694   0.03902406  0.05879138  0.0115375   0.09298906
  0.22558674  0.19726248  0.00797105  0.16008733 -0.05236274  0.05341285
  0.01323281 -0.07040416 -0.02255218 -0.13155293  0.13503185 -0.01690895
  0.0824204   0.118871   -0.03467402 -0.09649996  0.02101236 -0.07635527
 -0.02718265 -0.06239719  0.06192379  0.10297251  0.1112942  -0.06241665
  0.11810257 -0.1838368  -0.04344601 -0.08730295 -0.08754975  0.06260104
 -0.02336557  0.01150582 -0.07861178 -0.04252569  0.15203165 -0.10085892
 -0.00072142  0.01738137  0.20987333  0.10102387  0.01646906 -0.05849835
 -0.21338788  0.04265477  0.04484015 -0.07211962 -0.12576418  0.1217806
 -0.15298802  0.06146162 -0.072516   -0.05523285 -0.05442924 -0.05183978
  0.16435184  0.00227955  0.15819138 -0.09672785  0.06951652 -0.01741732
  0.06482944 -0.09368659 -0.06855002  0.04402376 -0.14555973 -0.0347495
  0.07145251 -0.11022122 -0.04747614 -0.05698948 -0.03449067 -0.04256414
 -0.06748926  0.1299227  -0.15914488  0.10019467]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.4309795744670585,1
req,src,test_data/LibEST_semeru_format/requirements/RQ48-pre.txt,test_data/LibEST_semeru_format/source_code/est_server.h,requir csr attribut request est client request list desir csr attribut send https get messag est server oper path csrattr,prototyp privat est server part public api void est send http error est ctx ctx void http ctx int fail code prototyp privat est server part public api int est enrol auth est ctx ctx void http ctx ssl ssl char path seg int reenrol prototyp privat est server part public api int est handl cacert est ctx ctx unsign char cert int cert len void http ctx char path seg prototyp privat est server part public api int est tls uid auth est ctx ctx ssl ssl req req prototyp privat est server part public api req est server pars csr unsign char pkcs int pkcs len prototyp privat est server part public api int est server check csr req req prototyp privat est server part public api est error est server send http retri est ctx ctx void http ctx int delay,"[ 0.02002758 -0.12629412 -0.26697797  0.0034956   0.02461626  0.10127906
  0.25129998  0.06000828 -0.02672494 -0.1079785  -0.07595601 -0.04931965
 -0.02696041  0.08025389 -0.08667208  0.03605753  0.01440395  0.08650382
  0.09739792  0.05822663  0.04096767  0.05469621  0.00824327  0.09201299
  0.23467979  0.18412314  0.00747143  0.15159453 -0.04240852  0.04653342
  0.02637563 -0.07683077 -0.02884299 -0.12357812  0.12887454 -0.01404486
  0.07451217  0.12343709 -0.0407328  -0.08099362  0.02017124 -0.06972123
 -0.02995891 -0.05795939  0.05504693  0.10681709  0.09271178 -0.04990526
  0.11930827 -0.17942119 -0.03980168 -0.0897399  -0.08688195  0.06949901
 -0.027505   -0.00061127 -0.08535286 -0.04290544  0.15987721 -0.09457348
  0.00626497  0.01546233  0.21935037  0.10524669  0.01012975 -0.06153227
 -0.20000124  0.04297137  0.03431046 -0.07392709 -0.13515612  0.11984724
 -0.1505557   0.06548285 -0.06087423 -0.03773393 -0.04999869 -0.05378553
  0.15527998 -0.00671193  0.15815628 -0.08938377  0.0784928  -0.00864411
  0.06059305 -0.08556458 -0.06554455  0.04344543 -0.14902171 -0.04006366
  0.06310629 -0.11431018 -0.05935525 -0.05731422 -0.03694518 -0.03194145
 -0.06246174  0.13882542 -0.16407111  0.09793685]","[-0.03448066 -0.14800207 -0.26153752  0.01860353  0.03291209  0.09299336
  0.21855591  0.06188473 -0.0732351  -0.06656175 -0.05412377 -0.04942052
 -0.03035495  0.0804024  -0.08498437 -0.0202797   0.01305559  0.08039699
  0.08743906 -0.02085941  0.00387389  0.04203983  0.01802462  0.09953611
  0.21273911  0.14772174  0.02284225  0.11524689 -0.02219943  0.02153944
  0.06796216 -0.06937531 -0.06721529 -0.11362999  0.11698466 -0.00298368
  0.02319442  0.08784335 -0.05744766 -0.06246546 -0.01083424 -0.08002044
 -0.01642437  0.00855288  0.03213703  0.11672004  0.03887153 -0.01510844
  0.12558614 -0.15382355  0.00908638 -0.09248895 -0.03361282  0.123527
 -0.02250013 -0.05361122 -0.08870934 -0.02207963  0.15079229 -0.12053153
 -0.00388169 -0.01158211  0.23560339  0.11498204 -0.0041721  -0.06923901
 -0.16131113  0.03235906  0.0440696  -0.02854339 -0.08580997  0.08651803
 -0.13393743  0.07229796 -0.02247662 -0.02390396 -0.0316219  -0.07769834
  0.11652736 -0.0180934   0.13809282 -0.05395175  0.07918373 -0.01152649
  0.03642613 -0.07673904 -0.04851412  0.02588795 -0.10273923 -0.03565805
  0.07746129 -0.09363496 -0.08078434 -0.04323328 -0.04522039 -0.01802551
 -0.02205215  0.18893582 -0.14950466  0.063878  ]",0.3597531434267224,0
req,src,test_data/LibEST_semeru_format/requirements/RQ48-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir csr attribut request est client request list desir csr attribut send https get messag est server oper path csrattr,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.02002758 -0.12629412 -0.26697797  0.0034956   0.02461626  0.10127906
  0.25129998  0.06000828 -0.02672494 -0.1079785  -0.07595601 -0.04931965
 -0.02696041  0.08025389 -0.08667208  0.03605753  0.01440395  0.08650382
  0.09739792  0.05822663  0.04096767  0.05469621  0.00824327  0.09201299
  0.23467979  0.18412314  0.00747143  0.15159453 -0.04240852  0.04653342
  0.02637563 -0.07683077 -0.02884299 -0.12357812  0.12887454 -0.01404486
  0.07451217  0.12343709 -0.0407328  -0.08099362  0.02017124 -0.06972123
 -0.02995891 -0.05795939  0.05504693  0.10681709  0.09271178 -0.04990526
  0.11930827 -0.17942119 -0.03980168 -0.0897399  -0.08688195  0.06949901
 -0.027505   -0.00061127 -0.08535286 -0.04290544  0.15987721 -0.09457348
  0.00626497  0.01546233  0.21935037  0.10524669  0.01012975 -0.06153227
 -0.20000124  0.04297137  0.03431046 -0.07392709 -0.13515612  0.11984724
 -0.1505557   0.06548285 -0.06087423 -0.03773393 -0.04999869 -0.05378553
  0.15527998 -0.00671193  0.15815628 -0.08938377  0.0784928  -0.00864411
  0.06059305 -0.08556458 -0.06554455  0.04344543 -0.14902171 -0.04006366
  0.06310629 -0.11431018 -0.05935525 -0.05731422 -0.03694518 -0.03194145
 -0.06246174  0.13882542 -0.16407111  0.09793685]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.495150044994975,0
req,src,test_data/LibEST_semeru_format/requirements/RQ2-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir terminolog key word must must requir shall shall recommend recommend may option document interpret describ rfc assum reader familiar term concept describ public key cryptographi standard pkcs rfc https rfc cmp rfc cmc rfc rfc rfc tls rfc addit term defin terminolog section cmc rfc follow term defin clariti est certif issu servic est reach est server could logic behind est server embed within third parti trust anchor trust anchor authorit pki hierarchi est server provid servic explicit trust anchor explicit configur client server use est tls authent exampl manual configur est client bootstrap describ section see detail section implicit trust anchor third parti avail client server use tls authent specif indic use est tls authent exampl tas common use web browser authent web server tas use server authent manufactur instal client credenti certif popul cabl modem router factori author model tas differ author model explicit trust anchor see detail section certif less tls certif less tls cipher suit provid way perform mutual authent situat neither client server certif will use credenti use authent word phrase code key share client server credenti must uniqu share client server order provid authent individu client individu server,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 2.07649991e-02 -1.23978503e-01 -2.67159611e-01  1.30387805e-02
  2.72379238e-02  9.25438255e-02  2.48097673e-01  6.15683980e-02
 -1.89826228e-02 -1.00402072e-01 -6.73580691e-02 -4.38584648e-02
 -1.54374503e-02  9.61187184e-02 -9.23477560e-02  3.81437652e-02
  3.98038188e-03  9.61137637e-02  9.22925770e-02  5.54877557e-02
  2.39771102e-02  6.58327118e-02  1.46603864e-02  9.60533172e-02
  2.19410419e-01  1.91637903e-01  1.71471834e-02  1.48857161e-01
 -5.19462526e-02  4.78976518e-02  2.74605285e-02 -6.68648630e-02
 -3.10950298e-02 -1.49806589e-01  1.44800693e-01 -1.10108415e-02
  6.46093562e-02  1.06654502e-01 -4.08820063e-02 -1.03157014e-01
  5.78791602e-03 -8.80751163e-02 -3.46440189e-02 -4.03746106e-02
  6.40682504e-02  1.06157422e-01  1.07702062e-01 -6.19764514e-02
  1.14483289e-01 -1.79105714e-01 -3.47319804e-02 -9.35924500e-02
 -7.40223303e-02  7.71135464e-02 -3.00947558e-02 -1.19986267e-04
 -6.99129924e-02 -3.98511849e-02  1.52865112e-01 -1.18956573e-01
 -1.12027526e-02  8.59872717e-03  2.12367073e-01  1.13323547e-01
  1.84823927e-02 -5.22320047e-02 -2.10016459e-01  4.18052226e-02
  5.44632412e-02 -5.76656982e-02 -1.00603886e-01  1.15542866e-01
 -1.51536003e-01  6.05084300e-02 -6.55100197e-02 -5.66768460e-02
 -4.56210077e-02 -6.13810308e-02  1.55998811e-01  1.74423866e-03
  1.41226783e-01 -9.38318819e-02  6.19892403e-02 -2.93949302e-02
  6.78196102e-02 -9.01478902e-02 -7.21427798e-02  4.08927873e-02
 -1.33510277e-01 -2.93874368e-02  7.92512447e-02 -1.16184101e-01
 -5.59945144e-02 -4.67266217e-02 -3.56314331e-02 -4.92527708e-02
 -5.34678958e-02  1.30352095e-01 -1.57004431e-01  9.66723338e-02]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.3700879041619139,0
req,src,test_data/LibEST_semeru_format/requirements/RQ53-pre.txt,test_data/LibEST_semeru_format/source_code/est_proxy.c,"requir inform refer idev ieee standard associ ieee secur devic identifi decemb http standard ieee org findstd standard html rfc howard approach use ldap network inform servic rfc march rfc rescorla http tls rfc may rfc nystrom kaliski pkcs https tool ietf org html rfc select object class attribut type version rfc novemb rfc schaad housley advanc encrypt standard key wrap algorithm rfc septemb rfc taylor mavrogiannopoulo perrin use secur remot password srp protocol tls authent rfc novemb rfc turner applic pkcs media type rfc august rfc zieglar turner peck suit profil certif manag cms rfc novemb shs nation institut standard technolog secur hash standard shs feder inform process standard public march http csrc nist gov public fip fips180 fip 180 pdf 800 part nation institut standard technolog recommend key manag part general revis )"", juli 2012 http :// csrc nist gov public nistpub 800 sp800 57_part1_rev3_gener pdf","sinc hijack open ssl buf mem data util function allow free buf mem without free under data static void est proxi free ossl bufmem buf mem data null buf mem free bsearch compar use bsearch function perform comparison node within client context array static int bsearch compar const void const void int result client ctx node client ctx node client ctx node client ctx node threadid threadid result threadid threadid result threadid threadid result return result get client ctx perform search order array key search current thread valu return client context creat thread entri exist array thread new one creat static est ctx get client ctx est ctx ctx est ctx ctx null est error unsign long cur threadid unsign long cur pid getpid client ctx node found node unsign long zero threadid client ctx node empti node int empti index window todo like need replac get current thread addit realli return pointer opaqu valu use typic pointer pthread base environ actual pthread helper api access actual pthread equal must use array search would best chang linear search mix pid current process thread case applic fork new process nginx ifndef disabl pthread cur threadid unsign long pthread self endif cur threadid cur pid found node client ctx node bsearch cur threadid ctx client ctx array cur max ctx array sizeof client ctx node bsearch compar found node null need alloc context get readi use c_ctx est_client_init p_ctx ca_chain_raw p_ctx ca_chain_raw_len est_cert_format_pem null c_ctx null est_log_err unabl alloc initi est client context proxi use ""); return null name bit mislead ident cert privat key use proxi mode one store server_cert server_priv_key howev use direct set client side look mix might want chang name context hold est_client_set_auth c_ctx p_ctx userid p_ctx password p_ctx server_cert p_ctx server_priv_key est_err_non est_log_err unabl set authent configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx auth_credentials_cb est_err_non est_log_err unabl regist authent credenti callback .""); return null wrt path segment unlik true client mode path segment chang everi request upstream need obtain local proxi set one time left null est_client_set_serv c_ctx p_ctx est_serv p_ctx est_port_num null est_err_non est_log_err unabl set upstream server configur client context proxi use ""); est_destroy c_ctx return null c_ctx p_ctx read_timeout est_err_non est_log_err unabl set ssl read timeout client context ""); est_destroy c_ctx return null make sure room anoth entri empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod null space alloc new array copi alreadi doubl size current one client_ctx_lu_node_t temp_array cur_max_ctx_array temp_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array memcpy_ temp_array sizeof client_ctx_lu_node_t cur_max_ctx_array p_ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array free p_ctx client_ctx_array p_ctx client_ctx_array temp_array qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_nod client_ctx_lu_node_t bsearch zero_threadid p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar empty_index int empty_nod p_ctx client_ctx_array add array sort proper place p_ctx client_ctx_array empty_index threadid cur_threadid p_ctx client_ctx_array empty_index client_ctx c_ctx qsort p_ctx client_ctx_array cur_max_ctx_array sizeof client_ctx_lu_node_t bsearch_compar els entri found tree return client context pid c_ctx found_nod client_ctx return c_ctx proxy_cleanup invok est_destroy current context proxi mode void proxy_cleanup est_ctx p_ctx int p_ctx client_ctx_array null return cur_max_ctx_array ++) p_ctx client_ctx_array client_ctx est_destroy p_ctx client_ctx_array client_ctx free p_ctx client_ctx_array p_ctx client_ctx_array null routin check result code enrol attempt propag retri messag client need static est_error est_ctx ctx void http_ctx sign request ask client retri futur may occur configur automat enrol send http retri respons client need propag retri respons client est_log_info server request retri propag client )"", ctx retry_after_delay est_err_non ctx http_ctx ctx retry_after_delay return est_err_http_writ return est_err_non routin send pkcs7 encod certif est client via http static est_error void http_ctx unsign char pkcs7 int pkcs7_len char http_hdr est_http_hdr_max int hdrlen send http header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_pkcs7_co est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl pkcs7_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) return est_err_http_writ send sign pkcs7 certif bodi mg_write http_ctx pkcs7 pkcs7_len est_log_err http write error propag pkcs7 ""); return est_err_http_writ return est_err_non issu request server obtain cert chain use get cert request client cert chain return server pass back caller respons caller free buffer est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_ctx client_ctx est_error int rcvd_cacerts_len unsign char rcvd_cacert ctx null est_log_err ctx pass __function__ return est_err_no_ctx cacerts_rtn null cacerts_rtn_len null est_log_err ctx pass __function__ return cacerts_rtn null cacerts_rtn_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx client_ctx rcvd_cacerts_len est_err_non est_log_err unabl retriev cert upstream server est_err_num_to_str )); return alloc buffer retriev cert get copi rcvd_cacert malloc rcvd_cacerts_len rcvd_cacert null est_log_err unabl malloc buffer cacert receiv server ""); return est_err_malloc client_ctx rcvd_cacert est_err_non est_log_err unabl copi cert upstream server est_err_num_to_str )); free rcvd_cacert return retriev cert normal client interfac caus client back uniniti state case though get pass back downstream client put client context back initi state client_ctx est_client_initi cacerts_rtn rcvd_cacert cacerts_rtn_len rcvd_cacerts_len return est_err_non routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx clnt_ctx buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int reenrol est_error ssl ssl_client connect server est_client_connect clnt_ctx ssl_client est_err_non return send enrol request clnt_ctx ssl_client pkcs10 pkcs7 pkcs7_len reenrol disconnect server clnt_ctx ssl_client return routin connect est server attempt enrol csr pkcs10 buffer upon success return x509 cert pkcs7 buffer length return cert pkcs7_len pkcs7 buffer alloc caller static est_error est_ctx client_ctx char path_seg int path_segment_len est_error path_segment_len strnlen_ path_seg est_store_path_seg client_ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return return est_err_non function use server side est proxi respond incom simpl enrol request function similar client api function (), except bypass thing done function proxi sign csr insert tls uniqu instead includ cmc usag extens static est_error est_ctx ctx void http_ctx ssl ssl const char char bodi int body_len char path_seg int reenrol est_error buf_mem pkcs10 unsign char pkcs7 int pkcs7_len int diff x509_req csr null est_ctx client_ctx errno_t safec_rc make sure client sent pkcs10 csr request safec_rc memcmp_ sizeof applic pkcs10 ""), applic pkcs10 sizeof applic pkcs10 ""), diff safec_rc eok est_log_info memcmp_ error safec_rc diff return authent client switch est_enroll_auth ctx http_ctx ssl path_seg reenrol case est_http_auth case est_srp_auth case est_cert_auth break case est_http_auth_pend return est_err_auth_pend break case est_unauthor default return est_err_auth_fail break pars pkcs10 csr client csr est_server_parse_csr unsign char bodi body_len csr est_log_err unabl pars pkcs10 csr sent client ""); return est_err_bad_pkcs10 perform saniti check csr est_server_check_csr csr est_log_err pkcs10 csr sent client fail saniti check ""); x509_req_fre csr return est_err_bad_pkcs10 check proof possess challeng password pkcs10 request match tls uniqu est_tls_uid_auth ctx ssl csr x509_req_fre csr est_err_non return bodi point pkcs10 data pass enrol routin need jack buf_mem attach bodi new buf_mem pkcs10 buf_mem_new (); pkcs10 data bodi pkcs10 length body_len pkcs10 max body_len get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); pkcs10 return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg alloc space hold cert expect receiv est server pkcs7 malloc est_ca_max attempt enrol csr client client_ctx pkcs10 pkcs7 pkcs7_len reenrol handl error like occur switch case est_err_auth_fail tri one time digest auth ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token est_log_info http auth fail tri digest basic paramet ""); client_ctx pkcs10 pkcs7 pkcs7_len reenrol client_ctx http_ctx els est_err_non est_log_warn est enrol fail error code break case client_ctx http_ctx break default est_log_warn initi est enrol request error code break client_ctx auth_mod auth_non prevent open ssl free data pkcs10 cert respons est server let forward back est client pkcs7_len http_ctx pkcs7 pkcs7_len free pkcs7 return function use server side est proxi respond incom cacert request cert respons set local respond local set buffer set issu request upstream server static int est_ctx ctx void http_ctx char path_seg est_error est_err_non est_ctx client_ctx int cacerts_len ctx ca_cert null est_log_info proxi cert set local respond local set cert respons ""); return est_handle_cacert ctx ctx ca_cert ctx ca_certs_len http_ctx path_seg )); els get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev cacert note need authent client see sec est_log_info proxi attempt retriev cert upstream server ""); client_ctx cacerts_len upstream request success retriev cert context est_err_non est_log_info proxi cert retriev success server forward est client .""); return est_handle_cacert client_ctx client_ctx retrieved_ca_cert client_ctx http_ctx path_seg )); els someth went wrong upstream request server treat found condit est_log_err proxi server reachabl sent corrupt cert ""); return function use server side est proxi respond incom csr attribut request function similar client api function (). static int est_ctx ctx void http_ctx char path_seg int est_err_non int pop_pres char csr_data csr_data_pop int csr_len csr_pop_len est_ctx client_ctx get client context thread client_ctx get_client_ctx ctx client_ctx est_log_err unabl obtain client context proxi oper ""); return est_err_no_ctx path_seg path seg valu come downstream client request alreadi valid place ctx use client code path_seg client_ctx path_seg est_err_non est_log_err unabl save path segment uri client context ""); return invok client code retriev csr attribut note need authent client see sec est_log_info proxi attempt retriev csr attr upstream server ""); client_ctx unsign char **)& csr_data csr_len csr_data point memori alloc hold csr attribut freed call stack prevent doubl free null pointer client context client_ctx retrieved_csrattr null client_ctx est_err_non ctx csr_pop_pres ctx server_enable_pop est_is_challeng password_pres csr_data csr_len pop_pres est_err_non est_log_err error saniti check ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non ctx csr_pop_pres pop_pres ctx csr_pop_pres csr_len csr_data malloc est_csrattrs_pop_len csr_data return est_err_malloc strncpy_ csr_data est_csrattrs_pop_len est_csrattrs_pop est_csrattrs_pop_len csr_data est_csrattrs_pop_len csr_len est_csrattrs_pop_len return ctx csr_data csr_len http_ctx )); est_add_challeng password csr_data csr_len csr_data_pop csr_pop_len est_err_non csr_data free csr_data est_log_err error add ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non csr_data free csr_data csr_data csr_data_pop csr_len csr_pop_len els est_log_err server reachabl sent corrupt attribut ""); est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non return ctx csr_data csr_len http_ctx )); function call web server layer http request arriv listen port est proxi determin est request type dispatch request appropri handler paramt ctx pointer est_ctx http_ctx context pointer web server method html method request either get post uri pointer http uri bodi pointer full html bodi content body_len length html bodi html content type header est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char ssl ssl est_error int diff errno_t safec_rc est_oper oper char path_seg null est_error est_err_non ctx return est_err_no_ctx verifi context proxi client server ctx est_mod est_proxi return est_err_bad_mod est_parse_uri uri oper path_seg est_err_non est_send_http_error ctx http_ctx return see cacert request oper est_op_cacert get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return see simpl enrol request els oper est_op_simple_enrol post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn enrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see enrol request els oper post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method est_log_warn incom http header content type header ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return case bodi indic content pass enrol request cannot correct csr requir continu proxi mode tri forward non exist csr bodi null est_log_warn incom http header csr content ""); est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return get ssl context requir authent client ssl ssl mg_get_conn_ssl http_ctx ssl est_send_http_error ctx http_ctx est_err_no_ssl_ctx free path_seg path_seg null return est_err_no_ssl_ctx ctx http_ctx ssl bodi body_len path_seg est_err_non est_err_auth_pend est_log_warn reenrol fail est_err_num_to_str )); est_err_auth_fail est_send_http_error ctx http_ctx est_err_auth_fail els est_send_http_error ctx http_ctx est_err_bad_pkcs10 free path_seg path_seg null return est_err_bad_pkcs10 see keygen request fixm current implement els strncmp uri est_keygen_uri est_uri_max_len post allow safec_rc strcmp_s method max_http_method_len post diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method return est_err_wrong_method est_log_warn incom http header content type header ""); return ctx est_send_http_error ctx http_ctx fixm last param zero return est_err_http_writ fixm need appropri return code endif see csr attribut request els oper est_op_csrattr get allow safec_rc strcmp_s method max_http_method_len get diff safec_rc eok est_log_info strcmp_s error safec_rc diff est_send_http_error ctx http_ctx est_err_wrong_method free path_seg path_seg null return est_err_wrong_method ctx http_ctx path_seg est_err_non est_send_http_error ctx http_ctx free path_seg path_seg null return send 404 error uri match els est_send_http_error ctx http_ctx free path_seg path_seg null return est_err_non /*! brief est_proxy_start use applic start est proxi est_proxy_init est_proxy_set_serv call requir callback function provid applic param ctx pointer est context lib est use http code mongoos http server function allow applic start http servic layer requir est return est_error est_error est_proxy_start est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx mg_start ctx mgctx ctx mg_ctx mgctx return est_err_non els return est_err_no_ssl_ctx /*! brief est_proxy_stop use applic stop est proxi call prior est_destroy (). param ctx pointer est context lib est use http code mongoos http server function allow applic stop http servic layer return est_error est_error est_proxy_stop est_ctx ctx est_mg_context mgctx ctx est_log_err null context ""); return est_err_no_ctx mgctx est_mg_context ctx mg_ctx mgctx mg_stop mgctx return est_err_non /*! brief est_proxy_init use applic creat context est librari context use invok function api proxi mode param ca_chain char array contain pem encod cert crl entri chain certif use trust anchor establish tls connect param ca_chain_len length ca_chain char array param cacerts_resp_chain char array contain pem encod cert includ cacert respons option paramet set contain chain certif use proxi respond get cert request est client paramet includ proxi obtain certif chain configur upstream est server paramet null correct length buffer must specifi param length cacerts_resp_chain char array param cert_format specifi encod local extern certif chain pem der param http_realm char array contain http realm name http auth param tls_id_cert pointer x509 contain proxi certif tls layer param tls_id_key pointer evp_pkey contain privat key associ proxi certif param uid user use authent server param pwd password use authent server function allow applic initi est server context proxi mode oper use oper applic must provid trust certif use server oper use ca_chain paramet certif set includ explicit trust anchor certif number implicit trust anchor certif intermedi sub certif requir complet chain trust ident certif pass tls_id_cert paramet root certif ident certif certif encod use format specifi cert_format paramet pem may contain crl entri use authent est client connect server applic must also provid http realm use http authent server cerif privat key use tls warn includ addit intermedi sub certif need complet chain trust may result potenti mitm attack return est_ctx est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_id_cert evp_pkey tls_id_key char uid char pwd est_ctx ctx int len est_log_vers (); saniti check input ca_chain null est_log_err trust certif set empti ""); return null tls_id_cert null est_log_err tls cert empti ""); return null tls_id_key null est_log_err tls privat key empti ""); return null http_realm null est_log_err est http realm null ""); return null cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null verifi length cert chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match ca_chain_len ""); return null cacerts_resp_chain len int strnlen_ char cacerts_resp_chain est_ca_max len est_log_err length cacerts_resp_chain match ""); return null alloc set proxi base est context context use oper server downstream client est proxi mode basic server function requir client capabl communic upstream server need ctx malloc sizeof est_ctx )); ctx est_log_err malloc fail ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_proxi ctx retry_period est_retry_period_def ctx server_enable_pop ctx require_http_auth http_auth_requir ctx server_read_timeout ctx uid pwd est_err_non est_log_err fail store userid password proxi initi ""); free ctx return null load certif local memori retain futur use use cacert request cacerts_resp_chain est_load_ca_cert ctx cacerts_resp_chain est_log_err fail load certif respons buffer ""); free ctx return null load certif chain x509 store structur use verifi incom cert tls establish also save way raw copi ca_chain buffer use creat client context use communinc upstream server ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx ca_chain_raw malloc ca_chain_len ctx ca_chain_raw est_log_err malloc fail ""); est_destroy ctx return null memcpy_ char ctx ca_chain_raw ca_chain_len char ca_chain ca_chain_len ctx ca_chain_raw ca_chain_len ctx ca_chain_raw_len ca_chain_len strncpy_ ctx realm max_realm http_realm max_realm ctx server_cert tls_id_cert ctx server_priv_key tls_id_key ctx auth_mod auth_bas ctx read_timeout ctx retry_after_delay ctx retry_after_d ctx client_ctx_array client_ctx_lu_node_t malloc sizeof client_ctx_lu_node_t cur_max_ctx_array memzero_ ctx client_ctx_array sizeof client_ctx_lu_node_t cur_max_ctx_array return ctx /*! brief use applic layer configur http authent method use valid ident est client param ctx pointer est proxi context return est_proxy_init (). param amod either auth_bas auth_digest function option invok applic layer chang default http authent mode default mode http basic authent applic may desir use digest authent instead case function use set mode function invok prior start est proxi return est_error est_error est_ctx ctx est_http_auth_mod amod return ctx amod )); /*! brief use applic regist callback function param ctx est context obtain est_proxy_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback return ctx callback )); /*! brief use applic set timeout valu read oper est proxi send request est server attempt read respons server timeout valu limit amount time proxi wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout return ctx timeout )); /*! brief est_proxy_set_serv call applic layer specifi address port est server must call est_proxy_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long invalid port number input less zero greater 65535 est_proxy_set_serv error check input paramet store hostnam port number est context est_error est_proxy_set_serv est_ctx ctx const char server int port ctx return est_err_no_ctx server null return strnlen_ server return port port 65535 return strncpy_ ctx est_serv server ctx est_port_num port return est_err_non","[ 0.01319338 -0.11533403 -0.2819848   0.00990328  0.05376234  0.10185458
  0.23951474  0.08045531 -0.01853419 -0.1131255  -0.05485727 -0.04338977
 -0.0102566   0.1099622  -0.08808511  0.01196841 -0.01779054  0.1122872
  0.08624494  0.02919303 -0.00689821  0.07794971  0.0141936   0.10150144
  0.22071712  0.18736595  0.03268617  0.13126399 -0.05178919  0.04590297
  0.04534998 -0.07178124 -0.04453324 -0.17484565  0.16308282 -0.01045712
  0.03377596  0.09652384 -0.05052194 -0.11465301 -0.0268607  -0.10799024
 -0.04462377 -0.01027137  0.05799931  0.11823808  0.09819899 -0.05109863
  0.10031927 -0.18378118 -0.02648262 -0.09882805 -0.04807419  0.10333949
 -0.04671875 -0.02342246 -0.05312942 -0.03053781  0.1639278  -0.14686675
 -0.02447448 -0.01016775  0.22425641  0.14013483  0.02079331 -0.03472797
 -0.20735519  0.04474457  0.06065626 -0.0416242  -0.07342704  0.10396896
 -0.15080395  0.05912101 -0.04484918 -0.04730462 -0.04163873 -0.08358982
  0.13922104 -0.00726333  0.10584519 -0.08943589  0.06419261 -0.04038159
  0.07424197 -0.08175149 -0.07975222  0.03710765 -0.11566629 -0.01916005
  0.09576742 -0.12076638 -0.07158495 -0.02908102 -0.03369354 -0.05639433
 -0.03894927  0.12922879 -0.16803622  0.08045925]","[-1.69997998e-02 -1.35897011e-01 -2.74189174e-01  1.70317777e-02
  5.58414757e-02  1.15330115e-01  2.17528522e-01  8.58596489e-02
 -6.26345053e-02 -1.11164369e-01 -4.86302339e-02 -5.50346151e-02
 -2.63312161e-02  7.72084817e-02 -8.20802897e-02 -2.58404855e-02
 -4.82703233e-03  9.73957628e-02  8.28364268e-02 -8.33752006e-03
 -6.86064083e-03  4.85500656e-02  1.69467703e-02  1.05127431e-01
  2.36401588e-01  1.42734602e-01  3.21286842e-02  1.02205366e-01
 -2.80654114e-02  1.73775107e-02  8.28395784e-02 -8.74879211e-02
 -6.56846762e-02 -1.29000992e-01  1.21474363e-01 -9.58437938e-03
  1.17988782e-02  1.01203635e-01 -6.76453561e-02 -5.73409609e-02
 -3.01130284e-02 -8.82627666e-02 -3.34238745e-02  4.37195692e-03
  2.39399448e-02  1.24423355e-01  4.91810516e-02 -1.03503987e-02
  1.03783309e-01 -1.64302975e-01 -3.54036619e-03 -8.95753801e-02
 -3.88157405e-02  1.23404019e-01 -5.33224493e-02 -6.90320954e-02
 -7.98115209e-02 -2.67461780e-02  1.74384400e-01 -1.26384586e-01
 -9.66917071e-03 -6.36508269e-03  2.44369864e-01  1.35908321e-01
 -1.13741038e-02 -5.17569594e-02 -1.61574870e-01  4.46434431e-02
  2.09719632e-02 -4.55862731e-02 -8.97309035e-02  8.88117999e-02
 -1.23152331e-01  7.08776116e-02 -7.42091238e-03 -9.81570847e-05
 -2.75236722e-02 -7.40716606e-02  1.00555524e-01 -2.44132243e-02
  1.18647739e-01 -6.38015345e-02  9.19418857e-02 -5.36718685e-03
  3.55758406e-02 -6.31803274e-02 -6.69969767e-02  2.62999665e-02
 -1.16064072e-01 -2.22701635e-02  7.69556239e-02 -1.15279421e-01
 -1.00846559e-01 -2.73129977e-02 -3.72701511e-02 -8.29212554e-03
 -1.89667251e-02  1.82418033e-01 -1.71551779e-01  6.34938031e-02]",0.31172083535953704,0
req,src,test_data/LibEST_semeru_format/requirements/RQ48-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir csr attribut request est client request list desir csr attribut send https get messag est server oper path csrattr,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.02002758 -0.12629412 -0.26697797  0.0034956   0.02461626  0.10127906
  0.25129998  0.06000828 -0.02672494 -0.1079785  -0.07595601 -0.04931965
 -0.02696041  0.08025389 -0.08667208  0.03605753  0.01440395  0.08650382
  0.09739792  0.05822663  0.04096767  0.05469621  0.00824327  0.09201299
  0.23467979  0.18412314  0.00747143  0.15159453 -0.04240852  0.04653342
  0.02637563 -0.07683077 -0.02884299 -0.12357812  0.12887454 -0.01404486
  0.07451217  0.12343709 -0.0407328  -0.08099362  0.02017124 -0.06972123
 -0.02995891 -0.05795939  0.05504693  0.10681709  0.09271178 -0.04990526
  0.11930827 -0.17942119 -0.03980168 -0.0897399  -0.08688195  0.06949901
 -0.027505   -0.00061127 -0.08535286 -0.04290544  0.15987721 -0.09457348
  0.00626497  0.01546233  0.21935037  0.10524669  0.01012975 -0.06153227
 -0.20000124  0.04297137  0.03431046 -0.07392709 -0.13515612  0.11984724
 -0.1505557   0.06548285 -0.06087423 -0.03773393 -0.04999869 -0.05378553
  0.15527998 -0.00671193  0.15815628 -0.08938377  0.0784928  -0.00864411
  0.06059305 -0.08556458 -0.06554455  0.04344543 -0.14902171 -0.04006366
  0.06310629 -0.11431018 -0.05935525 -0.05731422 -0.03694518 -0.03194145
 -0.06246174  0.13882542 -0.16407111  0.09793685]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.3757879898566972,0
req,src,test_data/LibEST_semeru_format/requirements/RQ29-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.h,requir client author decis issu certif client alway control local polici est server configur reflect polici document specifi constraint polici est provid est server access client authent ident tls client certif addit http user authent credenti help implement polici client certif issu est includ cmc rfc extend key usag extens client registr author describ rfc rfc case est server appli author polici consist client exampl handl simpleenrol request est server could configur accept pop link inform match current tls session authent est client verifi inform act est server specifi section specif mechan avail est client use fullcmc method,mingw typedef pid int use defin static int pthread mutex lock pthread mutex mingw typedef pid int use defin static int pthread mutex unlock pthread mutex mingw typedef pid int use defin static void unicod const char path wchar wbuf size wbuf len,"[ 0.02829203 -0.12302754 -0.26229742  0.00880806  0.02002794  0.09051092
  0.25270495  0.05446298 -0.01571509 -0.09972385 -0.07377151 -0.04399642
 -0.01788861  0.08840609 -0.09109861  0.04871471  0.00914043  0.08954263
  0.09437549  0.06899469  0.0366182   0.06181451  0.01434302  0.09435619
  0.22057936  0.19458833  0.0112726   0.15630749 -0.05232048  0.04996011
  0.01733976 -0.06790815 -0.02509712 -0.1393817   0.13728    -0.01343643
  0.08020362  0.11493257 -0.03532334 -0.09900467  0.01777131 -0.07821506
 -0.03149048 -0.05596867  0.06513039  0.10057502  0.11343491 -0.06573108
  0.11800817 -0.17973056 -0.03928315 -0.08946294 -0.08520797  0.06376544
 -0.02493978  0.0095234  -0.07520843 -0.0428663   0.15157445 -0.10560311
 -0.00431229  0.01709236  0.20855834  0.10295875  0.01721841 -0.05470847
 -0.21069679  0.04191446  0.04686016 -0.06694676 -0.11594611  0.1205094
 -0.15234648  0.06024561 -0.0731443  -0.05764334 -0.05095166 -0.05290856
  0.16270734  0.00474755  0.15396082 -0.09820273  0.06537385 -0.02404833
  0.06720523 -0.09346303 -0.06992313  0.04271678 -0.14311957 -0.03287098
  0.07132775 -0.11474663 -0.04793837 -0.05362155 -0.0352576  -0.04658654
 -0.06290676  0.12567624 -0.15676533  0.10325272]","[-0.03037988 -0.11331    -0.27465558 -0.00203319  0.07519955  0.09355958
  0.19650115  0.06960465 -0.06197666 -0.07534166 -0.03835084 -0.04944178
 -0.02543062  0.08664084 -0.08646585 -0.04048822 -0.0412206   0.09362981
  0.08307725 -0.07858405 -0.05480267  0.06726368 -0.00325975  0.09827047
  0.20161283  0.16126537  0.04237292  0.09172165 -0.03171454  0.0403454
  0.0507689  -0.08224706 -0.06746737 -0.13799907  0.14117962 -0.02948107
 -0.02898829  0.06969103 -0.06291301 -0.10410526 -0.07580978 -0.11767408
 -0.01902835  0.04528895  0.00822657  0.1325896   0.04069861  0.00389869
  0.09279744 -0.18381928  0.00359802 -0.08284968  0.02725833  0.15617426
 -0.03961406 -0.0730326  -0.04251455  0.01983031  0.1554352  -0.16565521
 -0.02604633 -0.06621581  0.23679247  0.16015719  0.00463419 -0.03216541
 -0.16877046  0.03641336  0.05460791 -0.01445771 -0.0313769   0.0533159
 -0.13452259  0.0657654   0.01098714 -0.00750631 -0.04080506 -0.11322837
  0.08275991 -0.02547094  0.06750318 -0.05717668  0.08456459 -0.02704674
  0.05315566 -0.06293311 -0.06729733  0.02463711 -0.07433925 -0.01553668
  0.12031873 -0.07553184 -0.08833927 -0.01761947 -0.01969375 -0.0383084
 -0.02034266  0.18647684 -0.16771911  0.00373917]",0.5367288875513898,0
req,src,test_data/LibEST_semeru_format/requirements/RQ40-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.c,requir full cmc request http post fullcmc valid full pki request server must reject messag http content type use applic pkcs mime smime type paramet cmc request specifi rfc bodi messag binari valu encod pki request content transfer encod base rfc,"author routin int ossl verifi int store ctx ctx int cert error store ctx get error ctx current cert store ctx get current cert ctx est log info enter function cert error cert error current cert name print stdout _get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% serror depth lookup ctx crl path """", cert_error ctx cert_error )); switch cert_error case enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok warn applic est_log_warn crl load tls peer allow .""); break case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error break return return function use load x509_store use raw data buffer data expect pem encod return number cert store static int x509_store store unsign char raw int size stack_of x509_info null x509_info bio int cert_cnt bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return load file stack x509 crl pkey set null null null null est_log_err unabl read pem encod cert bio ""); bio_fre return bio_fre scan pull crl sk_x509_info_num sk_x509_info_shift x509 null est_log_info cert store )"", x509 name x509_store_add_cert store x509 cert_cnt ++; crl null est_log_info crl store ""); x509_store_add_crl store crl x509_info_fre null sk_x509_info_pop_fre x509_info_fre return cert_cnt function use popul x509_store structur use open ssl tls stack verifi tls peer x509_store alreadi alloc paramet store pointer x509_store structur hold cert raw1 char array contain pem encod cert put store size1 length raw1 char array est_error ossl_init_cert_stor x509_store store unsign char raw1 int size1 x509_store_set_flag store int cnt raw1 cnt store raw1 size1 cnt est_log_err cert count zero store ""); return return est_err_non function use output open ssl error buffer use open ssl api call fail like provid detail user regard caus failur void ossl_dump_ssl_error bio null buf_mem bptr null bio_new bio_s_mem ()); est_log_err bio_new fail ""); return err_print_error void bio_flush bio_get_mem_ptr bptr est_log_warn ossl error bptr data bio_free_al /*! brief convert base64 encod pkcs7 respons est server pem format param certs_p7 point buffer contain base64 encod pkcs7 data param certs_len indic size certs_p7 buffer param pem doubl pointer receiv pem encod data sever est messag return data contain base64 encod pkcs7 certif function use convert data pem format function alloc memori point pem argument caller respons releas memori return valu length pem buffer error return int int unsign char certs_p7 int certs_len unsign char pem x509 stack_of x509 cert null bio b64 unsign char cacerts_decod null int cacerts_decoded_len bio p7bio_in null pkcs7 null int nid unsign char pem_data int pem_len base64 decod incom cert buffer decod alway take origin buffer b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); return bio_new_mem_buf certs_p7 certs_len est_log_err bio_new fail ""); return bio_push b64 cacerts_decod malloc certs_len cacerts_decod est_log_err malloc fail ""); return cacerts_decoded_len bio_read cacerts_decod certs_len bio_free_al get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); free cacerts_decod return d2i_pkcs7_bio p7bio_in null est_log_err pem_read_bio_pkcs7 fail ""); ossl_dump_ssl_error (); free cacerts_decod return bio_free_al p7bio_in free cacerts_decod decod cert get refer stack cert nid obj_obj2nid type switch nid case nid_pkcs7_sign cert sign cert break case nid_pkcs7_sign envelop cert signed_and_envelop cert break default est_log_err invalid nid valu pkcs7 structur ""); pkcs7_free return break cert est_log_err fail attain x509 cert stack pkcs7 data ""); pkcs7_free return output cert new bio use pem format bio_new bio_s_mem ()); est_log_err bio_new fail ""); pkcs7_free return sk_x509_num cert ++) sk_x509_valu cert pem_write_bio_x509 bio_put ""); void bio_flush convert bio char pem_len int bio_get_mem_data char **)& pem_data pem_len est_log_err bio_get_mem_data fail ""); pkcs7_free return pem malloc pem_len (!* pem est_log_err malloc fail ""); pkcs7_free return memcpy_ pem pem_len pem_data pem_len pem pem_len make sure null termiant bio_free_al pkcs7_free return pem_len","[ 3.31680961e-02 -1.09561153e-01 -2.68568397e-01  2.37767425e-04
  3.33783962e-02  9.65451896e-02  2.52346873e-01  6.12566657e-02
 -6.83800830e-03 -1.12069331e-01 -7.14952350e-02 -4.07509990e-02
 -1.47267375e-02  9.90439281e-02 -8.92788023e-02  4.46578301e-02
 -5.72738284e-03  9.85863283e-02  9.12647992e-02  6.06227145e-02
  2.19066795e-02  7.30349645e-02  7.30477972e-03  9.10852402e-02
  2.21028283e-01  2.00857237e-01  1.56332124e-02  1.54753238e-01
 -5.49394339e-02  5.89441024e-02  1.39411455e-02 -6.94569945e-02
 -2.41238903e-02 -1.53245836e-01  1.53422415e-01 -1.88801717e-02
  6.56609833e-02  1.09690443e-01 -3.77843194e-02 -1.13284960e-01
  2.35931342e-03 -8.86012316e-02 -3.72381434e-02 -5.00572771e-02
  6.61972910e-02  1.07987843e-01  1.13125801e-01 -6.54744655e-02
  1.06814340e-01 -1.89130858e-01 -4.63803560e-02 -9.17774439e-02
 -7.48868138e-02  6.78933039e-02 -3.24718319e-02  9.36878566e-03
 -6.18498549e-02 -3.91116180e-02  1.55523777e-01 -1.18827656e-01
 -1.18092746e-02  3.32569703e-03  2.04179272e-01  1.17506154e-01
  2.49034110e-02 -4.30628993e-02 -2.18112126e-01  4.51110452e-02
  5.19152917e-02 -6.40306473e-02 -1.06978685e-01  1.15810812e-01
 -1.54294774e-01  5.59741445e-02 -6.68439493e-02 -5.56377918e-02
 -5.39109372e-02 -6.56110197e-02  1.60431534e-01  1.11163722e-03
  1.29392907e-01 -1.00717850e-01  6.43804967e-02 -3.09858229e-02
  7.69515261e-02 -8.96500126e-02 -7.70879537e-02  4.44716923e-02
 -1.38319999e-01 -2.86600087e-02  8.06313604e-02 -1.18195809e-01
 -5.23767993e-02 -4.55874465e-02 -2.78428383e-02 -5.93711808e-02
 -6.40961230e-02  1.13241263e-01 -1.65623546e-01  9.51777995e-02]","[-0.02280794 -0.13919947 -0.28047982  0.02055176  0.05719239  0.11580008
  0.21982583  0.08664732 -0.06486179 -0.10728963 -0.04538092 -0.0485174
 -0.02340238  0.0915816  -0.08403641 -0.03389406 -0.00680382  0.10322481
  0.08214781 -0.02023232 -0.01739727  0.05432794  0.02143495  0.10811873
  0.23230235  0.14707267  0.03343172  0.09869646 -0.02522595  0.01939251
  0.08936349 -0.079725   -0.07090753 -0.14112723  0.13800469 -0.0044158
 -0.00118626  0.09041351 -0.07368236 -0.0651512  -0.03746948 -0.0967169
 -0.03527454  0.01767246  0.02962421  0.1314824   0.04278544 -0.00958085
  0.1028138  -0.1680194   0.00360245 -0.09777321 -0.03135832  0.1338649
 -0.05140613 -0.07215084 -0.07555516 -0.02815823  0.17305858 -0.14494699
 -0.01413719 -0.01573827  0.24476083  0.14470093 -0.00722645 -0.05078406
 -0.16619018  0.04294062  0.03615962 -0.03229743 -0.07867274  0.08533599
 -0.1291659   0.07151608 -0.00589654 -0.00445574 -0.02803521 -0.09147019
  0.10225114 -0.02535055  0.10955609 -0.05982644  0.08245157 -0.01598702
  0.03577185 -0.06218307 -0.06432889  0.02448558 -0.102182   -0.02171448
  0.08405258 -0.11564184 -0.09899607 -0.02413773 -0.0364875  -0.01774029
 -0.01183339  0.17720269 -0.17135827  0.06180004]",0.4004984732951181,1
req,src,test_data/LibEST_semeru_format/requirements/RQ19-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir messag type document use exist media type messag specifi ftp http rfc applic pkcs rfc cmc rfc consist rfc distinct est messag type use http content type header specif media type est messag correspond media type oper messag type request media type request section respons media type respons section per oper sourc type distribut section certif applic pkcs mime section rfc cacert client certif applic pkcs10 section request function applic pkcs7 mime section rfc5967 rfc5751 simpleenrol simplereenrol full cmc applic pkcs7 mime section applic pkcs7 mime section fullcmc rfc5751 server side key applic pkcs10 section generat multipart mix section applic pkcs7 mime applic pkcs8 rfc5967 rfc5751 serverkeygen rfc5958 csr attribut section applic csrattr section document csrattr figur,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.02480437 -0.11728615 -0.26795545  0.00619919  0.03287434  0.09476029
  0.24743827  0.06529675 -0.01310141 -0.10482081 -0.06616237 -0.0425465
 -0.01393973  0.10133674 -0.08952554  0.03560685 -0.00479299  0.09998573
  0.09146743  0.0510737   0.01796927  0.07160509  0.01316675  0.09596094
  0.21853924  0.19536503  0.01916811  0.15075968 -0.05518525  0.05459089
  0.0264561  -0.06906594 -0.0308692  -0.15646254  0.15443161 -0.01437793
  0.06161686  0.10248507 -0.03997527 -0.11073412  0.00060297 -0.09123478
 -0.03746448 -0.03951796  0.06551383  0.10881574  0.1088464  -0.06363022
  0.11230122 -0.18387358 -0.03757964 -0.0949434  -0.06991491  0.07850139
 -0.03288061  0.00164794 -0.06452169 -0.0378795   0.15352608 -0.12292963
 -0.01440485  0.00423601  0.20927717  0.11765676  0.02267848 -0.04384664
 -0.21248193  0.04186571  0.05879945 -0.05452083 -0.09591392  0.1154337
 -0.15399636  0.05752812 -0.06454521 -0.05712061 -0.05031272 -0.06844957
  0.15793686  0.00096536  0.13013817 -0.09436408  0.06269205 -0.03508111
  0.07452258 -0.09076336 -0.07440425  0.04393045 -0.13078514 -0.02674996
  0.0838663  -0.1173908  -0.05627068 -0.04261345 -0.03413154 -0.05983952
 -0.05523409  0.12090265 -0.16179574  0.09461352]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.5067299459839283,1
req,src,test_data/LibEST_semeru_format/requirements/RQ51-pre.txt,test_data/LibEST_semeru_format/source_code/est_client.c,requir secur consider support basic authent specifi http rfc allow server access client cleartext password provid support legaci usernam password databas requir expos plaintext password est server use pin one time password help mitig exposur recommend est client use credenti obtain client certif use futur interact est server client use implicit databas certif valid see section author proceed specifi section situat client valid server respond certifi third parti uri configur cannot verifi respond author act pki client tri enrol client use implicit trust anchor databas recommend use tls base client authent prevent expos http base client authent inform recommend client includ link ident pop inform section request prevent request forward real est server man middl recommend implicit trust anchor databas use est server authent care manag reduc chanc third parti poor certif practic trust disabl implicit trust anchor databas success receiv distribut certif respons section limit vulner first tls exchang certif less tls cipher suit maintain secur perform mutual authent necessari enrol follow properti inform leak activ attack whether singl guess secret correct advantag adversari gain interact comput possibl perform countermeasur exponenti backoff certain number fail attempt frustrat repeat activ attack use certif less cipher suit properti list would render result enrol void potenti result certif issu unauthent unauthor entiti use certif less tls cipher suit share secret use authent author cannot share entiti parti exchang someon client server addit share secret void secur afford certif less cipher suit exposur share secret use certif less cipher suit third parti enabl client imperson result corrupt client trust anchor databas tls cipher suit includ export des name must use cipher offer suffici level protect bit crypto offer accept protect use des deprec describ cmc section rfc key use signatur key sign certif request privat key serv pop key pair inclus tls uniqu within certif request link proof possess tls proof ident enforc pop oper occur tls session activ impli server authent client current access privat key authent client known specif capabl hardwar protect authent credenti key storag implic strengthen proven server side key generat method allow key transport tls connect client without applic layer protect distribut privat key materi inher riski privat key distribut use encrypt mode negoti tls cipher suit key protect prefer key wrap method key wrap rfc specifi rfc encrypt privat key beyond provid tls option recommend est server support oper default recommend client request servic unless compel oper benefit use implicit trust anchor databas recommend server side key generat employ use encrypt cms server side key generat respons recommend regard csr attribut may list inclus enrol request real inher secur issu content convey adversari abl interpos convers could exclud attribut server may want includ attribut server may want render meaningless attribut server may want asn encod rule der ber type length valu structur easi construct malici content invalid length field caus buffer overrun condit asn encod rule allow arbitrari level nest may make possibl construct malici content caus stack overflow interpret asn structur awar issu take appropri measur guard buffer overflow stack overrun particular malici content general,"util function set certif privat key use ssl context return success int est client set cert key ssl ctx ctx cert evp pkey key ssl ctx use certif ctx cert est log err error set certif ossl dump ssl error return ssl ctx use privat key ctx key est log err unabl set privat key ossl dump ssl error return verifi key match cert ssl ctx check privat key ctx est log err privat key match certif public key ossl dump ssl error return return sign certif request use digest key pass return open ssl error code req sign ctx static int est client req sign req evp pkey pkey const evp int evp pkey ctx pkctx null evp ctx mctx evp ctx init mctx evp digest sign init mctx pkctx null pkey return encod use der asn set modifi flag req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req info enc modifi req sign ctx mctx evp ctx cleanup mctx return popul request build request buffer call open ssl insert field header paramet req pointer buffer hold x509 request header pkey public key place x509 request common name place x509 request challeng password place x509 header return valu est_err_non success static est_error est_ctx ctx x509_req req evp_pkey pkey char char x509_name subj setup version number x509_req_set_vers req est_log_err unabl set x509 version ""); ossl_dump_ssl_error (); return est_err_x509_v add common name entri subj req subj mbstring_asc unsign char est_log_err unabl set x509 common name ""); ossl_dump_ssl_error (); return est_err_x509_cn add challeng password attribut requir need remov add attribut part simpl enrol flow ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); req nid_pkcs9_challeng password mbstring_asc unsign char est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr set public key request x509_req_set_pubkey req pkey est_log_err unabl set public key ""); ossl_dump_ssl_error (); return est_err_x509_pubkey return est_err_non function generat pkcs10 request paramet common name put certif tls uniqu ssl session becom challeng password pkey privat key use sign request return valu est_err_non success static est_error est_generate_pkcs10 est_ctx ctx char char evp_pkey pkey x509_req pkcs10 x509_req req null est_error int ossl_rv req x509_req_new (); req null est_log_err unabl alloc x509_req ""); ossl_dump_ssl_error (); return est_err_malloc ctx req pkey est_err_non x509_req_fre req return sign request ossl_rv req pkey ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); x509_req_fre req ossl_dump_ssl_error (); return est_err_x509_sign pkcs10 req return est_err_non function callback use open ssl verify_cert function call end cert verif allow opportun gather inform regard fail cert verif possibl chang result verif callback similar ossl routin alter verif result static int int x509_store_ctx ctx int cert_error ctx x509 current_cert ctx est_log_info enter function cert_error cert_error current_cert stdout x509_get_subject_nam current_cert xn_flag_onelin printf (""\ ""); est_log_info (""% error depth lookup ctx crl path """", cert_error ctx cert_error )); return function remov crls receiv cacert respons buffer paramet ctx est context repres session cacert pointer buffer hold result cert cacerts_len length cacert buffer pointer pkcs7 buffer receiv return valu est_err_non success static est_error est_ctx ctx unsign char cacert int cacerts_len pkcs7 int nid int crls_found bio b64_enc null bio p7bio_out null int new_cacerts_len char new_cacerts_buf null int count nid obj_obj2nid type switch nid case nid_pkcs7_sign sign crl sk_x509_crl_pop_fre sign crl x509_crl_free sign crl null crls_found break case nid_pkcs7_sign envelop signed_and_envelop crl sk_x509_crl_pop_fre signed_and_envelop crl x509_crl_free sign crl null crls_found break default est_log_err invalid nid valu pkcs7 structur ""); return est_err_cacert_verif break crls remov origin pkcs7 buffer need updat alway base64 encod alloc bio write pkcs7 struct back pem format get pointer length new base64 pem encod buffer copi origin buffer pass sinc crls remov new buffer alway shorter fit origin buffer crls_found est_log_info crl attach certif remov crl )""); b64_enc bio_new bio_f_base64 ()); b64_enc null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_new bio_s_mem ()); p7bio_out null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); return est_err_malloc p7bio_out bio_push b64_enc p7bio_out memzero_ cacert cacerts_len count i2d_pkcs7_bio p7bio_out count est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif void bio_flush p7bio_out bio_get_mem_data return pointer length data contain mem bio noth alloc pass back new_cacerts_len int bio_get_mem_data p7bio_out char **)& new_cacerts_buf new_cacerts_len est_log_err fail copi pkcs7 data ""); ossl_dump_ssl_error (); bio_free_al p7bio_out return est_err_cacert_verif copi new buffer back old buffer memcpy_ cacert cacerts_len new_cacerts_buf new_cacerts_len cacerts_len new_cacerts_len bio_free_al p7bio_out return est_err_non function decod pass base64 encod buffer return decod cacert return est_err_non caller respons free cacerts_decod buffer static est_error b64_decode_cacert unsign char cacert int cacerts_len unsign char cacerts_decod int cacerts_decoded_len bio null bio b64 null unsign char decoded_buf int decoded_buf_len cacerts_decod null cacerts_decoded_len b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc decod alway take less origin buffer bio_new_mem_buf cacert cacerts_len null est_log_err unabl access cert buffer ""); ossl_dump_ssl_error (); bio_free_al b64 return est_err_malloc bio_push b64 decoded_buf malloc cacerts_len decoded_buf null est_log_err unabl alloc cert buffer decod ""); bio_free_al return est_err_malloc decoded_buf_len bio_read decoded_buf cacerts_len cacerts_decod decoded_buf cacerts_decoded_len decoded_buf_len bio_free_al return est_err_non return est_err_non caller respons free pkcs7 struct static est_error create_pkcs7 unsign char cacerts_decod int cacerts_decoded_len pkcs7 pkcs7out bio p7bio_in null pkcs7 pkcs7 null get pkcs7 format buffer certif read stack x509 cert p7bio_in bio_new_mem_buf cacerts_decod cacerts_decoded_len p7bio_in null est_log_err unabl access pkcs7 buffer ""); ossl_dump_ssl_error (); return est_err_malloc pkcs7 d2i_pkcs7_bio p7bio_in null pkcs7 null est_log_err unabl read pkcs7 base certif buffer ""); ossl_dump_ssl_error (); bio_free_al p7bio_in return est_err_load_cacert bio_free_al p7bio_in pkcs7out pkcs7 return est_err_non function invok cacert respons receiv cert chain built cert store certif verifi store essenti verifi cert chain ensur intermedi verifi back one includ root cert cacert respons crls attach remov new pkcs7 buffer creat paramet ctx est context repres session cacert pointer buffer hold receiv cert cacerts_len length cacert buffer return valu est_err_non success static est_error verify_cacert_resp est_ctx ctx unsign char cacert int cacerts_len int int fail est_error est_rc est_err_non x509_store trusted_cacerts_stor null stack_of x509 stack null x509 current_cert null int unsign char cacerts_decod null int cacerts_decoded_len x509_store_ctx store_ctx null pkcs7 pkcs7 null ctx null cacert null cacerts_len est_log_err invalid paramet ctx cacert cacerts_len ctx cacert cacerts_len return base64 decod incom cert buffer convert pkcs7 structur extract stack cert b64_decode_cacert cacert cacerts_len cacerts_decod cacerts_decoded_len est_err_non est_log_err base64 decod receiv cert fail ""); return create_pkcs7 cacerts_decod cacerts_decoded_len pkcs7 est_err_non est_log_err fail build pkcs7 structur receievd buffer ""); free cacerts_decod return pkcs7_to_stack pkcs7 stack est_err_non est_log_err could obtain stack cert pkcs7 structur ""); free cacerts_decod pkcs7_free pkcs7 return point stack x509 cert make cert respons sent est server build store trust cert use verifi walk cert verifi build store context store cert verifi call verifi function trusted_cacerts_stor x509_store_new (); trusted_cacerts_stor null est_log_err unabl alloc cert store ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 return est_err_malloc trusted_cacerts_stor sk_x509_num stack ++) current_cert sk_x509_valu stack self sign add trust store otherwis add untrust store x509_check_issu current_cert current_cert x509_v_ok est_log_info cert trust store )"", current_cert name x509_store_add_cert trusted_cacerts_stor current_cert set x509 store context store_ctx x509_store_ctx_new (); store_ctx null est_log_err unabl alloc new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor return est_err_malloc sk_x509_num stack ++) x509_store_ctx_init store_ctx trusted_cacerts_stor null stack est_log_err unabl initi new store context ""); ossl_dump_ssl_error (); free cacerts_decod pkcs7_free pkcs7 x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx return est_err_malloc current_cert sk_x509_valu stack est_log_info cert store )"", current_cert name store_ctx current_cert x509_verify_cert store_ctx cert fail verif log continu est_log_warn certif fail verif )"", current_cert name fail final remov crls might attach est_rc ctx cacert cacerts_len pkcs7 free cacerts_decod x509_store_fre trusted_cacerts_stor x509_store_ctx_fre store_ctx pkcs7_free pkcs7 fail return est_err_cacert_verif els return est_rc function regist ssl call verif certif server ident cert chain main purpos look case cert could verifi case est client app regist callback receiv untrust cert forward est client applic paramet status certif ssl verifi code x_ctx ptr x509 certif store structur return valu int potenti modifi status process certif cane modifi client applic provid callback allow process modifi callback static int cert_verify_cb int x509_store_ctx x_ctx ssl ssl est_ctx e_ctx int approv int cert_error x509 current_cert null approv x_ctx null est_log_err invalid x509 context pointer ""); return approv cert_error x_ctx current_cert x_ctx est_log_info enter cert pass open ssl error cert_error cert_error )); retriev pointer ssl structur connect applic specif data store ssl object est ctx est session est_log_err invalid ssl exdata index est context valu ""); return approv ssl x_ctx ()); ssl est_log_err null pointer retriev ssl session pointer x509 ctx ex_data ""); return approv e_ctx ssl_get_ex_data ssl e_ctx est_log_err null pointer retriev est context ssl ex_data ""); return approv switch cert_error case notifi client applic cert_untrust expect get case cannot verifi server cert current result server cannot verifi cert unable_to_get_crl pass make sure applic know although case case case applic provid callback ahead pass cert store log warn return ssl gave status e_ctx est_log_info est client applic server cert verifi function regist ""); approv e_ctx current_cert cert_error els est_log_info est client applic server cert verifi function regist ""); cert_error enabl crl check tls stack applic load crl verifi error occur peer cert valid confirm revok app provid way notifi option log warn proceed est_log_warn crl load tls peer allow .""); approv break remaind result state remain unchang est log warn messag log case case sinc check certif self sign still warn user case continu extens error case case case case case case case case default est_log_warn certif verifi fail reason )"", cert_error cert_error )); break return approv function use creat initi ssl_ctx use client proxi est oper ssl_ctx store est_ctx paramet ctx est context return valu est_error est_err_non success static est_error est_ctx ctx ssl_ctx s_ctx x509_verify_param vpm null est_error est_err_non est_log_vers (); ctx null est_log_err invalid context pointer ""); return est_err_no_ctx s_ctx ssl_ctx_new sslv23_client_method ())) null est_log_err fail obtain new ssl context ""); ossl_dump_ssl_error (); return est_err_ssl_ctx_new tls use est ssl_ctx_set_opt s_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 limit cipher suit offer s_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); ossl_dump_ssl_error (); return make sure verifi server ssl_ctx_set_verifi s_ctx ssl_verify_p cert_verify_cb leverag cert store alreadi creat trust chain provid applic either case ssl stack clean cert store ssl_ctx_free (), let remov refer tri clean later s_ctx ctx trusted_certs_stor ctx trusted_certs_stor null set x509 param assign ssl ctx enabl crl check max untrust cert exist chain ensur cert use intend contain x509 key usag extens vpm (); vpm null est_log_err unabl alloc verifi paramet structur ""); ossl_dump_ssl_error (); return est_err_malloc enabl crl check ctx enable_crl vpm vpm vpm est_tls_verify_depth vpm ssl_ctx_set1_param s_ctx vpm vpm save refer ssl session use later match est_ctx ssl context est_ssl_info_cb (). ctx ssl_ctx s_ctx ssl_get_ex_new_index est context null null null last config set ctx base instead global entir libcrypto librari need ensur csr string attribut ascii printabl format b_asn1_print return function calcul digest valu use http request server ask client use http digest authent use token pars http server respons earlier calcul digest static unsign char est_ctx ctx char uri char user char pwd evp_md_ctx mdctx const evp_md evp_md5 (); uint8_t ha1 evp_max_md_s unsign int ha1_len char ha1_str uint8_t ha2 evp_max_md_s unsign int ha2_len char ha2_str char nonce_cnt 00000001 unsign char digest evp_max_md_s unsign int d_len unsign char calcul ha1 use usernam realm password server nonc mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx user strnlen_ user max_uidpwd )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx realm strnlen_ ctx realm max_realm )); evp_digest updat mdctx "":"", evp_digest updat mdctx pwd strnlen_ pwd max_uidpwd )); evp_digest final mdctx ha1 ha1_len evp_md_ctx_destroy mdctx est_hex_to_str ha1_str ha1 ha1_len calcul ha2 use method uri mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx post evp_digest updat mdctx "":"", evp_digest updat mdctx uri strnlen_ uri max_realm )); evp_digest final mdctx ha2 ha2_len evp_md_ctx_destroy mdctx est_hex_to_str ha2_str ha2 ha2_len calcul auth digest use ha1 nonc nonc count client nonc qop ha2 mdctx evp_md_ctx_creat (); evp_digest init_ex mdctx null est_log_err unabl initi digest ""); return null evp_digest updat mdctx ha1_str ha1_len evp_digest updat mdctx "":"", evp_digest updat mdctx ctx s_nonc strnlen_ ctx s_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx nonce_cnt strnlen_ nonce_cnt max_nc )); evp_digest updat mdctx "":"", evp_digest updat mdctx ctx c_nonc strnlen_ ctx c_nonc max_nonc )); evp_digest updat mdctx "":"", evp_digest updat mdctx auth evp_digest updat mdctx "":"", evp_digest updat mdctx ha2_str ha2_len evp_digest final mdctx digest d_len evp_md_ctx_destroy mdctx malloc null est_log_err unabl alloc memori digest ""); return null est_hex_to_str char digest d_len return use retriev credenti server request either basic digest mode valu need applic layer either mode usernam password api indic mode callback case anyth chang static void est_ctx ctx est_http_auth_mod auth_mod char user char pwd est_http_auth_hdr auth_credenti see one part reset part ctx userid memzero_ ctx userid sizeof ctx userid )); ctx password memzero_ ctx password sizeof ctx password )); need ask applic layer credenti memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_mod ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti user null user els max_uidpwd strnlen_ auth_credenti user max_uidpwd est_log_err userid provid larger max max_uidpwd user els eok strncpy_ user max_uidpwd auth_credenti user max_uidpwd est_log_err invalid user provid ""); auth_credenti pwd null pwd els max_uidpwd strnlen_ auth_credenti pwd max_uidpwd est_log_err password provid larger max max_uidpwd pwd els eok strncpy_ pwd max_uidpwd auth_credenti pwd max_uidpwd est_log_err invalid user password provid ""); auth_credenti function add http authent header outgo http request allow server authent est client paramet ctx est context hdr pointer buffer hold header uri pointer buffer hold uri use header static void est_ctx ctx char hdr char uri int hdr_len unsign char digest unsign char client_random char max_uidpwd uid pwd "":"" char both_b64 max_uidpwd int both_len est_http_auth_hdr auth_credenti char token null char token_b64 max_auth_token_len char user max_uidpwd char pwd max_uidpwd int enc_len int token_len memzero_ max_uidpwd memzero_ both_b64 max_uidpwd hdr_len int strnlen_ hdr hdr_len est_log_warn authent header took maximum amount buffer )"", switch ctx auth_mod case auth_bas make sure part credenti send oper origin mode app layer provid front need ask app layer ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd regardless come back build string contain snprintf max_uidpwd user pwd els use given configur est_client_set_auth snprintf max_uidpwd ctx userid ctx password base64 encod combin string build http auth header both_len strnlen_ max_uidpwd enc_len est_base64_encod const char both_len both_b64 max_uidpwd )); enc_len est_log_err unabl encod basic auth valu ""); snprintf hdr hdr_len hdr_len author basic both_b64 break case auth_digest generat client nonc rand_byt client_random est_log_err rng failur generat nonc ""); forc hdr null string memzero_ hdr break est_hex_to_str ctx c_nonc client_random check see applic layer provid usernam password front configur retriev otherwis copi local buffer get readi ctx userid ctx password memzero_ user max_uidpwd memzero_ pwd max_uidpwd ctx ctx auth_mod user pwd els eok strncpy_ user max_uidpwd ctx userid max_uidpwd est_log_err invalid user provid ""); eok strncpy_ pwd max_uidpwd ctx password max_uidpwd est_log_err invalid user password provid ""); digest ctx uri user pwd digest null est_log_err error generat digest ""); forc hdr null string memzero_ hdr memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd break snprintf hdr hdr_len hdr_len author digest usernam =\""% \"", realm =\""% \"", nonc =\""% \"", uri =\""% \"", cnonc =\""% \"", 00000001 qop =\"" auth \"", respons =\""% \""\ user ctx realm ctx s_nonc uri ctx c_nonc digest memzero_ digest memzero_ ctx c_nonc max_nonc memzero_ user max_uidpwd memzero_ pwd max_uidpwd free digest break case auth_token est_log_info server request token base authent ""); memzero_ auth_credenti sizeof auth_credenti )); ctx auth_credentials_cb auth_credenti mode auth_token ctx auth_credentials_cb auth_credenti est_log_err attempt obtain token applic fail .""); get credenti expect point null string generat header auth_credenti auth_token null est_log_err request token credenti applic provid .""); token """"; els make sure token given long forc null caus auth failur server credenti provid max_auth_token_len strnlen_ auth_credenti auth_token max_auth_token_len est_log_err token provid larger max max_auth_token_len token """"; els token auth_credenti auth_token base64 encod combin string build http auth header memzero_ token_b64 max_auth_token_len token_len strnlen_ token max_auth_token_len enc_len est_base64_encod const char token token_len token_b64 max_auth_token_len enc_len est_log_err unabl encod bearer token auth valu ""); snprintf hdr hdr_len hdr_len author bearer token_b64 auth_credenti break default est_log_info http auth mode set send anonym request ""); break function use build http header cacert request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_cacert est_http_hdr_est_cli ctx est_serv ctx est_port_num hdr_len int strnlen_ hdr hdr_len est_log_warn cert header took maximum amount buffer )"", return hdr_len function use build http header csr attribut request flow paramet ctx est context hdr pointer buffer hold header static int est_ctx ctx char hdr int hdr_len snprintf hdr get http user agent connect close host accept */*\ est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_get_csrattr est_http_hdr_est_cli ctx est_serv ctx est_port_num ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn csr attribut request header took maximum amount buffer )"", return hdr_len function work csr attribut request flow paramet ctx est context ssl ssl context static int est_ctx ctx ssl ssl unsign char csrattr int csrattrs_len char http_data int hdr_len int read_siz write_s unsign char csr_attrs_buf null int assum defeat csrattr null csrattrs_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data hdr_len est_log_err csr attribut http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_csrattr csr_attrs_buf read_siz switch case est_err_non csr_attrs_buf null csrattr csr_attrs_buf csrattrs_len read_siz break case est_err_auth_fail default est_log_err est request fail )"", est_err_num_to_str )); csr_attrs_buf free csr_attrs_buf break free http_data return function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_enrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client enrol request header took maximum amount buffer )"", return hdr_len function use build http header simpl enrol flow paramet ctx est context hdr pointer buffer hold header pkcs10_len length buffer point hdr static int est_ctx ctx char hdr int pkcs10_len int hdr_len snprintf hdr post http user agent connect close host accept */*\ content type applic pkcs10 content length est_path_prefix ctx uri_path_seg ?""/"":""""), ctx uri_path_seg ctx uri_path_seg :""""), est_simple_reenrol est_http_hdr_est_cli ctx est_serv ctx est_port_num pkcs10_len ctx hdr hdr_len int strnlen_ hdr hdr_len est_log_warn client reenrol request header took maximum amount buffer )"", return hdr_len function send http request simpl enrol csr pkcs10 alreadi built point function simpli creat http header bodi put wire wait respons server copi respons buffer provid caller paramet ctx est context ssl ssl context bptr pointer contain pkcs10 csr pkcs7 pointer receiv pkcs7 respons pkcs7_len length pkcs7 respons reenrol set reenrol instead enrol int est_ctx ctx ssl ssl buf_mem bptr unsign char pkcs7 int pkcs7_len int reenrol char http_data int hdr_len int write_s unsign char enroll_buf null int enroll_buf_len int assum enrol fail set return length zero defens pkcs7_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc reenrol perform simpleenrol hdr_len ctx http_data int bptr length els perform simplereenrol hdr_len ctx http_data int bptr length hdr_len est_log_err enrol http header could built correct ""); free http_data return termin http header snprintf http_data hdr_len hdr_len ""); hdr_len build http bodi contain pkcs10 request memcpy_ http_data hdr_len bptr data rsize_t bptr length hdr_len bptr length termin http request snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_simple_enrol enroll_buf enroll_buf_len switch case est_err_non enroll_buf_len est_log_err enrol buf zero byte length ""); break memcpy_ pkcs7 enroll_buf enroll_buf_len pkcs7_len enroll_buf_len break case est_err_auth_fail est_log_warn http auth failur ""); break default est_log_err est request fail )"", est_err_num_to_str )); break free enroll_buf openssl_cleans http_data strnlen_ http_data )); free http_data http_data null return function saniti check x509 prior attempt convert x509 csr reenrol oper return est_error code static est_error x509 cert make sure cert sign cert signatur est_log_err certif provid contain signatur .""); return est_err_bad_x509 make sure signatur length invalid cert signatur length est_log_err certif provid contain invalid signatur length .""); return est_err_bad_x509 return est_err_non function use clear challeng password attribut x509 csr use http authent use enrol process valu chang client send second http request contain http author valu sinc csr reus initi secondari request need clear valu csr submit secondari request static void x509_req csr int pos x509_attribut attr challeng password may csr never happen defens pos look valu csr pos csr nid_pkcs9_challeng password pos found delet attr x509_req_delete_attr csr pos attr doc open ssl show use x509_req_delete_attr assum need free attribut appear good exampl use api x509_attribute_fre attr function work convert x509_req base64 encod der format specifi est rfc convert proper format routin forward request server check respons save cert local context retriev later applic layer static est_error est_ctx ctx ssl ssl x509_req req int pkcs7_len int reenrol est_error est_err_non bio p10out null b64 buf_mem bptr null unsign char recv_buf unsign char new_cert_buf int new_cert_buf_len grab pkcs10 pem encod data b64 bio_new bio_f_base64 ()); b64 est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_new bio_s_mem ()); p10out est_log_err bio_new fail ""); ossl_dump_ssl_error (); return est_err_malloc p10out bio_push b64 p10out encod use der asn set modifi flag x509_req open ssl keep cach copi der encod data case set flag tell open ssl run asn encod rather use cach copi req req_info enc modifi i2d_x509_req_bio p10out req void bio_flush p10out bio_get_mem_ptr p10out bptr get buffer place entir respons server recv_buf malloc est_ca_max recv_buf null est_log_err fail alloc buffer server respons ""); return est_err_malloc new_cert_buf recv_buf new_cert_buf_len send pkcs10 http request est server ctx ssl bptr new_cert_buf new_cert_buf_len reenrol switch case est_err_non make sure even though got success return code actual receiv someth new_cert_buf_len est_log_err buffer contain newli enrol client certif zero byte length ""); break resiz buffer hold retriev client certif link ctx get rid http hdr extra space back ctx enrolled_client_cert null free ctx enrolled_client_cert ctx enrolled_client_cert malloc new_cert_buf_len ctx enrolled_client_cert null est_log_err unabl alloc newli enrol client certif buffer ""); est_err_malloc break ctx enrolled_client_cert new_cert_buf_len memcpy_ ctx enrolled_client_cert new_cert_buf_len new_cert_buf new_cert_buf_len ctx new_cert_buf_len pass back length newli enrol cert pkcs7_len ctx est_log_info newli enrol client certif ctx enrolled_client_cert est_log_info length ctx break case est_err_auth_fail est_log_info http author fail request auth mode ctx auth_mod break default est_log_err est enrol fail error code )"", est_err_num_to_str )); break recv_buf free recv_buf bio_free_al p10out return function implement simpl enrol flow sign csr provid send csr est server retriev pkcs7 respons paramet ctx est context ssl ssl context use est session csr pointer x509_req object contain pkcs10 csr pkcs7_len pointer integ length reciev pkcs7 respons place priv_key pointer privat key use sign csr reenrol set reenrol instead enrol return est_error static est_error est_ctx ctx ssl ssl x509_req csr int pkcs7_len evp_pkey priv_key int reenrol est_error est_err_non char tls_uid int ossl_rv make sure remov csr proceed csr get valu tls session emb csr requir ctx csr_pop_requir ctx client_force_pop est_log_info client includ challeng password csr ""); tls_uid est_get_tls_uid ssl tls_uid ossl_rv csr nid_pkcs9_challeng password mbstring_asc unsign char tls_uid free tls_uid ossl_rv est_log_err unabl set x509 challeng password attribut ""); ossl_dump_ssl_error (); return est_err_x509_attr els est_log_err unabl obtain tls uid ""); return sign csr ossl_rv csr priv_key ctx signing_digest ossl_rv est_log_err unabl sign x509 cert request ""); ossl_dump_ssl_error (); return est_err_x509_sign ctx ssl csr pkcs7_len reenrol return est_client_enroll_cn function implement simpl enrol flow use privat key generat csr pkcs10 request send request est server retriev pkcs7 respons user function simpli provid common name valu place pkcs10 csr simplifi interfac none csr attribut specifi param ctx est context param ssl ssl context use est session param pointer common name place x509 request param pkcs7_len pointer integ length reciev pkcs7 respons place param pkey new client public key enrol return est_error static est_error est_client_enroll_cn est_ctx ctx ssl ssl char int pkcs7_len evp_pkey pkey x509_req pkcs10 null est_error est_err_non char tls_uid ctx return est_err_no_ctx attempt creat pkcs10 certif request get tls uid case need popul tls_uid est_get_tls_uid ssl tls_uid est_generate_pkcs10 ctx tls_uid pkey pkcs10 free tls_uid els est_log_err unabl obtain tls uid ""); est_err_non ctx ssl pkcs10 pkcs7_len pkcs10 x509_req_fre pkcs10 return follow function taken url content incorpor portion lib hostcheck lib rawstr portabl consist toupper rememb ebcdic use toupper behavior alter current local static char char switch case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return case return return follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second first second first second get loop soon match break first ++; second ++; comparison possibl make sure loop skip one string reach zero must return success match return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int const char first const char second size_t max first second max first second break max --; first ++; second ++; max return equal far return first second )); follow function taken url curl_raw_equ raw case insensit string meant local independ compar string know safe see http :// daniel haxx blog 2008 strcasecmp turkish explan function necessari function capabl compar case insensit even non ascii static int est_client_hostmatch const char hostnam const char pattern const char pattern_label_end pattern_wildcard hostname_label_end int wildcard_en size_t prefixlen suffixlen struct in_addr ignor struct sockaddr_in6 si6 pattern_wildcard strchr pattern *'); pattern_wildcard null return pattern hostnam host_match host_nomatch detect address hostnam fail match inet_pton af_inet hostnam ignor return host_nomatch els inet_pton af_inet6 hostnam si6 sin6_addr return host_nomatch requir least dot pattern avoid wide wildcard match wildcard_en pattern_label_end strchr pattern .'); pattern_label_end null strchr pattern_label_end .') null pattern_wildcard pattern_label_end pattern --"", wildcard_en wildcard_en return pattern hostnam host_match host_nomatch hostname_label_end strchr hostnam .'); hostname_label_end null pattern_label_end hostname_label_end return host_nomatch wildcard must match least one charact left label hostnam least larg left label pattern hostname_label_end hostnam pattern_label_end pattern return host_nomatch prefixlen pattern_wildcard pattern suffixlen pattern_label_end pattern_wildcard return pattern hostnam prefixlen pattern_wildcard hostname_label_end suffixlen suffixlen host_match host_nomatch follow function taken url fqdn check server cert static int const char match_pattern const char hostnam saniti check input match_pattern match_pattern hostnam hostnam return trival case hostnam match_pattern return est_client_hostmatch hostnam match_pattern host_match return return function taken url adapt est url file name lib ssluse function verifyhost quot rfc2818 section server ident subject alt name extens type nsname present must use ident otherwis specif common name field subject field certif must use although use common name exist practic deprec certif author encourag use nsname instead match perform use match rule specifi rfc2459 one ident given type present certif one nsname name match one set consid accept name may contain wildcard charact consid match singl domain name compon compon fragment com match foo com bar foo com com match foo com bar com case uri specifi address rather hostnam case paddress subject alt name must present certif must exact match uri static est_error char hostnam x509 server_cert int match altern match yet mean match mean mismatch size_t addrlen stack_of general_nam altnam struct in6_addr addr_v6 struct in_addr addr_v4 int addr_is_v4 int addr_is_v6 est_error res est_err_non int errno_t safec_rc int numalt int int diff const general_nam check const char altptr size_t altlen unsign char nulstr unsign char peer_cn x509_name name asn1_str tmp attempt resolv host name address inet_pton af_inet hostnam addr_v4 addr_is_v4 addrlen sizeof struct in_addr els tri see hostnam resolv address inet_pton af_inet6 hostnam addr_v6 addr_is_v6 addrlen sizeof struct in6_addr get list altern name altnam x509_get_ext_d2i server_cert nid_subject_alt_nam null null altnam get amount altern rfc2459 claim must least one depend ... numalt sk_general_name_num altnam est_log_info found subject altern name numalt loop altern none match numalt match ++) get handl altern name number check sk_general_name_valu altnam get data length altptr char asn1_string_data check ia5 altlen size_t asn1_string_length check ia5 switch check type case gen_dn name pattern comparison est_log_info check fqdn san altptr open ssl man page explicit say general cannot assum data return asn1_string_data null termin contain embed null also actual format data depend actual string type exampl ia5str data ascii gisl research open ssl sourc check sourc patch alway termin ia5str altlen strnlen_ altptr true embed zero name string cannot match altptr hostnam match els match break case gen_ipadd address comparison compar altern address data chunk size server address psb complianc use safe librari memcmp_ addr_is_v4 safec_rc memcmp_ altptr altlen addr_v4 altlen diff safec_rc eok est_log_info memcmp_ error ipv4 address safec_rc els addr_is_v6 safec_rc memcmp_ altptr altlen addr_v6 altlen diff safec_rc eok est_log_info memcmp_ error ipv6 address safec_rc els never get ... forc match diff addr_is_v4 altlen addrlen diff match els addr_is_v6 altlen addrlen diff match els match break general_names_fre altnam match altern name match server hostnam est_log_info subject alt name match hostnam els match altern name field exist match must fail est_log_info subject alt name match hostnam res els look last occurr common name distinguish one get signific one follow done bug nulstr unsign char *)""""; peer_cn nulstr name x509_get_subject_nam server_cert name name nid_common name name entri convert string use comparison support bmpstring utf8 etc tmp x509_name_get_entri name )); open ssl earlier asn1_string_to_utf8 fail input alreadi utf encod check case copi raw string manual avoid problem code made condit futur open ssl fix work around brought alexi carvalho tmp asn1_string_typ tmp v_asn1_utf8str asn1_string_length tmp peer_cn malloc peer_cn safec_rc memcpy_ peer_cn asn1_string_data tmp safec_rc eok est_log_info memcpy_ error asn1 string safec_rc peer_cn els utf8 name asn1_string_to_utf8 peer_cn tmp peer_cn strnlen_ char peer_cn termin zero end string cannot match return failur est_log_warn ssl illeg cert name field ""); res peer_cn nulstr peer_cn null els convert peer_cn utf8 utf8 current support first releas libest curlcod data peer_cn strlen peer_cn )); call failf unsuccess free peer_cn return endif res est_err_non error alreadi detect pass els peer_cn est_log_warn ssl unabl obtain common name peer certif ""); res els const char peer_cn hostnam est_log_warn ssl fqdn hostnam mismatch server certif match target host name peer_cn hostnam res els est_log_info common name match )"", peer_cn peer_cn free peer_cn return res routin check fqdn server certif configur server name use establish tcp connect est server requir per section est spec note fqdn check defin rfc 6125 look cmc extend key usag extens server cert restrict allow fqdn mismatch cmc present current way determin use explicit trust anchor allow addit flexibl static est_error est_ctx ctx ssl ssl x509 cert est_error cert ssl_get_peer_certif ssl cert ctx est_serv cert x509_free cert return els cert ctx enable_srp est_log_info peer certif skip fqdn check sinc srp enabl .""); return est_err_non els est_log_warn unabl perform fqdn check peer certif .""); return function open tcp socket establish tls session est server call est_client_init (). paramet ctx pointer est context client session ssl pointer ssl context structur return ssl context creat reurn est_err_non success est_error est_client_connect est_ctx ctx ssl ssl bio tcp ssl_ctx s_ctx est_error est_err_non ifndef win32 int sock els socket sock invalid_socket endif int int oval int ssl_connect_ret tcw_err_t tcw_err tcw_opts_t tcw_opt ctx return est_err_no_ctx s_ctx ctx ssl_ctx establish connect proxi applic ctx use_proxi tcw_opt proxy_proto ctx proxy_proto tcw_opt proxy_host ctx proxy_serv tcw_opt proxy_port ctx proxy_port ctx proxy_usernam ctx proxy_password ctx proxy_auth tcw_opt proxy_usernam ctx proxy_usernam tcw_opt proxy_password ctx proxy_password tcw_opt proxy_auth initi ctx proxy_auth tcw_opt proxy_auth ctx proxy_auth tcw_opt proxy_auth els tcw_opt proxy_proto est_client_proxy_non tcw_err tcw_connect ctx tcw_sock tcw_opt ctx est_serv ctx est_port_num sock tcw_err tcw_err_resolv est_log_err unabl lookup hostnam ."", ctx est_serv return est_err_ip_getaddr tcw_err tcw_ok est_log_err unabl connect est server ctx est_serv return est_err_ip_connect enabl tcp keep aliv setsockopt sock sol_socket so_keepal char *)& oval sizeof oval )); tcw_close ctx tcw_sock sock sock_invalid est_log_err unabl connect est server address ctx est_serv return est_err_ip_connect pass socket bio interfac open ssl use creat tls session tcp bio_new_socket sock bio_noclos tcp null est_log_err error creat socket ""); tcw_close ctx tcw_sock sock sock_invalid ossl_dump_ssl_error (); return est_err_ip_connect (!(* ssl ssl_new s_ctx ))) est_log_err error creat tls context ""); ossl_dump_ssl_error (); bio_free_al tcp tcw_close ctx tcw_sock sock sock_invalid return est_err_ssl_new need set est ctx exdata ssl session context retriev per session basi ssl_set_ex_data ssl ctx set est server name ssl context sent server name extens client hello ssl ctx est_serv ssl_set_bio ssl tcp tcp ctx sess ssl_set_sess ssl ctx sess ssl_connect_ret ssl_connect ssl est_log_err error connect tls context ssl_get_error ssl ssl_connect_ret )); ossl_dump_ssl_error (); tcw_close ctx tcw_sock sock sock_invalid est_err_ssl_connect els ctx tcw_sock_connect establish tls session est server need verifi fqdn server cert match server name use establish connect section est spec est_err_non ctx ssl host name match shut tunnel bail ctx ssl est_log_warn est server name match fqdn server certif .""); return function close tls session under socket paramet ssl pointer ssl context set connect est server void est_ctx ctx ssl ssl ssl_session new_sess (!* ssl return first disconnect get session cach away use session resumpt ctx sess ctx sess ssl_get1_sess ssl els first time disconnect see session chang offici obtain get1 call cach away new_sess ssl_get0_sess ssl new_sess ctx sess ctx sess ssl_get1_sess ssl ssl_shutdown ssl ssl_free ssl ssl null ctx tcw_sock_connect tcw_close ctx tcw_sock ctx tcw_sock_connect function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert static int est_ctx ctx ssl ssl int ca_certs_len char http_data int hdr_len int write_s int unsign char ca_certs_buf null int ca_certs_buf_len build http request alloc buffer header data termin charact build header data termin http_data malloc http_data null est_log_err unabl alloc memori http_data ""); return est_err_malloc hdr_len ctx http_data termin http header snprintf http_data hdr_len hdr_len ,""\ ""); hdr_len data sent ahead termin http request snprintf http_data hdr_len hdr_len ""); hdr_len send request server wait respons ctx last_http_status write_s ssl_write ssl http_data hdr_len write_s est_log_err tls write error ""); ossl_dump_ssl_error (); est_err_ssl_writ els est_log_info tls wrote byte attempt byte write_s hdr_len tri get respons server est_io_get_respons ctx ssl est_op_cacert ca_certs_buf ca_certs_buf_len switch case est_err_non make sure even though got success return code actual receiv someth ca_certs_buf_len est_log_err retriev cert buf zero byte length ""); break ca_certs_buf_len est_ca_max est_log_err retriev cert buf larger maximum allow ""); break resiz buffer hold retriev cert link ctx get rid http hdr extra space back ctx retrieved_ca_cert null free ctx retrieved_ca_cert ctx retrieved_ca_cert malloc ca_certs_buf_len ctx retrieved_ca_cert null est_log_err unabl alloc cert buffer ""); est_err_malloc break ctx retrieved_ca_cert ca_certs_buf_len memcpy_ ctx retrieved_ca_cert ca_certs_buf_len ca_certs_buf ca_certs_buf_len ctx ca_certs_buf_len verifi return cert chain verify_cacert_resp ctx ctx retrieved_ca_cert ctx est_err_non est_log_err return cacert chain invalid ""); free ctx retrieved_ca_cert ctx retrieved_ca_cert null ctx ca_certs_len ctx break pass back length retriev cert buffer ca_certs_len ctx est_log_info cacert buf ctx retrieved_ca_cert est_log_info cacert length ctx break case est_err_auth_fail est_log_err http auth failur ""); break case est_log_info http request fail retri resp ""); break default est_log_err est request fail )"", est_err_num_to_str )); break http_data free http_data ca_certs_buf free ca_certs_buf return function work cacert request flow paramet ctx est context ssl ssl context ca_certs_len pointer unsign int hold length return cert est_error est_ctx ctx const char uid const char pwd userid must password vice versa userid still empti string cannot null password uid null pwd null est_log_err user provid password ""); return uid null pwd null est_log_err password provid user ""); return uid pwd set basic digest authent uid null eok strncpy_ ctx userid max_uidpwd uid max_uidpwd est_log_err invalid user provid ""); return eok strncpy_ ctx password max_uidpwd pwd max_uidpwd est_log_err invalid password provid ""); return return est_err_non /*! brief perform simpl enrol request est server use pkcs10 csr provid applic layer param ctx pointer est context param csr pointer pkcs10 csr data defin open ssl x509_req param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr null return est_error connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request applic layer must provid pkcs10 csr enrol priv_key argument given null csr need sign privat key howev csr must contain everyth els requir includ public key privat key provid alreadi sign csr est librari sign csr enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context unless csr alreadi sign indic null priv_key applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar x509_req data pass function must valid pass corrupt csr data may result system crash lib est util open ssl asn decod logic read x509_req data open ssl perform safeti check x509_req data pars applic read extern generat pem der encod csr data pleas use helper function convert pem der csr valid x509_req pointer est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key est_error ssl ssl null ctx return est_err_no_ctx csr return est_err_no_csr ctx est_client_initi return establish tls session est server est_client_connect ctx ssl est_err_non goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err priv_key ctx ssl csr pkcs7_len priv_key els ctx ssl csr pkcs7_len est_err_non est_log_err enrol fail second attempt basic digest authent ""); ctx ssl err ssl ssl_shutdown ssl ssl_free ssl return /*! brief est_client_enrol perform simpl enrol request est server param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 buffer param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error est_client_enrol connect est server build simpl enrol request use common name pass establish ssl tls connect est server configur previous call est_client_set_serv (), send simpl enrol request respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key est_error ssl ssl null ctx return est_err_no_ctx new_public_key return est_err_no_key ctx est_client_initi return est_client_connect ctx ssl est_err_non goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri basic digest token paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest token paramet ""); goto err est_client_enroll_cn ctx ssl pkcs7_len new_public_key est_err_non est_log_err enrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl ctx auth_mod auth_non err ssl ssl_shutdown ssl ssl_free ssl return /*! brief perform full sequenc est oper enrol new certif use trust messag flow param ctx pointer est context param pointer common name valu use enrol request param pkcs7_len pointer integ hold length pkcs7 certif return param ca_cert_len pointer integ hold length buffer hold new trust certif param new_public_key pointer evp_pkey structur hold client key pair use simpl enrol request public key includ certif sign request csr sent server privat key use sign request return est_error connect est server retriev latest trust certifict server retriev csr attribut server send simpl enrol request server provis new certif conveni function equival invok follow three function order est_client_enrol function take common name entiti identifi use csr addit x509 attribut extens requir est server enforc presenc csr attribut function use provis certif function use addit x509 attribut includ enrol request provis respons store est context length pass back applic pkcs7_len paramet function applic alloc correct size buffer call retriev new client certif context provis respons also includ latest copi trust certif est server persist local applic futur use ca_cert_len argument contain length certic retriev invok (). est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key est_error unsign char new_ta_p7 unsign char new_ta_pem unsign char attr_data null int attr_len int new_ta_len ctx return est_err_no_ctx make sure non null pointer length pkcs7_len ca_cert_len return ctx est_client_initi return new_public_key return est_err_no_key first get latest trust anchor cert server ctx ca_cert_len est_err_non return new_ta_p7 malloc ca_cert_len new_ta_p7 null est_log_err unabl alloc cert buffer ""); est_err_malloc return ctx new_ta_p7 est_err_non free new_ta_p7 return cert base64 der encod need convert pem new_ta_len new_ta_p7 ca_cert_len new_ta_pem free new_ta_p7 new_ta_len return est_err_pem_read new trust anchor pem encod let load current est context futur est oper use new trust anchor ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx new_ta_pem new_ta_len free new_ta_pem est_err_non return sinc reset trust store mark client context initi ctx est_client_initi next need get csr attribut allow lib est know challeng password need includ csr ctx attr_data attr_len est_err_non est_log_err unabl get csr attribut provis new certif ""); return final attempt enrol new certif use common name provid applic est_client_enrol ctx pkcs7_len new_public_key return /*! brief est_client_reenrol perform enrol request est server use exist x509 certif param ctx pointer est context param cert pointer x509 certif defin open ssl x509 param pkcs7_len pointer integ hold length pkcs7 buffer param priv_key pointer privat key use sign csr return est_error est_client_reenrol connect est server establish ssl tls connect est server configur previous call est_client_set_serv (), send enrol request applic layer must provid x509 certif enrol certif previous enrol applic also need provid privat key associ public key x509 certif privat key requir sign csr generat x509 certif enrol respons store est context length pass back applic pkcs7_len paramt function applic alloc correct size buffer call retriev new client certif context applic must provid pointer privat key use sign csr requir est librari event est server request proof possess valu includ csr est librari automat includ proof posess valu sign csr awar public key subject name x509 certif includ enrol request sent est server respons appli x509 extens issu renew certif est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key x509_req req est_error ssl ssl null int ossl_rv ctx return est_err_no_ctx cert return est_err_no_cert priv_key return est_err_no_key ctx est_client_initi return check x509 given cert est_err_non return check privat key match public key cert cert priv_key return convert exist certif csr copi subject name cert new csr pass null privat key paramet sign csr later req x509_to_x509_req cert null ctx signing_digest req est_log_err x509 csr convers fail .""); ossl_dump_ssl_error (); return est_err_no_csr copi x509 extens old certif csr may may retain behavior depend polici use open ssl test set copy_extens set config file copyal retain extens csr issu new cert cert cert_info cert cert_info extens ossl_rv x509_req_add_extens req cert cert_info extens ossl_rv est_log_warn fail copi x509 extens csr new certif may contain extens present old certif .""); establish tls session est server est_client_connect ctx ssl est_err_non goto err send enrol request ctx ssl req pkcs7_len priv_key ctx ssl est_err_auth_fail ctx auth_mod auth_digest ctx auth_mod auth_bas ctx auth_mod auth_token https digest mode requir use md5 make sure fip mode use md5 ctx auth_mod auth_digest fips_mod ())){ est_log_err http digest auth allow fip mode ""); est_err_bad_mod goto err tri one time digest auth est_log_info http auth fail tri digest basic paramet ""); est_client_connect ctx ssl est_err_non est_log_err connect fail second attempt basic digest paramet ""); goto err ctx ssl req pkcs7_len priv_key est_err_non est_log_err reenrol fail second attempt basic digest authent ""); attempt token mode second time server respond error attribut log ctx token_error ctx token_error_desc est_log_err token auth mode fail server provid error inform error error descript ctx token_error ctx token_error_desc ctx token_error ctx token_error_desc ctx ssl err ssl ssl_shutdown ssl ssl_free ssl x509_req_fre req return /*! brief pass back client certif previous obtain est server call est_client_enrol (). param ctx pointer est context param pointer common name valu use enrol request param pkcs7 pointer pointer point buffer contain newli enrol client certif return est_error copi previous obtain client certif est context applic buffer client certif copi context remov context est_error est_ctx ctx unsign char pkcs7 ctx return est_err_no_ctx ctx est_client_initi return pkcs7 null est_log_err est client simpl enrol invalid paramet ""); return ctx enrolled_client_cert null est_log_err client certif copi ""); return est_err_no_certif memzero_ pkcs7 ctx memcpy_ pkcs7 ctx ctx enrolled_client_cert ctx copi context hand free free ctx enrolled_client_cert ctx enrolled_client_cert null ctx return est_err_non /*! brief perform cacert get request est server param ctx pointer est context param ca_certs_len pointer integ hold length cert buffer return est_error connect est server build cert request send get cert request respons place buffer alloc maintain est client librari pointer buffer return call applic return cert base64 encod der format store null termin string buffer certif retriev est server client librari must reset retriev certif pass est client initi function explicit databas est_error est_ctx ctx int ca_certs_len est_error est_err_non ssl ssl null ctx return est_err_no_ctx ctx est_client_initi return ca_certs_len null est_log_err est client get cacert invalid paramet ""); return est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return ctx ssl ca_certs_len ctx ssl ssl ssl_shutdown ssl ssl_free ssl return /*! brief copi previous retriev certif applic buffer param ctx pointer current est context param ca_cert pointer buffer retriev certif copi return est_error copi recent retriev certif est server certif copi applic buffer point ca_cert remov est clietn context certif retriev applic est client librari must reset reset perform certif retriev call pass est client initi function explicit databas est_error est_ctx ctx unsign char ca_cert ctx return est_err_no_ctx ctx est_client_initi return ca_cert null est_log_err est client get cacert invalid paramet ""); return ctx retrieved_ca_cert null est_log_err certif copi ""); return est_err_no_certif memzero_ ca_cert ctx memcpy_ ca_cert ctx ctx retrieved_ca_cert ctx cert obtain client lib need reset ctx est_client_initi return est_err_non /*! brief perform csr attribut request est server param ctx pointer est context client session param csr_data pointer buffer hold return csr attribut param csr_len pointer integ hold length csr attribut buffer return est_error connect est server send csr attribut request server save away return csr attribut data disconnect est server est_error est_ctx ctx unsign char csr_data int csr_len int new_csr_len pop_requir ssl ssl null unsign char new_csr_data ctx return est_err_no_ctx csr_data return csr_len return assum defeat csr_data null csr_len connect est server est_client_connect ctx ssl est_err_non ssl ssl_shutdown ssl ssl_free ssl return free current attribut cach ctx retrieved_csrattr free ctx retrieved_csrattr ctx retrieved_csrattr null ctx ctx ctx retrieved_csrattr null send http request est server ctx ssl new_csr_data new_csr_len ctx ssl est_err_non est_log_err csr request fail error code )"", est_err_num_to_str )); new_csr_data free new_csr_data ssl ssl_shutdown ssl ssl_free ssl return ssl ssl_shutdown ssl ssl_free ssl new_csr_data null est_log_info csr attribut null ""); return est_err_non alloc new memori prior pars sure null termin ctx retrieved_csrattr malloc new_csr_len ctx retrieved_csrattr free new_csr_data return est_err_malloc ctx new_csr_len memcpy_ ctx retrieved_csrattr new_csr_len new_csr_data new_csr_len ctx retrieved_csrattr new_csr_len est_log_info csr attribut ctx ctx retrieved_csrattr free new_csr_data make sure data valid char ctx retrieved_csrattr ctx pop_requir est_err_non free ctx retrieved_csrattr ctx retrieved_csrattr null ctx els csr_data ctx retrieved_csrattr csr_len ctx ctx csr_pop_requir pop_requir return /*! brief use applic enabl tls srp transport use place tradit tls tls srp allow secur transport 509 certif avail trust anchor avail param ctx est context obtain est_client_init call param strength specifi srp strength use param uid char buffer contain user use srp user name param pwd char buffer contain passowrd use srp password function allow applic enabl tls srp cipher suit anoth form tls could use est client 509 certif identifi est server also use est client trust anchor avail authent est server ident est server must support tls srp use api function must invok est_client_init prior issu est command string paramet null termin string return est_error est_error est_ctx ctx int strength char uid char pwd x509_store store int ctx null est_log_err null context pass ""); return est_err_no_ctx ctx ssl_ctx null est_log_err ssl context initi ""); return est_err_no_ssl_ctx strength est_srp_strength_min est_log_err srp strength must greater est_srp_strength_min return uid null est_log_err srp user must provid ""); return pwd null est_log_err srp password must provid ""); return ctx enable_srp enabl srp cipher suit srp enabl use exclus check trust anchor configur enabl dss rsa auth cipher suit store ctx ssl_ctx store store obj sk_x509_object_num store obj est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx els est_log_info enabl ssl srp cipher suit rsa dss ""); ctx ssl_ctx est_log_err fail set ssl srp cipher suit ""); ossl_dump_ssl_error (); return set srp user name password ctx ssl_ctx uid est_log_err unabl set srp usernam ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx pwd est_log_err unabl set srp password ""); ossl_dump_ssl_error (); return est_err_unknown ctx ssl_ctx strength est_log_info tls srp enabl ""); return est_err_non /*! brief est_client_set_auth use applic set authent paramet use param ctx est context obtain est_client_init call param uid char buffer contain user use basic digest base authent param pwd char buffer contain passowrd use basic digest base authent param client_cert_raw char buffer contain client applic certif param pkey_raw privat key use client cert param pkey_len length buffer hold privat key function allow applic provid inform requir authent est client est server call made accept request get cert user provid password must also provid applic may pass privat key pkey_raw pkey_len use sign request server otherwis basic digest base authent perform tls session request privat key pass must contain privat key match public key contain client_cert paramet string paramet null termin string return est_error error null est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key est_error est_err_non ctx null est_log_err null context pass ""); return est_err_no_ctx ctx uid pwd est_err_non return ctx auth_mod auth_non cach away client cert associ privat key get load ssl context use ctx client_key private_key ctx client_cert client_cert load client cert avail ctx client_cert ctx client_key ctx ssl_ctx ctx client_cert ctx client_key est_log_err unabl load local certif privat key ""); return els est_log_warn use client certif tls session http basic digest auth use .""); return est_err_non /*! brief use applic regist callback function param ctx est context obtain est_client_init call param auth_credentials_cb function pointer applic layer callback regist callback function use est client librari obtain authent credenti applic provid authent credenti initi avail userid password use http basic authent process request est client librari call applic callback event authent credenti request est server callback function definit must match follow function prototyp int auth_credentials_cb est_http_auth_hdr auth_credenti auth_credenti pointer est_http_auth_hdr structur structur provid est librari callback function fill specif credenti request credenti valu must pass format sent server est client librari perform reformat credenti ownership memori hold credenti valu transfer applic layer est librari applic layer return valu est librari allow est librari free memori soon done use valu return valu callback must one follow valu callback abl provid request credenti callback could provid request credenti auth_credentials_cb paramet set null reset callback function string paramet null termin string return est_error est_err_non success est_err_no_ctx est_error est_ctx ctx auth_credentials_cb callback ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_credentials_cb callback return est_err_non /*! brief use applic reduc overhead tcp tls layer client know est server use http basic authent param ctx pointer est context client session normal lib est send anonym http request initi request est server function allow applic improv perform send http basic auth header initi request sent est server elimin need server send http authent challen respons elimin round trip est client server function call immedi invok est_client_set_auth (). precaut taken applic ensur hint enabl known est server configur http basic authent est server configur http digest authent enabl hint caus est transact fail return est_error est_err_non success est_error est_ctx ctx ctx null est_log_err null context pass ""); return est_err_no_ctx ctx auth_mod auth_bas return est_err_non /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int est_ctx ctx volatil int len int ifdef win32 int result initi winsock result wsastartup makeword wsa data result est_log_err wsastartup fail result return endif cert_format est_cert_format_pem est_log_err pem encod certif support .""); return null chain pass check length valu pass match calcul length buffer verifi length valu correct buffer proper null termin ca_chain len int strnlen_ char ca_chain est_ca_max len ca_chain_len est_log_err length ca_chain match pass ca_chain_len ""); return null ctx malloc sizeof est_ctx )); ctx est_log_err unabl alloc memori est context ""); return null memzero_ ctx sizeof est_ctx )); ctx est_mod est_client load local certif memori retain futur use use cacert request ctx ca_chain ca_chain_len est_log_err fail load trust certif store ""); est_destroy ctx return null ctx est_err_non est_log_err fail initi ssl context certifici privat key pass ""); est_destroy ctx return null save away client callback function allow manual verif server ident certif ctx cert_verify_cb set default valu socket read timeout ctx read_timeout use sha 256 default hash algorithm sign csr chang applic use function ctx signing_digest evp_sha256 (); ctx retry_after_delay ctx retry_after_d ctx est_client_initi return ctx /*! brief est_client_init use applic creat context est librari context use invok function client api param ca_chain requir char buffer contain certif raw byte data use authent est server param ca_chain_len length ca_chain char buffer param cert_format defin format certif pass instanti est client librari current valu accept est_cert_format_pem param cert_verify_cb pointer function est client applic call receiv server ident certif fail verif ssl code function take input two paramet pointer x509 structur contain server certif integ valu set open ssl defin error certif callback function return server ident certif reject valu approv function allow applic initi est client context applic must provid local certif ca_chain ca_chain_len use client oper certif provid must format specifi cert_format paramet current pem encod certif support length paramet certif ca_chain_len use der format certif pass certif may contain crl entri use authent certif receiv server return est_ctx error null static est_error char path_seg uri parser state state uri uri parsed_uri int uriparse_rc uri path segment cur_seg null char cur_seg_str null est_oper oper char canned_uri est_uri_max_len build can uri pass uripars librari caus incom path segment correct spot within uri get valid main issu possibl use path segment becom theme delimit memzero_ canned_uri est_uri_max_len strcpy_ canned_uri est_uri_max_len ""/. well known est /""); strcat_ canned_uri est_uri_max_len path_seg state uri parsed_uri uriparse_rc uri pars uri state canned_uri uriparse_rc uri_success uri free uri member state uri return cur_seg parsed_uri path head cur_seg null est_log_err valid path segment suppli string ""); uri free uri member state uri return cur_seg cur_seg next next cur_seg_str char cur_seg text first oper est_parse_oper cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper occur path segment string problem oper est_op_max est_log_err path segment string contain oper valu path segment pass cur_seg_str uri free uri member state uri return look see multipl segment char cur_seg next null cur_seg text last est_log_err path segment string contain multipl path segment path segment ""); uri free uri member state uri return uri free uri member state uri return est_err_non /*! brief est_client_set_serv call applic layer specifi address port est server must call est_client_init prior issu est command param ctx pointer est context client session param server name est server connect ascii string repres name server limit 254 charact param port tcp port est server connect param path_seg string contain option path segment uri use set null return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long call est_client_init invalid port number input less zero greater 65535 est_client_set_serv error check input paramet store hostnam port number est context est_error est_client_set_serv est_ctx ctx const char server int port char path_seg ctx return est_err_no_ctx ctx est_client_initi return server null return port port 65535 return eok strncpy_ ctx est_serv server return ctx est_port_num port ifdef have_uripars int path_segment_len est_error path_seg null path_seg return make sure long path_segment_len strnlen_ path_seg path_segment_len return valid incom path segment string path_seg est_err_non est_log_err path segment fail valid .""); return valid store away context est_store_path_seg ctx path_seg path_segment_len est_err_non est_log_err fail store uri path segment .""); return els uripars support cannot support path segment pass path_seg est_log_err use path segment support build lib est .""); return endif return est_err_non /*! brief est_client_set_proxi call applic layer specifi proxi est server must call est_client_init prior issu est command param ctx pointer est context client session param proxy_proto proxi protocol param proxy_serv name proxi server connect ascii string repres name server limit 254 charact param port tcp port proxi server connect param proxy_auth proxi authent method param usernam usernam use authent proxi param password password use authent proxi return est_error est_err_non success est_err_no_ctx null valu pass est context null valu pass est server name server name string long port num proxi server invalid call est_client_init null valu pass either usernam password usernam password long client proxi mode support built libcurl support invalid proxi protocol specifi est_client_set_proxi error check input paramet store proxi inform est context note http proxi tunnel support lib est server mode configur lib est client mode communic lib est server mode must specifi proxi protocol est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password ifdef have_libcurl ctx return est_err_no_ctx ctx est_client_initi return proxy_serv null proxy_serv return strnlen_ proxy_serv return ctx proxy_serv eok strncpy_ ctx proxy_serv sizeof ctx proxy_serv proxy_serv sizeof ctx proxy_serv ))) return proxy_port proxy_port 65535 return ctx proxy_port proxy_port proxy_proto proxy_proto return ctx proxy_proto proxy_proto proxy_auth proxy_auth )))) return ctx proxy_auth proxy_auth usernam password proxy_auth max_uidpwd strnlen_ usernam max_uidpwd return usernam return ctx proxy_usernam eok strncpy_ ctx proxy_usernam sizeof ctx proxy_usernam usernam sizeof ctx proxy_usernam ))) return max_uidpwd strnlen_ password max_uidpwd return password return ctx proxy_password eok strncpy_ ctx proxy_password sizeof ctx proxy_password password sizeof ctx proxy_password ))) return ctx proxy_auth proxy_auth ctx use_proxi return est_err_non els est librari built support libcurl client proxi mode support est_log_err client proxi mode requir libest built libcurl .""); return endif /*! brief call applic layer specifi hash algorithm use sign pkcs10 csr enrol oper must call est_client_init prior issu est command param ctx pointer est context client session param nid nid valu defin open ssl header file obj_mac desir digest use sign return est_error est_err_non success est_err_no_ctx null valu pass est context unsupport nid provid lib est support sha1 sha224 sha256 sha384 sha512 digest sha256 default digest use sign need invok function unless anoth digest desir support nid valu nid_sha1 nid_sha224 nid_sha256 nid_sha384 nid_sha512 est_error est_ctx ctx int nid ctx return est_err_no_ctx switch nid case nid_sha512 ctx signing_digest evp_sha512 (); break case nid_sha384 ctx signing_digest evp_sha384 (); break case nid_sha256 ctx signing_digest evp_sha256 (); break case nid_sha224 ctx signing_digest evp_sha224 (); break case nid_sha1 ctx signing_digest evp_sha1 (); break default return break return est_err_non /*! brief copi retri valu store client context param ctx pointer current est context param retry_delay pointer integ retri delay sec valu copi server sent retri delay second format pass valu zero param retry_tim pointer time_t retri time date valu copi server sent retri time date string format string convert time_t valu pass paramet valu set server sent time date string respons otherwis valu set zero return est_error respons receiv est server header check see server includ retri header indic request current cannot process retri http header includ receiv respons server delay valu save context est error code given applic request indic client must retri request later time valu specifi server one two basic format string version integ valu repres number second client must wait retri request string contain date time client retri request date time string format specifi rfc 2616 second delay valu sent convert integ save est context date time string valu sent convert time_t valu save est context applic must call obtain amount time wait retri request copi current retri valu client context return applic one two return valu set non zero valu note process retri valu time date format current support est client alway return retri delay valu second est_error est_ctx ctx int retry_delay time_t retry_tim ctx return est_err_no_ctx ctx est_client_initi return retry_delay ctx retry_after_delay ctx retry_after_delay retry_tim ctx retry_after_d ctx retry_after_d return est_err_non /*! brief est_client_force_pop use applic enabl proof possess generat est client prove est client sent csr server proxi possess privat key use sign csr bind tls session csr note csr attribut configur server requir check need call function enabl enabl automat scenario csr attribut request server proxi param ctx pointer est context function may call time return est_error est_error est_client_force_pop est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic disabl proof possess generat est client pleas see documen est_client_force_pop inform proof possess check param ctx pointer est context function may call time return est_error est_error est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx client_force_pop return est_err_non /*! brief use applic set timeout valu read oper est client send request est server attempt read respons server timeout valu limit amount time client wait respons param ctx pointer est context param timeout integ valu repres read timeout second minimum valu maximum valu return est_error est_error est_ctx ctx int timeout ctx est_log_err null context ""); return est_err_no_ctx timeout timeout est_log_err invalid read timeout valu pass timeout return ctx read_timeout timeout return est_err_non /*! brief use applic get http status code return est server recent oper param ctx pointer est context call est oper enrol oper function return recent http status code receiv est server normal status 200 would return est server indic success oper howev oper fail reason http status code may use understand reason failur instanc est server would return http status 401 est client author pleas see rfc 2616 descript various http status code return int valu repres http status code null null est context provid int est_ctx ctx ctx return ctx last_http_status els return","[ 0.0189344  -0.12086762 -0.27243558  0.01124373  0.0368322   0.09904639
  0.24570268  0.06664453 -0.02290943 -0.10877211 -0.06552196 -0.04178625
 -0.01695314  0.09657768 -0.08949996  0.02774441  0.00127898  0.10010207
  0.08983328  0.04830928  0.01734949  0.06528727  0.01335612  0.09518918
  0.2228079   0.18503615  0.0203068   0.14092821 -0.04587187  0.04432371
  0.03544043 -0.06770312 -0.03433644 -0.15114896  0.14524175 -0.01042842
  0.05346381  0.10856967 -0.04492432 -0.09854058 -0.00346637 -0.08806235
 -0.03638779 -0.03482285  0.05887227  0.11063449  0.09703409 -0.05485849
  0.10917465 -0.17768449 -0.03212404 -0.09335963 -0.06889676  0.08228234
 -0.03486841 -0.01089434 -0.06850056 -0.03938957  0.15965264 -0.12361487
 -0.01187668  0.00436597  0.21695496  0.11946355  0.0173128  -0.05032689
 -0.20565802  0.04454385  0.04663602 -0.05815081 -0.10334317  0.11066569
 -0.14804283  0.0624555  -0.05406999 -0.04576638 -0.0440175  -0.06608483
  0.14855218 -0.00354439  0.1332854  -0.09077922  0.06694544 -0.02622521
  0.06570163 -0.08479669 -0.07486844  0.0359394  -0.13179006 -0.02893699
  0.07756511 -0.11924619 -0.06247345 -0.04438787 -0.03446443 -0.04317556
 -0.04945877  0.13138828 -0.1619641   0.09331657]","[-0.01212583 -0.13326815 -0.27721918  0.01635954  0.05460812  0.11366506
  0.22404866  0.08302981 -0.05739356 -0.11167102 -0.05115006 -0.0517216
 -0.02480861  0.08251221 -0.08399706 -0.0190204  -0.00484709  0.09947497
  0.08405377 -0.00260336 -0.00562813  0.05290641  0.01596781  0.10406233
  0.23529129  0.15021756  0.03056725  0.10741489 -0.02995356  0.02169143
  0.07640073 -0.08338851 -0.06206417 -0.13434137  0.12783496 -0.00984126
  0.01540106  0.10162499 -0.06595883 -0.06472126 -0.02892043 -0.08943283
 -0.03375332  0.00046836  0.02879858  0.12423744  0.05490479 -0.01550826
  0.1040336  -0.16828917 -0.00703106 -0.09175976 -0.04129839  0.11937694
 -0.05075381 -0.06230455 -0.07787734 -0.02868691  0.17373309 -0.13005476
 -0.01069565 -0.00704421  0.24201873  0.13577178 -0.00637569 -0.05181186
 -0.16948485  0.04573436  0.0255648  -0.04662471 -0.09180512  0.09107003
 -0.12774551  0.07014243 -0.01302422 -0.00620153 -0.0305648  -0.07601472
  0.10792644 -0.02161874  0.11940879 -0.0677339   0.08831538 -0.00984346
  0.03920789 -0.06618405 -0.06885599  0.02607972 -0.11706995 -0.02366428
  0.07802808 -0.11661694 -0.09568571 -0.02959289 -0.0361881  -0.01365107
 -0.02317121  0.17533597 -0.17172252  0.06771094]",0.2662834963107236,1
req,src,test_data/LibEST_semeru_format/requirements/RQ57-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir enrol enrol follow exampl valid simpleenrol exchang data messag simplereenrol similar exchang est client use band distribut usernam password authent est server normal http www authent behavior includ inform purpos exist tls client certif use server might skip request http www authent header simplereenrol oper initi tls handshak client ignor option server generat certif request instead proceed http post request respons initi http post attempt server request www authent client might occur even client use client certif detail normat text http unauthor content length www authent digest qop auth realm estrealm nonc subsequ http post usernam password includ along complet applic pkcs content post well known est simpleenrol http author digest usernam estus realm estrealm nonc uri well known est simpleenrol cnonc tyw mzg qop auth respons host accept content type applic pkcs content transfer encod base content length miich tccaw caqaw mbs ueax muzgvtb zxa idez njgx ndez ntiwgg gcsq gsib dqebaquaa ibdw awgg ekao ibaqcl kdz kaum fyjp qkz zixqixc mcatn zrcax gjwbqo xsqff odbyw wdk qoibnt cqri ydc krmjmo slm nkf mlr krmah ycsvw tnv javh teiit ayq ryhk cxo dan skf tyci vxfx wwi skeprel devag bieym rxtlujirwnq srj oquzk d31be961kzcx ygrhxa r4pag aagg itaf bgkqhki g9w0bcqcx mqk3ji q2li lzcr rvl1ntbundanbgkqhki g9w0b aqufaaocaqearbv0aj hpl1mfidz wqoi1d ocf6u ywc bzp ladv pk1qx5pq xm830a1o 7rvr nyd6vf2rl a9lywibj lxo bo8d kxr yl16c vus yydi1m daft ysrgol mlt weiqbc2sdbr2k hxw1tr130h icpwmr29k c2kzur 5thsuj276fgl1v pu0d gqfx4wwa9u ahbgz6t w37cep zsr uke 0pf vhr2o hgbqdqhvtfvj hccd axicrtb u5o1l pv7f4l eapv3sbqm jcaq5o832bz hw7n mfc m15e9gt uvee5c62b vwuk tbn gsbw est server use usernam password perform authent author respond issu certif http 200 status 200 content type applic pkcs7 mime smime type cert content transfer encod base64 content length 1122 miidoayjko zihvc naqc iidktccay ucaqex adalbgkqhki g9w0bbw gggg mlmiid ccae ibag ibftanbgkqhki g9w0baqufadab mrkw ydvqqdex blc3rfe gft gxl q0eg tnd omb4xdtez mduw otiz mtu1m1o xdte0mduw otiz mtu1m1ow mbs a1ueax muzgvtb3n0zxa0idez njgx ndez ntiwgg ma0gcsq gsib3dqebaquaa4ib awgg ekao ibaqcl kdz nj8xp ep9kaum dz3e fyjp qkz9dd d5e5oz cm103 zixqixc0 mcatn rr3dn zrcax gjwbqo b3e kt29 xsqff odbyw0wdk qoibnt qry8ydc 8lj n7m2krmjmo slm u2v4a ycsvw tnv 6mx6pr2p tj82javh teiit ayq1ryhk m1cxo dan n7tz c94skf s3vv f53 j9sk tycy1rw0k3vxfx wwi skeprel7i6k0y devag bieym l1s69rxtluji rwnq srj oquzk d31be961kzcx ygrhxa r4pag mbaagj bqma4ga1ud dad nvhq4efg b6ii6ic q8w gmxvy1jf e4xt ydvr0j bbgw rp5luj bkf yl6olo7 5ar qjww dqyjko zihvc naqefbqadgg ebacmxg1hv ftaroxain bx5gxd z9om sb0l 4pdvg khz mcrc u6m4yp5n0edkm ga6 y8fb et4tt7ju jg6ixb95 760th0vuctwk gr6 d6ettfqi hnrbh x3l ahn 0ja7 o1gv4cwxh1i8a txdp ohorv n0smxdcrl cys2vrt r2a3kaj jo6e q5le odz opha lwen0e2blnji0v c2fa 2lmcnf c38xf gala5a8e7f nhxwzbj xzlbcza3 es9mlh2cj wxm mvd eqnt fpgg f8izsrv ruct ge1lg dmu6afuxc r4por t2xz8ch adea,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.01086677 -0.11569759 -0.28234908  0.00865691  0.05637074  0.10462321
  0.23565991  0.08105508 -0.02279514 -0.11592611 -0.05374048 -0.04687865
 -0.01230416  0.10313725 -0.08892097  0.00668846 -0.02123964  0.10955703
  0.08608304  0.0214883  -0.01048485  0.0763002   0.01242931  0.10334464
  0.224149    0.18546924  0.03474633  0.12835288 -0.05218068  0.04371798
  0.04764066 -0.07795496 -0.04618291 -0.16880637  0.16087836 -0.01423203
  0.0291514   0.09832232 -0.05347303 -0.11215606 -0.0329565  -0.10921572
 -0.04392487 -0.0091577   0.05223354  0.1207661   0.09599475 -0.04334331
  0.09906842 -0.18660526 -0.02528658 -0.09504613 -0.04417253  0.10603093
 -0.05040376 -0.03031288 -0.05405537 -0.02554804  0.16556297 -0.14586699
 -0.02407699 -0.01302934  0.2279794   0.14382462  0.01681753 -0.03241924
 -0.20396417  0.04428796  0.05654696 -0.04329154 -0.07235874  0.10083704
 -0.14799389  0.06084191 -0.04004302 -0.04092317 -0.04353067 -0.08508565
  0.13239193 -0.00888586  0.10366532 -0.08903971  0.07002182 -0.03829064
  0.07049979 -0.07948064 -0.07984372  0.03788071 -0.11605795 -0.01662358
  0.09837063 -0.11859854 -0.07322418 -0.02647374 -0.03121147 -0.05059266
 -0.03966936  0.13683142 -0.17230171  0.07387189]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.21155577983029566,0
req,src,test_data/LibEST_semeru_format/requirements/RQ42-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.c,requir server side key generat est client may request privat key associ certif est server use https post oper path valu serverkeygen support serverkeygen function option client must authent est server specifi section certif base authent use section option certif less authent use check server author given section est server must authent client specifi section certif base authent use section option certif less authent use check client author given section est server appli whatev author logic choos determin privat key certif provid cipher suit null confidenti algorithm must use disclos content unprotect privat key proper random number key generat rfc server implement respons server archiv generat key determin polici key pair certif transfer tls session cipher suit use return privat key certif must offer confidenti commensur privat key deliv client est client may request addit certif even use exist certif tls client authent exampl client use exist certif tls client authent request certif cannot use tls client authent,"use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static int addr str struct sockaddr addr char str size str size unsign short int port int ret ifdef win dword str size size addr len switch addr famili case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break case inet addr len sizeof struct sockaddr port ntoh struct sockaddr addr sin port break default break str size str size addr len wsaaddress string addr addr len null lpwstr str str size ret els switch addr famili case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break case inet port ntoh struct sockaddr addr sin port inet ntop addr famili struct sockaddr addr sin addr str str size ret break default break endif return ret use wsaaddress string instead inet ntop window inet ntop exist window use const struct sockaddr wsaaddress string take lpsockaddr static tcw err tcw_direct_clos tcw_sock_t sock tcw_err_t ret tcw_ok close_socket sock sock_fd est_log_err close fail get_sock_err ()); ret tcw_err_clos sock_err alreadi set goto done sock sock_fd sock_invalid done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_direct_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok struct addrinfo addr null struct addrinfo cur_addr sock_typ int err int saved_err char port_str char sock_addr_str inet6_addrstrlen unsign short int sock_port struct addrinfo hint int hint ai_socktyp sock_stream hint ai_flag ai_addrconfig snprintf port_str sizeof port_str port int sizeof port_str errno enomem ret tcw_err_alloc goto done est_log_info getaddrinfo )"", host port_str err getaddrinfo host port_str hint addr est_log_err getaddrinfo return err gai_strerror err )); ret tcw_err_resolv ifdef win32 sock_err alreadi set els switch err case eai_system sock_err alreadi set break case eai_memori set_sock_err_nomem (); break default could resolv host set_sock_err_nonam (); break endif goto done cur_addr addr cur_addr ret tcw_ok socket cur_addr ai_famili sock_stream ipproto_tcp est_log_warn socket fail get_sock_err ()); ret tcw_err_socket cur_addr cur_addr ai_next continu err addr_to_str cur_addr ai_addr sock_addr_str sizeof sock_addr_str sock_port err est_log_info connect port )"", sock_addr_str sock_port connect cur_addr ai_addr cur_addr ai_addrlen est_log_warn connect fail get_sock_err ()); ret tcw_err_connect close_socket may clobber sock_err saved_err get_sock_err (); close_socket sock_invalid set_sock_err saved_err cur_addr cur_addr ai_next continu break sock sock_fd els est_log_err could connect host port ret sock_err alreadi set done return ret establish direct socket connect est server use normal system call static tcw_err_t tcw_curl_clos tcw_sock_t sock tcw_err_t ret tcw_ok sock curl_handl curl_easy_cleanup sock curl_handl sock curl_handl null sock sock_fd sock_invalid return ret establish direct socket connect est server use normal system call static tcw_err_t set_blocking_mod tcw_sock_t sock int block tcw_err_t ret tcw_ok ifdef win32 int result unsign long mode block result ioctlsocket sock sock_fd fionbio mode result no_error per https :// msdn microsoft com librari window desktop ms740126 aspx ioctl ioctlsocket wsaioctl various languag run time system use ioctl purpos unrel window socket consequ ioctlsocket function wsaioctl function defin handl socket function perform ioctl fcntl berkeley softwar distribut sinc ioctlsocket window equival ioctl fcntl set return type accord ret tcw_err_fcntl goto done els int flag fcntl sock sock_fd f_getfl flag est_log_err fcntl f_getfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done flag block flag o_nonblock flag o_nonblock fcntl sock sock_fd f_setfl flag est_log_err fcntl f_setfl fail get_sock_err ()); sock_err alreadi set ret tcw_err_fcntl goto done endif win32 done return ret establish socket remot server use libcurl actual send url leverag libcurl proxi support establish connect static tcw_err_t tcw_curl_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port tcw_err_t ret tcw_ok size_t url_siz char url null curlcod curlcod long curl_socket long auth_bit long proxy_typ int saved_err const char proxy_type_str none int sock curl_handl curl_easy_init (); sock curl_handl est_log_err curl_easy_init fail ""); errno enomem ret tcw_err_alloc goto done want libcurl establish connect proxi server done use socket normal direct connect est server curlcod curl_easy_setopt sock curl_handl curlopt_connect_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_connect_on return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done url_siz strlen host url char calloc url_siz url est_log_err calloc fail ""); errno enomem ret tcw_err_alloc goto done http tell libcurl wrap whatev data send ssl snprintf url url_siz http ://% host port int url_siz errno enomem ret tcw_err_alloc goto done curlcod curl_easy_setopt sock curl_handl curlopt_url url curlcod curle_ok est_log_err curl_easy_setopt curlopt_url return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi host port curlcod curl_easy_setopt sock curl_handl curlopt_proxi opt proxy_host curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxi return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyport opt proxy_port curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyport return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done proxi protocol includ http tunnel mode opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_http proxy_type_str http tunnel )""; els opt proxy_proto proxy_typ curlproxy_socks4 proxy_type_str socks4 els opt proxy_proto proxy_typ curlproxy_socks5 proxy_type_str socks5 els opt proxy_proto proxy_typ curlproxy_socks4a proxy_type_str socks4a els opt proxy_proto proxy_typ proxy_type_str socks5_hostnam curlcod curl_easy_setopt sock curl_handl curlopt_proxytyp proxy_typ curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxytyp return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done opt proxy_proto curlcod curl_easy_setopt sock curl_handl curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth curlauth_bas curlauth_on curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done usernam password opt proxy_usernam opt proxy_password curlcod curl_easy_setopt sock curl_handl curlopt_proxyusernam opt proxy_usernam curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyusernam return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curlcod curl_easy_setopt sock curl_handl opt proxy_password curlcod curle_ok est_log_err curl_easy_setopt return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done auth_bit opt proxy_auth auth_bit curlauth_bas opt proxy_auth auth_bit curlauth_ntlm auth_bit curlcod curl_easy_setopt sock curl_handl curlopt_proxyauth auth_bit curlcod curle_ok est_log_err curl_easy_setopt curlopt_proxyauth return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done signal generat libcurl curlcod curl_easy_setopt sock curl_handl curlopt_nosign curlcod curle_ok est_log_err curl_easy_setopt curlopt_nosign return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done perform curl request est_log_info curl_easy_perform proxi type url proxy_type_str curlcod curl_easy_perform sock curl_handl curlcod curle_ok est_log_err curl_easy_perform return url curlcod curl_easy_strerror curlcod )); curlcod curlcod set_sock_err_nonam (); ret tcw_err_resolv goto done els set_sock_err_conn (); ret tcw_err_connect goto done retriev socket libcurl curlcod curl_easy_getinfo sock curl_handl curlinfo_lastsocket curl_socket curlcod curle_ok est_log_err curl_easy_getinfo curlinfo_lastsocket return curlcod curl_easy_strerror curlcod )); errno einval ret tcw_err_oth goto done curl_socket est_log_err curlinfo_lastsocket invalid socket ""); errno einval ret tcw_err_oth goto done sock sock_fd curl_socket connect made set socket block ret set_blocking_mod sock ret tcw_ok sock_err alreadi set est_log_err fail set socket block ""); goto done done free url url null ret tcw_ok saved_err get_sock_err (); tcw_curl_clos sock set_sock_err saved_err return ret entri point establish connect remot est server tcw_err_t tcw_connect tcw_sock_t sock tcw_opts_t opt const char host unsign short int port sock_typ sock_fd tcw_err_t ret tcw_ok memset sock sizeof tcw_sock_t )); sock sock_fd sock_invalid sock proxy_proto opt proxy_proto sock proxy_proto est_client_proxy_non ifdef have_libcurl ret tcw_curl_connect sock opt host port els make far log messag wrong return est_log_err proxi set current requir libcurl ""); errno einval ret tcw_err_arg goto done endif els ret tcw_direct_connect sock opt host port ret tcw_ok goto done est_log_info success connect host port sock_fd sock sock_fd done return ret entri point establish connect remot est server tcw_err_t tcw_close tcw_sock_t sock tcw_err_t ret tcw_ok sock proxy_proto est_client_proxy_non ret tcw_direct_clos sock els ifdef have_libcurl ret tcw_curl_clos sock endif return ret","[ 0.01919132 -0.13436481 -0.25637367  0.01858142  0.01092108  0.08953746
  0.24932313  0.05371811 -0.0263567  -0.09012524 -0.07275695 -0.03987717
 -0.01759863  0.09318005 -0.08997033  0.04462247  0.02457746  0.08916382
  0.09124328  0.07051212  0.04171342  0.05132639  0.02268148  0.09133249
  0.21535838  0.1816229   0.00759033  0.15343934 -0.04265289  0.04019423
  0.03096654 -0.05640681 -0.02895182 -0.13533044  0.13143943 -0.00101383
  0.07991996  0.10942763 -0.03829321 -0.08362848  0.02952784 -0.07156906
 -0.02867445 -0.05152122  0.06871213  0.0978834   0.10015245 -0.06682049
  0.12539087 -0.16184358 -0.03034533 -0.09291632 -0.0908902   0.06531499
 -0.01852043  0.00560938 -0.08480003 -0.0533124   0.14742002 -0.10332853
 -0.00208629  0.02636629  0.204129    0.09236573  0.01615208 -0.06733359
 -0.20259242  0.03944089  0.0477067  -0.0610938  -0.11997097  0.12203156
 -0.14711682  0.06176237 -0.0731723  -0.05851442 -0.04038087 -0.04820354
  0.16489074  0.00550204  0.16409378 -0.08869059  0.05877932 -0.018537
  0.05870541 -0.09174685 -0.06436934  0.03492665 -0.13870497 -0.03679516
  0.06041276 -0.11863453 -0.05214754 -0.05817756 -0.04439661 -0.0399189
 -0.05176818  0.1304039  -0.1448997   0.11404135]","[-0.01188305 -0.11989585 -0.28681368  0.01214463  0.07315791  0.11326519
  0.217836    0.0944679  -0.0451991  -0.11877022 -0.04056842 -0.05241441
 -0.01885119  0.09231448 -0.08503158 -0.03129539 -0.02941971  0.10862147
  0.07963138 -0.01868726 -0.03219031  0.06873195  0.01229763  0.11046854
  0.22906604  0.16061644  0.04480148  0.09991591 -0.04184448  0.02916301
  0.07580003 -0.08859676 -0.06532968 -0.16118166  0.15181449 -0.01318201
 -0.00434233  0.09322203 -0.0673915  -0.0967823  -0.05834565 -0.11377597
 -0.04401211  0.02238951  0.03064513  0.13216403  0.06445314 -0.01539415
  0.09036843 -0.17970978 -0.00655799 -0.09252311 -0.02049591  0.1339102
 -0.06344157 -0.06756513 -0.05386623 -0.01321931  0.1760321  -0.15522438
 -0.02666624 -0.02773205  0.24760361  0.1611861   0.00300834 -0.0297629
 -0.17715964  0.04359191  0.04271986 -0.03175938 -0.05782419  0.08275491
 -0.13435124  0.06468542 -0.00791983 -0.01371861 -0.03439819 -0.09845947
  0.09888592 -0.02352023  0.0848446  -0.07108621  0.08391754 -0.03058564
  0.05637581 -0.06458214 -0.07754525  0.03115152 -0.10091239 -0.01269271
  0.10268663 -0.11500347 -0.09586684 -0.01240259 -0.03097106 -0.03011728
 -0.02091982  0.16357501 -0.17855448  0.04992825]",0.4494929492752123,0
req,src,test_data/LibEST_semeru_format/requirements/RQ23-pre.txt,test_data/LibEST_semeru_format/source_code/est_client_proxy.h,requir certif less tls mutual authent certif less tls cipher suit provid way perform mutual authent situat neither client server certif desir use certif trust anchor necessari verifi certif client server may negoti certif less cipher suit mutual authent use certif less mutual authent tls enrol cipher suit must base protocol resist dictionari attack must base zero knowledg protocol transport layer secur secur remot password tls srp cipher suit srp name list section rfc suitabl purpos section list characterist cipher suit suitabl use certif less mutual authent enrol success authent use certif less cipher suit prove knowledg pre share secret implicit author peer exchang,tcw err tcw connect tcw sock sock tcw opt opt const char host unsign short int port sock type tcw err tcw close tcw sock sock,"[ 0.03502419 -0.11070093 -0.26910967  0.00777616  0.02791341  0.10168082
  0.2549339   0.05649045 -0.0143865  -0.12104694 -0.07655802 -0.0343263
 -0.0197481   0.09124649 -0.09171128  0.0503534   0.00999131  0.09990548
  0.09415257  0.07287048  0.0353492   0.0612152   0.00379392  0.08496425
  0.23055631  0.19217035  0.01274706  0.14793596 -0.04581299  0.04930047
  0.01866526 -0.06496868 -0.01570188 -0.14055377  0.13634585 -0.01440789
  0.06431904  0.1236918  -0.0424067  -0.09151722  0.00775591 -0.08086397
 -0.0342573  -0.0591412   0.05797459  0.1055127   0.10518643 -0.05868877
  0.10452148 -0.18195724 -0.051609   -0.08838895 -0.08329114  0.05896837
 -0.03349564  0.00661981 -0.06643137 -0.04309354  0.16077377 -0.1123402
 -0.00621304  0.00910075  0.20758864  0.11458318  0.01921583 -0.05592223
 -0.21312287  0.05017256  0.03245937 -0.08189879 -0.13241974  0.11413654
 -0.14800094  0.06054307 -0.05660127 -0.03889328 -0.04985166 -0.05365571
  0.15377773 -0.0011861   0.14377767 -0.09773597  0.06884117 -0.01214004
  0.06039708 -0.08083048 -0.07974792  0.0349386  -0.14917791 -0.03636461
  0.06550532 -0.12041557 -0.05732323 -0.05503714 -0.02430081 -0.03534544
 -0.06488306  0.12177993 -0.16346969  0.09805314]","[-0.02559054 -0.11442585 -0.285615    0.00588459  0.08140744  0.10919993
  0.2025552   0.09227076 -0.05288828 -0.10508315 -0.03450128 -0.05000919
 -0.01895749  0.09241728 -0.0825227  -0.04746013 -0.04190391  0.11057997
  0.07707261 -0.05081448 -0.04736394  0.07211433  0.00481617  0.10405831
  0.22073705  0.15570243  0.05207276  0.08818626 -0.03623734  0.03228203
  0.07584656 -0.08614524 -0.0680483  -0.15912452  0.15105945 -0.0176961
 -0.02634157  0.08282487 -0.06824675 -0.09650894 -0.08014593 -0.11928507
 -0.03722025  0.04271827  0.01640472  0.13784954  0.04986245 -0.00652583
  0.0891173  -0.17669564  0.00071935 -0.09104431  0.00715671  0.14993069
 -0.05865422 -0.07927951 -0.04344445  0.00132594  0.17408217 -0.16809788
 -0.02875789 -0.04706879  0.24801992  0.1723621   0.00407052 -0.02492814
 -0.17019147  0.04301095  0.04741421 -0.02034728 -0.03768035  0.06754561
 -0.13278511  0.06559402  0.01077702 -0.00851638 -0.03142531 -0.10705622
  0.08153803 -0.03021447  0.06499343 -0.06556234  0.08207458 -0.03263115
  0.05326113 -0.06163096 -0.07458441  0.02681185 -0.08756457 -0.01315804
  0.11402813 -0.10114845 -0.09870127 -0.01105796 -0.02375322 -0.03328297
 -0.013665    0.17352374 -0.17754659  0.02712149]",0.4832090566103116,0
req,src,test_data/LibEST_semeru_format/requirements/RQ24-pre.txt,test_data/LibEST_semeru_format/source_code/est_server_http.c,requir proof possess defin section cmc rfc proof possess pop refer valu use prove privat key correspond public key possess use end entiti sign enrol request provid signatur base proof possess mechan describ section strengthen option includ direct base proof possess rfc includ tls session specif inform within data cover enrol request signatur thus link enrol request authent end point tls connect,"static pthread pthread self void return get current thread const void get conn ssl struct connect conn return conn conn ssl null static void sockaddr string char buf size len const union usa usa buf defin use ipv inet ntop usa famili usa famili inet void usa sin sin addr void usa sin sin addr buf socklen len elif defin win windoz vista newer inet ntop strncpi buf max src addr inet ntoa usa sin sin addr len els inet ntop usa famili void usa sin sin addr buf len endif print error messag open error log stream static void cri struct connect conn const char fmt char buf buf len src addr max src addr list time timestamp start fmt void vsnprintf buf sizeof buf fmt end lock get callback valu suppos fine sinc function cannot disappear way string option conn request info data buf timestamp time null sockaddr string src addr sizeof src addr conn client rsa est log err error client unsign long timestamp src addr conn request info request method null est log_err (""% conn request_info request_method conn request_info uri est_log_err (""% buf conn request_info ev_data null applic moment log static struct mg_connect struct mg_context ctx static struct mg_connect fake_connect fake_connect ctx ctx return fake_connect applic moment log const char mg_version void return mongoose_vers applic moment log struct mg_request_info mg_get_request_info struct mg_connect conn return conn request_info applic moment log void mg_strlcpi regist char dst regist const char src size_t src --) dst src ++; dst applic moment log char mg_strndup const char ptr size_t len char char malloc len null mg_strlcpi ptr len return applic moment log static int lowercas const char return tolow (*( const unsign char applic moment log static int mg_strncasecmp const char const char size_t len int diff len diff lowercas ++) lowercas ++); diff len return diff applic moment log static int mg_strcasecmp const char const char int diff diff lowercas ++) lowercas ++); diff return diff audit report static int mg_vsnprintf struct mg_connect conn char buf size_t buflen const char fmt va_list int buflen return vsnprintf buf buflen fmt cri conn vsnprintf error ""); els int buflen cri conn truncat vsnprintf buffer [%.* ]"", 200 200 buf int buflen buf return printf_arg static int mg_snprintf struct mg_connect conn char buf size_t buflen const char fmt ...) va_list int va_start fmt mg_vsnprintf conn buf buflen fmt va_end return printf_arg static size_t est_strcspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strcspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strcspn_s error safec_rc return return count printf_arg static size_t est_strspn const char str1 const char str2 rsize_t count errno_t safec_rc str1 null str1 return safec_rc strspn_s str1 strnlen_ str1 rsize_max_str str2 rsize_max_str count safec_rc eok est_log_info strspn_s error safec_rc return return count delimit quot quotechar char skip_quot char buf const char delimit const char whitespac char quotechar char begin_word end_word end_whitespac begin_word buf end_word begin_word est_strcspn begin_word delimit check quotechar end_word begin_word end_word quotechar anyth beyond end_word copi end_word break els rsize_t end_off rsize_t est_strcspn end_word delimit memmove_ end_off end_word end_off end_off must correspond end_word end_word end_off ++; end_word ++) end_word buf end_word els end_whitespac end_word est_strspn end_word whitespac end_word end_whitespac ++) buf end_whitespac return begin_word whitespac delimit char skip char buf const char delimit return skip_quot buf delimit delimit return http header valu null found static const char get_head const struct mg_request_info const char name int num_head ++) mg_strcasecmp name http_header name return http_header valu return null return http header valu null found const char mg_get_head const struct mg_connect conn const char name return get_head conn request_info name set exampl request pars fail static int should_keep_al const struct mg_connect conn const char http_version conn request_info http_version const char header mg_get_head conn connect ""); slight deviat mongoos behavior close connect send 202 accept respons also close connect 4xx respons mongoos close 401 unauthor conn must_clos conn status_cod est_http_stat_202 conn status_cod 400 conn ctx enable_keepal header null mg_strcasecmp header keep aliv header null http_version strncmp http_version ))) return return set exampl request pars fail static const char const struct mg_connect conn return should_keep_al conn keep aliv close set exampl request pars fail void mg_send_http_error struct mg_connect conn int status const char reason const char fmt ...) char buf mg_buf_len va_list int len conn status_cod status conn request_info ev_data void *)( long status buf len error 1xx 204 304 must send bodi status 199 status 204 status 304 len mg_snprintf conn buf sizeof buf error status reason buf len ++] va_start fmt len mg_vsnprintf conn buf len sizeof buf len fmt va_end est_log_info (""[% ]"", buf mg_printf conn http content length connect status reason len conn )); conn num_bytes_s mg_printf conn buf window chang slash backslash path name static void char path int path ++) path /') path \\'; check preserv unc path like server file txt path path path /') void memmove_ path est_uri_max_len path strnlen_ path est_uri_max_len )); wbuf wbuf_len target buffer length static void to_unicod const char path wchar_t wbuf size_t wbuf_len char buf path_max buf2 path_max mg_strlcpi buf path sizeof buf )); buf point end file name buf strnlen_ buf est_uri_max_len convert unicod back doubli convert string match origin someth fishi reject memzero_ wbuf wbuf_len sizeof wchar_t )); multi byte wide char cp_utf8 buf wbuf int wbuf_len wide char multi byte cp_utf8 wbuf int wbuf_len buf2 sizeof buf2 null null strcmp buf buf2 wbuf function return non path end garbag static int const char path static const char allowed_last_charact -""; int last path strnlen_ path est_uri_max_len return isalnum last strchr allowed_last_charact last null function return non path end garbag static handl dlopen const char dll_name int flag wchar_t wbuf path_max flag unus to_unicod dll_name wbuf array_s wbuf )); return load librari wbuf descriptor return number byte written static int64_t push file socket sock ssl ssl const char buf int64_t len int64_t sent int sent sent len mani byte send iter len sent int_max int_max int len sent ssl null ssl_write ssl buf sent els null int fwrite buf sent size_t ferror els int send sock buf sent size_t msg_nosign break sent return sent read must give close connect exit serv thread static int struct mg_connect conn struct pollfd pfd int result int times_up est_uint total_wait_tim est_uint read_timeout conn read_timeout 1000 accuml total amount time wait total_wait_tim msec_poll_wait_tim pfd conn client sock pfd event pollin pfd revent errno result poll pfd msec_poll_wait_tim result conn ssl null result ssl_pend conn ssl check see time give set thing accord close session total_wait_tim read_timeout result times_up conn must_clos result continu wait noth read socket poll interrupt signal master process indic stop wait read timeout occur result result errno eintr conn ctx stop_flag times_up return conn ctx stop_flag result return negat valu error number byte read success static int pull file struct mg_connect conn char buf int len int nread int err_cd null use read instead fread (), read cgi pipe fread may block buffer fill cannot afford block must pass read byte immedi client nread int read fileno buf size_t len els conn must_clos conn nread els conn ssl null nread ssl_read conn ssl buf len err_cd ssl_get_error conn ssl nread switch err_cd case ssl_error_non noth grace shutdown break case ssl_error_want_read data may come chang nread zero mongoos attempt read data peer would occur peer initi ssl renegot nread break case est_log_err ssl_read error want lookup ""); break default error simpli log error make sure nread indic error function est_log_err ssl_read error code err_cd nread break els nread int recv conn client sock buf size_t len return conn ctx stop_flag nread return negat valu error number byte read success int mg_read struct mg_connect conn void buf size_t len int buffered_len nread const char bodi rsize_t max_len nread max_len rsize_t len conn consumed_cont conn content_len adjust number byte read int64_t to_read conn content_len conn consumed_cont to_read int64_t len len size_t to_read return buffer data bodi conn buf conn request_len conn consumed_cont buffered_len int conn buf conn data_len bodi buffered_len len size_t buffered_len buffered_len int len memcpy_ buf max_len bodi rsize_t buffered_len len buffered_len conn consumed_cont buffered_len nread buffered_len buf char buf buffered_len return buffer data read new data remot socket len pull null conn char buf int len nread propag error break els buf char buf conn consumed_cont nread len els retri return nread return negat valu error number byte read success int mg_write struct mg_connect conn const void buf size_t len int64_t total total push null conn client sock conn ssl const char buf int64_t len return int total return negat valu error number byte read success int mg_printf struct mg_connect conn const char fmt ...) char mem mg_buf_len buf mem int len va_list print local buffer first hope larg enough hold whole messag va_start fmt len vsnprintf mem sizeof mem fmt va_end len noth mg_printf conn """") call els len vsnprintf error give len cri conn ...): vsnprintf error __func__ fmt els len int sizeof mem buf char malloc len null local buffer larg enough alloc big buffer heap va_start fmt vsnprintf buf len fmt va_end len mg_write conn buf size_t len free buf els len int sizeof mem fail alloc larg enough buffer give cri conn ...): alloc byte print anyth __func__ fmt len len els copi local buffer succeed len mg_write conn buf size_t len return len http :// ftp uci edu pub ietf html rfc1866 txt static int url_decod const char src int src_len char dst int dst_len int is_form_url_encod int defin hextoi isdigit src_len dst_len ++, ++) src isxdigit (*( const unsign char *)( src isxdigit (*( const unsign char *)( src ))) tolow (*( const unsign char *)( src )); tolow (*( const unsign char *)( src )); dst char )(( hextoi hextoi )); els is_form_url_encod src +') dst els dst src dst null termin destin return src_len actual request length includ last static int get_request_len const char buf int buflen const char int len buf buflen len ++) control charact allow 128 isprint (*( const unsign char const unsign char 128 len break i_a abort scan soon one malform charact found let subsequ win anyhow els len int buf els len int buf return len excess charact static void char char ++; \\') skip follow slash backslash doubl dot \\') ++; els .') els break perform pars http authent header client basic authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char save_ptr char max_uidpwd contain uid pwd rsize_t len char sep "":""; int colon_found char possible_pw char auth_head gobbl initi space isspac (*( unsign char ++; valu len est_base64_decod valu max_uidpwd )); len est_log_warn base64 decod http auth header fail http auth fail ""); return make sure string colon_found strstr_s len "":"", possible_pw colon_found eok est_log_warn invalid format basic http credenti miss :""); memzero_ max_uidpwd )); return start colon mean userid :') len password possible_pw ++; pwd strndup possible_pw max_uidpwd est_log_info http authent header contain password ""); els got neither userid password est_log_info http authent header contain userid password ""); memzero_ max_uidpwd )); return els start userid pars usernam password separ "":"" valu strtok_ len sep save_ptr valu user strndup valu max_uidpwd pwd strndup save_ptr max_uidpwd mode auth_bas memzero_ max_uidpwd )); perform pars http authent header client digest authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char name valu char buf max_auth_hdr_len int mode auth_digest make modifi copi auth header strncpy_ buf max_auth_hdr_len auth_head max_auth_hdr_len buf pars author header gobbl initi space isspac (*( unsign char ++; name skip_quot ""="", valu either quot delimit end first comma space \""') ++; valu skip_quot ""\"""", \\'); ,') ++; els valu skip_quot use comma use space name break memcmp_ name usernam user strndup valu max_uidpwd continu memcmp_ name cnonc cnonc strndup valu max_nonc continu memcmp_ name respons respons strndup valu max_respons continu memcmp_ name uri uri strndup valu max_realm continu memcmp_ name qop qop strndup valu max_qop continu memcmp_ name strndup valu max_nc continu memcmp_ name nonc nonc strndup valu max_nonc perform pars http authent header client token bearer authent use static void struct mg_connect conn const char auth_head est_http_auth_hdr char valu char value_decod max_auth_token_len int len char auth_head strlen est_bearer_token_str gobbl initi space isspac (*( unsign char ++; valu memzero_ value_decod max_auth_token_len len est_base64_decod valu value_decod max_auth_token_len )); len est_log_warn base64 decod http auth credenti fail http auth fail ""); return copi token auth header structur auth_token strndup value_decod max_auth_token_len mode auth_token auth_token null est_log_err fail obtain memori authent token buffer ""); els est_log_err authent header client contain token ""); function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss mg_parse_auth_head struct mg_connect conn est_http_auth_hdr const char auth_head get auth header http client auth_head mg_get_head conn author "")) null return est_auth_hdr_miss mg_strncasecmp auth_head digest make sure server configur digest auth conn ctx est_ctx auth_mod auth_digest return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head basic make sure server configur basic auth conn ctx est_ctx auth_mod auth_bas return est_auth_hdr_bad conn auth_head els mg_strncasecmp auth_head est_bearer_token_str strlen est_bearer_token_str make sure server configur bearer token auth conn ctx est_ctx auth_mod auth_token return est_auth_hdr_bad conn auth_head els basic digest bearer token authent support mode auth_fail return est_auth_hdr_bad digest auth make sure valu pars mode auth_digest uri nonc cnonc est_log_err pars http auth header fail ""); return est_auth_hdr_bad abl pars user token auth mode make sure fail authent user null mode auth_token return est_auth_hdr_bad mode auth_token save user connect context want pass later strncpy_ conn user_id mg_uid_max user mg_uid_max return est_auth_hdr_good function pars http authent header client fill field est_http_auth_hdr struct use later verifi user credenti use either http basic http digest authent paramet alreadi alloc call function return either good bad miss void struct mg_connect conn conn status_cod 401 switch conn ctx est_ctx auth_mod case auth_bas mg_printf conn basic realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_digest mg_printf conn digest qop =\"" auth \"", realm =\""% \"", nonc =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm unsign long time null )); break case auth_token mg_printf conn bearer realm =\""% \""\ est_http_hdr_401 est_http_hdr_cl est_http_hdr_auth conn ctx est_ctx realm break case auth_fail case auth_non default mode valid point noth break pars stop static void parse_http_head char buf struct mg_request_info int int array_s http_header ++) http_header name skip_quot buf "":"", http_header valu skip buf ""); http_header name break num_head pars stop static int is_valid_http_method const char method est allow get post return strncmp method get strncmp method post http request compon header name header valu static int parse_http_messag char buf int len struct mg_request_info int request_length get_request_len buf len request_length reset attribut touch is_ssl remote_ip remote_port request_method uri http_version null num_head buf request_length rfc say initi whitespac ingor buf isspac (*( unsign char buf buf ++; request_method skip buf ""); uri skip buf ""); http_version skip buf ""); parse_http_head buf est_log_info request_len request_length est_log_info request uri uri return request_length http request compon header name header valu static int parse_http_request char buf int len struct mg_request_info int result parse_http_messag buf len result is_valid_http_method request_method strncmp http_version http /"", http_version skip http els result return result upon everi read oper increas nread number byte read static int read_request file struct mg_connect conn char buf int bufsiz int nread int request_len request_len get_request_len buf nread nread bufsiz request_len pull conn buf nread bufsiz nread nread request_len get_request_len buf nread recv error propag error process b0rked high probabl request return return request_len function call mongoos code incom http request process return success non zero request handl static int est_mg_handl struct mg_connect conn const struct mg_request_info request_info mg_get_request_info conn est_ctx ectx conn ctx est_ctx char bodi int int est_rv est_err_non const char cl_hdr content length html header const char ct_hdr content type html header cl_hdr mg_get_head conn content length ""); cl_hdr point content length valu alreadi error check guarante within correct rang obtain length alloc buffer bodi read atoi cl_hdr bodi malloc mg_read conn bodi make sure buffer null termin bodi 0x0 els bodi null ct_hdr mg_get_head conn content type ""); ectx est_mod est_serv est_rv est_http_request ectx conn char request_info request_method char request_info uri bodi ct_hdr els ectx est_mod est_proxi est_rv ectx conn char request_info request_method char request_info uri bodi ct_hdr est_rv est_err_non est_log_err est error respons code est_rv est_err_num_to_str est_rv )); cl_hdr free bodi return est_rv directori call embed function etcetera static void handle_request struct mg_connect conn struct mg_request_info conn request_info int uri_len int conn request_info query_str strchr uri ?')) null *(( char conn request_info query_str ++) uri_len int strnlen_ uri est_uri_max_len url_decod uri uri_len char uri uri_len char uri est_log_info (""% uri process request est_mg_handl conn est_err_non est_log_warn incom request fail )"", est_err_num_to_str )); directori call embed function etcetera static void log_head const struct mg_connect conn const char header const char header_valu header_valu mg_get_head conn header null est_log_info (""% -""); els est_log_info \""% \"""", header_valu directori call embed function etcetera static void log_access const struct mg_connect conn const struct mg_request_info char date src_addr strftime date sizeof date localtim conn birth_tim )); conn request_info sockaddr_to_str src_addr sizeof src_addr conn client rsa est_log_info (""% \""% http int64_fmt src_addr date request_method request_method ""-"", uri uri ""-"", http_version conn status_cod conn num_bytes_s log_head conn refer ""); log_head conn user agent ""); return open ssl error messag static const char ssl_error void unsign long err err err_get_error (); return err err_error_str err null dynam load ssl librari set ctx ssl_ctx pointer static int set_ssl_opt struct mg_context ctx struct mg_connect conn est_ctx ectx ssl_ctx ssl_ctx ec_key ecdh null x509_verify_param vpm null char sic est ssl_ctx ssl_ctx_new sslv23_server_method ())) null cri ctx ssl_ctx_new server error ssl_error ()); return ctx ssl_ctx ssl_ctx ectx ctx est_ctx conn ctx conn request_info ev_data ctx ssl_ctx ssl_ctx_set_verifi ssl_ctx ssl_verify_p null set session context enabl open ssl session reus improv perform set estxxxxxxxx valu random number rand_byt unsign char *)& sic est_log_warn rng failur set sic ssl_error ()); ssl_ctx void *)& sic load cert use verifi client certif ssl_ctx ectx trusted_certs_stor ssl code free store ssl_ctx later ectx trusted_certs_stor null note disabl tls ticket anoth way reus tls session avoid key exchang overhead tls handshak enabl session reus session reus work ticket support enabl server may want look enabl ticket futur session reus give perform boost option set improv forward secrecti compli est draft ssl_ctx_set_opt ssl_ctx ssl_op_no_sslv2 ssl_op_no_sslv3 ssl_op_no_tlsv1 ssl_op_no_ticket set ecdh singl use parm use configur curv use prime256v1 default ectx ecdhe_nid setup user select curv ecdh ectx ecdhe_nid est_log_info use non default ecdh curv nid )"", ectx ecdhe_nid els default prime256 curv ecdh nid_x9_62_prime256v1 est_log_info use default ecdh curv prime256v1 )""); ecdh null est_log_err fail generat temp ecdh paramet ""); return ssl_ctx_set_tmp_ecdh ssl_ctx ecdh ec_key_fre ecdh setup addit cert check includ crl depth purpos vpm (); enabl crl check ectx enable_crl vpm vpm est_tls_verify_depth note purpos check keyusag valu present client cert vpm x509_purpose_ssl_cli ssl_ctx_set1_param ssl_ctx vpm vpm set singl use paramet applic request capabl ectx dh_tmp ssl_ctx_set_opt ssl_ctx ssl_op_single_dh_us ssl_ctx_set_tmp_dh ssl_ctx ectx dh_tmp dh_free ectx dh_tmp ectx dh_tmp null ectx enable_srp est_log_info enabl tls srp mode ""); ssl_ctx est_log_err fail set ssl cipher suit ""); return set applic specif handler provid srp paramet user authent ssl_ctx ectx est_srp_username_cb els est_log_info tls srp enabl ""); set tls cipher suit allow disabl anonym null cipher ssl_ctx est_cipher_list est_log_err fail set ssl cipher suit ""); return ssl_ctx_use_certif ssl_ctx ectx server_cert est_log_err unabl set server certif ""); return ssl_ctx_use_priv key ssl_ctx ectx server_priv_key est_log_err unabl set server privat key ""); return need includ cert chain server certif tls certif messag server reason est draft specifi subordin cert includ cacert messag flow henc client alreadi full cert chain therfor tls handshak contain server cert full chain ctx ssl_ctx ctx est_ctx http_cert_fil return dynam load ssl librari set ctx ssl_ctx pointer static void struct mg_connect conn conn path_info conn request_info ev_data null conn num_bytes_s conn consumed_cont conn status_cod conn must_clos conn request_len dynam load ssl librari set ctx ssl_ctx pointer static int is_valid_uri const char uri conform http :// www org protocol rfc2616 rfc2616 sec5 html sec5 uri asterisk (*) start slash return uri uri uri dynam load ssl librari set ctx ssl_ctx pointer static void process_new_connect struct mg_connect conn struct mg_request_info conn request_info int keep_alive_en keep_al discard_len const char keep_alive_en conn ctx enable_keepal keep_al import new connect reset receiv buffer credit goe crule42 conn data_len conn conn request_len read_request null conn conn buf conn buf_siz conn data_len assert conn request_len conn data_len conn request_len conn request_len conn data_len conn buf_siz send_http_error conn 413 request larg """"); return conn request_len return remot end close connect parse_http_request conn buf conn buf_siz is_valid_uri uri put garbag access log send back client send_http_error conn 400 bad request cannot pars http request [%.* ]"", conn data_len conn buf conn must_clos els strncmp http_version strncmp http_version request seem valid http version strang send_http_error conn 505 http version support """"); log_access conn els request valid handl get_head content length "")) null conn content_len strtoll null els mg_strcasecmp request_method post mg_strcasecmp request_method put "")) conn content_len els conn content_len ensur content length valu size est code will accept conn content_len est_max_content_len est_log_warn http request content length greater est maximum support content length )"", est_max_content_len send_http_error conn 413 content length larg """"); log_access conn els conn content_len est_log_warn http request content length negat valu ""); send_http_error conn 400 bad request content length negat conn data_len conn buf log_access conn els conn birth_tim time null handle_request conn log_access conn note lsm order import should_keep_al call use pars request invalid memmov therefor memor should_keep_al result later use loop exit condit keep_al should_keep_al conn discard buffer data request discard_len conn content_len conn request_len conn content_len int64_t conn data_len int conn request_len conn content_len conn data_len conn data_len discard_len memmove_ conn buf max_request_s conn buf discard_len conn data_len discard_len conn data_len discard_len assert conn data_len assert conn data_len conn buf_siz conn ctx stop_flag keep_alive_en conn content_len keep_al /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx int struct mg_connect conn struct socket accept socklen_t len char ipstr inet6_addrstrlen int port struct sockaddr_storag addr int ssl_err err_cod est_error est_err_non int ctx est_log_err null est context ""); return est_err_no_ctx ctx mg_ctx est_log_err null est context ""); return est_err_no_ctx accept sock accept next null len sizeof struct sockaddr_storag getpeernam struct sockaddr *)& addr len est_log_err getpeernam fail ""); never happen sure would caus return est_err_unknown deal ipv4 ipv6 addr ss_famili af_inet memcpy_ accept rsa sin sizeof struct sockaddr_in addr sizeof struct sockaddr_in )); port ntoh accept rsa sin sin_port inet_ntop af_inet accept rsa sin sin_addr ipstr sizeof ipstr els af_inet6 memcpy_ accept rsa sin6 sizeof struct sockaddr_in6 addr sizeof struct sockaddr_in6 )); port ntoh accept rsa sin6 sin6_port inet_ntop af_inet6 accept rsa sin6 sin6_addr ipstr sizeof ipstr est_log_info peer address ipstr est_log_info peer port port conn struct mg_connect calloc sizeof conn max_request_s conn null cri ctx mg_ctx cannot creat new connect struct oom ""); return est_err_malloc els conn buf_siz max_request_s conn buf char *)( conn conn client accept conn birth_tim time null conn ctx ctx mg_ctx conn read_timeout ctx server_read_timeout fill port info earli even ssl setup fail error handler would correspond info conn request_info remote_port ntoh conn client rsa sin sin_port memcpy_ conn request_info remote_ip conn client rsa sin sin_addr s_addr conn request_info remote_ip ntohl conn request_info remote_ip conn request_info is_ssl est requir tls setup tls tunnel conn ssl ssl_new conn ctx ssl_ctx conn ssl null ssl_set_fd conn ssl conn client sock ssl_err ssl_accept conn ssl ssl_err err_cod ssl_get_error conn ssl ssl_err switch err_cod case ssl_error_syscal est_log_err open ssl system call error ""); est_err_syscal break case ssl_error_ssl unknown open ssl error dump open ssl error log learn ossl_dump_ssl_error (); est_err_unknown break case ssl_error_want_read case ssl_error_want_writ est_log_info app use non block socket ""); process_new_connect conn break case est_log_err ssl_accept error want lookup ""); est_err_unknown break case ssl_error_non default break els process_new_connect conn ssl_err ssl_shutdown conn ssl switch ssl_err case open ssl doc say call shutdown case ssl_shutdown conn ssl est_log_info two phase ssl_shutdown initi ""); break case noth shutdown work est_log_info ssl_shutdown succeed ""); break default log error est_log_warn ssl_shutdown fail ""); break ssl_free conn ssl conn ssl null memzero_ conn sizeof conn max_request_s free conn return /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error static void free_context struct mg_context ctx dealloc ssl context ctx ssl_ctx null ssl_ctx_free ctx ssl_ctx dealloc context free ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error void mg_stop struct mg_context ctx ctx stop_flag free_context ctx defin _win32 defin __symbian32__ void wsacleanup (); endif _win32 /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error struct mg_context mg_start void user_data struct mg_context ctx defin _win32 defin __symbian32__ wsadata data wsastartup makeword data initi critic section global_log_file_lock endif _win32 alloc context initi reason general case default todo lsm proper error handl ctx struct mg_context calloc sizeof ctx ))) null return null ctx user_data user_data ctx est_ctx est_ctx user_data ctx enable_keepal set_ssl_opt ctx free_context ctx return null return ctx /*! brief use applic process est request applic respons open listen socket est request come socket applic use function hand request lib est param ctx pointer est_ctx provid est_server_init est_proxy_init invok param file descriptor read retriev http request client typic tcp socket file descriptor use applic incom est request need process request would cacert simpleenrol reenrol csrattr request use implement est server applic respons open listen tcp socket incom est request data readi read socket api entri point use allow lib est read request socket respond request return est_error est_error est_ctx ctx char csr_data int csr_len void http_ctx char http_hdr est_http_hdr_max int hdrlen csr_len csr_data send http 200 header snprintf http_hdr est_http_hdr_max est_http_hdr_200 est_http_hdr_eol est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_ct est_http_ct_csrattr est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_c est_http_ce_base64 est_http_hdr_eol hdrlen strnlen_ http_hdr est_http_hdr_max snprintf http_hdr hdrlen est_http_hdr_max est_http_hdr_cl csr_len est_http_hdr_eol est_http_hdr_eol mg_write http_ctx http_hdr strnlen_ http_hdr est_http_hdr_max ))) free csr_data return est_err_http_writ send csr bodi mg_write http_ctx csr_data csr_len free csr_data return est_err_http_writ free csr_data els csr_data free csr_data send 204 respons indic server csr est_send_http_error ctx http_ctx est_err_http_no_cont return est_err_non","[ 2.31978204e-02 -1.14786230e-01 -2.69795746e-01  6.51546987e-03
  3.40447575e-02  9.36617553e-02  2.47893289e-01  6.26544207e-02
 -1.38401343e-02 -1.06274642e-01 -6.78405762e-02 -3.86850648e-02
 -1.73026603e-02  9.95008126e-02 -8.72873738e-02  3.19836549e-02
  2.19697738e-03  9.79658589e-02  8.79186168e-02  5.35206161e-02
  1.89503487e-02  6.99304864e-02  7.96700548e-03  9.41005722e-02
  2.16429964e-01  1.91979468e-01  1.75699107e-02  1.47812083e-01
 -4.82626930e-02  5.02374470e-02  2.46946644e-02 -6.53545856e-02
 -3.27396281e-02 -1.52497068e-01  1.51304647e-01 -9.39227175e-03
  5.93021438e-02  1.08051166e-01 -4.13811654e-02 -1.08989790e-01
  2.00418101e-04 -8.91248956e-02 -3.89357321e-02 -4.07590866e-02
  6.49973676e-02  1.07444011e-01  1.03559271e-01 -5.79529740e-02
  1.07417293e-01 -1.79897457e-01 -3.62904184e-02 -9.30461213e-02
 -7.27795511e-02  7.61521831e-02 -2.93873623e-02 -1.52336853e-03
 -6.54952675e-02 -4.03385572e-02  1.56087562e-01 -1.22641668e-01
 -1.36664165e-02  1.27543730e-03  2.11658210e-01  1.17112227e-01
  2.41319016e-02 -4.91394103e-02 -2.10546434e-01  4.06668074e-02
  5.55888452e-02 -5.73357232e-02 -1.03868738e-01  1.11337982e-01
 -1.54522642e-01  5.82905561e-02 -6.25813231e-02 -5.49915321e-02
 -5.23708239e-02 -7.03058168e-02  1.57516688e-01  1.08537287e-03
  1.31793246e-01 -9.15601701e-02  6.33344725e-02 -3.50347236e-02
  7.28789717e-02 -8.61717835e-02 -7.26431310e-02  3.84189412e-02
 -1.28702864e-01 -3.10225636e-02  7.86217153e-02 -1.17940873e-01
 -5.02822138e-02 -4.63090576e-02 -3.47401276e-02 -5.11340722e-02
 -5.62962182e-02  1.17372453e-01 -1.59793988e-01  9.73655283e-02]","[-0.01663938 -0.12135821 -0.279722    0.00970804  0.06994198  0.10897515
  0.2125138   0.08565843 -0.05537551 -0.10886049 -0.04230729 -0.05063778
 -0.02240045  0.08708676 -0.08453611 -0.03050391 -0.02502253  0.10232614
  0.07982667 -0.02986115 -0.02983751  0.06253053  0.00794772  0.10466386
  0.22565909  0.15377058  0.04029627  0.09748404 -0.03443026  0.02683572
  0.07258586 -0.08462194 -0.06505586 -0.14490324  0.13834825 -0.01647656
 -0.00676085  0.08987422 -0.06718194 -0.08342964 -0.05549103 -0.10494792
 -0.03431161  0.02148569  0.02222126  0.12916024  0.05192045 -0.00865496
  0.0943559  -0.1750491  -0.00375808 -0.08883944 -0.01404432  0.1352132
 -0.05491792 -0.07138784 -0.05864261 -0.01107119  0.17191273 -0.14854969
 -0.02113119 -0.03042011  0.2423489   0.15282284 -0.00120576 -0.03818428
 -0.16946559  0.04472822  0.03563915 -0.03341981 -0.06370419  0.07646564
 -0.12854855  0.0655768  -0.00079198 -0.0060563  -0.03376019 -0.09338019
  0.09347238 -0.02329838  0.09037989 -0.06510089  0.08719632 -0.01981877
  0.0475559  -0.06356998 -0.07289422  0.02613775 -0.10055043 -0.01694768
  0.09641165 -0.10684197 -0.09691048 -0.01834167 -0.02913173 -0.02439634
 -0.01968607  0.17546472 -0.17345122  0.0428595 ]",0.3743214942185245,0
req,src,test_data/LibEST_semeru_format/requirements/RQ38-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir simpl enrol enrol respons enrol success server respons must contain http respons code content type applic pkcs mime success respons must cert cmc simpl pki respons defin rfc contain certif issu http content type applic pkcs mime smime type paramet cert use specifi rfc server must answer suitabl http rfc error code problem occur simpl pki respons http content type applic pkcs mime see section may includ respons data convey error respons content type set respons data must plaintext human readabl error messag contain explanatori inform describ request reject exampl indic csr attribut incomplet server respond http rfc indic request accept process respons yet avail server must includ retri header defin http respons server also may includ inform human readabl content client must wait least specifi retri time repeat request client repeat initi enrol request appropri retri interv expir client log inform end user event server respons maintain state necessari recogn handl retri oper client stateless regard simpli send request repeat receiv differ respons code return code handl specifi http rfc client close tls connect wait retri time expir client initi new tls connect perform applic secur check client alreadi generat csr includ link ident pop inform section csr need recreat incorpor tls uniqu new redirect session note key pair need regener process interfac burden client est server administr advis take consider est client may also make certif respons associ privat key avail end entiti softwar use end entiti certif,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 2.60162316e-02 -1.15243517e-01 -2.68985897e-01  3.89979943e-03
  3.22336070e-02  9.67861116e-02  2.52314925e-01  5.98994941e-02
 -1.68040451e-02 -1.09637395e-01 -7.19415918e-02 -3.99656780e-02
 -1.98316369e-02  9.33375955e-02 -8.85187462e-02  3.70184593e-02
  1.84732990e-03  9.37291011e-02  9.05560777e-02  5.54151013e-02
  2.42765937e-02  6.69588670e-02  7.24519091e-03  9.32773501e-02
  2.23536626e-01  1.92325026e-01  1.40737845e-02  1.49025112e-01
 -4.85690273e-02  5.07280491e-02  2.05508992e-02 -6.89596534e-02
 -2.92262845e-02 -1.43886313e-01  1.45852000e-01 -1.43732615e-02
  6.18595555e-02  1.11636691e-01 -4.15958799e-02 -1.02186508e-01
  2.72000069e-03 -8.32299739e-02 -3.40227261e-02 -4.85698283e-02
  6.06528558e-02  1.07573964e-01  1.02394573e-01 -5.57830594e-02
  1.08940788e-01 -1.83902442e-01 -4.03380878e-02 -9.12143365e-02
 -7.59458989e-02  7.15928003e-02 -3.06235738e-02 -5.81278982e-06
 -6.81577995e-02 -4.01532352e-02  1.57574117e-01 -1.14927195e-01
 -7.85856601e-03  4.68323845e-03  2.12032318e-01  1.15444124e-01
  1.92030594e-02 -5.10454141e-02 -2.09209427e-01  4.30526435e-02
  4.54858243e-02 -6.52366951e-02 -1.14444010e-01  1.12576976e-01
 -1.50505409e-01  5.87717518e-02 -6.06237501e-02 -4.90748845e-02
 -5.25093116e-02 -6.65929988e-02  1.56021312e-01 -1.47826748e-03
  1.36956453e-01 -9.33287665e-02  6.90785274e-02 -2.56693885e-02
  6.82770461e-02 -8.66072550e-02 -7.27254376e-02  4.00673710e-02
 -1.35501638e-01 -3.15742120e-02  7.41241649e-02 -1.16722263e-01
 -5.37960753e-02 -4.77882028e-02 -3.07618398e-02 -4.59676310e-02
 -6.08017705e-02  1.22683033e-01 -1.65270954e-01  9.61328670e-02]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.34563117952203964,0
req,src,test_data/LibEST_semeru_format/requirements/RQ40-pre.txt,test_data/LibEST_semeru_format/source_code/est_ossl_util.h,requir full cmc request http post fullcmc valid full pki request server must reject messag http content type use applic pkcs mime smime type paramet cmc request specifi rfc bodi messag binari valu encod pki request content transfer encod base rfc,int ossl verifi int store ctx ctx libest test api void ossl dump ssl error void est error ossl init cert store store store unsign char raw int size,"[ 3.31680961e-02 -1.09561153e-01 -2.68568397e-01  2.37767425e-04
  3.33783962e-02  9.65451896e-02  2.52346873e-01  6.12566657e-02
 -6.83800830e-03 -1.12069331e-01 -7.14952350e-02 -4.07509990e-02
 -1.47267375e-02  9.90439281e-02 -8.92788023e-02  4.46578301e-02
 -5.72738284e-03  9.85863283e-02  9.12647992e-02  6.06227145e-02
  2.19066795e-02  7.30349645e-02  7.30477972e-03  9.10852402e-02
  2.21028283e-01  2.00857237e-01  1.56332124e-02  1.54753238e-01
 -5.49394339e-02  5.89441024e-02  1.39411455e-02 -6.94569945e-02
 -2.41238903e-02 -1.53245836e-01  1.53422415e-01 -1.88801717e-02
  6.56609833e-02  1.09690443e-01 -3.77843194e-02 -1.13284960e-01
  2.35931342e-03 -8.86012316e-02 -3.72381434e-02 -5.00572771e-02
  6.61972910e-02  1.07987843e-01  1.13125801e-01 -6.54744655e-02
  1.06814340e-01 -1.89130858e-01 -4.63803560e-02 -9.17774439e-02
 -7.48868138e-02  6.78933039e-02 -3.24718319e-02  9.36878566e-03
 -6.18498549e-02 -3.91116180e-02  1.55523777e-01 -1.18827656e-01
 -1.18092746e-02  3.32569703e-03  2.04179272e-01  1.17506154e-01
  2.49034110e-02 -4.30628993e-02 -2.18112126e-01  4.51110452e-02
  5.19152917e-02 -6.40306473e-02 -1.06978685e-01  1.15810812e-01
 -1.54294774e-01  5.59741445e-02 -6.68439493e-02 -5.56377918e-02
 -5.39109372e-02 -6.56110197e-02  1.60431534e-01  1.11163722e-03
  1.29392907e-01 -1.00717850e-01  6.43804967e-02 -3.09858229e-02
  7.69515261e-02 -8.96500126e-02 -7.70879537e-02  4.44716923e-02
 -1.38319999e-01 -2.86600087e-02  8.06313604e-02 -1.18195809e-01
 -5.23767993e-02 -4.55874465e-02 -2.78428383e-02 -5.93711808e-02
 -6.40961230e-02  1.13241263e-01 -1.65623546e-01  9.51777995e-02]","[-3.32884416e-02 -1.27662703e-01 -2.79828310e-01  5.80133311e-03
  6.43268228e-02  1.03074744e-01  2.14966252e-01  6.60702139e-02
 -7.85031915e-02 -8.58116224e-02 -4.89064455e-02 -4.54016812e-02
 -3.50504331e-02  7.81022385e-02 -8.51701126e-02 -4.31111641e-02
 -1.43419495e-02  8.63216594e-02  8.00839439e-02 -5.96548319e-02
 -3.35270874e-02  5.42765968e-02 -1.53618690e-03  9.97250006e-02
  2.21757606e-01  1.44508734e-01  2.97749359e-02  9.53684822e-02
 -1.38290357e-02  2.61135083e-02  6.73204586e-02 -7.80463517e-02
 -7.40294531e-02 -1.17273666e-01  1.25188559e-01 -1.86110064e-02
 -1.73459444e-02  8.57384130e-02 -7.10445195e-02 -6.99145049e-02
 -5.70689812e-02 -9.25302655e-02 -1.81697085e-02  2.58753784e-02
  4.22456441e-03  1.32250607e-01  2.52796076e-02  1.20715918e-02
  1.00857124e-01 -1.75514713e-01  7.28853466e-03 -9.01656672e-02
  6.84287661e-05  1.42916068e-01 -3.64756361e-02 -8.28685537e-02
 -6.90998882e-02 -5.78271784e-03  1.69050395e-01 -1.46098763e-01
 -1.19599076e-02 -4.28447016e-02  2.49336705e-01  1.46444991e-01
 -4.27160785e-03 -5.82108498e-02 -1.55882642e-01  4.36593667e-02
  2.77376771e-02 -3.03240996e-02 -7.65059143e-02  6.02095202e-02
 -1.25623688e-01  6.99399114e-02  1.62779465e-02  4.95273247e-03
 -4.01525758e-02 -1.00578167e-01  9.12162662e-02 -2.73536108e-02
  1.01810545e-01 -5.02358116e-02  9.73470807e-02 -9.18499660e-03
  3.33920047e-02 -6.09980337e-02 -6.28004223e-02  1.38998525e-02
 -9.23806950e-02 -2.97233351e-02  8.88039470e-02 -9.21974853e-02
 -9.68739688e-02 -3.19986381e-02 -2.76823603e-02 -1.23113375e-02
 -2.05206685e-02  1.97517261e-01 -1.74902141e-01  3.41759808e-02]",0.4841855436664998,0
req,src,test_data/LibEST_semeru_format/requirements/RQ7-pre.txt,test_data/LibEST_semeru_format/source_code/est_locl.h,requir certif less tls authent est client est server mutual authent use certif less tls cipher suit see section,libest test api void est log est log level lvl char format libest test api void est log backtrac void est char est get tls uid ssl ssl int client est libest test api est error est load cert est ctx ctx unsign char raw int size est libest test api est error est load trust cert est ctx ctx unsign char cert int cert len est void est log est log level lvl char format est libest test api void est log version void est void est hex str char dst unsign char src int len est int est base encod const char src int actual src len char dst int max dst len est libest test api int est base decod const char src char dst int max len est server int est http request est ctx ctx void http ctx char method char uri char bodi int bodi len const char est client libest test api est error est client connect est ctx ctx ssl ssl est client int est client send enrol request est ctx ctx ssl ssl buf mem bptr unsign char pkcs int pkcs len int reenrol est client libest test api void est client disconnect est ctx ctx ssl ssl est client libest test api int ssl_ctx ctx x509 cert evp_pkey key est_client est_error est_ctx ctx const char uid const char pwd est_client_http est_error est_io_get_respons est_ctx ctx ssl ssl est_oper unsign char buf int payload_len est_proxi libest_test_api est_error est_ctx ctx void http_ctx char method char uri char bodi int body_len const char est_proxi void proxy_cleanup est_ctx p_ctx est_proxi est_error const char int len int offset est_proxi est_error est_is_challeng password_pres const char base64_ptr int b64_len int offset est_proxi est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len est_proxi libest_test_api est_error est_ctx ctx unsign char cacerts_rtn int cacerts_rtn_len est_proxi est_error est_ctx ctx char csr_data int csr_len void http_ctx est_proxi void est_http_auth_hdr auth_cr est_proxi est_error est_parse_uri char uri est_oper oper char path_seg est_proxi est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len est_proxi est_oper est_parse_oper char op_path est_proxi int est_strcasecmp_ char char,"[ 0.03959643 -0.11830101 -0.2548828   0.01077982  0.00566081  0.09178946
  0.25971216  0.04032584 -0.01340001 -0.10547499 -0.08484469 -0.03508832
 -0.02130948  0.08159896 -0.09337157  0.07070144  0.02650197  0.08629522
  0.09763462  0.09383267  0.05902656  0.05236711  0.00729992  0.08250453
  0.22394     0.19479032  0.00099752  0.16204035 -0.04796796  0.05053836
  0.00327445 -0.05890686 -0.00805137 -0.12360201  0.12266038 -0.01281946
  0.09161752  0.12744492 -0.03215759 -0.08461346  0.03541954 -0.06501617
 -0.02536058 -0.07928493  0.06529344  0.09452287  0.11429387 -0.07060181
  0.11798905 -0.17435278 -0.05373984 -0.08460791 -0.10178212  0.03956879
 -0.0179163   0.0252831  -0.0794533  -0.05085371  0.14963865 -0.08974943
  0.00263307  0.02504253  0.19634888  0.09015577  0.01737419 -0.06786606
 -0.21300258  0.04589445  0.03202966 -0.08856383 -0.1474802   0.12405513
 -0.15006101  0.06020238 -0.0760394  -0.05127401 -0.05193676 -0.03719536
  0.16823769  0.0072549   0.1711231  -0.09984331  0.06470174 -0.00642119
  0.05870793 -0.09075157 -0.07222641  0.03837254 -0.15819725 -0.04176787
  0.05399001 -0.11535335 -0.0443685  -0.06771926 -0.02842074 -0.03458875
 -0.07419587  0.11946263 -0.15156278  0.11259974]","[-0.04279312 -0.12860508 -0.2682275   0.00651777  0.06761134  0.10075321
  0.19327135  0.07253479 -0.08019505 -0.07878385 -0.03928425 -0.05379372
 -0.03128714  0.07157784 -0.08119685 -0.05132989 -0.02135723  0.08578855
  0.08016171 -0.07392414 -0.03866147  0.05099482  0.00059921  0.10037455
  0.21343507  0.1359197   0.03763928  0.08527809 -0.02036284  0.02110767
  0.07529008 -0.0850557  -0.07728016 -0.11411411  0.11654183 -0.02063316
 -0.02242872  0.07942173 -0.06983235 -0.06751972 -0.06173921 -0.09773593
 -0.01759825  0.0415915   0.00079642  0.12944834  0.0214136   0.0153671
  0.09950773 -0.16557862  0.01264235 -0.08277611  0.01367615  0.15351047
 -0.04277038 -0.08799963 -0.06382272  0.00715956  0.16357236 -0.14331488
 -0.01559081 -0.04720168  0.24696277  0.14802878 -0.01057122 -0.04721839
 -0.14379363  0.03814724  0.02979356 -0.02099092 -0.05314862  0.05604862
 -0.1218425   0.06890614  0.01993041  0.00822395 -0.03234107 -0.09720962
  0.07385144 -0.03118632  0.09056862 -0.04738585  0.09649505 -0.00711995
  0.03353021 -0.05953099 -0.05886029  0.01989055 -0.08477905 -0.02547711
  0.09850704 -0.08270413 -0.10252641 -0.02100399 -0.02978269 -0.01275631
 -0.01164542  0.20693138 -0.16616853  0.01751939]",0.6046133392302007,0
req,src,test_data/LibEST_semeru_format/requirements/RQ48-pre.txt,test_data/LibEST_semeru_format/source_code/est.c,requir csr attribut request est client request list desir csr attribut send https get messag est server oper path csrattr,"static void est log func char list null default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est logger stderr char format list ifndef win flockfil stderr endif vfprintf stderr format fflush stderr ifndef win funlockfil stderr endif default logger routin dump log data stderr applic overrid call est init logger pass function pointer function implement prototyp static void est log msg char format list argument pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth void est log est log level lvl char format list argument check user interest log messag lvl est desir log lvl return pull argument stack invok logger function start argument format est log func null est log func format argument els est logger stderr format argument end argument global function call log someth static void print stack trace void unsign int void stack unsign short frame symbol info symbol handl process process get current process sym initi process null true frame captur stack back trace stack null symbol symbol info calloc sizeof symbol info sizeof char symbol max name len 255 symbol size struct sizeof symbol_info frame ++) sym addr process dword64 stack ]), symbol est_log_msg (""\ frame symbol address symbol name free symbol global function call log someth void est_log_backtrac void ifndef disable_backtrac ifdef win32 spit backtrac enabl global est_backtrace_en print stack trace (); els void callstack 128 char strs int frame spit backtrac enabl global est_backtrace_en frame backtrac callstack 128 strs backtrace_symbol callstack frame frame est_log_msg (""\ strs ]); fprintf stderr strs ]); est_log_msg (""\ ""); free strs endif win32 endif disable_backtrac /*! brief est_get_vers allow applic retriev lib est version string return char array contain full version string valu librari return const char const char est_get_vers void return est_ver_str /*! brief est_get_api_level allow applic retriev lib est api level numer valu indic api level librari new version lib est releas api chang valu increment applic use determin capabl lib est librari attempt return int int est_get_api_level void return est_api_level use log lib est version inform log messag also log compil time run time open ssl version void est_log_vers void est_log_info (""% api level )"", est_get_vers (), est_get_api_level ()); ifdef source_revis est_log_info sourc repositori revis source_revis endif est_log_info compil openssl_version_text est_log_info link ssleay_vers ssleay_vers )); /*! brief est_init_logg allow applic overrid default log handler est log messag param lvl set desir log level est_log_level param loggerfunc set callback function handl log function allow applic use est provid function log est messag est provid default handler send messag stderr applic may desir send messag syslog log facil applic would provid function pointer use method intercept handl est log messag set global librari impact context return est_error est_error est_init_logg est_log_level lvl void loggerfunc char va_list initi logger loggerfunc est_log_func loggerfunc els instal default logger est_log_func est_logger_stderr set desir log level est_desired_log_lvl lvl return est_err_non /*! brief est_enable_backtrac allow applic toggl whether stack trace display warn error log messag come lib est param enabl set zero disabl stack trace non zero enabl stack trace log facil function allow applic enabl stack trace may use troubleshoot lib est librari stack trace disabl default call function non zero argument enabl stack trace warn error log messag set global librari impact context return void void est_enable_backtrac int enabl est_backtrace_en enabl /*! brief helper function read char convert open ssl x509_req char data either pem der encod param csr char contain pem der encod x509 csr param csr_len length csr char der encod data may contain zero requir length provid applic layer param csr_format paramet specifi encod method csr char provid set either est_cert_format_pem est_cert_format_d function convert pem der encod char open ssl x509_req structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori x509_req data must free memori applic longer need call x509_req_fre (). return x509_req x509_req unsign char csr int csr_len est_cert_format csr_format x509_req req null bio unsign long err csr est_log_err csr may null ""); return null csr_len est_raw_csr_len_max est_log_err csr length greater maximum allow )"", est_raw_csr_len_max return null csr_format est_cert_format_pem csr_format est_cert_format_d est_log_err pem der encod format support .""); return null bio_new_mem_buf csr csr_len null est_log_err unabl open csr memori buffer ""); return null switch csr_format case est_cert_format_pem req null null null break case est_cert_format_d req d2i_x509_req_bio null break default est_log_err invalid csr format specifi .""); break check error pars input data req est_log_err error occur open ssl librari read csr data .""); err err_get_error (); est_log_err open ssl error string err_error_str err null )); bio_free_al return req /*! brief est_load_key helper function read char convert open ssl evp_pkey char data either pem der encod param key char contain pem der encod key pair param key_len length key char der encod data may contain zero requir length provid applic layer param key_format paramet specifi encod method key char provid set either est_format_pem est_format_d function convert pem der encod char open ssl evp_pkey structur function return null pem der data corrupt unabl pars open ssl librari function alloc memori evp_pkey data must free memori applic longer need call evp_pkey_fre (). return evp_pkey evp_pkey est_load_key unsign char key int key_len int format bio null evp_pkey pkey null key null est_log_err key data provid ""); return null bio_new_mem_buf key key_len null est_log_err unabl open provid key buffer ""); return null switch format case est_format_pem pkey pem_read_bio_priv key null null null break case est_format_d pkey d2i_priv key_bio null break default est_log_err invalid key format ""); bio_fre return null break bio_fre return pkey convert pem pkcs7 encod cert option appli base64 encod output use creat cach cacert respons return bio contain pkcs7 encod cert respons option base64 encod pass non zero valu do_base_64 argument caller function invok bio_free_al return valu avoid memori leak note bio_fre suffici static bio est_get_certs_pkcs7 bio int do_base_64 stack_of x509 cert_stack null pkcs7_sign p7s null pkcs7 null bio null bio b64 int buflen creat pkcs7 object pkcs7_new ()) null est_log_err pkcs7_new fail ""); goto cleanup creat pkcs7 sign object p7s pkcs7_signed_new ()) null est_log_err pkcs7_signed_new fail ""); goto cleanup set version asn1_integer_set p7s version est_log_err asn1_integer_set fail ""); goto cleanup creat stack x509 cert cert_stack sk_x509_new_nul ()) null est_log_err stack malloc fail ""); goto cleanup popul cert stack cert_stack est_log_err unabl load certif ""); ossl_dump_ssl_error (); goto cleanup creat bio receiv output bio_new bio_s_mem ()); est_log_err bio_new fail ""); goto cleanup add base64 encod need do_base_64 b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); goto cleanup bio_push b64 type obj_nid2obj nid_pkcs7_sign sign p7s p7s content type obj_nid2obj nid_pkcs7_data p7s cert cert_stack convert pem pkcs7 buflen i2d_pkcs7_bio buflen est_log_err pem_write_bio_pkcs7 fail ""); ossl_dump_ssl_error (); bio_free_al null goto cleanup void bio_flush cleanup need cleanup free p7s cert_stack alloc sinc link pkcs7_free return take raw char array conta certif read data load certif context pkcs7 cert store est context use respond cacert request requir pkcs7 encod function also load x509 store context use verifi peer est_error est_load_ca_cert est_ctx ctx unsign char raw int size bio cacert null bio unsign char retval server proxi mode may load cacert respons ctx est_mod est_client return est_err_bad_mod bio_new_mem_buf raw size null est_log_err unabl open raw cert buffer ""); return est_err_load_cacert convert cert pkcs7 encod char array use est server respond cacert request cacert est_get_certs_pkcs7 cacert est_log_err est_get_certs_pkcs7 fail ""); bio_fre return est_err_load_cacert ctx ca_certs_len int bio_get_mem_data cacert char **)& retval ctx ca_certs_len est_log_err fail copi pkcs7 data ""); bio_free_al cacert bio_fre return est_err_load_cacert ctx ca_cert malloc ctx ca_certs_len ctx ca_cert est_log_err malloc fail ""); bio_free_al cacert bio_fre return est_err_load_cacert memcpy_ ctx ca_cert ctx ca_certs_len retval ctx ca_certs_len bio_free_al cacert bio_fre return est_err_non take char array contain pem encod certif implicit explict cert decod load trusted_certs_stor member est context cert store use tls stack peer verif tls layer note includ defens code check null argument function part public api check alreadi perform est_error est_ctx ctx unsign char cert int certs_len est_error creat combin cert store context contain implicit explicit cert ctx trusted_certs_stor x509_store_new (); ctx trusted_certs_stor null est_log_err unabl alloc combin cert store ""); return ctx trusted_certs_stor ossl_verify_cb ossl_init_cert_stor ctx trusted_certs_stor cert certs_len est_err_non est_log_err unabl popul combin cert store ""); return return est_err_non /*! brief est_set_ex_data set applic specif data est context param ctx pointer est context param ex_data pointer applic specif data pass est callback return est_error function use link applic specif data est_ctx structur use applic bind applic specif data est oper lib est use applic specif data ex_data pointer pass back applic lib est invok enrol enrol csr attribut http auth callback lib est free memori referenc ex_data paramet est_destroy invok applic respons releas applic specif data est_error est_set_ex_data est_ctx ctx void ex_data ctx return est_err_no_ctx ctx ex_data est_log_warn ex_data alreadi set possibl memori leak ""); ctx ex_data ex_data return est_err_non /*! brief est_get_ex_data retriev applic specif data est context param ctx pointer est context return void function use attain refer applic specif data est_ctx structur data set invok est_set_ex_data earlier otherwis return null void est_get_ex_data est_ctx ctx ctx return null return ctx ex_data /*! brief est_destroy free est context param ctx pointer est context return est_error function use releas memori alloc est_ctx call last perform est oper use context est_error est_destroy est_ctx ctx ctx return est_err_no_ctx ctx trusted_certs_stor null x509_store_fre ctx trusted_certs_stor ctx ca_cert free ctx ca_cert ctx retrieved_ca_cert free ctx retrieved_ca_cert ctx retrieved_csrattr free ctx retrieved_csrattr ctx server_csrattr free ctx server_csrattr ctx enrolled_client_cert free ctx enrolled_client_cert ctx ca_chain_raw free ctx ca_chain_raw ctx uri_path_seg free ctx uri_path_seg ctx dh_tmp dh_free ctx dh_tmp free ssl context act client oper server expect web server free context ctx ssl_ctx ctx est_mod est_client )||( ctx est_mod est_proxi ))) ssl session cach mean ssl_get1_sess call need explict freed get ref count decrememnt ctx sess ssl_session_fre ctx sess ssl_ctx_free ctx ssl_ctx ctx est_mod est_proxi proxy_cleanup ctx final free est context free ctx return est_err_non routin use determin whether option need use use open ssl base64 decod take string input check contain newlin charact return open ssl use option return otherwis static int const char src int len int len base64 less byte problem open ssl sinc minimum line length base64 encod return start look newlin 64th posit len ++) src return return routin use decod base64 encod data pass base64 encod data pointer buffer receiv decod data length decod data return return valu zero negat error occur dst_size paramet maximum allow size decod data int est_base64_decod const char src char dst int dst_size bio b64 b64in int len int max_in decod base64 output alway smaller ratio determin max size input base size given output buffer make sure actual input buffer big max_in dst_size get length base64 encod data make sure big len strnlen_ src max_in len max_in est_log_err sourc buffer base64 decod loo larg destin buffer sourc buf len max input len max dest len len max_in dst_size return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return b64in bio_new_mem_buf char src len b64in null est_log_err bio_new fail attempt creat mem bio ""); ossl_dump_ssl_error (); return src len enabl newlin option input data contain newlin charact bad open ssl implicit bio_set_flag b64 b64in bio_push b64 b64in len bio_read b64in dst dst_size len est_log_warn bio_read fail decod base64 data )"", len els make sure respons null termin dst len bio_free_al b64in return len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data int est_base64_encod const char src int actual_src_len char dst int max_dst_len bio b64 bio int max_src_len int actual_dst_len int write_cnt buf_mem bptr null encod base64 output alway larger ratio determin max size input base size given output buffer make sure actual input buffer big max_src_len max_dst_len actual_src_len max_src_len est_log_err sourc buffer base64 encod loo larg destin buffer max sourc len actual_sourc len max_src_len actual_src_len return b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio_new bio_s_mem ()); null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); bio_free_al b64 return bio_push b64 ever insert new line bio_set_flag write sourc buffer bio get pointer result memori buffer side obtain result write_cnt bio_writ src actual_src_len void bio_flush bio_get_mem_ptr bptr write_cnt est_log_warn bio_writ fail encod base64 data )"", write_cnt els copi result base64 encod string make sure null termin return length memcpy_ dst max_dst_len bptr data bptr length dst bptr length actual_dst_len bptr length bio_free_al b64 return actual_dst_len routin use encod base64 data pass unencod data length sourc buffer pointer buffer receiv encod data length encod data return return valu zero error occur max_dest_len paramet maximum allow size encod data char est_get_tls_uid ssl ssl int is_client char finish max_finish bio bio null b64 null buf_mem bptr null int len char null rfc5929 state first finish messag use deriv tls uniqu session resumpt use server send first finish messag normal client send first finish messag is_client ssl_session_reus ssl is_client ssl_session_reus ssl ))) len int ssl_get_finish ssl finish max_finish els len int ssl_get_peer_finish ssl finish max_finish b64 bio_new bio_f_base64 ()); b64 null est_log_err bio_new fail attempt creat base64 bio ""); ossl_dump_ssl_error (); return bio bio_new bio_s_mem ()); bio null est_log_err bio_new fail attempt creat mem base bio ""); ossl_dump_ssl_error (); return void bio_flush bio bio bio_push b64 bio bio_writ bio finish len void bio_flush bio bio_get_mem_ptr bio bptr awar open ssl add newlin charact end base64 encod data bptr length est_tls_uid_len est_log_warn tls uid length mismatch )"", bptr length est_tls_uid_len els malloc est_tls_uid_len null est_log_err fail alloc buffer ""); return memcpy_ est_tls_uid_len bptr data est_tls_uid_len est_tls_uid_len est_log_info tls uid found ""); bio_free_al bio return util function convert hex valu string use http digest authent logic void est_hex_to_str char dst unsign char src int len static const char hex 0123456789abcdef len --; src ++) dst hex src dst hex src 0x0f dst /*! brief est_enable_crl use applic enabl check certif revoc list valid client tls peer certif tls handshak enabl ca_chain paramet provid either est_server_init est_client_init contain trust certif along crl entri crl entri appen end param ctx pointer est context crl check disabl default function must call invok est_server_init est_client_init prior perform est oper therefor disabl version method return est_error est_error est_enable_crl est_ctx ctx ctx est_log_err null context ""); return est_err_no_ctx ctx enable_crl return est_err_non est_asn1_sanity_test perform saniti test csr attribut string function oper asn hex string alreadi based64 return est_error presenc challeng password static est_error est_asn1_sanity_test const unsign char string long out_len int pop_pres int tag xclass nid long out_len_sav out_len long len const unsign char ostr string asn1_object a_object int max_len max_csrattr assum challeng password oid present pop_pres make sure long enough asn out_len min_asn1_csrattr return out_len asn1_get_object string len tag xclass out_len est_log_info saniti tag len out_len tag len out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid nid nid_pkcs9_challeng password est_log_info challeng password oid found ""); pop_pres signifiy max_len max_csrattrs_withpop asn1_object_fre a_object break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); out_len return est_err_bad_asn1_hex out_len_sav max_len return return est_err_non est_is_challeng password_pres take base64 encod asn string scan see challeng password includ return est_error presenc challeng password est_error est_is_challeng password_pres const char base64_ptr int b64_len int presenc assum presenc return data base64_ptr null b64_len return est_err_non return base64_ptr b64_len presenc )); base64 decod saniti test given attribut string return est_error presenc challeng password est_error const char int len int pop_pres unsign char der_ptr int der_len check smallest possibl base64 case saniti test check min max valu asn data len min_csrattr return der_ptr malloc len der_ptr return est_err_malloc der_len est_base64_decod char der_ptr len der_len est_log_err invalid base64 encod data ""); free der_ptr return est_err_bad_base64 est_asn1_sanity_test der_ptr der_len pop_pres est_err_non est_log_err invalid asn1 encod data )"", est_err_num_to_str )); free der_ptr return free der_ptr return est_err_non est_add_challeng password caller verifi challeng password configur includ add attribut saniti check need sinc est_is_challeng password_pres alreadi call est_error est_add_challeng password const char base64_ptr int b64_len char new_csr int pop_len const unsign char der_ptr char orig_ptr new_der null csrattr int der_len tag xclass new_len long len int enc_len der_ptr malloc b64_len der_ptr return est_err_malloc der_len est_base64_decod base64_ptr char der_ptr b64_len der_len est_log_err malform base64 data ""); free void der_ptr return est_err_malloc orig_ptr char der_ptr grab first one pop stuff void asn1_get_object der_ptr len tag xclass der_len tag v_asn1_sequ est_log_err malform asn hex leand sequenc ""); free orig_ptr return est_err_bad_asn1_hex len char der_ptr orig_ptr new_len der_len int len sizeof hex_chpw remov lead sequenc length copi new buffer 256 need byte seq header der_len len sizeof hex_chpw 256 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x82 new_der new_len new_der new_len 0xff memcpy_ new_der der_len unsign int len der_ptr der_len unsign int len 256 128 need byte seq header els der_len len sizeof hex_chpw 128 new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der 0x81 new_der new_len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); els need byte header els new_len new_der malloc new_len new_der free orig_ptr return est_err_malloc memzero_ new_der new_len new_der new_len der_len len memcpy_ new_der der_len rsize_t len der_ptr der_len rsize_t len )); new_der 0x30 memcpy_ new_der new_len sizeof hex_chpw )), sizeof hex_chpw hex_chpw sizeof hex_chpw )); csrattr malloc new_len csrattr free orig_ptr free new_der return est_err_malloc memzero_ csrattr new_len enc_len est_base64_encod const char new_der new_len char csrattr new_len enc_len est_log_err invalid base64 encod data ""); free orig_ptr free new_der free csrattr return est_err_bad_base64 new_csr csrattr pop_len int strnlen_ csrattr new_len est_log_info csr reconstitut attribut b64_len pop_len csrattr new_der free new_der orig_ptr free orig_ptr return est_err_non /*! brief add nid charact string x509_req attribut param req x509_req structur use csr request param nid nid attribut param string pointer nid string need param chtype type string use nid return est_error function use add csr attribut csr request est client est_error x509_req req int nid void string int chtype req null return nid return string null return mbstring_asc use today caller could pass valu chtype chtype mbstring_asc req nid chtype unsign char string est_log_warn error attribut ""); return est_err_x509_attr return est_err_non /*! brief decod base64 encod string der format asn hex param csrattr pointer base64 encod string param csrattrs_len base64 string length param der_ptr pointer pointer store der encod string param der_len pointer store der string length return est_error function use decod base64 encod csr attribut string der format also perform rang check input paramet est_error char csrattr int csrattrs_len unsign char der int len unsign char der_ptr int der_len return data csrattr null csrattrs_len return der null len null return check smallest possibl base64 case saniti test check min max valu asn data csrattrs_len min_csrattr return der_ptr malloc csrattrs_len der_ptr return est_err_malloc der_len est_base64_decod csrattr char der_ptr csrattrs_len der_len est_log_warn invalid base64 encod data ""); free der_ptr return est_err_bad_base64 der der_ptr len der_len return est_err_non /*! brief get attribut nid der encod string param der_ptr pointer pointer der encod string param der_len pointer der encod string length param new_nid pointer storag nid found return est_error function use find next nid der encod string nid found reach end string new_nid return zero est_err_bad_asn1_hex est_error unsign char der_ptr int der_len int new_nid int tag xclass nid int out_len_sav long out_len long len const unsign char string const unsign char ostr asn1_object a_object null der_ptr null return string der_ptr ostr der_ptr der_len null return out_len der_len out_len_sav der_len new_nid null return out_len asn1_get_object string len tag xclass out_len 0x80 return est_err_bad_asn1_hex switch tag case v_asn1_object a_object c2i_asn1_object null string len a_object null nid obj_obj2nid a_object est_log_info nid nid new_nid nid der_len out_len_sav int string ostr )); der_ptr unsign char string asn1_object_fre a_object return est_err_non break default adjust string pointer string len break case v_asn1_set case v_asn1_sequ break out_len out_len_sav string ostr )); return est_err_non walk auth_credenti structur overwrit free valu void est_http_auth_hdr auth_cr auth_cr null return auth_cr user openssl_cleans auth_cr user strnlen_ auth_cr user max_uidpwd )); free auth_cr user auth_cr user null auth_cr pwd openssl_cleans auth_cr pwd strnlen_ auth_cr pwd max_uidpwd )); free auth_cr pwd auth_cr pwd null auth_cr uri openssl_cleans auth_cr uri strnlen_ auth_cr uri est_uri_max_len )); free auth_cr uri auth_cr uri null auth_cr cnonc openssl_cleans auth_cr cnonc strnlen_ auth_cr cnonc max_nonc )); free auth_cr cnonc auth_cr cnonc null auth_cr qop openssl_cleans auth_cr qop strnlen_ auth_cr qop max_qop )); free auth_cr qop auth_cr qop null auth_cr openssl_cleans auth_cr strnlen_ auth_cr max_nc )); free auth_cr auth_cr null auth_cr nonc openssl_cleans auth_cr nonc strnlen_ auth_cr nonc max_nonc )); free auth_cr nonc auth_cr nonc null auth_cr respons openssl_cleans auth_cr respons strnlen_ auth_cr respons max_respons )); free auth_cr respons auth_cr respons null auth_cr auth_token openssl_cleans auth_cr auth_token strnlen_ auth_cr auth_token max_auth_token_len )); free auth_cr auth_token auth_cr auth_token null return given input string look four valid oper est_oper est_parse_oper char op_path est_oper oper est_strcasecmp_ op_path est_get_cacert oper est_op_cacert els est_strcasecmp_ op_path est_get_csrattr oper est_op_csrattr els est_strcasecmp_ op_path est_simple_enrol oper est_op_simple_enrol els est_strcasecmp_ op_path est_simple_reenrol oper els oper est_op_max return oper given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg char path_seg_end int path_seg_len uri parser state state uri uri parsed_uri est_error est_err_non int uriparse_rc errno_t safec_rc int diff path_seg null state uri parsed_uri uriparse_rc uri pars uri state uri uriparse_rc uri_success uri free uri member state uri return parsed_uri path head valid uri pars path prefix (/. well known est look see path segment extens determin oper uri path segment cur_seg parsed_uri path head char cur_seg_str char cur_seg text first int cur_seg_len char segment null safec_rc memcmp_ cur_seg_str well known diff diff safec_rc eok est_log_err uri path start safec_rc well_known_seg safec_rc uri free uri member state uri return cur_seg cur_seg next cur_seg_str char cur_seg text first safec_rc memcmp_ cur_seg_str est_segment_len est est_segment_len diff diff safec_rc eok est_log_err uri contain segment est_seg safec_rc uri free uri member state uri return next segment either segment extens oper cur_seg cur_seg next cur_seg_str char cur_seg text first anoth segment one use find end els walk one length cur_seg text last cur_seg_len char cur_seg text last cur_seg_str els cur_seg_len strnlen_ cur_seg_str cur_seg_len est_log_err path segment exceed maximum uri free uri member state uri return see current segment need put string cur_seg text last null cur_seg text last segment strndup cur_seg_str cur_seg_len els segment strndup cur_seg_str look see oper path come next cacert csrattr simpleenrol simplereenrol oper est_parse_oper segment oper est_op_max one known oper must path segment pars find end path segment determin length save away path_seg_end char cur_seg text last path_seg_end null path_seg_len path_seg_end cur_seg_str path_seg malloc cur_seg_len path_seg null free segment uri free uri member state uri return est_err_malloc safec_rc memcpy_ path_seg cur_seg_len segment cur_seg_len safec_rc eok est_log_err uri path seg could copi context ""); free segment free path_seg path_seg null uri free uri member state uri return *((* path_seg cur_seg_len path segment pars tri oper jump path segment next cur_seg_str cur_seg_str cur_seg_len oper est_parse_oper cur_seg_str oper est_op_max oper code suppos next free segment free path_seg path_seg null uri free uri member state uri return est_err_http_bad_req els one oper make sure end cur_seg text last null cur_seg text last est_log_err invalid path segment contain oper valu ""); free segment free path_seg path_seg null oper est_op_max uri free uri member state uri return free segment uri free uri member state uri return given input string look four valid oper est_error est_parse_uri char uri est_oper oper char path_seg est_error est_err_non path_seg null assum uri point well known est oper strncmp uri est_cacerts_uri est_uri_max_len oper est_op_cacert els strncmp uri est_uri_max_len oper est_op_simple_enrol els strncmp uri est_re_enroll_uri est_uri_max_len oper els strncmp uri est_csr_attrs_uri est_uri_max_len oper est_op_csrattr els oper est_op_max return store path segment context est_error est_store_path_seg est_ctx ctx char path_seg int path_segment_len reset might alreadi cach ctx uri_path_seg free ctx uri_path_seg ctx uri_path_seg null ctx uri_path_seg malloc strnlen_ path_seg path_segment_len ctx uri_path_seg null return est_err_malloc eok strncpy_ ctx uri_path_seg path_segment_len path_seg path_segment_len return ctx uri_path_seg path_segment_len return est_err_non store path segment context int est_strcasecmp_ char char errno_t safec_rc int diff safec_rc strcasecmp_ strnlen_ rsize_max_str diff safec_rc eok log encount safe error est_log_info strcasecmp_ error safec_rc return diff","[ 0.02002758 -0.12629412 -0.26697797  0.0034956   0.02461626  0.10127906
  0.25129998  0.06000828 -0.02672494 -0.1079785  -0.07595601 -0.04931965
 -0.02696041  0.08025389 -0.08667208  0.03605753  0.01440395  0.08650382
  0.09739792  0.05822663  0.04096767  0.05469621  0.00824327  0.09201299
  0.23467979  0.18412314  0.00747143  0.15159453 -0.04240852  0.04653342
  0.02637563 -0.07683077 -0.02884299 -0.12357812  0.12887454 -0.01404486
  0.07451217  0.12343709 -0.0407328  -0.08099362  0.02017124 -0.06972123
 -0.02995891 -0.05795939  0.05504693  0.10681709  0.09271178 -0.04990526
  0.11930827 -0.17942119 -0.03980168 -0.0897399  -0.08688195  0.06949901
 -0.027505   -0.00061127 -0.08535286 -0.04290544  0.15987721 -0.09457348
  0.00626497  0.01546233  0.21935037  0.10524669  0.01012975 -0.06153227
 -0.20000124  0.04297137  0.03431046 -0.07392709 -0.13515612  0.11984724
 -0.1505557   0.06548285 -0.06087423 -0.03773393 -0.04999869 -0.05378553
  0.15527998 -0.00671193  0.15815628 -0.08938377  0.0784928  -0.00864411
  0.06059305 -0.08556458 -0.06554455  0.04344543 -0.14902171 -0.04006366
  0.06310629 -0.11431018 -0.05935525 -0.05731422 -0.03694518 -0.03194145
 -0.06246174  0.13882542 -0.16407111  0.09793685]","[-2.12573297e-02 -1.31797388e-01 -2.81705827e-01  1.45685058e-02
  6.59227595e-02  1.15167320e-01  2.14660659e-01  8.90359804e-02
 -6.16065003e-02 -1.09690435e-01 -4.33355644e-02 -5.31716496e-02
 -2.50033587e-02  8.57558399e-02 -8.36674273e-02 -3.57467197e-02
 -1.57868825e-02  1.02175854e-01  8.15244019e-02 -2.57650316e-02
 -2.34373026e-02  5.62083721e-02  1.43441129e-02  1.07649647e-01
  2.32217014e-01  1.47953078e-01  3.82012092e-02  9.74330530e-02
 -3.03134583e-02  2.14150194e-02  8.46143216e-02 -8.67635906e-02
 -7.02345073e-02 -1.40537918e-01  1.35726839e-01 -1.09129939e-02
 -2.81579280e-03  9.32337716e-02 -7.20193386e-02 -7.09344447e-02
 -4.63711843e-02 -1.01071656e-01 -3.53644714e-02  1.91417281e-02
  2.33696830e-02  1.30419225e-01  4.73588631e-02 -5.39172580e-03
  9.90237668e-02 -1.70960203e-01 -1.24718150e-04 -9.15377438e-02
 -2.33110264e-02  1.37160122e-01 -5.67477942e-02 -7.58315697e-02
 -6.96910322e-02 -1.87042598e-02  1.74664944e-01 -1.44484535e-01
 -1.74463280e-02 -2.10985690e-02  2.48605385e-01  1.49385810e-01
 -6.59728702e-03 -4.44337614e-02 -1.65531009e-01  4.41612601e-02
  3.19002867e-02 -3.45180966e-02 -7.31009170e-02  8.17898586e-02
 -1.27056897e-01  7.01086745e-02 -2.11013295e-03 -2.52369163e-03
 -3.05813756e-02 -9.07025635e-02  9.61535275e-02 -2.60004085e-02
  1.01081438e-01 -6.14933297e-02  8.96838233e-02 -1.55180134e-02
  4.02589552e-02 -6.24234490e-02 -6.87172487e-02  2.50193495e-02
 -1.03044420e-01 -1.88913792e-02  9.07634795e-02 -1.11511886e-01
 -1.00846790e-01 -2.05500629e-02 -3.48879136e-02 -1.64361708e-02
 -1.53128523e-02  1.80926427e-01 -1.74799874e-01  5.22878058e-02]",0.3965898328989936,0
req,src,test_data/LibEST_semeru_format/requirements/RQ6-pre.txt,test_data/LibEST_semeru_format/source_code/est.h,requir certif tls authent est client previous instal certif issu third parti certif use authent client request certif est server recogn est server est client respond est server tls certif request messag exist certif alreadi held client est server verifi client exist certif author client request describ section,"file est est public api enrol secur transport novemb copyright cisco system inc right reserv ifndef header est defin header est ifdef win ifdef libest export defin libest api declspec dllexport els defin libest api declspec dllimport endif els defin libest api endif includ openssl ssl includ openssl engin includ openssl conf includ openssl srp ifdef cplusplus extern endif allow runtim check path segment support ifdef uripars defin path segment support enabl endif defin est max file len defin 255 defin est_portnum_len sizeof int defin est_portnum_len defin 4096 defin 128 typedef enum est_serv est_client est_proxi est_mod typedef enum est_client_proxy_non valu ore togeth defin defin defin defin foreach_est_error est_err_no_ctx est_err_no_csr est_err_no_cert est_err_no_key est_err_load_cacert est_err_bad_mod est_err_bad_pkcs10 est_err_http_writ est_err_http_bad_req est_err_http_no_cont est_err_http_lock est_err_no_ssl_ctx est_err_auth_fail est_err_auth_pend est_err_wrong_method est_err_x509_sign est_err_x509_v est_err_x509_cn est_err_x509_attr est_err_x509_pubkey est_err_malloc est_err_ssl_writ est_err_ssl_read est_err_ssl_new est_err_ssl_ctx_new est_err_ssl_connect est_err_pem_read est_err_ip_getaddr est_err_ip_connect est_err_no_certif est_err_syscal est_err_cacert_verif est_err_bad_x509 est_err_bad_base64 est_err_bad_asn1_hex est_err_srp_pwd_bad est_err_cb_fail est_err_unknown defin generate_enum enum enum defin generate_str string string /*! enum est_error brief enum use indic error condit applic layer lib est function return error indic enumer applic alway check return error indic grace handl error error occur lib est return est_err_non valu zero est_err_non error occur est_err_no_ctx est_ctx provid invok function est_err_no_csr pkcs10 csr provid invok function est_err_no_cert valid x509 certif provid invok function est_err_no_key evp_pkey provid invok function invalid argument provid function est_err_load_cacert certifict provid load certif chain trust certif load est_err_bad_mod est oper attempt use wrong mode oper valid mode client server proxi est oper may perform certain mode est_err_bad_pkcs10 pkcs10 csr receiv client corrupt est_err_http_writ error occur write http respons socket est server sent unsupport http status code respons http header could built correct est_err_http_bad_req http request bad report server http request inform current found server est_err_http_no_cont content request avail est_err_http_lock resourc access lock uri path segment pass invalid either long contain invalid charact build est support use addit path segment uri est need rebuilt uripars librari support path segment http content type header request invalid http content length header request specifi valu larg est_err_no_ssl_ctx applic provid valid ssl_ctx refer api est_err_auth_fail est server unabl authent est client authent failur due invalid challeng password pkcs10 csr est_err_auth_pend http authent challeng sent client respons yet arriv certif author unabl sign pkcs10 csr certif author request client retri enrol request futur like due configur automat enrol est_err_wrong_method invalid http method get post use request est_err_x509_sign error occur open ssl librari tri sign pkcs10 csr est_err_x509_v error occur open ssl librari tri set version pkcs10 csr est_err_x509_cn error occur open ssl librari tri set common name pkcs10 csr est_err_x509_attr error occur open ssl librari tri set x509 attribut pkcs10 csr est_err_x509_pubkey error occur open ssl librari tri set public key pkcs10 csr est_err_malloc unabl alloc malloc like indic critic failur host system est_err_ssl_writ error occur tls layer tri write socket est_err_ssl_read error occur tls layer tri read socket est_err_ssl_new error occur open ssl librari tri alloc ssl refer est_err_ssl_ctx_new error occur open ssl librari tri alloc ssl_ctx refer est_err_ssl_connect error occur open ssl librari tri establish tls session server error occur open ssl librari tri set allow tls cipher suit est_err_pem_read error occur open ssl librari tri read pem encod pkcs10 csr may due corrupt pkcs10 applic layer fail provid requir callback function request est oper est_err_ip_getaddr unabl resolv server host name est_err_ip_connect unabl connect request host port server name provid lib est invalid may null may exceed maximum server name length tcp port number provid lib est invalid must greater less 65536 certif privat key provid lib est could load privat key must match public key certif applic attempt use lib est api prior invok est_client_init (). certif receiv server invalid length buffer provid read data socket larg enough receiv respons server est server sent cacert respons exceed maximum size allow est_err_no_certif attempt made copi cert context prior est oper perform certif found trust certif list provid lib est est server name match fulli qualifi domain name server x509 certif est_err_syscal open ssl librari report system call error attempt establish tls session pkcs10 csr provid lib est alreadi contain signatur lib est requir csr sign sinc lib est respons sign csr pkcs10 csr receiv est client contain requir csr attribut invalid digest type request est_err_cacert_verif valid certif chain receiv est server fail invalid author token receiv invalid miss retri receiv server est_err_bad_x509 invalid corrupt x509 certif provid lib est est_err_bad_base64 invalid corrupt csr attribut base64 encod string provid est_err_bad_asn1_hex invalid corrupt csr attribut asn1 hex string provid csr attribut asn1 hex string short csr attribut asn1 hex string long srp strength request applic small srp user accept est_err_srp_pwd_bad srp password accept est_err_cb_fail applic layer call back facil fail lib est built libcurl support libcurl requir client proxi mode invalid proxi protocol specifi configur client mode http sock proxi invalid proxi authent mode specifi configur client mode http sock proxi est_err_last last error enum definit never use typedef enum est_err_non foreach_est_error generate_enum est_err_last est_error libest_api extern const char est_err_str []; defin est_err_num_to_str est_err_str typedef enum auth_non auth_bas auth_digest auth_token auth_fail est_http_auth_mod typedef enum http_auth_not_requir http_auth_requir est_http_auth_requir typedef enum est_cert_format_pem est_cert_format_d est_cert_format_max est_cert_format defin est_format_pem est_cert_format_pem defin est_format_d est_cert_format_d enum allow log filter desir detail level bitmask filter new log level order maintain base urgenc log messag typedef enum est_log_lvl_err est_log_lvl_warn est_log_lvl_info est_log_level defin max_realm 255 defin max_nonc defin max_uidpwd 255 defin max_nc defin max_qop defin max_respons defin min_csrattr defin max_csrattr 1024 defin min_asn1_csrattr defin max_csrattrs_withpop 1035 defin max_token_error 255 defin max_token_error_desc 255 defin max_auth_token_len 512 defin max_http_method_len follow valu defin minimum maximum default valu timeout valu ssl read oper valu use est client proxi oper defin defin 3600 defin /*! struct est_http_auth_hdr brief structur use pass http authent paramet applic lib est contain user databas authent user expect applic perform user authent extern authent server radius structur allow http authent credenti pass lib est http layer applic var est_http_auth_hdr mode contain http authent mode use basic digest var est_http_auth_hdr user contain user est client authent var est_http_auth_hdr pwd contain password est client authent http basic authent use var est_http_auth_hdr uri contain uri est client http digest authent var est_http_auth_hdr cnonc contain nonc est client http digest authent var est_http_auth_hdr qop contain oper est client http digest authent var est_http_auth_hdr contain nonc count est client http digest authent var est_http_auth_hdr nonc contain server nonc http digest authent var est_http_auth_hdr respons contain client digest valu verifi var est_http_auth_hdr auth_token contain client token valu verifi typedef struct est_http_auth_mod mode char user char pwd char uri char cnonc char qop char char nonc char respons char auth_token est_http_auth_hdr defin valid return code applic layer auth credenti callback function provid typedef enum /*! struct est_ctx brief structur use maintain state est oper behalf applic singl context use repres singl instanc either est client est server est proxi server none member structur public access applic use function provid lib est api manag context context creat use one est_client_init (), est_server_init (), est_proxy_init (). context longer need applic shoud invok est_destroy releas memori associ context typedef struct est_ctx est_ctx /*! typedef auth_credentials_cb brief typedef defin prototyp callback function resid applic code applic regist function callback use api function callback call est client librari requir http authent credenti callback function take input pointer est_http_auth_hdr structur callback function must look mode structur element determin type credenti requir mode set auth_bas auth_digest callback function must suppli user pwd valu mode set auth_token callback must suppli auth_token valu auth_token valu must base64 encod string repres access token typedef auth_credentials_cb est_http_auth_hdr auth_credenti begin public api prototyp libest_api est_error est_enable_crl est_ctx ctx libest_api est_error est_init_logg est_log_level lvl void loggerfunc char va_list )); libest_api int est_get_api_level void libest_api const char est_get_vers void libest_api void est_enable_backtrac int enabl libest_api est_error est_set_ex_data est_ctx ctx void ex_data libest_api void est_get_ex_data est_ctx ctx libest_api est_ctx est_server_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key libest_api est_ctx est_proxy_init unsign char ca_chain int ca_chain_len unsign char cacerts_resp_chain int est_cert_format cert_format char http_realm x509 tls_cert evp_pkey tls_key char uid char pwd libest_api est_error est_destroy est_ctx ctx libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api char est_http_auth_hdr char ha1 libest_api est_error est_server_start est_ctx ctx libest_api est_error est_server_stop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int ssl int void arg )); libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx char csrattr int crsattrs_len libest_api est_error est_ctx ctx int second libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int timeout est proxi specif function libest_api est_error est_proxy_start est_ctx ctx libest_api est_error est_proxy_stop est_ctx ctx libest_api est_error est_proxy_set_serv est_ctx ctx const char server int port libest_api est_error est_ctx ctx est_http_auth_mod amod libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx auth_credentials_cb follow function use est client libest_api est_ctx est_client_init unsign char ca_chain int ca_chain_len est_cert_format cert_format int cert_verify_cb x509 int )); libest_api est_error est_client_set_auth est_ctx ctx const char uid const char pwd x509 client_cert evp_pkey private_key libest_api est_error est_ctx ctx auth_credentials_cb libest_api est_error est_client_set_serv est_ctx ctx const char server int port char path_seg libest_api est_error est_client_set_proxi est_ctx ctx proxy_proto const char proxy_serv unsign short int proxy_port unsign int proxy_auth const char usernam const char password libest_api est_error est_ctx ctx char int pkcs7_len int ca_cert_len evp_pkey new_public_key libest_api est_error est_client_enrol est_ctx ctx char int pkcs7_len evp_pkey new_public_key libest_api est_error est_ctx ctx x509_req csr int pkcs7_len evp_pkey priv_key libest_api est_error est_client_reenrol est_ctx ctx x509 cert int pkcs7_len evp_pkey priv_key libest_api est_error est_ctx ctx unsign char pkcs7 libest_api est_error est_ctx ctx unsign char csr_data int csr_len libest_api est_error est_ctx ctx int ca_certs_len libest_api est_error est_ctx ctx unsign char ca_cert libest_api est_error est_ctx ctx int nid libest_api est_error est_ctx ctx int retry_delay time_t retry_tim libest_api est_error est_ctx ctx int timeout libest_api est_error est_ctx ctx libest_api est_error est_client_force_pop est_ctx ctx libest_api est_error est_ctx ctx libest_api est_error est_ctx ctx int strength char uid char pwd libest_api int est_ctx ctx follow callback entri point must set applic act est server proxi libest_api est_error est_set_ca_enroll_cb est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_ctx ctx int unsign char pkcs10 int p10_len unsign char pkcs7 int pkcs7_len char user_id x509 peer_cert char path_seg void ex_data )); libest_api est_error est_set_csr_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_cacerts_cb est_ctx ctx unsign char *(* int csr_len char path_seg void ex_data )); libest_api est_error est_set_http_auth_cb est_ctx ctx int est_ctx est_http_auth_hdr x509 char void *)); libest_api est_error est_ctx ctx est_http_auth_requir requir libest_api est_error x509_req req int nid void string int chtype libest_api est_error unsign char der_ptr int der_len int new_nid libest_api est_error char csrattr int csrattrs_len unsign char der_ptr int der_len follow helper function deal open ssl data type cert key etc libest_api x509_req unsign char csr int csr_len est_cert_format csr_format libest_api evp_pkey est_load_key unsign char key int key_len int format libest_api int unsign char certs_p7 int certs_len unsign char pem helper macro applic use initi initi open ssl /*! brief est_apps_startup use applic initi open ssl librari call first prior use function lib est api helper function invok crypto_malloc_init (), err_load_crypto_str (), open (), (), ssl_library_init (), ssl_load_error_str (). return void defin est_apps_startup crypto_malloc_init (); err_load_crypto_str (); open (); (); ssl_library_init (); ssl_load_error_str (); /*! brief est_apps_shutdown use applic initi open ssl librari call prevent memori leak open ssl librari helper function invok conf_modules_unload (), obj_cleanup (), evp_cleanup (), engine_cleanup (), (), err_remove_thread_st (), err_free_str (). return void defin est_apps_shutdown conf_modules_unload obj_cleanup (); evp_cleanup (); engine_cleanup (); (); err_remove_thread_st null err_free_str (); ifdef __cplusplus endif endif","[ 0.03336135 -0.1320621  -0.24791686  0.0161902  -0.00149749  0.08323964
  0.25690195  0.04022855 -0.0199005  -0.08632659 -0.08407857 -0.04365258
 -0.01915759  0.08083872 -0.09145287  0.06770914  0.03163309  0.07573559
  0.09723865  0.0891825   0.06202325  0.04929754  0.01859782  0.08960303
  0.21628743  0.19188015 -0.00419967  0.16839777 -0.04860105  0.04733262
  0.00916432 -0.05792055 -0.01578088 -0.1182408   0.11728891 -0.01082836
  0.10205691  0.11737028 -0.02816573 -0.08335603  0.04397466 -0.06035566
 -0.02160573 -0.0757631   0.0697391   0.08930182  0.11468749 -0.0761991
  0.13082378 -0.16831778 -0.04093226 -0.08649557 -0.1065883   0.04720293
 -0.01137789  0.02468503 -0.09026835 -0.05374527  0.14151046 -0.0829995
  0.00627264  0.03477372  0.19424681  0.07610234  0.01382056 -0.07049354
 -0.20753522  0.041525    0.04141736 -0.07924067 -0.13626626  0.12759413
 -0.15023287  0.05991717 -0.0854184  -0.06263626 -0.0493475  -0.02888985
  0.17404081  0.01299885  0.18441653 -0.09714717  0.06035195 -0.01210502
  0.06167167 -0.09822016 -0.06457833  0.04232753 -0.15559949 -0.04169976
  0.05620336 -0.11290348 -0.04097989 -0.06758145 -0.04066444 -0.03866674
 -0.06922665  0.12768416 -0.1456445   0.11799926]","[-0.01909254 -0.12634756 -0.2693117   0.01079768  0.05737694  0.10408145
  0.21264736  0.07581581 -0.05908141 -0.09585825 -0.04790805 -0.05077471
 -0.02448615  0.08003641 -0.08282716 -0.02321364 -0.01237942  0.09374221
  0.0824822  -0.02401425 -0.01667159  0.05478712  0.00920871  0.09919886
  0.22163105  0.14927457  0.03182295  0.10305413 -0.02828613  0.02534186
  0.06690932 -0.08108345 -0.06239051 -0.12835562  0.12402296 -0.01611642
  0.00600411  0.09169937 -0.06203287 -0.07080077 -0.03888169 -0.09145347
 -0.02713901  0.01192958  0.02162523  0.12265486  0.04741049 -0.01042539
  0.10095463 -0.16852419 -0.00428339 -0.08739041 -0.02073391  0.12596624
 -0.0448936  -0.06380367 -0.06948948 -0.01497025  0.16423658 -0.13291995
 -0.01312862 -0.02151887  0.23613079  0.13620164 -0.00393716 -0.0477731
 -0.16357832  0.04298642  0.03069054 -0.03757569 -0.07566328  0.07877167
 -0.12662953  0.06767587 -0.00551845 -0.00643268 -0.03169019 -0.08026452
  0.09935305 -0.02213535  0.10785958 -0.06358584  0.08730119 -0.01155018
  0.04092865 -0.0657919  -0.06631834  0.02476919 -0.1062335  -0.02334461
  0.0850902  -0.10192799 -0.09289146 -0.02725446 -0.03223599 -0.01914548
 -0.02260447  0.1793639  -0.16590212  0.05001483]",0.4838955299337889,0
