▁<%@ tag lib ▁prefix =" itrust " ▁uri ="/ W EB - INF / tags . tld " ▁%> ▁<%@ page ▁error Page ="/ auth / exception Handler . jsp " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . dao . DAOFactory "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . DiagnosisBean "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . action . Emergency ReportAction "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . PrescriptionBean "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . AllergyBean "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . ProcedureBean "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . dao . mysql . ReportRequestDAO " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . PatientBean " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . dao . mysql . PatientDAO " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . dao . mysql . PersonnelDAO " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . PersonnelBean " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . Email " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . EmailUtil " ▁%> ▁<%@ page ▁import =" java . util . List " ▁%> ▁<%@ page ▁import =" java . util . ArrayList " ▁%> ▁<%@ page ▁import =" java . util . Date " ▁%> ▁<%@ include ▁file ="/ global . jsp " ▁%> ▁<% ▁pageTitle ▁= ▁" iTrust ▁- ▁ER ▁Report "; ▁String ▁pidString ▁= ▁null ; ▁boolean ▁print ▁= ▁( null ▁ != ▁request . getParameter (" print ") ▁&& ▁request . getParameter (" print "). equals (" true ")); ▁if ▁(! print ) ▁{ ▁/* ▁Require ▁a ▁Patient ▁ID ▁first ▁*/ ▁pidString ▁= ▁( String ) session . get Attribute (" pid "); ▁if ▁( null ▁== ▁pidString ▁|| ▁1 ▁> ▁pidString . length ()) ▁{ ▁response . send Redirect ("/ iTrust / auth / getPatientID . jsp ? forward = hcp - er / e mergencyReport . jsp "); ▁return ; ▁} ▁else ▁{ ▁session . set Attribute (" print Pid ", ▁pidString ); ▁session . remove Attribute (" pid "); ▁} ▁} ▁else ▁{ ▁pidString ▁= ▁( String ) session . get Attribute (" print Pid "); ▁if ▁( null ▁== ▁pidString ▁|| ▁1 ▁> ▁pidString . length ()) ▁{ ▁response . send Redirect ("/ iTrust / auth / getPatientID . jsp ? forward = hcp - er / e mergencyReport . jsp "); ▁return ; ▁} ▁session . remove Attribute (" print Pid "); ▁} ▁/* ▁If ▁the ▁patient ▁id ▁does n ' t ▁check ▁out , ▁then ▁kick ▁' em ▁out ▁to ▁the ▁exception ▁handler ▁*/ ▁Emergency ReportAction ▁action ▁= ▁new ▁Emergency ReportAction ( prodDAO , ▁loggedInMID . longValue (), ▁pidString ); ▁/* ▁ Now ▁take ▁care ▁of ▁updating ▁information ▁*/ ▁%> ▁<% ▁if ▁( print ) ▁{ ▁%> ▁<%@ include ▁file ="/ print _ header . jsp " ▁%> ▁<%} ▁else ▁{%> ▁<%@ include ▁file ="/ header . jsp " ▁%> ▁ <%}%> ▁<% ▁if ▁(! print ) ▁{ ▁// ▁Generate ▁a ▁report ▁to ▁the ▁hcp ' s ▁of ▁this ▁patient . ▁// ▁TODO : ▁ possibly ▁change ▁this ▁to ▁use ▁messages ▁and ▁a ▁different ▁display ▁format ▁on ▁// ▁hcp ' s ▁ home ▁screen . ▁ ReportRequestDAO ▁make Report ▁= ▁new ▁ ReportRequestDAO ( prodDAO ); ▁PatientDAO ▁patients ▁= ▁new ▁PatientDAO ( prodDAO ); ▁PatientBean ▁patient ▁= ▁patients . getPatient ( action . get Pid ()); ▁PersonnelDAO ▁hcps ▁= ▁new ▁PersonnelDAO ( prodDAO ); ▁List < PersonnelBean > ▁p ee ps ▁= ▁hcps . getAll Personnel (); ▁List < String > ▁emails ▁= ▁new ▁ArrayList < String > (); ▁for ▁( PersonnelBean ▁p ▁: ▁p ee ps ) ▁{ ▁if ▁( patients . check DeclaredHCP ( patient . get MID (), ▁p . get MID ())) ▁{ ▁make Report . add ReportRequest ( p . get MID (), ▁patient . get MID (), ▁new ▁Date ()); ▁emails . add ( p . getEmail ()); ▁} ▁} ▁Email ▁myEmail ▁= ▁new ▁Email (); ▁myEmail . s etBody (" Patient ▁" ▁+ ▁patient . getF ullName () ▁+ ▁" ' s ▁medical ▁record ▁was ▁viewed ▁by ▁an ▁ER "); ▁myEmail . set Subject (" Patient ▁records ▁viewed "); ▁myEmail . s etToList ( email s ); ▁myEmail . set From (" no reply @ itrust . com "); ▁EmailUtil ▁emailer ▁= ▁new ▁EmailUtil ( prodDAO ); ▁emailer . sendEmail ( my Email ); ▁%> ▁< form ▁action =" e mergencyReport . jsp " ▁method =" post "> ▁< input ▁type =" hidden " ▁name =" print " ▁id =" print " ▁value =" true " ▁/> ▁< input ▁type =" submit " ▁value =" Print " ▁/> ▁</ form > ▁<%} ▁%> ▁< ul > ▁< li > Name : ▁<%= action . get PatientName ()%></ li > ▁< li > Age : ▁<%= action . getPatient Age ()%></ li > ▁< li > Gender : ▁<%= action . getPatient Gender ()%> ▁</ li > ▁< li > Emergency ▁Contact : ▁<%= action . getPatient Emergency Contact () ▁%></ li > ▁< li > Allergies : ▁<% ▁if ▁(0 ▁== ▁action . get Allergies (). size ()) ▁{ ▁%>< st rong > No ▁allergies ▁on ▁record </ st rong ><% ▁} ▁else ▁{ ▁%>< ul ><% ▁for ▁( ▁AllergyBean ▁bean : ▁action . get Allergies ()) ▁{ ▁out . print ("< li > " ▁+ ▁bean . get Description () ▁+ ▁" ▁" ▁+ ▁bean . getFirstFound Str () ▁+ ▁"</ li >"); ▁} ▁%></ ul ><% ▁} ▁%> ▁</ li > ▁< li > Blood ▁Type : ▁<%= action . get BloodType ()%> ▁</ li > ▁< li > Diagnoses : ▁<% ▁if ▁(0 ▁== ▁action . get Warning Diagnoses (). size ()) ▁{ ▁%>< st rong > No ▁ critical ▁diagnoses ▁on ▁record </ st rong ><% ▁} ▁else ▁{ ▁%>< ul ><% ▁for ( DiagnosisBean ▁bean ▁: ▁action . get Warning Diagnoses ()) ▁{ ▁out . print ("< li > " ▁+ ▁bean . getICDCode () ▁+ ▁" ▁" ▁+ ▁bean . get Description () ▁+ ▁"</ li >"); ▁} ▁%></ ul ><% ▁} ▁%> ▁</ li > ▁< li > Prescriptions : ▁<% ▁if ▁(0 ▁== ▁action . getCurrent Prescriptions (). size ()) ▁{ ▁%>< st rong > No ▁current ▁prescriptions ▁on ▁record </ st rong ><% ▁} ▁else ▁{ ▁%>< ul ><% ▁for ( PrescriptionBean ▁bean ▁: ▁action . getCurrent Prescriptions ()) ▁{ ▁out . print ("< li > " ▁+ ▁bean . get Medication (). getNDCode () ▁+ ▁" ▁" ▁+ ▁bean . get Medication (). get Description () ▁+ ▁"</ li >"); ▁} ▁%></ ul ><% ▁} ▁%> ▁</ li > ▁< li > Immunizations : ▁<% ▁if ▁(0 ▁== ▁action . get Immunizations (). size ()) ▁{ ▁%> ▁< st rong > no ▁immunizations ▁on ▁record </ st rong > ▁<% ▁} ▁else ▁{ ▁%> ▁< ul > ▁<% ▁for ▁( ProcedureBean ▁bean ▁: ▁action . get Immunizations ()) ▁{ ▁if ▁( null ▁ != ▁bean . get Attribute () ▁&& ▁bean . get Attribute (). equals (" immunization ")) ▁out . print ("< li > " ▁+ ▁bean . get Description () ▁+ ▁" ▁ (" ▁+ ▁bean . getCPTCode () ▁+ ") " ▁+ ▁"</ li >"); ▁} ▁%> ▁</ ul > ▁<% ▁} ▁%> ▁</ li > ▁<%@ include ▁file ="/ f ooter . jsp " ▁%>