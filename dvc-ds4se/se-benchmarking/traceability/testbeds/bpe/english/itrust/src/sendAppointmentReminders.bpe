▁<%@ page ▁error Page ="/ auth / exception Handler . jsp " ▁%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . dao . DAOFactory "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . dao . mysql . TransactionDAO "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . enums . TransactionType "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . action . S endMessageAction "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . action . V iewMyApptsAction "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . ApptBean "%> ▁<%@ page ▁import =" edu . nc su . cs c . itrust . beans . MessageBean "%> ▁<%@ page ▁import =" java . util . Calendar "%> ▁<%@ page ▁import =" java . util . List "%> ▁<%@ page ▁import =" java . util . Date "%> ▁<%@ page ▁import =" java . text . DateFormat "%> ▁<%@ page ▁import =" java . text . SimpleDateFormat "%> ▁<%@ page ▁import =" java . sql . Timestamp "%> ▁<%@ include ▁file ="/ global . jsp " ▁%> ▁<% ▁pageTitle ▁= ▁" iTrust ▁- ▁Send ▁Appointment ▁Reminders "; ▁%> ▁<%@ include ▁file ="/ header . jsp " ▁%> ▁<% ▁String ▁headerMessage ▁= ▁""; ▁int ▁ messagesSent ▁= ▁-1; ▁boolean ▁error ▁= ▁false ; ▁if ( request . getParameter (" submit ") ▁ != ▁null ) ▁{ ▁if ( request . getParameter (" threshold ") ▁ != ▁null ) ▁{ ▁int ▁days ▁= ▁0; ▁try ▁{ ▁days ▁= ▁Integer . parse Int ( request . getParameter (" threshold ")); ▁} ▁catch ( NumberFormat Exception ▁e ) ▁{ ▁headerMessage ▁= ▁" P lease ▁enter ▁a ▁number ▁into ▁the ▁threshold ▁field . "; ▁error ▁= ▁true ; ▁} ▁S endMessageAction ▁action ▁= ▁new ▁S endMessageAction ( prodDAO , ▁ 9 000000009 L ); ▁MessageBean ▁toSend ▁= ▁new ▁MessageBean (); ▁DateFormat ▁format ▁= ▁new ▁ SimpleDateFormat (" hh : mm ▁a , ▁ MM - dd - yyyy "); ▁Calendar ▁current ▁= ▁Calendar . get Instance (); ▁Calendar ▁end ▁= ▁Calendar . get Instance (); ▁end . add ( Calendar . DAY _ OF _ MONTH , ▁days ); ▁end . set ( Calendar . H OUR _ OF _ DAY , ▁2 3 ); ▁end . set ( Calendar . MINUTE , ▁59) ; ▁end . set ( Calendar . SE CON D , ▁59) ; ▁Calendar ▁subject ▁= ▁Calendar . get Instance (); ▁View MyApptsAction ▁appt Action ▁= ▁new ▁View MyApptsAction ( prodDAO , ▁loggedInMID . longValue ()); ▁List < ApptBean > ▁ap List ▁= ▁appt Action . getAll Appts (); ▁ messagesSent ▁= ▁0; ▁for ( ApptBean ▁a ▁: ▁ap List ) ▁{ ▁if ( a . getDate (). after ( current . getTime ()) ▁&& ▁a . getDate (). before ( end . getTime ())) ▁{ ▁toSend . set From ( 9 000000009 L ); ▁subject . setTime InM illi s ( a . getDate (). getTime ()); ▁int ▁differen ce ▁= ▁subject . get ( Calendar . DAY _ OF _ MONTH ) - current . get ( Calendar . DAY _ OF _ MONTH ); ▁if ( subject . get ( Calendar . MONTH ) > current . get ( Calendar . MONTH )) ▁{ ▁differen ce ▁= ▁current . getActual Maximum ( Calendar . DAY _ OF _ MONTH ) - current . get ( Calendar . DAY _ OF _ MONTH ) + subject . get ( Calendar . DAY _ OF _ MONTH ); ▁} ▁toSend . set Subject (" Reminder : ▁up coming ▁appointment ▁in ▁" ▁+ ▁differen ce ▁+ ▁" ▁day ( s )"); ▁toSend . setSen tDate ( new ▁Timestamp ( current . getTime InM illi s ()) ); ▁toSend . setTo ( a . getPatient ()); ▁Date ▁d ▁= ▁new ▁Date ( a . getDate (). getTime ()); ▁toSend . s etBody (" You ▁have ▁an ▁appointment ▁on ▁"+ ▁format . format ( d ) ▁+ ▁" ▁with ▁ Dr . ▁" ▁+ ▁action . getPersonnel Name ( a . getHcp ()) ▁+ ▁" . "); ▁action . sendMessage ( toSend ); ▁toSend . setTo ( 9 000000009 L ); ▁toSend . set Subject ( a . getPatient ()+" :: "+ toSend . get Subject ()); ▁action . sendMessage ( toSend ); ▁ messagesSent ++; ▁} ▁} ▁// log ▁the ▁messages ▁TransactionDAO ▁transDAO ▁= ▁prodDAO . get TransactionDAO (); ▁transDAO . log Transaction ( TransactionType . SEND _ REMINDERS , ▁loggedInMID ); ▁} ▁} ▁%> ▁< div ▁align =" center "> ▁< h 2> Send ▁Appointment ▁Reminders </ h 2> ▁<%= error ?" < span ▁class =\" iTrustMessage \">"+ headerMessage +"</ span >< br ▁/>< br ▁/> ":"" ▁%> ▁<%= messagesSent != -1 ?" < span ▁class =\" iTrustMessage \">"+ messagesSent +" ▁message ( s ) ▁sent . </ span >< br ▁/>< br ▁/> ":"" ▁%> ▁< form ▁method =" post " ▁action =" send Appointment Reminders . jsp "> ▁< label ▁for =" threshold " ▁> Enter ▁reminder ▁threshold :</ label > ▁< input ▁type =" text " ▁name =" threshold " ▁id =" threshold " ▁/>< span > ▁days </ span > ▁< br ▁/> ▁< br ▁/> ▁< input ▁type =" submit " ▁name =" submit " ▁value =" Submit " ▁/> ▁</ form > ▁</ div > ▁<%@ include ▁file ="/ f ooter . jsp " ▁%>